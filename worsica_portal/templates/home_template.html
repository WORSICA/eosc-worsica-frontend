{% extends "base.html" %}

{% block content %}
{% load staticfiles %}

{% include 'components/_map_widget.html' %}
<style>
	
	hr {
		border-color: #2c3239;
		margin-top: 5px;
		margin-bottom: 5px;
	}
	.form-control:disabled{
		background-color: #ffffff;
	}

	#selectROI {
		color:#1fbbd9;
	}

	.rightPanelSubtitle {
		font-size:21px; 
		color:#1fbbd9
	}

	.myaccordion {
		padding-left:20px;
		padding-right: 20px;
		margin-bottom: 40px;
	}
	
	.chosenImageset {
		background-color: #1fbbd9 !important
	}
	
	
</style>
{% include 'components/_workspace_left_panel.html' %}
{% include 'components/_workspace_right_panel.html' %}
<script>
	
	$.ajaxSetup({ //send csrftoken inside xhr
		beforeSend: function(xhr, settings) {
			if (settings.type == 'POST' || settings.type == 'PUT' || settings.type == 'DELETE') {
				xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
			}
		} 
	})

	var jsonCreateSimulation = {}
	var jsonCreateLeakDetection = {}
	var curr_step = $('.step')[0].id
	var LEFT_PANEL_MODE = null
	var EDIT_SIMULATION_ID = null
	var EDIT_LEAK_DETECTION_ID = null
	var RIGHT_PANEL_MODE = null
	//var WATERLEAK_SIMULATION_EXISTS = false
	var todayDate = new Date()
	var yesterdayDate = new Date(new Date().setDate(todayDate.getDate()-1))
	var tomorrowDate = new Date(new Date().setDate(todayDate.getDate()+1))
	var _lmd = new Date().setDate(todayDate.getDate()-30)
	var lastMonthDate = new Date(_lmd)
	var _lyd = new Date().setDate(todayDate.getDate()-366)
	var lastYearDate = new Date(_lyd)
	var WATERLEAK_SENTINEL2_CUSTOM_BEGINDATE = "2016-08-01"
	var WATERLEAK_SENTINEL2_CUSTOM_ENDDATE = todayDate.toISOString().split('T')[0]
	/*{% if 'centaurus:9999' in request.build_absolute_uri %}//test
	var WATERLEAK_SENTINEL2_CUSTOM_BEGINDATE = "2020-11-01"
	var WATERLEAK_SENTINEL2_CUSTOM_ENDDATE = "2021-02-10"
	{% endif %}*/
	var drawUploadedROI = null
	//var data_container = {}
	/* data_container ={
		'imageset_id'{
			'product_id'{}
			}
		}
	}*/

	/*---------------------------------------  DEFAULT WORKFLOW VALUES -----------------------------------------------------*/
	DEFAULT_STEP2_S2_CLOUD_COV = 10

	DEFAULT_STEP4_WATER_INDEX = 'ndwi'
	DEFAULT_STEP4_WI_THRESHOLD = 0
	DEFAULT_STEP4_KMEANS_CLUSTERS = 5
	DEFAULT_STEP4_TOPO_DEPTH = 10
	DEFAULT_STEP4_BATH_DEPTH = -10

	DEFAULT_STEP6_SIMULATION_NAME = ''

	/*---------------------------------------Json Simulation------------------------------------------------------------*/
	function createFreshBlobJsonSimulation(){
		if(jsonCreateSimulation){
			jsonCreateSimulation['service'] = SERVICE_NAME
			jsonCreateSimulation['simulationName'] = ''
			jsonCreateSimulation['step1ROI'] = {}
			restartBlobJsonSimulation('step1ROI')
			jsonCreateSimulation['step2Inputs'] = {}
			restartBlobJsonSimulation('step2Inputs')
			jsonCreateSimulation['step3InputsRevision'] = {}
			restartBlobJsonSimulation('step3InputsRevision')
			jsonCreateSimulation['step4Detection'] = {}
			restartBlobJsonSimulation('step4Detection')
			/*jsonCreateSimulation['step5OCConnection'] = {}
			restartBlobJsonSimulation('step5OCConnection')*/
		}
		return jsonCreateSimulation
	}

	function restartBlobJsonSimulation(step){
		console.log('--restartBlobJsonSimulation '+step)
		if (step == 'step1ROI'){
			jsonCreateSimulation['step1ROI']['opt'] = 'optCreate'//radio
			jsonCreateSimulation['step1ROI']['roiName'] = ''
			jsonCreateSimulation['step1ROI']['optCreateFrom'] = 'optCreateFrom1'//radio
			//jsonCreateSimulation['step1ROI']['roiArea']  = ''
			jsonCreateSimulation['step1ROI']['topLeftY'] = ''
			jsonCreateSimulation['step1ROI']['bottomRightX'] = ''
			jsonCreateSimulation['step1ROI']['topLeftX'] = ''
			jsonCreateSimulation['step1ROI']['bottomRightY']  = ''
			jsonCreateSimulation['step1ROI']['selectROI'] = ''//select
		}
		else if (step == 'step2Inputs'){
			jsonCreateSimulation['step2Inputs']['beginDate'] = lastYearDate.toISOString().split('T')[0]
			jsonCreateSimulation['step2Inputs']['endDate'] = todayDate.toISOString().split('T')[0]
			jsonCreateSimulation['step2Inputs']['optInput'] = 'optInput1'//radio
			jsonCreateSimulation['step2Inputs']['optSentinelLevels'] = ['optSentinel2-L1C'] //checkboxes
			jsonCreateSimulation['step2Inputs']['optSentinel2-cloud-cov'] = DEFAULT_STEP2_S2_CLOUD_COV
			jsonCreateSimulation['step2Inputs']['conversion-l1-l2'] = false
			jsonCreateSimulation['step2Inputs']['filter-cloud-cov-l2'] = true	
		}
		else if (step == 'step3InputsRevision'){
			jsonCreateSimulation['step3InputsRevision']['listOfImagesets'] = []//table
			{% if request.path == home_waterleak %}
			jsonCreateSimulation['step3InputsRevision']['optInputRevision'] = 'optInputRevision1'
			{% endif %}
		}
		else if (step == 'step4Detection'){
			jsonCreateSimulation['step4Detection']['waterindex'] = DEFAULT_STEP4_WATER_INDEX
			jsonCreateSimulation['step4Detection']['wi-threshold'] = DEFAULT_STEP4_WI_THRESHOLD
			jsonCreateSimulation['step4Detection']['kmeans-clusters'] = DEFAULT_STEP4_KMEANS_CLUSTERS
			jsonCreateSimulation['step4Detection']['topography-depth'] = DEFAULT_STEP4_TOPO_DEPTH
			jsonCreateSimulation['step4Detection']['bathymetry-depth'] = DEFAULT_STEP4_BATH_DEPTH
		}
		//{% if request.path == home_coastal %}
		/*else if (step == 'step5OCConnection'){
			jsonCreateSimulation['step5OCConnection']['step5OCConnection-enable'] = true
			jsonCreateSimulation['step5OCConnection']['optOCConfig'] = 'optOCConfig1'
			jsonCreateSimulation['step5OCConnection']['oc-deployment-id'] = 1
		}*/
		//{% endif %}
		else if (step == 'step6Run'){
			jsonCreateSimulation['simulationName'] = DEFAULT_STEP6_SIMULATION_NAME
		}
		console.log('--restartBlobJsonSimulation '+step+' done')
	}

	function createFreshBlobJsonLeakDetection(){
		if(jsonCreateLeakDetection){
			jsonCreateLeakDetection['leakDetectionName'] = ''
			jsonCreateLeakDetection['step1ImageSelection'] = {}
			restartBlobJsonLeakDetection('step1ImageSelection')
			//jsonCreateLeakDetection['step2LeakDetection'] = {}
			//restartBlobJsonLeakDetection('step2LeakDetection')
			jsonCreateLeakDetection['step3LeakDetection'] = {}
			restartBlobJsonLeakDetection('step3LeakDetection')
			jsonCreateLeakDetection['step4LeakDetection'] = {}
			restartBlobJsonLeakDetection('step4LeakDetection')
		}
		return jsonCreateLeakDetection
	}

	function restartBlobJsonLeakDetection(step){
		console.log('--restartBlobJsonLeakDetection '+step)
		if (step == 'step1ImageSelection'){
			jsonCreateLeakDetection['leakDetectionName'] = ''
			jsonCreateLeakDetection['step1ImageSelection']['roi_id'] = null
			jsonCreateLeakDetection['step1ImageSelection']['simulation_id'] = null
			jsonCreateLeakDetection['step1ImageSelection']['image_source'] = {}
			jsonCreateLeakDetection['step1ImageSelection']['image_source']['from'] = null
			jsonCreateLeakDetection['step1ImageSelection']['image_source']['image_source_id'] = null
			jsonCreateLeakDetection['step1ImageSelection']['image_source']['listOfImagesets'] = []
			jsonCreateLeakDetection['step1ImageSelection']['image_source']['index_type'] = 'ndwi'
			jsonCreateLeakDetection['step1ImageSelection']['image_source']['detection_type'] = 'by_index'
		}
		//else if (step == 'step2LeakDetection'){
			//jsonCreateLeakDetection['step2LeakDetection'] = {}
		//}
		else if (step == 'step3LeakDetection'){
			jsonCreateLeakDetection['step3LeakDetection']['optStep3LeakDetectionPipeNetwork'] = 'optStep3LeakDetectionPipeNetwork3'
			jsonCreateLeakDetection['step3LeakDetection']['geometry_id'] = []			
			jsonCreateLeakDetection['step3LeakDetection']['optStep3LeakDetectionMask'] = 'optStep3LeakDetectionMask2'
			jsonCreateLeakDetection['step3LeakDetection']['mask_width'] = 10
		}
		else if (step == 'step4LeakDetection'){
			//jsonCreateLeakDetection['step4LeakDetection'] = {}
			//jsonCreateLeakDetection['step4LeakDetection']['filter_using'] = {}
			//jsonCreateLeakDetection['step4LeakDetection']['filter_using']['masks_id'] = []
			//jsonCreateLeakDetection['step4LeakDetection']['filter_using']['geometries_id'] = []
			//jsonCreateLeakDetection['step4LeakDetection']['show_number_of_points'] = 10000
		}
	}

	function saveBlobJsonLeakDetection(step, jsonCreateSimulation){		
		console.log('--saveBlobJsonLeakDetection '+step)
		if (step == 'step1ImageSelection'){
			if($('#div-step1ImageSelection #select-ld-listOfROI').val()!=null){
				jsonCreateLeakDetection[step]['roi_id'] = $('#div-step1ImageSelection #select-ld-listOfROI').val().split('_')[1]
			}
			if($('#div-step1ImageSelection #select-ld-listOfSimulation').val()!=null){
				jsonCreateLeakDetection[step]['simulation_id'] = $('#div-step1ImageSelection #select-ld-listOfSimulation').val().split('_')[1]
			}
			if($('#div-step1ImageSelection #div-ld-listOfImageset input[name="optImageset"]:checked').val()!=null){
				_chosen_imageset_id = $('#div-step1ImageSelection #div-ld-listOfImageset input[name="optImageset"]:checked').prop('id')
				if(_chosen_imageset_id.indexOf('esa_imageset')>-1){//if is for download
					jsonCreateLeakDetection[step]['image_source']['from'] = 'new_image'
					jsonCreateLeakDetection[step]['image_source']['image_source_id'] = null
					jsonCreateLeakDetection[step]['image_source']['listOfImagesets'] = JSON.parse($('#div-step1ImageSelection #div-ld-listOfImageset #'+_chosen_imageset_id+'_blob').text())
				}
				else{//if existing
					jsonCreateLeakDetection[step]['image_source']['from'] = 'processed_image'
					jsonCreateLeakDetection[step]['image_source']['image_source_id'] = _chosen_imageset_id.split('_')[1]
					jsonCreateLeakDetection[step]['image_source']['listOfImagesets'] = []
				}
			}			
			jsonCreateLeakDetection[step]['image_source']['index_type'] = $('#div-step1ImageSelection #select-ld-listOfWI').val()
			jsonCreateLeakDetection[step]['image_source']['detection_type'] = $('#div-step1ImageSelection #div-ld-listOfLeakDetection input[name="optLeakDetectionType"]:checked').prop('id')
			jsonCreateLeakDetection['leakDetectionName'] = $('#div-step1ImageSelection #leakDetectionName').val()
		}
		else if (step == 'step3LeakDetection'){
			optStep3LeakDetectionPipeNetwork = $('#div-step3LeakDetection #accordion1 input[name="optStep3LeakDetectionPipeNetwork"]:checked').prop('id')
			jsonCreateLeakDetection[step]['optStep3LeakDetectionPipeNetwork'] = optStep3LeakDetectionPipeNetwork
			jsonCreateLeakDetection[step]['geometry_id'] = []
			if (optStep3LeakDetectionPipeNetwork == 'optStep3LeakDetectionPipeNetwork2'){
				optSelectPipeNetwork = $('#div-step3LeakDetection #accordion1 #listOfUploadedGeometries input[name="optSelectPipeNetwork"]:checked').prop('id')
				if (optSelectPipeNetwork!==undefined){
					jsonCreateLeakDetection[step]['geometry_id'].push(optSelectPipeNetwork.split('_')[1])
				}
			}
			else if (optStep3LeakDetectionPipeNetwork == 'optStep3LeakDetectionPipeNetwork1'){
				optSelectPipeNetwork = parseInt($('#divuploadgeometry #_store_pipe_network_id').text()) //$('#div-step3LeakDetection #accordion1 #listOfUploadedGeometries input[name="optSelectPipeNetwork"]:checked').prop('id')
				if (optSelectPipeNetwork!==undefined){
					jsonCreateLeakDetection[step]['geometry_id'].push(optSelectPipeNetwork)
				}
			}
			jsonCreateLeakDetection[step]['optStep3LeakDetectionMask'] = $('#div-step3LeakDetection #accordion2 input[name="optStep3LeakDetectionMask"]:checked').prop('id')
			jsonCreateLeakDetection[step]['mask_width'] = $('#div-step3LeakDetection #accordion2 #optStep3LeakDetectionMask1-width').val()
		}
		else if (step == 'step4LeakDetection'){}
		return jsonCreateLeakDetection
	}

	function loadBlobJsonLeakDetection(step, jsonBlob){
		console.log('--loadBlobJsonLeakDetection '+step)
		jsonCreateLeakDetection = jsonBlob
		if (step == 'step1ImageSelection'){
			//you will not be able to edit image selection.
		}
		else if (step == 'step3LeakDetection'){
			/*optStep3LeakDetectionPipeNetwork = jsonCreateLeakDetection[step]['optStep3LeakDetectionPipeNetwork']
			if(optStep3LeakDetectionPipeNetwork=='optStep3LeakDetectionPipeNetwork1'){
				jsonCreateLeakDetection[step]['optStep3LeakDetectionPipeNetwork']='optStep3LeakDetectionPipeNetwork2'
			}*/
			//$('#div-step3LeakDetection #accordion1 input[name="optStep3LeakDetectionPipeNetwork"][value="'+jsonCreateLeakDetection[step]['optStep3LeakDetectionPipeNetwork']+'"]').click()
			/*if (optStep3LeakDetectionPipeNetwork == 'optStep3LeakDetectionPipeNetwork2'){
				//wait
				for (var i=0; i<jsonCreateLeakDetection[step]['geometry_id'].length; i++){
					$('#div-step3LeakDetection #accordion1 #listOfUploadedGeometries input[name="optSelectPipeNetwork"][value="pipenetwork_'+jsonCreateLeakDetection[step]['geometry_id'][i]+'"]').click()
				}
			}*/
			//$('#div-step3LeakDetection #accordion2 input[name="optStep3LeakDetectionMask"][value="'+jsonCreateLeakDetection[step]['optStep3LeakDetectionMask']+'"]').click()
			//$('#div-step3LeakDetection #accordion2 #optStep3LeakDetectionMask1-width').val(jsonCreateLeakDetection[step]['mask_width'])
		
		}
		else if (step == 'step4LeakDetection'){

		}	
	}

	function restartStep(step){
		console.log('--restartStep '+step)
		$('#'+step).removeClass('done')
		if (step == 'step1ROI'){
			$('#div-'+step+' #accordion1 #roiName').val('')
			//$('#accordion1 #roiArea').text('')
			$('#div-'+step+' #accordion1 #topLeftY').val('')
			$('#div-'+step+' #accordion1 #bottomRightX').val('')
			$('#div-'+step+' #accordion1 #topLeftX').val('')
			$('#div-'+step+' #accordion1 #bottomRightY').val('')
			$('#div-'+step+' #accordion1 #optCreateFrom1').click()//prop('checked',true)
			$('#div-'+step+' #accordion2 #selectROI').val('roi_create')
			disableDrawPolygonMode()
			disableMeasureMode()
			if (drawUploadedROI != null){
				map.removeLayer(drawUploadedROI)
				drawUploadedROI = null
			}
		}
		else if (step == 'step2Inputs'){
			//terrasarx
			//..
			//sentinel1
			//..
			//sentinel2
			$('#div-'+step+' #accordion2 #optInput1').prop('checked',true)//radio
			$('#div-'+step+' #accordion2 #optSentinel2-L2A').prop('checked',true)
			$('#div-'+step+' #accordion2 #optSentinel2-L1C').prop('checked',false) //checkboxes
			$('#div-'+step+' #accordion2 #filter-cloud-cov-l2').prop('checked',true)
			$('#div-'+step+' #accordion2 #optSentinel2-cloud-cov').val(DEFAULT_STEP2_S2_CLOUD_COV)	
			$('#div-'+step+' #accordion2 #conversion-l1-l2').prop('checked',false)
			//pleiades
			//..
			//drone
			//..
			$('#div-'+step+' #accordion1 #beginDate').val(lastYearDate.toISOString().split('T')[0])
			$('#div-'+step+' #accordion1 #endDate').val(todayDate.toISOString().split('T')[0])
		}
		else if (step == 'step3InputsRevision'){
			//jsonCreateSimulation['step3InputsRevision']['listOfImagesets'] = []//table
			{% if request.path == home_waterleak %}
			$('#div-'+step+' #beginDateFilterList').val(lastYearDate.toISOString().split('T')[0])
			$('#div-'+step+' #endDateFilterList').val(todayDate.toISOString().split('T')[0])
			{% endif %}
		}
		else if (step == 'step4Detection'){
			$('#div-'+step+' #accordion1 #step4Detection-waterindex input[name="waterindex-chkbox"][type="checkbox"]:checked').prop('checked',false)
			$('#div-'+step+' #accordion1 #step4Detection-waterindex #'+DEFAULT_STEP4_WATER_INDEX).prop('checked',true)
			$('#div-'+step+' #accordion1 #step4Detection-waterindex #'+DEFAULT_STEP4_WATER_INDEX+'-threshold').val(DEFAULT_STEP4_WI_THRESHOLD)
			$('#div-'+step+' #accordion1 #step4Detection-waterindex .subaccordion input[type="checkbox"]:checked').prop('checked',false)//auto-chkbox
			$('#div-'+step+' #accordion1 #kmeans-clusters').val(DEFAULT_STEP4_KMEANS_CLUSTERS)
			$('#div-'+step+' #accordion1 #topography-depth').val(DEFAULT_STEP4_TOPO_DEPTH)
			$('#div-'+step+' #accordion1 #bathymetry-depth').val(DEFAULT_STEP4_BATH_DEPTH)
		}
		//{% if request.path == home_coastal %}
		/*else if (step == 'step5OCConnection'){
			$('#div-'+step+' #accordion1 #step5OCConnection-enable').prop('checked',true)
			$('#div-'+step+' #accordion1 #optOCConfig1').prop('checked',true)
			$('#div-'+step+' #accordion1 #oc-deployment-id').val(1)
		}*/
		//{% endif %}
		else if (step == 'step6Run'){
			$('#div-'+step+' #accordion1 #simulationName').val(DEFAULT_STEP6_SIMULATION_NAME)
		}
	}

	function saveBlobJsonSimulation(step, jsonCreateSimulation){
		console.log('--saveBlobJsonSimulation '+step)
		//jsonCreateSimulation[step] = {}
		if (step == 'step1ROI'){
			if ($('#div-'+step+' #roiName').val() != ''){ jsonCreateSimulation[step]['opt'] = 'optCreate' }
			else{ jsonCreateSimulation[step]['opt'] = 'optSelect' }
			jsonCreateSimulation[step]['optCreateFrom'] = $('#div-'+step+' input[name="optCreateFrom"]:checked').prop('id')//radio
			//jsonCreateSimulation[step]['roiArea']  = $('#accordion1 #roiArea').text()
			if (!isOptCreate()){ 
				jsonCreateSimulation[step]['roiName'] = $('#div-'+step+' #accordion2 #selectROI option:selected').text() }//roi dropdown
			else{ 
				jsonCreateSimulation[step]['roiName'] = $('#div-'+step+' #accordion1 #roiName').val() }//roi name
			if(chosenROI != null){
				ex = chosenROI.getSource().getExtent()
				exS = ol.proj.transform([ex[0],ex[1]], 'EPSG:3857', 'EPSG:4326');
				exF = ol.proj.transform([ex[2],ex[3]], 'EPSG:3857', 'EPSG:4326');
				//$('#div-step6Run #accordion2 #roiExtent').text('['+exS[0]+', '+exS[1]+', '+exF[0]+', '+exF[1]+']')
				jsonCreateSimulation[step]['topLeftY'] = parseFloat(exS[1]).toFixed(6)
				jsonCreateSimulation[step]['bottomRightX'] = parseFloat(exF[0]).toFixed(6)
				jsonCreateSimulation[step]['topLeftX'] = parseFloat(exS[0]).toFixed(6)
				jsonCreateSimulation[step]['bottomRightY'] = parseFloat(exF[1]).toFixed(6)
			}
			else{
				jsonCreateSimulation[step]['topLeftY'] = parseFloat($('#div-'+step+' #accordion1 #topLeftY').val()).toFixed(6)
				jsonCreateSimulation[step]['bottomRightX'] = parseFloat($('#div-'+step+' #accordion1 #bottomRightX').val()).toFixed(6)
				jsonCreateSimulation[step]['topLeftX'] = parseFloat($('#div-'+step+' #accordion1 #topLeftX').val()).toFixed(6)
				jsonCreateSimulation[step]['bottomRightY']  = parseFloat($('#div-'+step+' #accordion1 #bottomRightY').val()).toFixed(6)
			}
			jsonCreateSimulation[step]['selectROI'] = $('#div-'+step+' #accordion2 #selectROI option:selected').val() //select roi_id
		}
		else if (step == 'step2Inputs'){
			jsonCreateSimulation[step]['beginDate'] = $('#div-'+step+' #accordion1 #beginDate').val()
			jsonCreateSimulation[step]['endDate'] = $('#div-'+step+' #accordion1 #endDate').val()
			optInput = $('#div-'+step+' #accordion2 input[name="optInput"]:checked').val()//radio
			jsonCreateSimulation[step]['optInput'] = optInput
			jsonCreateSimulation[step]['optSentinelLevels'] = [] //checkboxes
			if (optInput == 'optInput1'){
				$('#div-'+step+' input[name="optSentinel2"]:checked').each(function(){
					jsonCreateSimulation[step]['optSentinelLevels'].push($(this).prop('id'))
				})
			}
			else if (optInput == 'optInput5'){
				$('#div-'+step+' input[name="optSentinel1-PT"]:checked').each(function(){
					jsonCreateSimulation[step]['optSentinelLevels'].push($(this).prop('id'))
				})
				$('#div-'+step+' input[name="optSentinel1-SM"]:checked').each(function(){
					jsonCreateSimulation[step]['optSentinelLevels'].push($(this).prop('id'))
				})
			}
			jsonCreateSimulation[step]['conversion-l1-l2'] = $('#div-'+step+' #accordion2 #conversion-l1-l2').prop('checked')
			jsonCreateSimulation[step]['filter-cloud-cov-l2'] = $('#div-'+step+' #accordion2 #filter-cloud-cov-l2').prop('checked')	
			jsonCreateSimulation[step]['optSentinel2-cloud-cov'] = $('#div-'+step+' #accordion2 #optSentinel2-cloud-cov').val()
		}
		else if (step == 'step3InputsRevision'){
			{% if request.path == home_waterleak %}
			optInputRevision = $('#div-'+step+' input[name="optInputRevision"]:checked').prop('id')
			jsonCreateSimulation[step]['optInputRevision'] = optInputRevision
			if (optInputRevision == 'optInputRevision2'){
				jsonCreateSimulation['step2Inputs']['beginDate'] = $('#div-'+step+' #beginDateFilterList').val()
				jsonCreateSimulation['step2Inputs']['endDate'] = $('#div-'+step+' #endDateFilterList').val()
				jsonCreateSimulation[step]['listOfImagesets'] = []
				$('#div-'+step+' #accordion1 #listOfImagesets tr input[type="checkbox"]:checked').each(function(){
					iextend = $('#'+$(this).prop('id')+'_extent').text().split(',')
					jsonCreateSimulation[step]['listOfImagesets'].push({
						'uuid':$(this).prop('id'),
						'name':$('#'+$(this).prop('id')+'_name').text(),
						'small_name':$('#'+$(this).prop('id')+'_level').text()+' ('+$('#'+$(this).prop('id')+'_date').text()+')',
						'date':$('#'+$(this).prop('id')+'_date').text(),
						'extent':[parseFloat(iextend[0]),parseFloat(iextend[1]),parseFloat(iextend[2]),parseFloat(iextend[3])],
					})
				})
			}
			else{
				jsonCreateSimulation['step2Inputs']['beginDate'] = WATERLEAK_SENTINEL2_CUSTOM_BEGINDATE
				jsonCreateSimulation['step2Inputs']['endDate'] = WATERLEAK_SENTINEL2_CUSTOM_ENDDATE
				//do not delete previously fetched list
				//since it will not be loaded to the table, there's no need to verify the checked ones.
			}
			{% else %}
			jsonCreateSimulation[step]['listOfImagesets'] = []
			$('#div-'+step+' #accordion1 #listOfImagesets tr input[type="checkbox"]:checked').each(function(){
				iextend = $('#'+$(this).prop('id')+'_extent').text().split(',')
				jsonCreateSimulation[step]['listOfImagesets'].push({
					'uuid':$(this).prop('id'),
					'name':$('#'+$(this).prop('id')+'_name').text(),
					'small_name':$('#'+$(this).prop('id')+'_level').text()+' ('+$('#'+$(this).prop('id')+'_date').text()+')',
					'date':$('#'+$(this).prop('id')+'_date').text(),
					'extent':[parseFloat(iextend[0]),parseFloat(iextend[1]),parseFloat(iextend[2]),parseFloat(iextend[3])],
				})
			})
			{% endif %}
		}
		else if (step == 'step4Detection'){
			selectedWaterIdx = []
			selectedWaterIdxThrshlds = []
			$('#div-step4Detection #accordion1 #step4Detection-waterindex input[name="waterindex-chkbox"][type="checkbox"]:checked').each(function(){
				wi = $(this).prop('id')
				selectedWaterIdx.push(wi)
				if ($('#div-'+step+' #accordion1 #step4Detection-waterindex input[name="'+wi+'-threshold-auto-chkbox"]').prop('checked')){
					selectedWaterIdxThrshlds.push('AUTO')
				}
				else{
					selectedWaterIdxThrshlds.push($('#div-step4Detection #accordion1 #step4Detection-waterindex #'+wi+'-threshold').val())
				}
			})
			jsonCreateSimulation[step]['waterindex'] = selectedWaterIdx.toString()  //"mndwi,mndwi2,ndwi1,ndwi2"
			//jsonCreateSimulation[step]['waterindex'] = $('#div-'+step+' #accordion1 #waterindex option:selected').val()//select
			jsonCreateSimulation[step]['wi-threshold'] = selectedWaterIdxThrshlds.toString() //"0.3,0.7,0.1,0"
			//jsonCreateSimulation[step]['wi-threshold'] = $('#div-'+step+' #accordion1 #wi-threshold').val()
			jsonCreateSimulation[step]['kmeans-clusters'] = $('#div-'+step+' #accordion1 #kmeans-clusters').val()
			jsonCreateSimulation[step]['topography-depth'] = $('#div-'+step+' #accordion1 #topography-depth').val()
			jsonCreateSimulation[step]['bathymetry-depth'] = $('#div-'+step+' #accordion1 #bathymetry-depth').val()
		}
		/*else if (step == 'step5OCConnection'){
			jsonCreateSimulation['step5OCConnection']['step5OCConnection-enable'] = $('#div-'+step+' #accordion1 #step5OCConnection-enable').prop('checked')
			jsonCreateSimulation['step5OCConnection']['optOCConfig'] = $('#div-'+step+' input[name="optOCConfig"]:checked').prop('id')
			jsonCreateSimulation['step5OCConnection']['oc-deployment-id'] = $('#div-'+step+' #accordion1 #oc-deployment-id').val()
			
		}*/
		else if (step == 'step6Run'){
			jsonCreateSimulation['simulationName'] = $('#div-'+step+' #accordion1 #simulationName').val()
		}
		console.log('--saveBlobJsonSimulation '+step+' done!')
		return jsonCreateSimulation
	}

	function loadBlobJsonSimulation(step, jsonBlob){
		console.log('--loadBlobJsonSimulation '+step)
		jsonCreateSimulation = jsonBlob
		if (step == 'step1ROI'){				
			//step1chosenOpt = 'optSelect' //jsonCreateSimulation[step]['opt']
			//$('#div-'+step+' input[name="optAction"][value="'+step1chosenOpt+'"]').click()//radio			
			$('#div-'+step+' input[name="optCreateFrom"][value="'+jsonCreateSimulation[step]['optCreateFrom']+'"]').click()//radio
			$('#div-'+step+' #accordion2 #selectROI').val(jsonCreateSimulation[step]['selectROI']) //select roi_id
		}
		else if (step == 'step2Inputs'){			
			optInput = jsonCreateSimulation[step]['optInput']
			$('#div-'+step+' input[name="optInput"][value="'+optInput+'"]').click()//radio
			$('#div-'+step+' #accordion2 #conversion-l1-l2').prop('checked', false)//jsonCreateSimulation[step]['conversion-l1-l2'])
			$('#div-'+step+' #accordion1 #beginDate').val(jsonCreateSimulation[step]['beginDate'])
			$('#div-'+step+' #accordion1 #endDate').val(jsonCreateSimulation[step]['endDate'])
			optSentinel = jsonCreateSimulation[step]['optSentinelLevels']
			$('#div-'+step+' #accordion2 input[name="optSentinel2"]:checked').each(function(){ $(this).prop('checked',false) })//unckeck existing
			for (var x=0; x<optSentinel.length; x++){
				if (optInput == 'optInput1'){//S2
					if(optSentinel[x] == 'Level-1C' ){ optSentinel[x] = 'optSentinel2-L1C' }
					else if(optSentinel[x] == 'Level-2A'){ optSentinel[x] = 'optSentinel2-L2A' }
					$('#div-'+step+' input[name="optSentinel2"][value="'+optSentinel[x]+'"]').prop('checked',true)
				}
				else if (optInput == 'optInput5'){//S1
					/*if(optSentinel[x] == 'GRD'){ optSentinel[x] = 'optSentinel1-PT-GRD' }
					else if(optSentinel[x] == 'IW'){ optSentinel[x] = 'optSentinel1-SM-IW' }
					else if(optSentinel[x] == 'SM'){ optSentinel[x] == 'optSentinel1-SM-SM' }
					$('#div-'+step+' input[name="optSentinel1-PT"][value="'+optSentinel[x]+'"]').prop('checked',true)
					$('#div-'+step+' input[name="optSentinel1-SM"][value="'+optSentinel[x]+'"]').prop('checked',true)*/
				}
			}
			$('#div-'+step+' #accordion2 #conversion-l1-l2').prop('checked', false) //jsonCreateSimulation[step]['conversion-l1-l2'])
			if(jsonCreateSimulation[step]['filter-cloud-cov-l2'] !== undefined){
				$('#div-'+step+' #accordion2 #filter-cloud-cov-l2').prop('checked', jsonCreateSimulation[step]['filter-cloud-cov-l2'])	
			}
			$('#div-'+step+' #accordion2 #optSentinel2-cloud-cov').val((jsonCreateSimulation[step]['optSentinel2-cloud-cov']? jsonCreateSimulation[step]['optSentinel2-cloud-cov'] : DEFAULT_STEP2_S2_CLOUD_COV))
		}
		else if (step == 'step3InputsRevision'){
			//jsonCreateSimulation[step]['listOfImagesets'] = []//table
			{% if request.path == home_waterleak %}
			optInputRevision = jsonCreateSimulation[step]['optInputRevision']
			$('#div-'+step+' input[name="optInput"][value="'+optInputRevision+'"]').click()//radio
			$('#div-'+step+' #beginDateFilterList').val(jsonCreateSimulation['step2Inputs']['beginDate'])
			$('#div-'+step+' #endDateFilterList').val(jsonCreateSimulation['step2Inputs']['endDate'])
			{% endif %}

		}
		else if (step == 'step4Detection'){
			$('#div-'+step+' #accordion1 #step4Detection-waterindex input[name="waterindex-chkbox"][type="checkbox"]:checked').prop('checked',false)
			$('#div-'+step+' #accordion1 #step4Detection-waterindex .custom-form-control input[type="number"]').val(0)
			selectedWaterIdx = [DEFAULT_STEP4_WATER_INDEX]
			selectedWaterIdxThrshlds = [DEFAULT_STEP4_WI_THRESHOLD]
			if (jsonCreateSimulation[step]['waterindex']){ selectedWaterIdx = jsonCreateSimulation[step]['waterindex'].split(',') }
			if (jsonCreateSimulation[step]['wi-threshold']){ selectedWaterIdxThrshlds = jsonCreateSimulation[step]['wi-threshold'].split(',') }
			$.each(selectedWaterIdx, function(x,y){
				$('#div-'+step+' #accordion1 #step4Detection-waterindex #'+y).prop('checked',true)
				isAutoThreshold = true //(selectedWaterIdxThrshlds[x]=='AUTO')
				if (selectedWaterIdxThrshlds.length>1){
					$('#div-'+step+' #accordion1 #step4Detection-waterindex input[name="'+y+'-threshold-auto-chkbox"]').prop('checked', isAutoThreshold)
					$('#div-'+step+' #accordion1 #step4Detection-waterindex #'+y+'-threshold').val(isAutoThreshold? 0 : parseFloat(selectedWaterIdxThrshlds[x]))
				}
				else{
					$('#div-'+step+' #accordion1 #step4Detection-waterindex input[name="'+y+'-threshold-auto-chkbox"]').prop('checked', isAutoThreshold)
					$('#div-'+step+' #accordion1 #step4Detection-waterindex #'+y+'-threshold').val(isAutoThreshold? 0 : parseFloat(selectedWaterIdxThrshlds[0]))
				}
				
			})
			//$('#div-'+step+' #accordion1 #waterindex').val((jsonCreateSimulation[step]['waterindex']? jsonCreateSimulation[step]['waterindex'] : DEFAULT_STEP4_WATER_INDEX))//select			
			//$('#div-'+step+' #accordion1 #wi-threshold').val((jsonCreateSimulation[step]['wi-threshold']? jsonCreateSimulation[step]['wi-threshold'] : DEFAULT_STEP4_WI_THRESHOLD))
			$('#div-'+step+' #accordion1 #kmeans-clusters').val((jsonCreateSimulation[step]['kmeans-clusters']? jsonCreateSimulation[step]['kmeans-clusters'] : DEFAULT_STEP4_KMEANS_CLUSTERS))
			$('#div-'+step+' #accordion1 #topography-depth').val((jsonCreateSimulation[step]['topography-depth']? jsonCreateSimulation[step]['topography-depth'] : DEFAULT_STEP4_TOPO_DEPTH))
			$('#div-'+step+' #accordion1 #bathymetry-depth').val((jsonCreateSimulation[step]['bathymetry-depth']? jsonCreateSimulation[step]['bathymetry-depth'] : DEFAULT_STEP4_BATH_DEPTH))
		}
		/*else if (step == 'step5OCConnection'){
			$('#div-'+step+' input[name="optOCConfig"][value="'+jsonCreateSimulation['step5OCConnection']['optOCConfig']+'"]').click()
			$('#div-'+step+' #accordion1 #oc-deployment-id').val(jsonCreateSimulation['step5OCConnection']['oc-deployment-id'])
			
		}*/
		else if (step == 'step6Run'){
			$('#div-'+step+' #accordion1 #simulationName').val((jsonCreateSimulation['simulationName']? jsonCreateSimulation['simulationName'] : DEFAULT_STEP6_SIMULATION_NAME))
		}
		$('#'+step).addClass('done')
		console.log('--loadBlobJsonSimulation '+step+' done!')
	}

	function loadRegionsOfInterest(){
		$('#div-step1ROI #accordion2 #selectROI').empty()
		$('#showVisualizationAndDetectionManager #accordion1 #listOfROI').empty()
		$('#div-step1ROI #accordion2 #selectROI').append( '<option value="roi_create" style="font-style: italic;">--- Region of Interest ---</option>' )
		while (roiLayers.length>0){       
    		map.removeLayer(roiLayers.pop()) 	
		}
		$.ajax({ type: "GET", url: '/portal/rois?service='+SERVICE_NAME, async: true,
		     success : function(response){
	     		listOfROIs = $.parseJSON(JSON.stringify(response));
	     		for (var d=0;d<listOfROIs.length;d++){ 
     				loadARegionOfInterest(listOfROIs[d])
     				if (d==0){
     					$('#showVisualizationAndDetectionManager #accordion1 #listOfROI input[name="optROIshowVisualizationAndDetectionManager"]')[0].click()//.checked = true
     					
     				}
     				//RIGHT PANEL
					//$('#showVisualizationAndDetectionManager #accordion1 #listOfROI input[name="optROIshowVisualizationAndDetectionManager"]').change(function(){			
					//	getListOfSimulations()
					//})
     			}
     			_hideAllROI()
     			
		     },
		     error: function(response){
				console.log('loadRegionsOfInterest error! ')
		     }
		});
	}
	function _createRoiLayer(d, _name){
		console.log(d)
		geojson = {
	        'type': 'FeatureCollection',
	        'crs': { 'type': 'name', 'properties': { 'name': 'EPSG:4326' } },
	        'features': [{
	          'type': 'Feature',
	          'geometry': {
	            'type': 'Polygon',
	            'coordinates': [[
	            	[d.upperXcoordinate, d.upperYcoordinate], 
	           		[d.upperXcoordinate, d.lowerYcoordinate], 
	            	[d.lowerXcoordinate, d.lowerYcoordinate],
	            	[d.lowerXcoordinate, d.upperYcoordinate], 
	            	[d.upperXcoordinate, d.upperYcoordinate]]]
	          },
	          "properties": {
	          	'name': d.name,
	          	'id': d.roi_id,
	          	'color': d.color,
	          }
	        }]
	    }
		var r = new ol.layer.Vector({
			name: _name,
			source: new ol.source.Vector({
 				features: (new ol.format.GeoJSON()).readFeatures(geojson,{ featureProjection: 'EPSG:3857' })
 			}),
			style: new ol.style.Style({	        
		        stroke: new ol.style.Stroke({ color: d.color, width: 3 })
		    })
		})
		return r
	}
	function loadARegionOfInterest(d){
		if (d.is_owned_by_user==true){//show only the ones you own
			$('#div-step1ROI #accordion2 #selectROI').append( '<option value="roi_'+d.roi_id+'">'+d.name+'</option>' )
		}
		$('#showVisualizationAndDetectionManager #accordion1 #listOfROI').append( 
			'<tr id="tr_roi_'+d.roi_id+'">'+
			'<th style="width:85%"><input class="form-check-input custom-radio" type="radio" onchange=getListOfSimulations() id="roi_'+d.roi_id+'" name="optROIshowVisualizationAndDetectionManager" value="roi_'+d.roi_id+'">'+
				'<label for="roi_'+d.roi_id+'" style="padding-left:10px">'+d.name+'</label></th>'+
				
			"<td>"+(d.is_owned_by_user==true?
				"<a class='clickROIDelete' onclick=onClickROIButton('delete',"+d.roi_id+")><img height=24px src='/static/images/delete.svg' title='Delete' style='margin:3px'/></a>":"")+"</td>"+
			'</tr>' )
		
		roiLayer = _createRoiLayer(d, SERVICE_NAME+'-roi_'+d.roi_id)
		roiLayer.setZIndex(5)
		map.addLayer(roiLayer)
		roiLayers.push(roiLayer)		
	}

	function onClickUploadFile(){
		if(isOptCreate() && isOptCreateUploadFile()){

		}
	}

	function onClickDrawRectangle(){
		if(isOptCreate() && isOptCreateDrawRectangle()){
			if (DRAW_POLYGON_MODE){
				disableDrawPolygonMode()
			}
			else{
				enableDrawPolygonMode()
			}
		}
	}
	function onClickSelectStep2(){
		if (!$('#step-ph2').hasClass('current')){//if the starting button wasnt clicked yet
			if(!EDIT_LEAK_POINTS_MODE){
				if (LEFT_PANEL_MODE != null){
					if(LEFT_PANEL_MODE=='waterleak-create-leak-detection'){_placeholder='creating a new leak'}
					else if(LEFT_PANEL_MODE=='waterleak-edit-leak-detection'){_placeholder='editing a leak'}
					else if(LEFT_PANEL_MODE=='edit'){_placeholder='editing an existing simulation'}
					else{_placeholder='creating a new simulation'}
					buildDynamicModalPopup('Warning!', 
						'<p>You are '+_placeholder+'. Closing this will lose any changes you have done on the workflow. Continue?</p>', 
						[['Yes', function(){ 
							$(this).dialog( "close" )
							if (curr_step == null || curr_step != "step0DetectionSelection"){
								curr_step = "step0DetectionSelection"
							}
							if (LEFT_PANEL_MODE == null){
								LEFT_PANEL_MODE = 'waterleak-create-leak-detection'
							}
							// 
							$('#step-ph1').removeClass('current')
							$('#step-ph1-workflow').hide() 
							{% if request.path == home_waterleak %}
							$('#step-ph2').addClass('current')
							$('#step-ph2-workflow').show()
							//
							reverseRemoveLayerIndexOf('preview_pipe')
							$('#new-info-preview-pipe-active #new-info-preview-pipe-table').empty()
							if ($('#new-info-preview-pipe-active #new-info-preview-pipe-table tr').length==0){
								$('#new-info-preview-pipe-active #new-info-preview-pipe-table').append(
									'<tr id="err-list-empty"><td><b>(No pipe networks uploaded for preview)</b></td></tr>')
							}
							$('#divuploadgeometry2 #status_message').css( 'color', '')
							$('#divuploadgeometry2 #status_message').empty()
							$('#divuploadgeometry2 .progress-bar').css( 'background', '#2CC0DE')
							$('#divuploadgeometry2 .progress-bar').css('width', '0%')
							$('#divuploadgeometry2 #fileupload2').val('')
							{% endif %}
				
							if ($('#'+curr_step).hasClass('current') || $('#'+curr_step).hasClass('done')){
								goToStepLD(curr_step)
							}
							//$('.close').toggleClass('closed');
						}],
						['No', function(){
							$(this).dialog( "close" )
						}]], [300,220])
				}
				else{
					if (curr_step == null || curr_step != "step0DetectionSelection"){
						curr_step = "step0DetectionSelection"
					}
					if (LEFT_PANEL_MODE == null){
						LEFT_PANEL_MODE = 'waterleak-create-leak-detection'
					}
					// 
					$('#step-ph1').removeClass('current')
					$('#step-ph1-workflow').hide() 
					{% if request.path == home_waterleak %}
					$('#step-ph2').addClass('current')
					$('#step-ph2-workflow').show()
					//
					reverseRemoveLayerIndexOf('preview_pipe')
					$('#new-info-preview-pipe-active #new-info-preview-pipe-table').empty()
					if ($('#new-info-preview-pipe-active #new-info-preview-pipe-table tr').length==0){
						$('#new-info-preview-pipe-active #new-info-preview-pipe-table').append(
							'<tr id="err-list-empty"><td><b>(No pipe networks uploaded for preview)</b></td></tr>')
					}
					$('#divuploadgeometry2 #status_message').css( 'color', '')
					$('#divuploadgeometry2 #status_message').empty()
					$('#divuploadgeometry2 .progress-bar').css( 'background', '#2CC0DE')
					$('#divuploadgeometry2 .progress-bar').css('width', '0%')
					$('#divuploadgeometry2 #fileupload2').val('')
					{% endif %}

					if ($('#'+curr_step).hasClass('current') || $('#'+curr_step).hasClass('done')){
						goToStepLD(curr_step)
					}
					//$('.close').toggleClass('closed');
				}
			}
			else{
				buildDynamicModalPopup('Error!', 
					'<p>This option is disabled. Please leave the edit leak points mode.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
		}
	}
	function onClickSelectStep(){
		if (!$('#step-ph1').hasClass('current')){//if the starting button wasnt clicked yet
			if(!EDIT_LEAK_POINTS_MODE){
				if (LEFT_PANEL_MODE != null){
					if(LEFT_PANEL_MODE=='waterleak-create-leak-detection'){_placeholder='creating a new leak'}
					else if(LEFT_PANEL_MODE=='waterleak-edit-leak-detection'){_placeholder='editing a leak'}
					else if(LEFT_PANEL_MODE=='edit'){_placeholder='editing an existing simulation'}
					else{_placeholder='creating a new simulation'}
					buildDynamicModalPopup('Warning!', 
						'<p>You are '+_placeholder+'. Closing this will lose any changes you have done on the workflow. Continue?</p>', 
						[['Yes', function(){ 
							$(this).dialog( "close" )
							console.log(curr_step)
							if (curr_step == null || curr_step != "step1ROI" || curr_step == 'step-ph1'){
								curr_step = "step1ROI"
							}
							if (LEFT_PANEL_MODE == null){
								LEFT_PANEL_MODE = 'create'
							}
							//
							$('#step-ph1').addClass('current')
							$('#step-ph1-workflow').show()
							{% if request.path == home_waterleak %}
							$('#step-ph2').removeClass('current')
							$('#step1ImageSelection').removeClass('current')
							$('#step3LeakDetection').removeClass('current')
							$('#step4LeakDetection').removeClass('current')
							$('#step-ph2-workflow').hide()
							$('#showStateLeakDetection').hide()
							_clear_interval_leak_detection_details()
							//
							reverseRemoveLayerIndexOf('preview_pipe')
							$('#new-info-preview-pipe-active #new-info-preview-pipe-table').empty()
							if ($('#new-info-preview-pipe-active #new-info-preview-pipe-table tr').length==0){
								$('#new-info-preview-pipe-active #new-info-preview-pipe-table').append(
									'<tr id="err-list-empty"><td><b>(No pipe networks uploaded for preview)</b></td></tr>')
							}
							$('#divuploadgeometry2 #status_message').css( 'color', '')
							$('#divuploadgeometry2 #status_message').empty()
							$('#divuploadgeometry2 .progress-bar').css( 'background', '#2CC0DE')
							$('#divuploadgeometry2 .progress-bar').css('width', '0%')
							$('#divuploadgeometry2 #fileupload2').val('')
							{% endif %}
							if ($('#'+curr_step).hasClass('current') || $('#'+curr_step).hasClass('done')){
								goToStep(curr_step)
							}
						}],
						['No', function(){
							$(this).dialog( "close" )
						}]], [300,220])
				}
				else{
					if (curr_step == null || curr_step != "step1ROI" || curr_step == 'step-ph1'){
						curr_step = "step1ROI"
					}
					if (LEFT_PANEL_MODE == null){
						LEFT_PANEL_MODE = 'create'
					}
					//
					$('#step-ph1').addClass('current')
					$('#step-ph1-workflow').show()
					{% if request.path == home_waterleak %}
					$('#step-ph2').removeClass('current')
					$('#step1ImageSelection').removeClass('current')
					$('#step3LeakDetection').removeClass('current')
					$('#step4LeakDetection').removeClass('current')
					$('#step-ph2-workflow').hide()
					$('#showStateLeakDetection').hide()
					_clear_interval_leak_detection_details()
					//
					reverseRemoveLayerIndexOf('preview_pipe')
					$('#new-info-preview-pipe-active #new-info-preview-pipe-table').empty()
					if ($('#new-info-preview-pipe-active #new-info-preview-pipe-table tr').length==0){
						$('#new-info-preview-pipe-active #new-info-preview-pipe-table').append(
							'<tr id="err-list-empty"><td><b>(No pipe networks uploaded for preview)</b></td></tr>')
					}
					$('#divuploadgeometry2 #status_message').css( 'color', '')
					$('#divuploadgeometry2 #status_message').empty()
					$('#divuploadgeometry2 .progress-bar').css( 'background', '#2CC0DE')
					$('#divuploadgeometry2 .progress-bar').css('width', '0%')
					$('#divuploadgeometry2 #fileupload2').val('')
					{% endif %}
					if ($('#'+curr_step).hasClass('current') || $('#'+curr_step).hasClass('done')){
						goToStep(curr_step)
					}
				}
			}
			else{
				buildDynamicModalPopup('Error!', 
					'<p>This option is disabled. Please leave the edit leak points mode.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
		}		
	}
	function goToStepLD(step){
		disableDrawPolygonMode()
		disableMeasureMode()
		if (drawUploadedROI != null){
			map.removeLayer(drawUploadedROI)
			drawUploadedROI = null
		}

		if(RIGHT_PANEL_MODE != null){
			RIGHT_PANEL_MODE = null
			//$('#listOfSimulations input[type="checkbox"]:checked').prop('checked',false)
			$('#listOfSimulations tr td table tr td table tr th table tr td input[type="checkbox"]:checked').prop('checked',false)
			$('#listOfSimulations tr td table tr td table tr th table tr th input[type="checkbox"]').prop('checked',true)
			$('#listOfSimulations tr td table tr td table tr th table tr th input[type="checkbox"]').prop('disabled', true)
			
			//EYEDROPPER_CLICK_MODE = false
			disableEyedropperClickMode()
			$('#new-info-eyedrop').hide()
			$('#new-info-show-open-layers').hide()
			$('#new-info-show-ruler').hide()
			$('#new-info-preview-pipe').hide()
			$('#new-info-plot-sea-tide').hide()
		}
		console.log('-previous '+curr_step)
		console.log('-going to '+step)		
		closeRightPanel()
		cleanupRightPanel()
		jsonCreateLeakDetection = saveBlobJsonLeakDetection(curr_step, jsonCreateLeakDetection)
		//_clear_interval_leak_detection_details()
		cleanupLeftPanel()
		$('#div-'+curr_step).hide()
		$('#'+curr_step).removeClass('current').addClass('done');//change prev workflow button color
		$('#leftPanelNextButton #bprev').show()
		$('#leftPanelNextButton #bprev').css('width','')
		$('#leftPanelNextButton #bprev').attr('disabled',false)
		$('#leftPanelNextButton #bnext').show()
		$('#leftPanelNextButton #bnext').css('width','')
		$('#leftPanelNextButton #bnext').attr('disabled',false)
		$('#showStateLeakDetection').hide()
		removeThumbnail()		
		if (chosenROI != null){ chosenROI.setVisible(true) }
		if (step == 'step0DetectionSelection'){
			//resetSelectedROI()
			optionsStep0DetectionSelection()
			$('#leftPanelTitle #title').text('Detection')
			//$('#leftPanelNextButton #textNext').text('Go to Calculate Anomaly')
			
			$('#leftPanelNextButton #bprev').hide()
			$('#leftPanelNextButton #bnext').css('width','430px')//full length
			$('#leftPanelNextButton #textNext').text('Next')

			$('#step1ImageSelection').removeClass('done')
			$('#step3LeakDetection').removeClass('done')
			$('#step4LeakDetection').removeClass('done')
		}
		else if (step == 'step1ImageSelection'){
			optionsStep1ImageSelection()
			$('#leftPanelTitle #title').text('Image Selection')
			//$('#leftPanelNextButton #textNext').text('Go to Calculate Anomaly')
			
			$('#leftPanelNextButton #bprev').show()
			$('#leftPanelNextButton #bnext').css('width','')//full length
			$('#leftPanelNextButton #textNext').text('Go to Pipe Network')

			//$('#step2LeakDetection').removeClass('done')
			$('#step3LeakDetection').removeClass('done')
			$('#step4LeakDetection').removeClass('done')
		}
		/*else if (step == 'step2LeakDetection'){
			$('#leftPanelTitle #title').text('Calculate Anomaly')
			$('#leftPanelNextButton #textNext').text('Go to 2nd derivative')

			$('#step3LeakDetection').removeClass('done')
			$('#step4LeakDetection').removeClass('done')
		}*/
		else if (step == 'step3LeakDetection'){//pipe network
			//loadBlobJsonLeakDetection(step, jsonCreateLeakDetection)
			optionsStep3LeakDetection()
			$('#showStateLeakDetection').show()
			$('#leftPanelTitle #title').text('Pipe network')
			$('#leftPanelNextButton #textNext').text('Go to Identify Leaks')
			$('#step4LeakDetection').removeClass('done')
		}
		else if (step == 'step4LeakDetection'){//identify leaks
			optionsStep4LeakDetection()
			$('#showStateLeakDetection').show()
			$('#leftPanelTitle #title').text('Identify Leaks')
			$('#leftPanelNextButton #textNext').text('Go to View Leak Detections')
			//$('#leftPanelNextButton #bnext').hide()
			$('#leftPanelNextButton #bprev').css('width','')
		}
		curr_step = step
		$('#div-'+curr_step).show()
		$('#'+curr_step).removeClass('done').addClass('current');
		openLeftPanel()

	}
	//
	function goToStep(step){
		disableDrawPolygonMode()
		disableMeasureMode()
		if (drawUploadedROI != null){
			map.removeLayer(drawUploadedROI)
			drawUploadedROI = null
		}

		if(RIGHT_PANEL_MODE != null){
			RIGHT_PANEL_MODE = null
			//$('#listOfSimulations input[type="checkbox"]:checked').prop('checked',false)
			$('#listOfSimulations tr td table tr td table tr th table tr td input[type="checkbox"]:checked').prop('checked',false)
			$('#listOfSimulations tr td table tr td table tr th table tr th input[type="checkbox"]').prop('checked',true)
			$('#listOfSimulations tr td table tr td table tr th table tr th input[type="checkbox"]').prop('disabled', true)
			
			//EYEDROPPER_CLICK_MODE = false
			disableEyedropperClickMode()
			$('#new-info-eyedrop').hide()
			$('#new-info-show-open-layers').hide()
			$('#new-info-show-ruler').hide()
			$('#new-info-preview-pipe').hide()
			$('#new-info-plot-sea-tide').hide()
		}

		if (step == 'step1ROI' && LEFT_PANEL_MODE == 'edit'){
			buildDynamicModalPopup('Error', 
				'<p>Sorry, in edit mode, you are not allowed to edit Region of Interest.</p>', 
				[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
		}
		else if (step == 'step1ROI' && LEFT_PANEL_MODE == 'waterleak-update'){
			buildDynamicModalPopup('Error', 
				'<p>Sorry, in update mode, you are not allowed to edit Region of Interest.</p>', 
				[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
		}
		else if (step == 'step2Inputs' && LEFT_PANEL_MODE == 'edit'){
			buildDynamicModalPopup('Error', 
				'<p>Sorry, in edit mode, you are not allowed to edit Inputs.</p>', 
				[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
		}
		else{
			console.log('-previous '+curr_step)
			console.log('-going to '+step)		
			closeRightPanel()
			cleanupRightPanel()			
			jsonCreateSimulation = saveBlobJsonSimulation(curr_step, jsonCreateSimulation)
			cleanupLeftPanel()
			$('#div-'+curr_step).hide()
			$('#'+curr_step).removeClass('current').addClass('done');//change prev workflow button color
			$('#leftPanelNextButton #bprev').show()
			$('#leftPanelNextButton #bnext').css('width','')
			removeThumbnail()
			resetSelectedROI()
			if (chosenROI != null){ chosenROI.setVisible(true) }
			if (step == 'step1ROI'){
				//_showAllROI()
				optionsStep1ROI()
				$('#leftPanelTitle #title').text('Region of Interest')
				$('#leftPanelNextButton #textNext').text(
					{% if request.path == home_waterleak %}'Go to Image Source'
					{% else %}'Go to Inputs'
					{% endif %})
				$('#leftPanelNextButton #bprev').hide()
				$('#leftPanelNextButton #bnext').css('width','430px')//full length			
				
				$('#step2Inputs').removeClass('done')
				$('#step3InputsRevision').removeClass('done')
				$('#step4Detection').removeClass('done')
				//{% if request.path == home_coastal %}
				//$('#step5OCConnection').removeClass('done')
				//{% endif %}
				$('#step6Run').removeClass('done')	
				
			}
			else if (step == 'step2Inputs'){
				optionsStep2Inputs()
				highlightSelectedROI2($('#div-step1ROI #accordion2 #selectROI').val())
				$('#leftPanelTitle #title').text(
					{%if request.path == home_waterleak %}"Image Source "
					{% else %}"Inputs"
					{% endif %})			
				//$('#leftPanelNextButton #textPrev').text('Region of Interest')
				if (LEFT_PANEL_MODE == 'waterleak-update'){ 
					$('#leftPanelNextButton #bprev').hide()
					$('#leftPanelNextButton #bnext').css('width','430px') 
				}
				else { 
					$('#leftPanelNextButton #bprev').show()
					$('#leftPanelNextButton #bnext').css('width','')
				}								
				$('#leftPanelNextButton #textNext').text(
					{% if request.path == home_waterleak %}'Go to Image Selection'
					{% else %}'Go to Inputs Revision'
					{% endif %})
				$('#step3InputsRevision').removeClass('done')
				$('#step4Detection').removeClass('done')
				//{% if request.path == home_coastal %}
				//$('#step5OCConnection').removeClass('done')
				//{% endif %}
				$('#step6Run').removeClass('done')
				
				
			}
			else if (step == 'step3InputsRevision'){
				optionsStep3InputsRevision()
				onChangeStep3InputRevisionType()
				highlightSelectedROI2($('#div-step1ROI #accordion2 #selectROI').val())
				//chosenROI.setVisible(false)
				$('#leftPanelTitle #title').text(
					{%if request.path == home_waterleak %}"Image Selection"
					{% else %}"Inputs Revision"
					{% endif %})
				if (LEFT_PANEL_MODE == 'edit'){ 
					$('#leftPanelNextButton #bprev').hide()
					$('#leftPanelNextButton #bnext').css('width','430px') 
				}
				else { 
					$('#leftPanelNextButton #bprev').show()
					$('#leftPanelNextButton #bnext').css('width','')
				}
				$('#leftPanelNextButton #textNext').text(
					{%if request.path == home_waterleak %} 'Go to Summary'
					{% else %} 'Go to Detection'				
					{% endif %}
				)
				$('#step4Detection').removeClass('done')
				
				$('#step6Run').removeClass('done')
				//colocar aqui JS para carregamento dos imagesets	
				{% if request.path != home_waterleak %}
				chosenOptPrevStep = $('#div-step2Inputs input[name="optInput"]:checked').prop('id')
				if (chosenOptPrevStep=='optInput1' || chosenOptPrevStep=='optInput5'){
					loadListOfImagesets()
				}
				else{
					loadListOfUserImagesets()//
				}
				{% endif %}
				
			}
			else if (step == 'step4Detection'){
				optionsStep4SelectDetection()
				highlightSelectedROI2($('#div-step1ROI #accordion2 #selectROI').val())
				$('#leftPanelTitle #title').text(
					{%if request.path == home_waterleak %} 'Water Index'
					{% else %} 'Detection'
					{% endif %}
				)
				//$('#leftPanelNextButton #textPrev').text('Inputs Revision')
				//{% if request.path == home_coastal %}
				//$('#leftPanelNextButton #textNext').text('Go to OPENCoastS')
				//{% else %}
				$('#leftPanelNextButton #textNext').text('Run')
				//{% endif %}
				//{% if request.path == home_coastal %}
				//$('#step5OCConnection').removeClass('done')
				//{% endif %}
				$('#step6Run').removeClass('done')
			}
			/*else if (step == 'step5OCConnection'){
				optionsStep5OCConnection()
				highlightSelectedROI2($('#div-step1ROI #accordion2 #selectROI').val())
				$('#leftPanelTitle #title').text('OPENCoastS Connection')
				$('#leftPanelNextButton #textNext').text('Go to Summary')
				//$('#leftPanelNextButton #textPrev').text('Detection')
				$('#step6Run').removeClass('done')
			}*/
			else if (step == 'step6Run'){
				highlightSelectedROI2($('#div-step1ROI #accordion2 #selectROI').val())
				$('#leftPanelTitle #title').text('Run')
				if (LEFT_PANEL_MODE == 'waterleak-update'){
					$('#leftPanelNextButton #textNext').text('Save and start update')
				}
				else if (LEFT_PANEL_MODE == 'create'){
					$('#leftPanelNextButton #textNext').text('Start')
				}
				else{
					$('#leftPanelNextButton #textNext').text('Save and restart')
				}
				//{% if request.path == home_coastal %}
				//$('#leftPanelNextButton #textPrev').text('OPENCoastS Conn.')
				//{% else %}
				//$('#leftPanelNextButton #textPrev').text('Detection')
				//{% endif %}
				loadSummary()
			}

			curr_step = step
			//loadBlobJsonSimulation(curr_step, jsonCreateSimulation)
			$('#div-'+curr_step).show()
			$('#'+curr_step).removeClass('done').addClass('current');
			openLeftPanel()
		}

	}
	function loadSummary(){	
		//step1
		$('#div-step6Run #accordion2 #roiName').text(jsonCreateSimulation['step1ROI']['roiName'])
		latMax = Math.max(jsonCreateSimulation['step1ROI']['topLeftY'], jsonCreateSimulation['step1ROI']['bottomRightY'])
		latMin = Math.min(jsonCreateSimulation['step1ROI']['topLeftY'], jsonCreateSimulation['step1ROI']['bottomRightY'])
		lonMax = Math.max(jsonCreateSimulation['step1ROI']['topLeftX'], jsonCreateSimulation['step1ROI']['bottomRightX'])
		lonMin = Math.min(jsonCreateSimulation['step1ROI']['topLeftX'], jsonCreateSimulation['step1ROI']['bottomRightX'])
		$('#div-step6Run #accordion2 #roiExtent').text('Lat max: '+latMax+'; Lon max: '+lonMax+'; Lat min: '+latMin+'; Lon min: '+lonMin)
		//step2
		//optInput1 - sentinel 2
		//optInput2 - pleiades
		//optInput3 - drone
		//optInput4 - terra sar
		//optInput5 - sentinel 1		
		chosenOptInput = jsonCreateSimulation['step2Inputs']['optInput']
		inputImageType = ''
		if (chosenOptInput == 'optInput1'){
			inputImageType += 'Sentinel 2 '	
			procLevels = []
			sls = jsonCreateSimulation['step2Inputs']['optSentinelLevels']
			for (var x=0; x<sls.length; x++){
				if(sls[x] == 'Level-1C'){ procLevels.push('Level-1C') }
				else if(sls[x] == 'Level-2A'){ procLevels.push('Level-2A') }
			}	
			inputImageType += procLevels.toString()
			if (jsonCreateSimulation['step2Inputs']['filter-cloud-cov-l2']){
				inputImageType += ' with cloud coverage of '+jsonCreateSimulation['step2Inputs']['optSentinel2-cloud-cov']+'%'
			}
			if(jsonCreateSimulation['step2Inputs']['conversion-l1-l2']){
				inputImageType += ', with atmospheric correction'
			}
		}
		else if (chosenOptInput == 'optInput2'){
			inputImageType += 'Pleiades'
		}
		else if (chosenOptInput == 'optInput3'){
			inputImageType += 'Drone'
		}
		else if (chosenOptInput == 'optInput4'){
			inputImageType += 'TerraSAR-X'
		}
		else if (chosenOptInput == 'optInput5'){
			procLevels = []
			inputImageType += 'Sentinel 1 '
			sls = jsonCreateSimulation['step2Inputs']['optSentinelLevels']
			for (var x=0; x<sls.length; x++){
				if(sls[x] == 'optSentinel1-PT-GRD'){ procLevels.push('GRD') }
				else if(sls[x] == 'optSentinel1-SM-IW'){ procLevels.push('IW') }
				else if(sls[x]== 'optSentinel1-SM-SM'){ procLevels.push('SM') }
			}			
			inputImageType += procLevels.toString()
		}
		inputImageType += ''
		$('#div-step6Run #accordion2 #inputImageType').text(inputImageType)
		$('#div-step6Run #accordion2 #inputMonitoringPeriod').text(jsonCreateSimulation['step2Inputs']['beginDate']+' - '+jsonCreateSimulation['step2Inputs']['endDate'])
		//step 3
		$('#div-step6Run #accordion2 #inputRevisionList').empty()
		isets = jsonCreateSimulation['step3InputsRevision']['listOfImagesets']
		for (var x=0; x<isets.length; x++){
			$('#div-step6Run #accordion2 #inputRevisionList').append("<tr><td>"+isets[x]['small_name']+"</td></tr>")
		}
		//step 4
		txtWI = []
		arrWI = jsonCreateSimulation['step4Detection']['waterindex'].split(',')
		arrWIThr = jsonCreateSimulation['step4Detection']['wi-threshold'].split(',')
		$.each(arrWI, function(x,y){
			{% if request.path == home_waterleak %}
			txtWI.push(y.toUpperCase())
			{% else %}
			txtWI.push(y.toUpperCase()+" (w/ Threshold "+arrWIThr[x]+")")
			{% endif %}
		})
		$('#div-step6Run #accordion2 #detectionWaterIdx').text(txtWI.toString())
		//$('#div-step6Run #accordion2 #detectionWaterIdx').text(jsonCreateSimulation['step4Detection']['waterindex'].toUpperCase())
		//$('#div-step6Run #accordion2 #detectionWIThreshold').text(jsonCreateSimulation['step4Detection']['wi-threshold'])
		/*$('#div-step6Run #accordion2 #detectionKmeans').text(jsonCreateSimulation['step4Detection']['kmeans-clusters'])
		$('#div-step6Run #accordion2 #detectionTopoValue').text(jsonCreateSimulation['step4Detection']['topography-depth'])
		$('#div-step6Run #accordion2 #detectionBathValue').text(jsonCreateSimulation['step4Detection']['bathymetry-depth'])*/
		//step 5
		/*if (jsonCreateSimulation['step5OCConnection']['step5OCConnection-enable'] !== undefined){
			if (jsonCreateSimulation['step5OCConnection']['step5OCConnection-enable'] ){
				if(jsonCreateSimulation['step5OCConnection']['optOCConfig'] == 'optOCConfig1'){
					$('#div-step6Run #accordion2 #ocConfig').text('Yes. Automatic fetch adequate deployment')
				}
				else{
					$('#div-step6Run #accordion2 #ocConfig').text('Yes. Get from deployment ID '+jsonCreateSimulation['step5OCConnection']['oc-deployment-id'])
				}
			}
			else{
				$('#div-step6Run #accordion2 #ocConfig').text('No.')
			}
		}
		else{
			$('#div-step6Run #accordion2 #ocConfig').text('Yes. Automatic fetch adequate deployment')
		}*/
	}

	function _urlListOfImagesets2(roi_id, bd, ed, optInput){
		_url = '/portal/data/esa_imagery.json?'
		//roi_id = jsonCreateSimulation['step1ROI']['selectROI']		
		map.getLayers().forEach(function(el) {
			console.log(el.get('name'))
		    if(el.get('name') == SERVICE_NAME+'-'+roi_id){
		    	extent3857 = el.getSource().getExtent()
		        extent4326S = (ol.proj.transform([extent3857[0],extent3857[1]], 'EPSG:3857', 'EPSG:4326'))
		        extent4326F = (ol.proj.transform([extent3857[2],extent3857[3]], 'EPSG:3857', 'EPSG:4326'))
		    }
		})		
		//bd = jsonCreateSimulation['step2Inputs']['beginDate']
		//ed = jsonCreateSimulation['step2Inputs']['endDate']
		//optInput = 'optInput1'
		cc = 100
		_url += 'beginDate='+bd+'&endDate='+ed
		_url += '&lX='+extent4326S[0]+'&lY='+extent4326S[1]
		_url += '&uX='+extent4326F[0]+'&uY='+extent4326F[1]
		_url += '&cloudCoverage='+cc
		if (optInput == 'optInput1'){//Sentinel 2
			platformname = 'Sentinel-2'
			optSentinel2 = ['optSentinel2-L1C', 'optSentinel2-L2A']
			for (var x=0; x<optSentinel2.length; x++){
				if(optSentinel2[x] == 'optSentinel2-L1C'){ optSentinel2[x] = 'Level-1C' }
				else if(optSentinel2[x] == 'optSentinel2-L2A'){ optSentinel2[x] = 'Level-2A' }
			}
			_url += '&platformname='+platformname+'&processinglevel='+optSentinel2.toString()
		}
		else if(optInput == 'optInput5'){
			platformname = 'Sentinel-1'
			producttype = []
			sensormode = []
			optSentinel1 = ['optSentinel1-PT-GRD', 'optSentinel1-SM-IW', 'optSentinel1-SM-SM']
			for (var x=0; x<optSentinel1.length; x++){
				if(optSentinel1[x] == 'optSentinel1-PT-GRD'){ producttype.push('GRD') }
				else if(optSentinel1[x] == 'optSentinel1-SM-IW'){ sensormode.push('IW') }
				else if(optSentinel1[x] == 'optSentinel1-SM-SM'){ sensormode.push('SM') }
			}
			_url += '&platformname='+platformname+'&producttype='+producttype.toString()+'&sensoroperationalmode='+sensormode.toString()
		}
		return _url
	}

	function _urlListOfImagesets(jsonCreateSimulation){
		_url = '/portal/data/esa_imagery.json?'
		roi_id = jsonCreateSimulation['step1ROI']['selectROI']		
		map.getLayers().forEach(function(el) {
		    if(el.get('name') == SERVICE_NAME+'-'+roi_id){
		    	extent3857 = el.getSource().getExtent()
		        extent4326S = (ol.proj.transform([extent3857[0],extent3857[1]], 'EPSG:3857', 'EPSG:4326'))
		        extent4326F = (ol.proj.transform([extent3857[2],extent3857[3]], 'EPSG:3857', 'EPSG:4326'))
		    }
		})		
		bd = jsonCreateSimulation['step2Inputs']['beginDate']
		ed = jsonCreateSimulation['step2Inputs']['endDate']
		optInput = jsonCreateSimulation['step2Inputs']['optInput'] //optInput1		
		{% if request.path == home_waterleak %}	
		/*if water leak*/
		/*if (optInput=='optInput1'){//sentinel
			bd = custom_date[0]
			ed = custom_date[1]			
		}*/
		{% endif %}
		if(jsonCreateSimulation['step2Inputs']['filter-cloud-cov-l2'] !== undefined){
			if(jsonCreateSimulation['step2Inputs']['filter-cloud-cov-l2']){ cc = jsonCreateSimulation['step2Inputs']['optSentinel2-cloud-cov'] }
			else{ cc = 100 }
		}
		else{ cc = jsonCreateSimulation['step2Inputs']['optSentinel2-cloud-cov'] }
		_url += 'beginDate='+bd+'&endDate='+ed
		_url += '&lX='+extent4326S[0]+'&lY='+extent4326S[1]
		_url += '&uX='+extent4326F[0]+'&uY='+extent4326F[1]
		_url += '&cloudCoverage='+cc
		if (optInput == 'optInput1'){//Sentinel 2
			platformname = 'Sentinel-2'
			optSentinel2 = jsonCreateSimulation['step2Inputs']['optSentinelLevels'] //[optSentinel2-L1C, optSentinel2-L2A]
			for (var x=0; x<optSentinel2.length; x++){
				if(optSentinel2[x] == 'optSentinel2-L1C'){ optSentinel2[x] = 'Level-1C' }
				else if(optSentinel2[x] == 'optSentinel2-L2A'){ optSentinel2[x] = 'Level-2A' }
			}
			_url += '&platformname='+platformname+'&processinglevel='+optSentinel2.toString()
		}
		else if(optInput == 'optInput5'){
			platformname = 'Sentinel-1'
			producttype = []
			sensormode = []
			optSentinel1 = jsonCreateSimulation['step2Inputs']['optSentinelLevels'] //[optSentinel1-PT-GRD, optSentinel1-SM-IW, optSentinel1-SM-SM]
			for (var x=0; x<optSentinel1.length; x++){
				if(optSentinel1[x] == 'optSentinel1-PT-GRD'){ producttype.push('GRD') }
				else if(optSentinel1[x] == 'optSentinel1-SM-IW'){ sensormode.push('IW') }
				else if(optSentinel1[x] == 'optSentinel1-SM-SM'){ sensormode.push('SM') }
			}
			_url += '&platformname='+platformname+'&producttype='+producttype.toString()+'&sensoroperationalmode='+sensormode.toString()
		}
		return _url
	}

	function loadListOfUserImagesets(){
		$('#listOfImagesets').empty()
		roi_id = jsonCreateSimulation['step1ROI']['selectROI'].split('_')[1]
		buildDynamicModalPopup('Loading list...', 
			'<p>Searching imagesets uploaded by user, compatible with ROI. Please wait...</p>', 
			[], [250,220])
		_url = '/portal/proxy/intermediate/user_repository/coastal/imagesets?roi_id='+roi_id
		console.log(_url)					
		$.ajax({ type: "GET", url: _url, async: true,
			success : function(response){
				dm.dialog("close")
				listOfImagery2 = $.parseJSON(JSON.stringify(response));
				listOfImagery = listOfImagery2['imagesets']
				if (listOfImagery.length==0){
					dm.dialog("close")
					buildDynamicModalPopup('Warning', 
						'<p>Search did not retrieve any user uploaded imagesets. You need to upload them.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				for (var image=0; image<listOfImagery.length; image++){
					custom_processinglevel_name = listOfImagery[image]['name']
					$('#listOfImagesets').append(
						"<tr id=imageset-"+listOfImagery[image]['uuid']+">"+
							"<td style='padding-top:2px'>"+
								"<input style='margin-top:-10px;margin-right:20px;{% if request.path == home_waterleak %}display:none{% endif %}' class='form-check-input custom-checkbox' type='checkbox' id='"+listOfImagery[image]['uuid']+"' "+(listOfImagery[image]['compatible']?"":"disabled")+"></input>"+
							"</td>"+
							"<th style='padding-left:5px'>"+
								"<p id="+listOfImagery[image]['uuid']+"_level>"+custom_processinglevel_name+"</p>"+
								"<p style='font-size:10pt;' id="+listOfImagery[image]['uuid']+"_tilenumber>"+listOfImagery[image]['tilenumber']+"</p>"+
								"<p style='font-size:10pt; margin: -7px 0px 0 0;' id="+listOfImagery[image]['uuid']+"_uuid>"+listOfImagery[image]['uuid']+"</p>"+
								"<p style='display:none' id="+listOfImagery[image]['uuid']+"_name>"+listOfImagery[image]['name']+"</p>"+
								"<p style='font-size:10pt;' id="+listOfImagery[image]['uuid']+"_bands>"+
									("R:"+listOfImagery[image]['image_arguments']['redband'])+" | "+
									("G:"+listOfImagery[image]['image_arguments']['greenband'])+" | "+
									("B:"+listOfImagery[image]['image_arguments']['blueband'])+" | "+
									("NIR:"+listOfImagery[image]['image_arguments']['nirband'])+
								"</p>"+
								"<p id="+listOfImagery[image]['uuid']+"_compatible>"+(listOfImagery[image]['compatible']? 'Compatible ':'Not compatible ')+"with ROI</p>"+
							"</th>"+
							"<th>"+
								"<p id="+listOfImagery[image]['uuid']+"_date>"+listOfImagery[image]['date'].split('.')[0]+"</p>"+
								"<p style='display:none' id="+listOfImagery[image]['uuid']+"_extent>"+listOfImagery[image]['extent']+"</p>"+
								"<a onclick=onClickUserRepositoryImagesetCustom('params-edit',"+listOfImagery[image]['id']+")><img height=24px src='/static/images/edit.svg' title='Edit Uploaded Imageset' style='margin:3px'/></a>"+
								"<a onclick=onClickUserRepositoryImagesetCustom('delete',"+listOfImagery[image]['id']+")><img height=24px src='/static/images/delete.svg' title='Delete Uploaded Imageset' style='margin:3px'/></a>"+
							"</th>"+
							"<th><img height=110px id="+listOfImagery[image]['uuid']+"_image src='/static/images/load.gif' onclick='onClickThumbnail(\""+listOfImagery[image]['uuid']+"\",\""+listOfImagery[image]['bbox']+"\")'></img></th>"+
						"</tr>")
				}
				for (var image=0; image<listOfImagery.length; image++){
					$.ajax({ type: "GET", url: "/portal/proxy/intermediate/user_repository/coastal/imagesets/"+listOfImagery[image]['id']+"/show_thumbnail", async: true,
						success : function(response){
							if (response['alert']=='success'){$("#"+response['uuid']+"_image").attr('src', "data: image/png; base64, "+response['encodedImage'])}
							else{$("#"+response['uuid']+"_image").attr('src', '/static/images/logo.png')}
						},
						error: function(response){
							$("#"+response['uuid']+"_image").attr('src', '/static/images/logo.png')
						}
					});
				}
				//check if there is a previous list of chosen imagesets
				isets = jsonCreateSimulation[curr_step]['listOfImagesets']
				for (var x=0; x<isets.length; x++){
					$('#div-'+curr_step+' #accordion1 #listOfImagesets tr input[type="checkbox"][id="'+isets[x]['uuid']+'"]').prop('checked',true)//check
				}
	
			},
			error: function(response){
				dm.dialog("close")
				buildDynamicModalPopup('Error', 
					'<p>Could not load user uploaded imagesets.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				/*$('#listOfImagesets').empty()
				$('#message').css('color','#bb0000')
				$('#message').text('Error: Could not load imagesets from ESA Copernicus')*/
			}
		});
	}

	function loadListOfImagesets(){
		$('#listOfImagesets').empty()
		console.log('abort any remaining esa request')
		window.stop()
		buildDynamicModalPopup('Loading list...', 
			'<p>Searching imagesets from ESA Copernicus. Please wait...</p>', 
			[], [250,220])
		_url = _urlListOfImagesets(jsonCreateSimulation)
		console.log(_url)
		console.log('Cooldown 3s to not stress ESA servers...')
		setTimeout(function(){
			console.log('ESA search!')
			$.ajax({ type: "GET", url: _url, async: true,
				success : function(response){
					dm.dialog("close")
					listOfImagery = $.parseJSON(JSON.stringify(response));
					if (listOfImagery.length==0){
						dm.dialog("close")
						buildDynamicModalPopup('Error', 
							'<p>Search did not retrieve any imagesets. Go back and verify Input parameters.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					for (var image in listOfImagery){
						if(['Level-2A','Level-1C'].indexOf(listOfImagery[image]['processinglevel'])>-1){
							custom_processinglevel_name =  'Sentinel-2 '+listOfImagery[image]['processinglevel']+' ('+listOfImagery[image]['tilenumber']+')'
						}
						else{
							custom_processinglevel_name = listOfImagery[image]['processinglevel']
						}
						
						$('#listOfImagesets').append(
							"<tr id=imageset-"+listOfImagery[image]['uuid']+">"+
								"<td style='padding-top:2px'>"+
									"<input style='margin-top:-10px;margin-right:20px;{% if request.path == home_waterleak %}display:none{% endif %}' class='form-check-input custom-checkbox' type='checkbox' id='"+listOfImagery[image]['uuid']+"'></input>"+
								"</td>"+
								"<th style='padding-left:5px'>"+
									"<p id="+listOfImagery[image]['uuid']+"_level>"+custom_processinglevel_name+"</p>"+
									"<p style='font-size:10pt;' id="+listOfImagery[image]['uuid']+"_tilenumber>"+listOfImagery[image]['tilenumber']+"</p>"+
									"<p style='font-size:10pt; margin: -7px 0px 0 0;' id="+listOfImagery[image]['uuid']+"_uuid>"+listOfImagery[image]['uuid']+"</p>"+
									"<p style='display:none' id="+listOfImagery[image]['uuid']+"_name>"+listOfImagery[image]['name']+"</p>"+
								"</th>"+
								"<th>"+
									"<p id="+listOfImagery[image]['uuid']+"_date>"+listOfImagery[image]['date'].split('.')[0]+"</p>"+
									"<p style='display:none' id="+listOfImagery[image]['uuid']+"_extent>"+listOfImagery[image]['extent']+"</p>"+
								"</th>"+
								"<th><img height=110px src='/portal/data/thumbnail/"+listOfImagery[image]['uuid']+"/show' onclick='onClickThumbnail(\""+listOfImagery[image]['uuid']+"\",\""+listOfImagery[image]['bbox']+"\")'></img></th>"+
							"</tr>")
					}
					//check if there is a previous list of chosen imagesets
					isets = jsonCreateSimulation[curr_step]['listOfImagesets']
					for (var x=0; x<isets.length; x++){
						$('#div-'+curr_step+' #accordion1 #listOfImagesets tr input[type="checkbox"][id="'+isets[x]['uuid']+'"]').prop('checked',true)//check
					}
		
				},
				error: function(response){
					dm.dialog("close")
					buildDynamicModalPopup('Error', 
						'<p>Could not load imagesets from ESA Copernicus.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					/*$('#listOfImagesets').empty()
					$('#message').css('color','#bb0000')
					$('#message').text('Error: Could not load imagesets from ESA Copernicus')*/
				}
			});
		},3000)
	}
	function onClickThumbnail(uuid, wkt){
		$('#listOfImagesets tr th.chosenImageset').removeClass('chosenImageset')
		removeThumbnail()
		$('#listOfImagesets #imageset-'+uuid+' th').addClass('chosenImageset')
		addThumbnail(uuid, wkt)
	}
	function addThumbnail(uuid, wkt){
		//console.log(wkt)
		dP = 'EPSG:4326'
		if (wkt.indexOf('SRID')>-1){
			wkt_split = wkt.split(';')
			dP = wkt_split[0].replace('SRID=','EPSG:')
			wkt = wkt_split[1]
		}
		thumbnailsourceLayerRoi = new ol.source.Vector({
 			features: (new ol.format.WKT()).readFeatures(wkt, { dataProjection: dP, featureProjection: 'EPSG:3857' })
 		});
		thumbnailsourceLayer = new ol.layer.Vector({
			name: uuid,
			source: thumbnailsourceLayerRoi,
			//zIndex: 20,
			style: new ol.style.Style({	        
		        stroke: new ol.style.Stroke({ color: "#1fbbd9", width: 3 }),
		        fill: new ol.style.Fill({ color: "#1fbbd955" })
		        /*text: new ol.style.Text({ text: listOfShapelines['simulation_name'], stroke: new ol.style.Stroke({ color: '#99bb00', width: 3 }) })*/
		    })
		})

		thumbnailsourceLayer.setZIndex(2)
		map.addLayer(thumbnailsourceLayer)
	}
	function removeThumbnail(){
		if (thumbnailsourceLayer != null){
			map.removeLayer(thumbnailsourceLayer)
		}
	}

	function onClickEyedropper(){
		if (EYEDROPPER_CLICK_MODE){
			disableEyedropperClickMode()
		}
		else{
			enableEyedropperClickMode()
		}
	}

	function onClickMeasure(){
		if(MEASURE_MODE){
			disableMeasureMode()
		}
		else{
			enableMeasureMode()
		}
	}

	function onClickPlotSeaTide(){
		if(PLOT_SEA_TIDE_MODE){
			disablePlotSTMode()
		}
		else{
			enablePlotSTMode()
		}
	}

	


	function showVisualization(showWhat=null){
		if (LEFT_PANEL_MODE != null){
			if(LEFT_PANEL_MODE=='waterleak-create-leak-detection'){_placeholder='creating a new leak'}
			else if(LEFT_PANEL_MODE=='waterleak-edit-leak-detection'){_placeholder='editing a leak'}
			else if(LEFT_PANEL_MODE=='edit'){_placeholder='editing an existing simulation'}
			else{_placeholder='creating a new simulation'}
			if(LEFT_PANEL_MODE=='waterleak-edit-leak-detection' && curr_step == 'step4LeakDetection' && showWhat=='showLeakDetections'){
				//_showVisualization(showWhat)
				//$('.close').toggleClass('closed');
			}
			else{				
				buildDynamicModalPopup('Warning!', 
					'<p>You are '+_placeholder+'. Closing this will lose any changes you have done on the workflow. Continue?</p>', 
					[['Yes', function(){ 
						$(this).dialog( "close" )
						//_showPopupWarningClickYes()
						_showVisualization(showWhat)
						$('.close').toggleClass('closed');
					}],
					['No', function(){
						//cleanupLeftPanel() 
						$(this).dialog( "close" )
						//$('.close').toggleClass('closed');
					}]], [300,220])
			}
		}
		else{
			if(EDIT_LEAK_POINTS_MODE || DELETE_LEAK_POINTS_MODE){
				//if edit or delete
				buildDynamicModalPopup('Error!', 
					'<p>This option is disabled. Please leave the edit/delete leak points mode.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
			else{
				_showVisualization(showWhat)
				$('.close').toggleClass('closed');
			}
		}
	}
	function _showVisualization(showWhat=null){
		//if(RIGHT_PANEL_MODE != 'SHOW_VISUALIZATION' || RIGHT_PANEL_MODE != 'SHOW_LEAK_DETECTIONS'){
			if (showWhat == "showLeakDetections"){ NEW_RIGHT_PANEL_MODE = 'SHOW_LEAK_DETECTIONS' }
			else{ NEW_RIGHT_PANEL_MODE = 'SHOW_VISUALIZATION' }
			if (NEW_RIGHT_PANEL_MODE != RIGHT_PANEL_MODE){
				RIGHT_PANEL_MODE = NEW_RIGHT_PANEL_MODE
				_clear_interval_list_simulations()
				_clear_interval_list_user_repository_files()
				_clear_interval_leak_detection_details()
				cleanupLeftPanel()
				closeLeftPanel()
				//if (LEFT_PANEL_MODE == 'create'){  
				createFreshBlobJsonSimulation()
				//
				$('#step-ph1').removeClass('current')
				$('#step-ph1-workflow').hide()
				//
				{% if request.path == home_waterleak %}
				$('#step-ph2').removeClass('current')
				$('#step1ImageSelection').removeClass('current')
				$('#step3LeakDetection').removeClass('current')
				$('#step4LeakDetection').removeClass('current')
				$('#step-ph2-workflow').hide()
				{% endif %}
				restartStep('step1ROI')
				restartStep('step2Inputs')
				restartStep('step3InputsRevision')
				restartStep('step4Detection')
				//{% if request.path == home_coastal %}
				//restartStep('step5OCConnection')
				//{% endif %}
				restartStep('step6Run')
				
				$('#listOfSimulations tr td table tr td table tr th table tr td input[type="checkbox"]:checked').prop('checked',false)
				$('#listOfSimulations tr td table tr td table tr th table tr th input[type="checkbox"]').prop('checked',true)
				$('#listOfSimulations tr td table tr td table tr th table tr th input[type="checkbox"]').prop('disabled', true)
				$('#listOfUserRepository tr td table tr td table tr td table tr td input[type="checkbox"]:checked').prop('checked',false)
				$('#'+curr_step).removeClass('done').removeClass('current')
				$('#step1ROI').removeClass('done').addClass('current')
				$('#step0DetectionSelection').removeClass('done').addClass('current')
				curr_step = 'step1ROI'
				//}
				if (LEFT_PANEL_MODE != null){ 
					LEFT_PANEL_MODE = null
					EDIT_SIMULATION_ID = null
					EDIT_LEAK_DETECTION_ID = null
				//	WATERLEAK_SIMULATION_EXISTS = false
				}
				cleanupRightPanel()
				removeThumbnail()
				//loadRegionsOfInterest()	
				
				_showAllROI()	
				reverseRemoveLayerIndexOf('ld')	
				highlightSelectedROI4($('#showVisualizationAndDetectionManager #accordion1 #listOfROI input[name="optROIshowVisualizationAndDetectionManager"]:checked').prop('id'))
				$('#showUserRepository').hide()
				$('#listOfUserFile tr td table tr td table tr td input[type="checkbox"]:checked').prop('checked',false)
				$('#showVisualizationAndDetectionManager').show()		
				openRightPanel()
				showRightPanelOptions()
				$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations').empty()
				//_start_interval_list_simulations(showWhat)
				getListOfSimulations(showWhat)			
				if (RIGHT_PANEL_MODE == 'SHOW_LEAK_DETECTIONS'){ 
					$('#new-info-eyedrop').hide(); 
					$('#new-info-show-open-layers').hide();
					$('#new-info-show-ruler').hide()
					$('#new-info-plot-sea-tide').hide()
					//$('#new-info-preview-pipe').hide()
					disableEyedropperClickMode()
				}
				else{ 
					$('#new-info-eyedrop').show(); 
					$('#new-info-show-open-layers').show() 
					$('#new-info-show-ruler').show()
					$('#new-info-preview-pipe').show()
					$('#new-info-plot-sea-tide').show()
				}
				{% if request.path == home_waterleak %}
				map.getLayers().forEach(function(el) {
					if (el.get('name') !== undefined){ 
						if(el.get('name').indexOf('preview_pipe')>-1){
							el.setVisible(true)
							el.getStyle().setStroke(new ol.style.Stroke({ 
								color: el.getStyle().getStroke().getColor(), width: 2 }) )
							el.changed()		    
						}
					}
				})
				{% endif %}
			}
		//}	
	}

	function showUserRepository(){
		if(!EDIT_LEAK_POINTS_MODE){
			if (LEFT_PANEL_MODE != null){
				if(LEFT_PANEL_MODE=='waterleak-create-leak-detection'){_placeholder='creating a new leak'}
				else if(LEFT_PANEL_MODE=='waterleak-edit-leak-detection'){_placeholder='editing a leak'}
				else if(LEFT_PANEL_MODE=='edit'){_placeholder='editing an existing simulation'}
				else{_placeholder='creating a new simulation'}	
				buildDynamicModalPopup('Warning!', 
					'<p>You are '+_placeholder+'. Closing this will lose any changes you have done on the workflow. Continue?</p>', 
					[['Yes', function(){ 
						$(this).dialog( "close" )
						//_showPopupWarningClickYes()
						_showUserRepository()
						$('.close').toggleClass('closed');
					}],
					['No', function(){
						//cleanupLeftPanel() 
						$(this).dialog( "close" )
						//$('.close').toggleClass('closed');
					}]], [300,220])
			}
			else{
				_showUserRepository()
			}
		}
		else{
			buildDynamicModalPopup('Error!', 
				'<p>This option is disabled. Please leave the edit leak points mode.</p>', 
				[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
		}
	}
	function _showUserRepository(){
		if(RIGHT_PANEL_MODE != 'SHOW_USER_REPOSITORY'){				
			RIGHT_PANEL_MODE = 'SHOW_USER_REPOSITORY'
			_clear_interval_list_simulations()
			_clear_interval_leak_detection_details()
			cleanupLeftPanel()
			closeLeftPanel()
			//if (LEFT_PANEL_MODE == 'create'){  
			createFreshBlobJsonSimulation()
			//
			$('#step-ph1').removeClass('current')
			$('#step-ph1-workflow').hide()
			//
			{% if request.path == home_waterleak %}
			$('#step-ph2').removeClass('current')
			$('#step1ImageSelection').removeClass('current')
			$('#step3LeakDetection').removeClass('current')
			$('#step4LeakDetection').removeClass('current')
			$('#step-ph2-workflow').hide()
			{% endif %}
			restartStep('step1ROI')
			restartStep('step2Inputs')
			restartStep('step3InputsRevision')
			restartStep('step4Detection')
			//{% if request.path == home_coastal %}
			//restartStep('step5OCConnection')
			//{% endif %}
			restartStep('step6Run')
			$('#listOfSimulations tr td table tr td table tr th table tr td input[type="checkbox"]:checked').prop('checked',false)
			$('#listOfSimulations tr td table tr td table tr th table tr th input[type="checkbox"]').prop('checked',true)
			$('#listOfSimulations tr td table tr td table tr th table tr th input[type="checkbox"]').prop('disabled', true)
			$('#listOfUserRepository tr td table tr td table tr td table tr td input[type="checkbox"]:checked').prop('checked',false)
			$('#'+curr_step).removeClass('done').removeClass('current')
			$('#step1ROI').removeClass('done').addClass('current')
			$('#step0DetectionSelection').removeClass('done').addClass('current')
			curr_step = 'step1ROI'
			//}
			if (LEFT_PANEL_MODE != null){ 
				LEFT_PANEL_MODE = null
				EDIT_SIMULATION_ID = null
				EDIT_LEAK_DETECTION_ID = null
			//	WATERLEAK_SIMULATION_EXISTS = false
			}
			cleanupRightPanel()
			removeThumbnail()
			//loadRegionsOfInterest()
			//getListOfSimulations()
			//updateListOfUserRepositoryFiles()
			_clear_interval_list_user_repository_files()
			_start_interval_list_user_repository_files()
			_clear_interval_leak_detection_details()
			_showAllROI()
			//highlightSelectedROI3($('#showVisualizationAndDetectionManager #accordion1 #listOfROI input[name="optROIshowVisualizationAndDetectionManager"]:checked').prop('id'))
			$('#showVisualizationAndDetectionManager').hide()
			$('#showUserRepository').show()
			$('#listOfUserFile tr td table tr td table tr td input[type="checkbox"]:checked').prop('checked',false)
			openRightPanel()
			showRightPanelOptions()
			//_start_interval_list_simulations()
			//EYEDROPPER_CLICK_MODE = false
			disableEyedropperClickMode()
			$('#new-info-eyedrop').hide()
			$('#new-info-show-open-layers').hide()
			$('#new-info-show-ruler').hide()
			disableEyedropperClickMode()
			$('#new-info-preview-pipe').hide()
			$('#new-info-plot-sea-tide').hide()
		}
		
	}

	function isOptCreate(){
		return $('#div-step1ROI #accordion2 #selectROI').val() == 'roi_create'
	}
	function isOptCreateDrawRectangle(){
		return $('#div-step1ROI input[name="optCreateFrom"]:checked').prop('id') == 'optCreateFrom1'
	}
	function isOptCreateUploadFile(){
		return $('#div-step1ROI input[name="optCreateFrom"]:checked').prop('id') == 'optCreateFrom2'
	}
	
	function disableSubaccordion(condition, full_div_id){
		if (condition){ $(full_div_id).addClass('disabled') }
		else{ $(full_div_id).removeClass('disabled') }
	}
	/**LEFT PANEL**/
	/*Select ROI*/
	function optionsStep1ROI(){
		disableDrawPolygonMode()
		disableMeasureMode()
		//chosenOpt = $('#div-step1ROI input[name="optAction"]:checked').prop('id')
		chosenOptCreateFrom = $('#div-step1ROI input[name="optCreateFrom"]:checked').prop('id')
		//console.log(step1chosenOpt)
		console.log(chosenOptCreateFrom)
		$('#div-step1ROI #accordion1 #roiName').prop('disabled', !isOptCreate())
		$('#div-step1ROI #accordion1 #optCreateFrom1').prop('disabled', !isOptCreate())
		$('#div-step1ROI #accordion1 #iconDrawPolygon').prop('disabled', !isOptCreate() || !isOptCreateDrawRectangle())
		$('#div-step1ROI #accordion1 #optCreateFrom2').prop('disabled', !isOptCreate())
		$('#div-step1ROI #accordion1 #divuploadfile #fileupload').prop('disabled', !isOptCreate() || !isOptCreateUploadFile())
		if(!isOptCreate() || !isOptCreateUploadFile()){		
			$('#div-step1ROI #accordion1 #divuploadfile .progress-bar').css( 'background', '#2CC0DE')
			$('#div-step1ROI #accordion1 #divuploadfile .progress-bar').css('width', '0%')
			$('#div-step1ROI #accordion1 #divuploadfile #fileupload').val('')
		}
		//$('#div-step1ROI #accordion1 #optCreateFrom3').prop('disabled', isOptCreate())
		disableSubaccordion((chosenOptCreateFrom != 'optCreateFrom3'), '#div-step1ROI #accordion1 #roiCoords')
		/*if (chosenOptCreateFrom != 'optCreateFrom3'){ $('#div-step1ROI #accordion1 #roiCoords').addClass('disabled') }
		else{ $('#div-step1ROI #accordion1 #roiCoords').removeClass('disabled') }*/
		$('#div-step1ROI #accordion1 #topLeftX').prop('disabled', !isOptCreate() || chosenOptCreateFrom != 'optCreateFrom3')
		$('#div-step1ROI #accordion1 #topLeftY').prop('disabled', !isOptCreate() || chosenOptCreateFrom != 'optCreateFrom3')
		$('#div-step1ROI #accordion1 #bottomRightX').prop('disabled', !isOptCreate() || chosenOptCreateFrom != 'optCreateFrom3')
		$('#div-step1ROI #accordion1 #bottomRightY').prop('disabled', !isOptCreate() || chosenOptCreateFrom != 'optCreateFrom3')
		
		if (isOptCreate()){
			resetSelectedROI()
			_hideAllROI()
			$('#div-step1ROI #accordion1 #topLeftX').val('')
			$('#div-step1ROI #accordion1 #topLeftY').val('')
			$('#div-step1ROI #accordion1 #bottomRightX').val('')
			$('#div-step1ROI #accordion1 #bottomRightY').val('')
			if (drawUploadedROI != null){
				map.removeLayer(drawUploadedROI)
				drawUploadedROI = null
			}
			if (isOptCreateDrawRectangle()){
				//enableDrawPolygonMode()
			}
			else{				
				if (isOptCreateUploadFile()){
					
				}
			}
		}
		else {
			$('#div-step1ROI #accordion1 #roiName').val('')
			$('#div-step1ROI #accordion1 #topLeftX').val('')
			$('#div-step1ROI #accordion1 #topLeftY').val('')
			$('#div-step1ROI #accordion1 #bottomRightX').val('')
			$('#div-step1ROI #accordion1 #bottomRightY').val('')
			_showAllROI()
			highlightSelectedROI3($('#div-step1ROI #accordion2 #selectROI').val())
		}
	}

	function onClickSelectAll(){
		if (curr_step == 'step3InputsRevision'){
			imgsets_tr = $('#div-'+curr_step+' #accordion1 #listOfImagesets tr')
			if(imgsets_tr.length>0){
				for (var i=0; i<imgsets_tr.length; i++){
					console.log(imgsets_tr[i].id)
					if (!$('#'+imgsets_tr[i].id+' td input[type="checkbox"]').prop('disabled')){//if not disabled
						$('#'+imgsets_tr[i].id+' td input[type="checkbox"]').prop('checked',true)
					}
				}
			}
		}
	}
	function onClickDeselectAll(){
		if (curr_step == 'step3InputsRevision'){
			imgsets_tr = $('#div-'+curr_step+' #accordion1 #listOfImagesets tr')
			if(imgsets_tr.length>0){
				for (var i=0; i<imgsets_tr.length; i++){
					console.log(imgsets_tr[i].id)
					$('#'+imgsets_tr[i].id+' td input[type="checkbox"]').prop('checked',false)
				}
			}
		}
	}
	
	function onClickPrevious(){
		if ($('#leftPanelNextButton #bprev').attr('disabled') != 'disabled'){
			if (curr_step == 'step1ROI'){
			}
			else if (curr_step == 'step2Inputs'){
				goToStep('step1ROI')
			}
			else if (curr_step == 'step3InputsRevision'){
				goToStep('step2Inputs')
			}
			else if (curr_step == 'step4Detection'){
				goToStep('step3InputsRevision')
			}		
			/*else if (curr_step == 'step5OCConnection'){
				goToStep('step4Detection')
			}*/
			else if (curr_step == 'step6Run'){
				{% if request.path == home_waterleak %}
				//WATERLEAK_SIMULATION_EXISTS = false
				//EDIT_SIMULATION_ID = null
				//EDIT_LEAK_DETECTION_ID = null
				goToStep('step3InputsRevision')
				{% else %}
				goToStep('step4Detection')
				{% endif %}
				//{% if request.path == home_coastal %}
				//goToStep('step5OCConnection')
				//{% else %}
				
				//{% endif %}
			}
			//leak detection
			else if (curr_step == 'step0DetectionSelection'){

			}
			else if (curr_step == 'step1ImageSelection'){
				_clear_interval_leak_detection_details()
				goToStepLD('step0DetectionSelection')
			}
			//else if (curr_step == 'step2LeakDetection'){
				//goToStepLD('step1ImageSelection')
			//}
			else if (curr_step == 'step3LeakDetection'){
				if (LEFT_PANEL_MODE == 'waterleak-edit-leak-detection'){//create
					_clear_interval_leak_detection_details()
					goToStepLD('step0DetectionSelection')
					$('#step1ImageSelection').removeClass('current')
					EDIT_LEAK_DETECTION_ID = null
					createFreshBlobJsonLeakDetection()
				}
				else{
					goToStepLD('step1ImageSelection')
				}
				
			}
			else if (curr_step == 'step4LeakDetection'){
				goToStepLD('step3LeakDetection')
			}
		}
	}
	
	function onClickNext(){	
		if ($('#leftPanelNextButton #bnext').attr('disabled') != 'disabled'){
			if (curr_step == 'step1ROI'){
				if(isOptCreate()){
					if($('#div-'+curr_step+' #roiName').val() == ''){
						buildDynamicModalPopup('Error', 
							'<p>You are creating a RoI. Please give it a name.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else if (isOptCreateUploadFile() && $('#div-step1ROI #accordion1 #divuploadfile #fileupload').val() == ''){
						buildDynamicModalPopup('Error', 
							'<p>You need to upload a CSV file!</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else if (
						$('#div-'+curr_step+' #accordion1 #topLeftX').val() == '' && 
						$('#div-'+curr_step+' #accordion1 #topLeftY').val() == '' &&
						$('#div-'+curr_step+' #accordion1 #bottomRightX').val() == '' && 
						$('#div-'+curr_step+' #accordion1 #bottomRightY').val() == ''){
						buildDynamicModalPopup('Error', 
							'<p>You are creating a RoI. No coordinates for the RoI were set.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}				
					else{
						buildDynamicModalPopup('Creating RoI', 
							'<p>Please wait...</p>', [], [250,250])
						jsonR = {}
						jsonR['name'] = $('#div-'+curr_step+' #accordion1 #roiName').val()
						jsonR['service'] = SERVICE_NAME
						jsonR['upperXcoordinate'] = parseFloat($('#div-'+curr_step+' #accordion1 #topLeftX').val())
						jsonR['upperYcoordinate'] = parseFloat($('#div-'+curr_step+' #accordion1 #topLeftY').val())
						jsonR['lowerXcoordinate'] = parseFloat($('#div-'+curr_step+' #accordion1 #bottomRightX').val())
						jsonR['lowerYcoordinate'] = parseFloat($('#div-'+curr_step+' #accordion1 #bottomRightY').val())
						jsonR['color'] = generateRandomHexColor();
						
						$.post('/portal/rois/create', JSON.stringify(jsonR))
							.done(function( data ) {
								var answer = $.parseJSON(JSON.stringify(data)); 
								if(answer['alert']=='created'){
									//console.log(answer)
									dm.dialog( "close" );
									buildDynamicModalPopup('Success!', 
										'<p>Created '+$('#div-'+curr_step+' #roiName').val()+'. Selecting it and moving on to next step.</p>', [], [250,220])
									dm.dialog( "close" );
									
									loadARegionOfInterest(answer)
									$('#div-'+curr_step+' #accordion1 #topLeftX').val('')
									$('#div-'+curr_step+' #accordion1 #topLeftY').val('')
									$('#div-'+curr_step+' #accordion1 #bottomRightX').val('')
									$('#div-'+curr_step+' #accordion1 #bottomRightY').val('')
									$('#div-'+curr_step+' #roiArea').text('--')
									
									$('#div-'+curr_step+' #roiName').val('')
									//$('#div-'+curr_step+' input[name="optAction"][value="optSelect"]').click()
									//step1chosenOpt = 'optSelect'
									optionsStep1ROI()								
									$('#div-'+curr_step+' #accordion2 #selectROI').val('roi_'+answer.roi_id)
									highlightSelectedROI('roi_'+answer.roi_id)
									goToStep('step2Inputs')
								}
								else{
									//console.log(answer)
									dm.dialog( "close" );
									buildDynamicModalPopup('Error', 
										'<p>Something went wrong while creating RoI. Try again.</p>', 
										[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
								}
							})
							.fail(function( xhr, textStatus, errorThrown ){
								console.log( xhr, textStatus, errorThrown)
							})	
					}
				}
				else {
					if($('#div-'+curr_step+' #accordion2 #selectROI option').length==1){//"create a roi above" is only one option
						buildDynamicModalPopup('Error', 
							'<p>You do not have any RoI to select. Please create one!</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else{
						goToStep('step2Inputs')
					}
				}
			}
			else if (curr_step == 'step2Inputs'){
				optInput = $('#div-'+curr_step+' input[name="optInput"]:checked').prop('id')
				bD = $('#div-'+curr_step+' #accordion1 #beginDate').val()
				eD = $('#div-'+curr_step+' #accordion1 #endDate').val()
				isBeginTimeAboveEndTime = (new Date(bD).getTime() > new Date(eD).getTime())				
				if(optInput == 'optInput1'){//Sentinel 2
					//optInputChkbox = $('#div-'+curr_step+' input[name="optSentinel2"]:checked')
					hasNotChosenS2Levels = ($('#div-'+curr_step+' input[name="optSentinel2"]:checked').length==0)
					if(jsonCreateSimulation[curr_step]['filter-cloud-cov-l2'] !== undefined){
						if(jsonCreateSimulation[curr_step]['filter-cloud-cov-l2']){ cc = $('#div-'+curr_step+' #accordion2 #optSentinel2-cloud-cov').val() }
						else{ cc = 100 }
					}
					else{
						cc = $('#div-'+curr_step+' #accordion2 #optSentinel2-cloud-cov').val()
					}
					if(bD == ''){
						buildDynamicModalPopup('Error', 
							'<p>Please provide a valid begin date.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else if(eD == ''){
						buildDynamicModalPopup('Error', 
							'<p>Please provide a valid end date.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else if (isBeginTimeAboveEndTime){
						buildDynamicModalPopup('Error', 
							'<p>Begin date should be before the end date.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else if(hasNotChosenS2Levels){
						buildDynamicModalPopup('Error', 
							'<p>No product levels were chosen on Sentinel 2 option.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else if (!(cc >= 0 && cc <= 100)){
						buildDynamicModalPopup('Error', 
							'<p>Cloud coverage must be between 0 and 100%</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else{
						goToStep('step3InputsRevision')
						
					}
				}
				else if(optInput == 'optInput2'){//Pleiades
					
				}
				else if(optInput == 'optInput3'){//Drone
					goToStep('step3InputsRevision')
				}
				else if(optInput == 'optInput4'){//TerraSAR-X

				}
				else if(optInput == 'optInput5'){//Sentinel 1
					hasNotChosenS1PT = ($('#div-'+curr_step+' input[name="optSentinel1-PT"]:checked').length==0)
					hasNotChosenS1SM = ($('#div-'+curr_step+' input[name="optSentinel1-SM"]:checked').length==0)
					if (isBeginTimeAboveEndTime){
						buildDynamicModalPopup('Error', 
							'<p>Begin date should be before the end date.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else if(hasNotChosenS1PT){
						buildDynamicModalPopup('Error', 
							'<p>No product types were chosen on Sentinel 1 option.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else if(hasNotChosenS1SM){
						buildDynamicModalPopup('Error', 
							'<p>No sensor modes were chosen on Sentinel 1 option.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else{
						goToStep('step3InputsRevision')
					}
				}			
			}
			else if (curr_step == 'step3InputsRevision'){
				{% if request.path == home_waterleak %}
				chosenOpt = $('#div-step3InputsRevision input[name="optInputRevision"]:checked').prop('id')
				console.log(chosenOpt)
				if(chosenOpt == 'optInputRevision1'){
					_url = _urlListOfImagesets(jsonCreateSimulation)
					buildDynamicModalPopup('Loading...', 
						'<p>Checking for imagesets from '+WATERLEAK_SENTINEL2_CUSTOM_BEGINDATE+' until '+WATERLEAK_SENTINEL2_CUSTOM_ENDDATE+'. Please wait...</p>', 
						[], [250,220])
					$.ajax({ type: "GET", url: _url, async: true,
						success : function(response){
							dm.dialog("close")
							listOfImagery = $.parseJSON(JSON.stringify(response));
							if (listOfImagery.length==0){
								buildDynamicModalPopup('Error', 
									'<p>ESA Search did not retrieve any imagesets. Go back and verify Input parameters.</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							}
							else{
								buildDynamicModalPopup('Loading list...', 
									'<p>Imagesets found! Selecting automatically available sentinel inputs. Please wait...</p>', 
									[], [250,220])
								jsonCreateSimulation['step3InputsRevision']['listOfImagesets'] = []
								for (var image in listOfImagery){
									if(['Level-2A','Level-1C'].indexOf(listOfImagery[image]['processinglevel'])>-1){
										custom_processinglevel_name =  'Sentinel-2 '+listOfImagery[image]['processinglevel']+' ('+listOfImagery[image]['tilenumber']+')'
									}
									else{
										custom_processinglevel_name = listOfImagery[image]['processinglevel']
									}
									iextend = listOfImagery[image]['extent']
									jsonCreateSimulation['step3InputsRevision']['listOfImagesets'].push({
										'uuid':listOfImagery[image]['uuid'],
										'name':listOfImagery[image]['name'],
										'small_name':custom_processinglevel_name+' ('+listOfImagery[image]['date'].split('.')[0]+')',
										'date':listOfImagery[image]['date'].split('.')[0],
										'extent':[parseFloat(iextend[0]),parseFloat(iextend[1]),parseFloat(iextend[2]),parseFloat(iextend[3])],
									})	
								}
								dm.dialog("close")
								apply_waterleak_automatic_steps() //set wis and go to step 6
							}
						},
						error: function(response){
							dm.dialog("close")
							buildDynamicModalPopup('Error', 
								'<p>Could not load imagesets from ESA Copernicus.</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						}
					})
				}
				else{
					$('#div-step3InputsRevision #accordion1 #listOfImagesets tr input[type="checkbox"]').each(function(){
						$(this).prop('checked',true)
					})
					hasNotChosenImagesets = ($('#div-'+curr_step+' #accordion1 #listOfImagesets tr input[type="checkbox"]:checked').length==0)
					bD = $('#div-'+curr_step+' #beginDateFilterList').val()
					eD = $('#div-'+curr_step+' #endDateFilterList').val()
					if (bD == ''){
						buildDynamicModalPopup('Error', 
							'<p>Please provide a valid begin date.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else if (eD == ''){
						buildDynamicModalPopup('Error', 
							'<p>Please provide a valid end date.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else if(hasNotChosenImagesets){
						buildDynamicModalPopup('Error', 
							'<p>Please select at least one imageset for processing.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else{
						//step3
						//this checkbox tick is being done on the saveblobsimulation on gotostep('step6run')
						apply_waterleak_automatic_steps() //set wis and go to step 6
					}
				}
				{% else %}
					hasNotChosenImagesets = ($('#div-'+curr_step+' #accordion1 #listOfImagesets tr input[type="checkbox"]:checked').length==0)
					if(hasNotChosenImagesets){
						buildDynamicModalPopup('Error', 
							'<p>Please select at least one imageset for processing.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else{					
						goToStep('step4Detection')
					}
				{% endif %}
				
				
			}
			else if (curr_step == 'step4Detection'){
				waterindex_chkboxs = $('#div-'+curr_step+' #accordion1 #step4Detection-waterindex input[name="waterindex-chkbox"][type="checkbox"]:checked')
				kmeans_clusters = parseInt($('#div-'+curr_step+' #accordion1 #kmeans-clusters').val())
				min_kmeans_clusters = parseInt($('#div-'+curr_step+' #accordion1 #kmeans-clusters').prop('min'))
				max_kmeans_clusters = parseInt($('#div-'+curr_step+' #accordion1 #kmeans-clusters').prop('max'))
				topography_depth = parseInt($('#div-'+curr_step+' #accordion1 #topography-depth').val())
				min_topography_depth = parseInt($('#div-'+curr_step+' #accordion1 #topography-depth').prop('min'))
				bathymetry_depth = parseInt($('#div-'+curr_step+' #accordion1 #bathymetry-depth').val())
				max_bathymetry_depth = parseInt($('#div-'+curr_step+' #accordion1 #bathymetry-depth').prop('max'))
				if(waterindex_chkboxs.length == 0){
					buildDynamicModalPopup('Error', 
						'<p>Please select at least one water index!</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				else if (kmeans_clusters<min_kmeans_clusters || kmeans_clusters>max_kmeans_clusters){
					buildDynamicModalPopup('Error', 
						'<p>KMeans clusters must be between '+min_kmeans_clusters+' and '+max_kmeans_clusters+'</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				
				else if (topography_depth<min_topography_depth){
					buildDynamicModalPopup('Error', 
						'<p>Topography depth must be at least '+min_topography_depth+'</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				
				else if (bathymetry_depth>max_bathymetry_depth){
					buildDynamicModalPopup('Error', 
						'<p>Bathymetry depth must be at least '+max_bathymetry_depth+'</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}

				else{
					are_thresholds_valid = true
					$('#div-step4Detection #accordion1 #step4Detection-waterindex input[name="waterindex-chkbox"][type="checkbox"]:checked').each(function(){
						wi = $(this).prop('id')
						if (!($('#div-step4Detection #accordion1 #step4Detection-waterindex input[name="'+wi+'-threshold-auto-chkbox"]').prop('checked'))){
							wi_threshold = parseFloat($('#div-'+curr_step+' #accordion1 #'+wi+'-threshold').val())
							min_wi_threshold = parseFloat($('#div-'+curr_step+' #accordion1 #'+wi+'-threshold').prop('min'))
							max_wi_threshold = parseFloat($('#div-'+curr_step+' #accordion1 #'+wi+'-threshold').prop('max'))
							if ((wi_threshold<min_wi_threshold) || (wi_threshold>max_wi_threshold)){
								buildDynamicModalPopup('Error', 
									'<p>Threshold for '+wi.toUpperCase()+' must be between '+min_wi_threshold+' and '+max_wi_threshold+'</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
								are_thresholds_valid = false
								return false
							}
						}
					})
					if (are_thresholds_valid){
						goToStep('step6Run')
					}
					//{% if request.path == home_coastal %}
					//goToStep('step5OCConnection')
					//{% else %}
					
					//{% endif %}
				}
			}
			//{% if request.path == home_coastal %}
			//else if (curr_step == 'step5OCConnection'){
				//goToStep('step6Run')
			//}
			//{% endif %}
			else if (curr_step == 'step6Run'){
				hasNotGivenAName = ($('#div-step6Run #accordion1 #simulationName').val()=='')
				if(hasNotGivenAName){
					buildDynamicModalPopup('Error', 
						'<p>Please give a name to the simulation before running</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				else{
					jsonCreateSimulation['simulationName'] = $('#div-step6Run #accordion1 #simulationName').val()
					//console.log(jsonCreateSimulation)
					roi_id = jsonCreateSimulation['step1ROI']['selectROI'].split('_')[1]
					buildDynamicModalPopup('Submitting and running simulation', 
						'<p>Please wait...</p>', [], [250,250])
					{% if request.path == home_waterleak %}
					if (LEFT_PANEL_MODE == 'create'){// && !WATERLEAK_SIMULATION_EXISTS){ 
						_url = '/portal/rois/'+roi_id+'/create_simulation' }
					else{ 
						_url = '/portal/rois/'+roi_id+'/simulations/'+EDIT_SIMULATION_ID+'/edit_simulation' }
					{% else %}
					if (LEFT_PANEL_MODE == 'create'){ 
						_url = '/portal/rois/'+roi_id+'/create_simulation' }
					else{ 
						_url = '/portal/rois/'+roi_id+'/simulations/'+EDIT_SIMULATION_ID+'/edit_simulation' }
					{% endif %}
					$.post(_url, JSON.stringify(jsonCreateSimulation))
						.done(function( data ) {
							var answer = $.parseJSON(JSON.stringify(data)); 
							if(answer['alert']=='submitted'){
								//console.log(answer)
								cs_simulation_id = answer['simulation_id']
								//run_simulation
								{% if request.path == home_waterleak %}
								if (LEFT_PANEL_MODE == 'create'){ // && !WATERLEAK_SIMULATION_EXISTS){  
									_url_run = '/portal/rois/'+roi_id+'/simulations/'+cs_simulation_id+'/run_simulation'
									_answer_state='created'
								}
								else{
									_url_run = '/portal/rois/'+roi_id+'/simulations/'+cs_simulation_id+'/update_simulation' 
									_answer_state='updating'
								}
								{% else %}
								if (LEFT_PANEL_MODE == 'create'){ 
									_url_run = '/portal/rois/'+roi_id+'/simulations/'+cs_simulation_id+'/run_simulation'
									_answer_state='created'
								}
								else{ 
									_url_run = '/portal/rois/'+roi_id+'/simulations/'+cs_simulation_id+'/restart_simulation'
									_answer_state='restarted'
								}
								{% endif %}
								$.get(_url_run)
									.done(function(data){
										var answer = $.parseJSON(JSON.stringify(data)); 
										if(answer['state']==_answer_state){
											dm.dialog( "close" );
											
											buildDynamicModalPopup('Success!', 
												'<p>Your simulation was submitted and it is running! Go to Visualization to check your simulation state.</p>', 
												[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
											closeLeftPanel()
											createFreshBlobJsonSimulation()
											//
											$('#step-ph1').removeClass('current')
											$('#step-ph1-workflow').hide()
											//
											//{% if request.path == home_waterleak %}
											//$('#step-ph2').removeClass('current')
											//$('#step1ImageSelection').removeClass('current')
											//$('#step3LeakDetection').removeClass('current')
											//$('#step4LeakDetection').removeClass('current')
											//$('#step-ph2-workflow').hide()
											//{% endif %}
											restartStep('step1ROI')
											restartStep('step2Inputs')
											restartStep('step3InputsRevision')
											restartStep('step4Detection')
											//{% if request.path == home_coastal %}
											//restartStep('step5OCConnection')
											//{% endif %}
											restartStep('step6Run')
											$('#step6Run').removeClass('done').removeClass('current')
											$('#step1ROI').removeClass('done').addClass('current')
											$('#step0DetectionSelection').removeClass('done').addClass('current')
											curr_step = 'step1ROI'
											//if (LEFT_PANEL_MODE == 'edit'){ 
											LEFT_PANEL_MODE = null
											EDIT_SIMULATION_ID = null
											EDIT_LEAK_DETECTION_ID = null
											//WATERLEAK_SIMULATION_EXISTS = false
											//}
										}
									})
									.fail(function( xhr, textStatus, errorThrown ){
										console.log( xhr, textStatus, errorThrown)
										dm.dialog( "close" );
										buildDynamicModalPopup('Error!', 
											'<p>Your simulation failed to run! Something went wrong, try again!</p>', 
											[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
									})
							}
							else{
								dm.dialog( "close" );
								buildDynamicModalPopup('Error!', 
									'<p>'+answer['exception']+'</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							}
						})
						.fail(function( xhr, textStatus, errorThrown ){
							console.log( xhr, textStatus, errorThrown)
							dm.dialog( "close" );
							buildDynamicModalPopup('Error!', 
								'<p>Your simulation was not submitted! Something went wrong, try again!</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						})
				}
			}
			//leak detection
			else if (curr_step == 'step0DetectionSelection'){
				optDetectionSelection = $('#div-step0DetectionSelection input[name="optDetectionSelection"]:checked').prop('id')
				_clear_interval_leak_detection_details()
				if (optDetectionSelection == 'optDetectionSelection1'){//create
					goToStepLD('step1ImageSelection')
					LEFT_PANEL_MODE = 'waterleak-create-leak-detection'
				}
				else if (optDetectionSelection == 'optDetectionSelection2'){//edit
					selectDetection = $('#div-step0DetectionSelection #select-ld-listOfDetection').val()
					if (selectDetection == 'no_leak_detection'){
						buildDynamicModalPopup('Error!', 
							'<p>You do not have created Leak detections. You must create one.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else{
						//load the leak detection blob
						//and go to identify leaks
						selectDetectionSplit = selectDetection.split('_')
						roi_id = selectDetectionSplit[1]
						$('#showVisualizationAndDetectionManager #accordion1 #listOfROI #roi_'+roi_id).prop('checked',true); 
						sim_id = selectDetectionSplit[3]
						EDIT_LEAK_DETECTION_ID = selectDetectionSplit[5]
						_url = '/portal/waterleak/leakdetection/rois/'+roi_id+'/simulations/'+sim_id+'/leak_detections/'+EDIT_LEAK_DETECTION_ID
						buildDynamicModalPopup('Loading leak detection!', 
							'<p>Please wait!</p>', 
							[], [250,220])
						$.get(_url)
							.done(function(data){
								dm.dialog( "close" );
								var answer = $.parseJSON(JSON.stringify(data));
								if (answer['alert']=='error'){
									buildDynamicModalPopup('Error!', 
										'<p>Something went wrong on loading the leak detection, try again!</p>', 
										[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
								}
								else{
									steps = ['step1ImageSelection','step3LeakDetection','step4LeakDetection']
									for (var s in steps){
										loadBlobJsonLeakDetection(steps[s], answer['leak_detection']['blob'])
									}
									dm.dialog( "close" );
									LEFT_PANEL_MODE = 'waterleak-edit-leak-detection'
									$('#step1ImageSelection').addClass('current')
									_start_interval_leak_detection_details(roi_id, sim_id, EDIT_LEAK_DETECTION_ID)
									//check state
									_goto_step4_if_state_is = ['generating-mask-leak',
										'generated-mask-leak','error-generating-mask-leak','determinating-leak',
										'determinated-leak','error-determinating-leak','storing-determinated-leak','stored-determinated-leak','error-storing-determinated-leak']
									if (_goto_step4_if_state_is.indexOf(answer['leak_detection']['state'])>-1){
										_lock_unlock_options_step3_step4_ld('step4LeakDetection', answer['leak_detection']['state'])
										$('#step3LeakDetection').addClass('current')
										goToStepLD('step4LeakDetection') 
									}
									else{ 
										_lock_unlock_options_step3_step4_ld('step3LeakDetection', answer['leak_detection']['state'])
										goToStepLD('step3LeakDetection') }
								}
							})
							.fail(function( xhr, textStatus, errorThrown ){
								console.log( xhr, textStatus, errorThrown)
								dm.dialog( "close" );
								buildDynamicModalPopup('Error!', 
									'<p>Something went wrong on loading the leak detection, try again!</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						})					
					}
				}
			}
			else if (curr_step == 'step1ImageSelection'){
				if($('#div-step1ImageSelection #select-ld-listOfROI').val() == ''){
					buildDynamicModalPopup('Error!', 
						'<p>You do not have created ROIs. Go to Phase 1 to create one.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				else if($('#div-step1ImageSelection #select-ld-listOfSimulation').val() == 'no_simulation'){
					buildDynamicModalPopup('Error!', 
						'<p>You do not have climatology processings for this ROI. Go to Phase 1 to create one.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}				
				else if($('#div-step1ImageSelection #leakDetectionName').val() == ''){
					buildDynamicModalPopup('Error', 
						'<p>Please give a name to the leak detection below!</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				else if($('#div-step1ImageSelection #div-ld-listOfImageset #ld-listOfImageset tr').length==0){
					buildDynamicModalPopup('Error', 
						'<p>No images available.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				/*else if($('#div-step1ImageSelection #select-ld-listOfSimulation').val() != 'no_simulation' && $('#div-step1ImageSelection #select-ld-listOfSimulation option:selected').text()){
					//do not allow doing anomalies with images that do not belong to the period of the processed climatology

				}*/
				else{
					jsonCreateLeakDetection = saveBlobJsonLeakDetection(curr_step, jsonCreateLeakDetection)
					buildDynamicModalPopup('Submitting and running leak detection', 
						'<p>Please wait...</p>', [], [250,250])	
					window.stop()
					_roi_id = jsonCreateLeakDetection['step1ImageSelection']['roi_id']
					$('#showVisualizationAndDetectionManager #accordion1 #listOfROI #roi_'+_roi_id).prop('checked',true); 
					_sim_id = jsonCreateLeakDetection['step1ImageSelection']['simulation_id']
					_url = '/portal/waterleak/leakdetection/rois/'+_roi_id+'/simulations/'+_sim_id+'/create_leak_detection' 
					$.post(_url, JSON.stringify(jsonCreateLeakDetection))
						.done(function( data ) {
							var answer = $.parseJSON(JSON.stringify(data)); 
							if(answer['alert']=='submitted'){
								dm.dialog( "close" );
								console.log(answer)
								cs_simulation_id = answer['simulation_id']
								EDIT_LEAK_DETECTION_ID = answer['leak_detection_id']
								//run_simulation
								_url_run = '/portal/waterleak/leakdetection/rois/'+_roi_id+'/simulations/'+_sim_id+'/leak_detections/'+EDIT_LEAK_DETECTION_ID+'/run'
								_answer_state='created'
								$.get(_url_run)
									.done(function(data){
										var answer = $.parseJSON(JSON.stringify(data)); 
										if(answer['state']==_answer_state){
											dm.dialog( "close" );
											LEFT_PANEL_MODE = 'waterleak-edit-leak-detection'
											_start_interval_leak_detection_details(_roi_id, _sim_id, EDIT_LEAK_DETECTION_ID)
											goToStepLD('step3LeakDetection')
											//buildDynamicModalPopup('Success!', 
											//	'<p>Your simulation was submitted and it is running! Go to Visualization to check your simulation state.</p>', 
											//	[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])									
											
										}
									})
									.fail(function( xhr, textStatus, errorThrown ){
										console.log( xhr, textStatus, errorThrown)
										dm.dialog( "close" );
										buildDynamicModalPopup('Error!', 
											'<p>Your simulation failed to run! Something went wrong, try again!</p>', 
											[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
									})
							}
							else{
								dm.dialog( "close" );
								buildDynamicModalPopup('Error!', 
									'<p>'+answer['exception']+'</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							}
						})
						.fail(function( xhr, textStatus, errorThrown ){
							console.log( xhr, textStatus, errorThrown)
							dm.dialog( "close" );
							buildDynamicModalPopup('Error!', 
								'<p>Your simulation was not submitted! Something went wrong, try again!</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						})
					//goToStepLD('step3LeakDetection')
					
				}
			}
			//else if (curr_step == 'step2LeakDetection'){
			//	goToStepLD('step3LeakDetection')
			//}
			else if (curr_step == 'step3LeakDetection'){
				optStep3LeakDetectionPipeNetwork=$('#div-step3LeakDetection #accordion1 input[name="optStep3LeakDetectionPipeNetwork"]:checked').prop('id')
				optStep3LeakDetectionMask = $('#div-step3LeakDetection #accordion2 input[name="optStep3LeakDetectionMask"]:checked').prop('id')
				mask_width = $('#div-step3LeakDetection #accordion2 #optStep3LeakDetectionMask1-width').val()
				min_mask_width = parseInt($('#div-step3LeakDetection #accordion2 #optStep3LeakDetectionMask1-width').prop('min'))
				max_mask_width = parseInt($('#div-step3LeakDetection #accordion2 #optStep3LeakDetectionMask1-width').prop('max'))

				if(optStep3LeakDetectionMask=='optStep3LeakDetectionMask1' && mask_width == ''){
					buildDynamicModalPopup('Error mask width!', 
						'<p>Please give a valid value for width.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				else if(optStep3LeakDetectionMask=='optStep3LeakDetectionMask1' && parseInt(mask_width)<min_mask_width){
					buildDynamicModalPopup('Error mask width!', 
						'<p>Value is below '+min_mask_width+'.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				else if(optStep3LeakDetectionMask=='optStep3LeakDetectionMask1' && parseInt(mask_width)>max_mask_width){
					buildDynamicModalPopup('Error mask width!', 
						'<p>Value is above '+max_mask_width+'.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				else if(optStep3LeakDetectionPipeNetwork=='optStep3LeakDetectionPipeNetwork1' && $('#divuploadgeometry #fileupload2').val()==''){
					//if new pipe network and user has not chosen a file.
					buildDynamicModalPopup('Error uploading new pipe network!', 
						'<p>Please select the file to upload.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				else if(optStep3LeakDetectionPipeNetwork=='optStep3LeakDetectionPipeNetwork1' && $('#divuploadgeometry #_store_pipe_network_id').text()==''){
					//if new pipe network and user has not chosen a file.
					buildDynamicModalPopup('Error uploading new pipe network!', 
						'<p>Click on the upload to start uploading file.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				else if(optStep3LeakDetectionPipeNetwork=='optStep3LeakDetectionPipeNetwork2' && $('#div-step3LeakDetection #accordion1 #listOfUploadedGeometries tr').length == 0){
					//if table of existing pipes is empty (no choices)
					buildDynamicModalPopup('Error existing pipe network!', 
						'<p>No pipes available for choose. Must upload new ones first.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
				else if(optStep3LeakDetectionPipeNetwork=='optStep3LeakDetectionPipeNetwork2' && $('#div-step3LeakDetection #accordion1 #listOfUploadedGeometries input[name="optSelectPipeNetwork"]:checked').prop('id') === undefined){
					//if table of existing pipes is empty (no choices)
					buildDynamicModalPopup('Error existing pipe network!', 
						'<p>No compatible pipes available for choose. Please upload a compatible one.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				else{
					//for step3, check first if user has changed options before saving
					//this is possible by comparing the previously saved blob with the user selections made on the step3 menu
					//if yes, flag it as update
					if(optStep3LeakDetectionPipeNetwork=='optStep3LeakDetectionPipeNetwork2'){//existing
						pipe_network_id = $('#div-step3LeakDetection #accordion1 #listOfUploadedGeometries input[name="optSelectPipeNetwork"]:checked').prop('id').split('_')[1]
					}
					else if(optStep3LeakDetectionPipeNetwork=='optStep3LeakDetectionPipeNetwork1'){
						pipe_network_id = parseInt($('#divuploadgeometry #_store_pipe_network_id').text())
					}
					else{
						pipe_network_id = ''
					}
					STEP3_UPDATE_FLAG = true //this code below has bugs, does not run for the first time...
					/*STEP3_UPDATE_FLAG = false			
					if ((jsonCreateLeakDetection[curr_step]['optStep3LeakDetectionPipeNetwork']!=optStep3LeakDetectionPipeNetwork) ||
						(jsonCreateLeakDetection[curr_step]['optStep3LeakDetectionMask']!=optStep3LeakDetectionMask) ||
						(jsonCreateLeakDetection[curr_step]['mask_width']!=mask_width)||
						(jsonCreateLeakDetection[curr_step]['geometry_id']!=null && jsonCreateLeakDetection[curr_step]['geometry_id'].toString()!=[pipe_network_id].toString()) ){
							STEP3_UPDATE_FLAG = true
							console.log('Changes were made on step3, run again identify leaks!')
					}
					else{
						console.log('No changes were made on step3, skip run!')
					}*/
					
					jsonCreateLeakDetection = saveBlobJsonLeakDetection(curr_step, jsonCreateLeakDetection)
					//hack to when user comes back from identify leaks, go back to existing pipenetwork
					/*if(optStep3LeakDetectionPipeNetwork=='optStep3LeakDetectionPipeNetwork1'){
						jsonCreateLeakDetection[curr_step]['optStep3LeakDetectionPipeNetwork']='optStep3LeakDetectionPipeNetwork2'
					}*/
					buildDynamicModalPopup('Updating leak detection', 
						'<p>Please wait...</p>', [], [250,250])	
					roi_id = jsonCreateLeakDetection['step1ImageSelection']['roi_id']
					$('#showVisualizationAndDetectionManager #accordion1 #listOfROI #roi_'+roi_id).prop('checked',true);					
					_sim_id = jsonCreateLeakDetection['step1ImageSelection']['simulation_id']
					_url = '/portal/waterleak/leakdetection/rois/'+roi_id+'/simulations/'+_sim_id+'/leak_detections/'+EDIT_LEAK_DETECTION_ID+'/edit' 
					$.post(_url, JSON.stringify(jsonCreateLeakDetection))
						.done(function( data ) {
							var answer = $.parseJSON(JSON.stringify(data)); 
							if(answer['alert']=='submitted'){
								dm.dialog( "close" );
								console.log(answer)
								cs_simulation_id = answer['simulation_id']
								//EDIT_LEAK_DETECTION_ID = answer['leak_detection_id']					
								//run_simulation
								console.log('========STEP3_UPDATE_FLAG========')
								console.log(STEP3_UPDATE_FLAG)
								console.log('===========================')
								if (STEP3_UPDATE_FLAG){
									buildDynamicModalPopup('Running leak detection', 
										'<p>Please wait...</p>', [], [250,250])	
									_url_run = '/portal/waterleak/leakdetection/rois/'+roi_id+'/simulations/'+cs_simulation_id+'/leak_detections/'+EDIT_LEAK_DETECTION_ID+'/run_identify_leaks'
									_answer_state='created'
									$.get(_url_run)
										.done(function(data){
											var answer = $.parseJSON(JSON.stringify(data)); 
											if(answer['state']==_answer_state){
												dm.dialog( "close" );
												//LEFT_PANEL_MODE = 'waterleak-edit-leak-detection'
												_start_interval_leak_detection_details(roi_id, cs_simulation_id, EDIT_LEAK_DETECTION_ID)
												goToStepLD('step4LeakDetection')
												//buildDynamicModalPopup('Success!', 
												//	'<p>Your simulation was submitted and it is running! Go to Visualization to check your simulation state.</p>', 
												//	[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])									
												
											}
										})
										.fail(function( xhr, textStatus, errorThrown ){
											console.log( xhr, textStatus, errorThrown)
											dm.dialog( "close" );
											buildDynamicModalPopup('Error!', 
												'<p>Your leak detection failed to run! Something went wrong, try again!</p>', 
												[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
										})
								}
								else{
									dm.dialog( "close" );
									_start_interval_leak_detection_details(roi_id, cs_simulation_id, EDIT_LEAK_DETECTION_ID)
									goToStepLD('step4LeakDetection')										
								}
							}
							else{
								dm.dialog( "close" );
								buildDynamicModalPopup('Error!', 
									'<p>'+answer['exception']+'</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							}
						})
						.fail(function( xhr, textStatus, errorThrown ){
							console.log( xhr, textStatus, errorThrown)
							dm.dialog( "close" );
							buildDynamicModalPopup('Error!', 
								'<p>Your leak detection was not updated! Something went wrong, try again!</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						})
						//goToStepLD('step3LeakDetection')
				}
			}
			else if (curr_step == 'step4LeakDetection'){
				if($('#div-step4LeakDetection #div-ld-listOfSavedLPs #ld-listOfSavedLPs tr').length==0){
					buildDynamicModalPopup('Warning!', 
						'<p>You have not created any leak point sets. Continue?</p>', 
						[['Yes', function(){ 
							$(this).dialog( "close" )
							reverseRemoveLayerIndexOf('ld')
							listActiveLayers()
							//getListOfSimulations()
							_showVisualization('showLeakDetections')
							$('.close').toggleClass('closed');
						}],
						['No', function(){
							$(this).dialog( "close" )
						}]], [300,220])
				}
				else{
					reverseRemoveLayerIndexOf('ld')
					listActiveLayers()
					//getListOfSimulations()
					//showVisualization('showLeakDetections')
					_showVisualization('showLeakDetections')
					$('.close').toggleClass('closed');
				}
			}
		}
	}

	{% if request.path == home_waterleak %}
	function apply_waterleak_automatic_steps(){		
		//step4
		selectedWaterIdx = []
		selectedWaterIdxThrshlds = []
		$('#div-step4Detection #accordion1 #step4Detection-waterindex input[name="waterindex-chkbox"][type="checkbox"]').each(function(){
			wi = $(this).prop('id')
			selectedWaterIdx.push(wi)
			if ($('#div-step4Detection #accordion1 #step4Detection-waterindex input[name="'+wi+'-threshold-auto-chkbox"]').prop('checked')){
				selectedWaterIdxThrshlds.push('AUTO')
			}
			else{
				selectedWaterIdxThrshlds.push($('#div-step4Detection #accordion1 #step4Detection-waterindex #'+wi+'-threshold').val())
			}
		})
		jsonCreateSimulation['step4Detection']['waterindex'] = selectedWaterIdx.toString()  //"mndwi,mndwi2,ndwi1,ndwi2"
		jsonCreateSimulation['step4Detection']['wi-threshold'] = selectedWaterIdxThrshlds.toString()
		goToStep('step6Run')
		/*chosenOptInput = jsonCreateSimulation['step2Inputs']['optInput']
		inputImageType = 'custom'
		if (chosenOptInput == 'optInput1'){inputImageType = 'Sentinel2'}
		else if (chosenOptInput == 'optInput2'){inputImageType = 'Pleiades'}
		else if (chosenOptInput == 'optInput3'){inputImageType = 'Drone'}
		else if (chosenOptInput == 'optInput4'){inputImageType = 'TerraSAR-X'}
		else if (chosenOptInput == 'optInput5'){inputImageType = 'Sentinel1'}
		jsonCreateSimulation['step2Inputs']['conversion-l1-l2'] = $('#div-step2Inputs #accordion2 #conversion-l1-l2').prop('checked')
		jsonCreateSimulation['step2Inputs']['filter-cloud-cov-l2'] = $('#div-step2Inputs #accordion2 #filter-cloud-cov-l2').prop('checked')	
		jsonCreateSimulation['step2Inputs']['beginDate'] = $('#div-step2Inputs #accordion1 #beginDate').val()
		jsonCreateSimulation['step2Inputs']['endDate'] = $('#div-step2Inputs #accordion1 #endDate').val()
		jsonCreateSimulation['step3InputsRevision']['listOfImagesets'] = []*/

		/*buildDynamicModalPopup('Loading list...', 
			'<p>WORSICA is searching imagesets from ESA Copernicus and automatically selecting them to the processing. Please wait...</p>', 
			[], [250,220])
		//force
		jsonCreateSimulation['step2Inputs']['optSentinelLevels'] = [] //checkboxes
		if (optInput == 'optInput1'){
			$('#div-step2Inputs input[name="optSentinel2"]:checked').each(function(){
				jsonCreateSimulation['step2Inputs']['optSentinelLevels'].push($(this).prop('id'))
			})
		}*/
		/*else if (optInput == 'optInput5'){
			$('#div-step2Inputs input[name="optSentinel1-PT"]:checked').each(function(){
				jsonCreateSimulation['step2Inputs']['optSentinelLevels'].push($(this).prop('id'))
			})
			$('#div-step2Inputs input[name="optSentinel1-SM"]:checked').each(function(){
				jsonCreateSimulation['step2Inputs']['optSentinelLevels'].push($(this).prop('id'))
			})
		} */
		/*_url = _urlListOfImagesets(jsonCreateSimulation)					
		//console.log(_url)
		$.ajax({ type: "GET", url: _url, async: true,
			success : function(response){
				dm.dialog("close")
				listOfImagery = $.parseJSON(JSON.stringify(response));
				if (listOfImagery.length==0){
					buildDynamicModalPopup('Error', 
						'<p>Search did not retrieve any imagesets. Go back and verify Input parameters.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				else{
					buildDynamicModalPopup('Loading list...', 
						'<p>Imagesets found! Selecting automatically available sentinel inputs. Please wait...</p>', 
						[], [250,220])
					for (var image in listOfImagery){
						if(['Level-2A','Level-1C'].indexOf(listOfImagery[image]['processinglevel'])>-1){
							custom_processinglevel_name =  'Sentinel-2 '+listOfImagery[image]['processinglevel']+' ('+listOfImagery[image]['tilenumber']+')'
						}
						else{
							custom_processinglevel_name = listOfImagery[image]['processinglevel']
						}
						iextend = listOfImagery[image]['extent']
						jsonCreateSimulation['step3InputsRevision']['listOfImagesets'].push({
							'uuid':listOfImagery[image]['uuid'],
							'name':listOfImagery[image]['name'],
							'small_name':custom_processinglevel_name+' ('+listOfImagery[image]['date'].split('.')[0]+')',
							'date':listOfImagery[image]['date'].split('.')[0],
							'extent':[parseFloat(iextend[0]),parseFloat(iextend[1]),parseFloat(iextend[2]),parseFloat(iextend[3])],
						})	
					}
					//do the automatic water indexes selection
					//dm.dialog("close")
					buildDynamicModalPopup('Loading list...', 
						'<p>WORSICA is selecting automatically available water index. Please wait...</p>', 
						[], [250,220])							
					selectedWaterIdx = []
					selectedWaterIdxThrshlds = []
					$('#div-step4Detection #accordion1 #step4Detection-waterindex input[name="waterindex-chkbox"][type="checkbox"]').each(function(){
						wi = $(this).prop('id')
						selectedWaterIdx.push(wi)
						if ($('#div-step4Detection #accordion1 #step4Detection-waterindex input[name="'+wi+'-threshold-auto-chkbox"]').prop('checked')){
							selectedWaterIdxThrshlds.push('AUTO')
						}
						else{
							selectedWaterIdxThrshlds.push($('#div-step4Detection #accordion1 #step4Detection-waterindex #'+wi+'-threshold').val())
						}
					})
					jsonCreateSimulation['step4Detection']['waterindex'] = selectedWaterIdx.toString()  //"mndwi,mndwi2,ndwi1,ndwi2"
					jsonCreateSimulation['step4Detection']['wi-threshold'] = selectedWaterIdxThrshlds.toString()
					//jsonCreateSimulation['simulationName'] = jsonCreateSimulation['step1ROI']['roiName']+'-'+inputImageType
					//$('#div-step6Run #accordion1 #simulationName').val(jsonCreateSimulation['simulationName'])
					//moving on to the run
					//dm.dialog("close")
					goToStep('step6Run')
				}
			},
			error: function(response){
				dm.dialog("close")
				buildDynamicModalPopup('Error', 
					'<p>Could not load imagesets from ESA Copernicus.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
		})*/
	}
	{% endif %}
	function calculateAreaROI(){
		if(extentS != null && extentF != null){
			var coordinates =  [[extentS[0],extentS[1]],
	              [extentS[0],extentF[1]],
	              [extentF[0],extentF[1]],
	              [extentF[0],extentS[1]]]
			var sphere = new ol.Sphere(6378137);
	        var area_m = sphere.geodesicArea(coordinates);
	     	var area_km = Math.abs(area_m / 1000 / 1000);
			return area_km
		}
		else{
			return null
		}
	}
	
	
	/*Options for select Inputs*/
	function optionsStep2Inputs(){
		chosenOpt = $('#div-step2Inputs input[name="optInput"]:checked').prop('id')
		console.log(chosenOpt)
		disableSubaccordion((chosenOpt != 'optInput1'), '#div-step2Inputs #accordion2 #inputsSentinel2')
		$('#div-step2Inputs #accordion2 #optSentinel2-L1C').prop('disabled', chosenOpt != 'optInput1')
		$('#div-step2Inputs #accordion2 #optSentinel2-L2A').prop('disabled', chosenOpt != 'optInput1')
		$('#div-step2Inputs #accordion2 #filter-cloud-cov-l2').prop('disabled', chosenOpt != 'optInput1' || (chosenOpt == 'optInput1' && !$('#div-step2Inputs #accordion2 #optSentinel2-L2A').prop('checked')) )	
		$('#div-step2Inputs #accordion2 #optSentinel2-cloud-cov').prop('disabled', chosenOpt != 'optInput1' || (chosenOpt == 'optInput1' && !$('#div-step2Inputs #accordion2 #optSentinel2-L2A').prop('checked') && $('#div-step2Inputs #accordion2 #filter-cloud-cov-l2').prop('checked')) )	
		$('#div-step2Inputs #accordion1 #beginDate').prop('disabled', !(chosenOpt == 'optInput1' || chosenOpt == 'optInput5'))
		$('#div-step2Inputs #accordion1 #endDate').prop('disabled', !(chosenOpt == 'optInput1' || chosenOpt == 'optInput5'))
		$('#div-step2Inputs #accordion1').show()
		if (!(chosenOpt == 'optInput1' || chosenOpt == 'optInput5')){
			$('#div-step2Inputs #accordion1').hide()
		}
		disableSubaccordion((chosenOpt != 'optInput2'), '#div-step2Inputs #accordion2 #inputsPleiades')
		$('#div-step2Inputs #accordion2 #uploadPleiades #fileupload').prop('disabled', chosenOpt != 'optInput2')
		$('#div-step2Inputs #accordion2 #uploadPleiades #up_btn').prop('disabled', chosenOpt != 'optInput2')
		disableSubaccordion((chosenOpt != 'optInput3'), '#div-step2Inputs #accordion2 #inputsDrone')
		//$('#div-step2Inputs #accordion2 #uploadDrone #fileupload').prop('disabled', chosenOpt != 'optInput3')
		//$('#div-step2Inputs #accordion2 #uploadDrone #up_btn').prop('disabled', chosenOpt != 'optInput3')
		disableSubaccordion((chosenOpt != 'optInput5'), '#div-step2Inputs #accordion2 #inputsSentinel1')
		disableSubaccordion((chosenOpt != 'optInput5'), '#div-step2Inputs #accordion2 #inputsSentinel1 #inputsSentinel1PT')
		$('#div-step2Inputs #accordion2 #optSentinel1-PL-GRD').prop('disabled', chosenOpt != 'optInput5')		
		disableSubaccordion((chosenOpt != 'optInput5'), '#div-step2Inputs #accordion2 #inputsSentinel1 #inputsSentinel1SM')
		$('#div-step2Inputs #accordion2 #optSentinel1-SM-IW').prop('disabled', chosenOpt != 'optInput5')
		$('#div-step2Inputs #accordion2 #optSentinel1-SM-SM').prop('disabled', chosenOpt != 'optInput5')
		if(chosenOpt == 'optInput1'){
			//.....
		}
		{% if request.path == home_waterleak %}
		//lock sentinel search by l1c and l2a
		$('#div-step2Inputs #accordion2 #optSentinel2-L1C').prop('checked',true)
		$('#div-step2Inputs #accordion2 #optSentinel2-L1C').prop('disabled',true)
		$('#div-step2Inputs #accordion2 #optSentinel2-L2A').prop('checked',true)
		$('#div-step2Inputs #accordion2 #optSentinel2-L2A').prop('disabled',true)
		//do not filter by cloud (hide)
		$('#div-step2Inputs #accordion2 #filter-cloud-cov-l2-div').hide()
		$('#div-step2Inputs #accordion2 #filter-cloud-cov-l2').prop('checked',false)
		$('#div-step2Inputs #accordion1').hide()
		//set period from 2016 (begin) until today (end)
		$('#div-step2Inputs #beginDate').val("2016-08-01")//not used
		$('#div-step2Inputs #endDate').val(todayDate.toISOString().split('T')[0])//not used
		{% endif %}
	}
	/*Options for select Inputs revision*/
	function optionsStep3InputsRevision(){
		chosenOptPrevStep = $('#div-step2Inputs input[name="optInput"]:checked').prop('id')
		$('#div-step3InputsRevision #iconUpload').hide()
		{% if request.path != home_waterleak %}
		if (!(chosenOptPrevStep=='optInput1' || chosenOptPrevStep=='optInput5')){
			$('#div-step3InputsRevision #iconUpload').show()
		}
		{% endif %}
		{% if request.path == home_waterleak %}
		chosenOpt = $('#div-step3InputsRevision input[name="optInputRevision"]:checked').prop('id')
		console.log(chosenOpt)
		$('#div-step3InputsRevision #optSentinel2-warning').html('<p>WORSICA will automatically search Sentinel2 imagesets between '+WATERLEAK_SENTINEL2_CUSTOM_BEGINDATE+' and '+WATERLEAK_SENTINEL2_CUSTOM_ENDDATE+'</p>')
		$('#div-step3InputsRevision #beginDateFilterList').prop('disabled',(chosenOpt != 'optInputRevision2'))
		$('#div-step3InputsRevision #endDateFilterList').prop('disabled',(chosenOpt != 'optInputRevision2'))
		$('#div-step3InputsRevision #iconSelectAll').hide()
		$('#div-step3InputsRevision #iconDeselectAll').hide()
		{% endif %}
	}
	function onChangeStep3InputRevisionType(){
		{% if request.path == home_waterleak %}
		chosenOpt = $('#div-step3InputsRevision input[name="optInputRevision"]:checked').prop('id')
		console.log(chosenOpt)
		if(chosenOpt == 'optInputRevision2'){//select period
			$('#div-step3InputsRevision #listOfImagesets').show()
			$('#div-step3InputsRevision #optSentinel2-warning').hide()
			$('#div-step3InputsRevision #dateFilterList').show()
			$('#div-step3InputsRevision #iconSearch').show()
			onClickStep3InputsRevisionSearch()//search button
		}
		else{//use all images
			$('#div-step3InputsRevision #listOfImagesets').hide()
			$('#div-step3InputsRevision #listOfImagesets').empty()
			$('#div-step3InputsRevision #optSentinel2-warning').show()
			$('#div-step3InputsRevision #dateFilterList').hide()
			$('#div-step3InputsRevision #iconSearch').hide()
			jsonCreateSimulation['step2Inputs']['beginDate'] = WATERLEAK_SENTINEL2_CUSTOM_BEGINDATE
			jsonCreateSimulation['step2Inputs']['endDate'] = WATERLEAK_SENTINEL2_CUSTOM_ENDDATE
			//loadListOfImagesets()
		}
		{% endif %}
	}
	function onClickStep3InputsRevisionSearch(){
		{% if request.path == home_waterleak %}
		//check dates, etc...
		$('#div-step3InputsRevision #listOfImagesets').empty()
		bD = $('#div-'+curr_step+' #beginDateFilterList').val()
		eD = $('#div-'+curr_step+' #endDateFilterList').val()
		isBeginTimeAboveEndTime = (new Date(bD).getTime() > new Date(eD).getTime())
		if (bD == ''){
			buildDynamicModalPopup('Error', 
				'<p>Please provide a valid begin date.</p>', 
				[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
		}
		else if (eD == ''){
			buildDynamicModalPopup('Error', 
				'<p>Please provide a valid end date.</p>', 
				[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
		}
		else if (isBeginTimeAboveEndTime){
			buildDynamicModalPopup('Error', 
				'<p>"From" date should be before the "until" date.</p>', 
				[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
		}
		else{
			var diff =( new Date($('#div-'+curr_step+' #endDateFilterList').val()).getTime() - new Date($('#div-'+curr_step+' #beginDateFilterList').val()).getTime() ) / 1000
			diff = diff/(60 * 60 * 24)
			//diff_years = Math.abs(Math.round(diff/365.25))
			if (diff < 365){
				buildDynamicModalPopup('Error', 
					'<p>You must select a period with at least 1 year.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
			else{
				jsonCreateSimulation['step2Inputs']['beginDate'] = $('#div-step3InputsRevision #beginDateFilterList').val()
				jsonCreateSimulation['step2Inputs']['endDate'] = $('#div-step3InputsRevision #endDateFilterList').val()
				loadListOfImagesets()
			}
		}
		{% endif %}
	}
	/*Options for select detection*/
	function optionsStep4SelectDetection(){
		chosenOptPrevStep = $('#div-step2Inputs input[name="optInput"]:checked').prop('id')
		isDrone = (chosenOptPrevStep=='optInput3')
		$('#div-step4Detection #accordion1 #step4Detection-waterindex input[name="waterindex-chkbox"][type="checkbox"][id="mndwi"]').prop('disabled',isDrone)
		$('#div-step4Detection #accordion1 #step4Detection-waterindex input[name="waterindex-chkbox"][type="checkbox"][id="awei"]').prop('disabled',isDrone)
		$('#div-step4Detection #accordion1 #step4Detection-waterindex input[name="waterindex-chkbox"][type="checkbox"][id="aweish"]').prop('disabled',isDrone)
				
	}



	/*LEFT PANEL*/
	/*Options for leak detection image selection */
	function optionsStep0DetectionSelection(){
		$('#div-step0DetectionSelection #select-ld-listOfDetection').empty()
		$.ajax({ type: "GET", url: '/portal/waterleak/leakdetection/leak_detections', async: true,
			success : function(response){
				listOfROIs = $.parseJSON(JSON.stringify(response));
				if(listOfROIs.length>0){
					for (var d=0;d<listOfROIs.length;d++){ 
						$('#div-step0DetectionSelection #select-ld-listOfDetection').append(
							"<option value='roi_"+listOfROIs[d]['roi_id']+"_simulation_"+listOfROIs[d]['simulation_id']+"_leakdetection_"+listOfROIs[d]['id']+"'>"+
							listOfROIs[d]['name']+" (From "+listOfROIs[d]['roi_name']+" - "+listOfROIs[d]['simulation_name']+")"+
							"</option>")
					}
					
				}
				else{
					$('#div-step0DetectionSelection #select-ld-listOfDetection').append(
						"<option value='no_leak_detection'>(No Leak Detections available)</option>")
				}
			},
			error: function(response){
				$('#div-step0DetectionSelection #select-ld-listOfDetection').append(
					"<option value='no_leak_detection'>(No Leak Detections available)</option>")
				console.log('optionsStep0DetectionSelection error! ')
			}
		});
		onChangeDropdownLeakConfigStep0DetectionSelection()		
		onChangeRadioDetectionStep0DetectionSelection()		
	}
	function onChangeDropdownLeakConfigStep0DetectionSelection(){
		selection = $('#div-step0DetectionSelection #select-ld-listOfDetection').val()
		if(selection != null){
			roi_id = selection.split('_')[1]
			highlightSelectedROI4("roi_"+roi_id)
		}
	}
	function onChangeRadioDetectionStep0DetectionSelection(){
		optDetectionSelection = $('#div-step0DetectionSelection input[name="optDetectionSelection"]:checked').prop('id')
		if(optDetectionSelection == 'optDetectionSelection2'){
			$('#div-step0DetectionSelection #select-ld-listOfDetection').show()				
			$('#div-step0DetectionSelection #select-ld-listOfDetection').change()
		}
		else{
			//remove ld and other before resetting
			map.getLayers().forEach(function(el) {
				if(el.get('name') !== undefined){
					if(el.get('name').indexOf(SERVICE_NAME+'-')==-1){
						console.log('remove '+el.get('name'))
						reverseRemoveLayerEqual(el.get('name'))
					}
				}
			})
			listActiveLayers()
			resetSelectedROI()
			$('#div-step0DetectionSelection #select-ld-listOfDetection').hide()
		}
	}


	function optionsStep1ImageSelection(){
		$('#div-step1ImageSelection #select-ld-listOfROI').empty()
		$('#div-step1ImageSelection #select-ld-listOfSimulation').empty()
		$('#div-step1ImageSelection #div-ld-listOfImageset #ld-listOfImageset').empty()
		onLoadStep1ImageSelectionOptions('roi')
	}
	function onChangeDropdownROIStep1ImageSelection(){
		selection = $('#div-step1ImageSelection #select-ld-listOfROI').val()
		if(selection != null){
			roi_id = selection.split('_')[1]
			highlightSelectedROI4("roi_"+roi_id)
		}
	}
	function onLoadStep1ImageSelectionOptions(type){
		if (type=='roi'){
			$('#div-step1ImageSelection #select-ld-listOfSimulation').empty()
			$('#div-step1ImageSelection #div-ld-listOfImageset #ld-listOfImageset').empty()
			$.ajax({ type: "GET", url: '/portal/waterleak/leakdetection/rois', async: true,
				success : function(response){
					listOfROIs = $.parseJSON(JSON.stringify(response));
					if(listOfROIs.length>0){
						for (var d=0;d<listOfROIs.length;d++){ 
							$('#div-step1ImageSelection #select-ld-listOfROI').append("<option value='roi_"+listOfROIs[d]['roi_id']+"'>"+listOfROIs[d]['name']+"</option>")
						}
						onChangeDropdownROIStep1ImageSelection()
						onLoadStep1ImageSelectionOptions('simulation')
					}
					else{
						$('#div-step1ImageSelection #select-ld-listOfROI').append("<option value='no_roi'>(No ROIs available)</option>")
						$('#div-step1ImageSelection #select-ld-listOfSimulation').append("<option value='no_simulation'>(No climatology processings available)</option>")
						$('#div-step1ImageSelection #div-ld-listOfImageset #ld-listOfImageset').append('<tr><td>(No images available for this processing)</td></tr>')
					}
				},
				error: function(response){
					console.log('onChangeStep1ImageSelectionOptions roi error! ')
				}
			});
		}
		else if (type=='simulation'){
			$('#div-step1ImageSelection #div-ld-listOfImageset #ld-listOfImageset').empty()
			selected_roi = $('#div-step1ImageSelection #select-ld-listOfROI').val().split('_')[1]
			$.ajax({ type: "GET", url: '/portal/waterleak/leakdetection/rois/'+selected_roi+'/simulations', async: true,
				success : function(response){
					listOfSimulations = $.parseJSON(JSON.stringify(response));
					if(listOfSimulations.length>0){
						for (var d=0;d<listOfSimulations.length;d++){ 
							$('#div-step1ImageSelection #select-ld-listOfSimulation').append("<option value='simulation_"+listOfSimulations[d]['simulation_id']+"'>"+listOfSimulations[d]['name']+" ["+listOfSimulations[d]['beginDate']+" - "+listOfSimulations[d]['endDate']+"]</option>")
						}
						//onLoadStep1ImageSelectionOptions('imageset')
						onClickStep1ImageSelectionSearch()
					}
					else{
						//no imagesets
						$('#div-step1ImageSelection #select-ld-listOfSimulation').append("<option value='no_simulation'>(No climatology processings available)</option>")
						$('#div-step1ImageSelection #div-ld-listOfImageset #ld-listOfImageset').append('<tr><td>(No images available for this processing)</td></tr>')
					
					}
				},
				error: function(response){
					console.log('onChangeStep1ImageSelectionOptions simulation error! ')
				}
			});
		}
		else if (type=='imageset'){
			selected_roi = $('#div-step1ImageSelection #select-ld-listOfROI').val().split('_')[1]
			selected_sim = $('#div-step1ImageSelection #select-ld-listOfSimulation').val().split('_')[1]
			begin_date_ld = $('#div-step1ImageSelection #beginDateLDFilterList').val()
			end_date_ld = $('#div-step1ImageSelection #endDateLDFilterList').val()
			buildDynamicModalPopup('Searching images...', 
				'<p>Worsica is searching for processed imagesets, and for download at ESA. Please wait...</p>', 
				[], [250,220])
			//abort any remaining esa request
			console.log('abort any remaining esa request')
			window.stop()
			console.log('Cooldown 3s to not stress ESA servers...')
			setTimeout(function(){
				console.log('ESA search!')
				_url = '/portal/waterleak/leakdetection/rois/'+selected_roi+'/simulations/'+selected_sim+'/intermediate/processimageset'
				_url += '?begin_date_ld='+begin_date_ld+'&end_date_ld='+end_date_ld
				$.ajax({ type: "GET", url: _url, async: true,
					success : function(response){
						dm.dialog("close")
						jResponse = $.parseJSON(JSON.stringify(response));
						if(jResponse['state']=='success'){					
							listOfImageset = jResponse['imagesets']
							if (listOfImageset.length>0){			
								esaFail = jResponse['esaFail']
								if (esaFail){
									buildDynamicModalPopup('Warning!', 
										'<p>Search for images at ESA failed, try again later. WORSICA was only able to list the available.</p>', 
										[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
								}				
								for (var d=0;d<listOfImageset.length;d++){ 
									ymd = listOfImageset[d]["date"].split(' ')[0]
									_uuids = listOfImageset[d]['uuids']
									if(listOfImageset[d]['type']=='existing'){
										tr= "<tr>"+
												"<th><input class='form-check-input custom-radio' type='radio' id='imageset_"+listOfImageset[d]['id']+"' name='optImageset' value='imageset_"+listOfImageset[d]['id']+"' "+(d==0?"checked":"")+"></input></th><th>"+ymd+"<br>"+listOfImageset[d]['small_name']+"</th>"
											tr+="<th>"
											for (var u=0; u<_uuids.length; u++){
												tr += "<img id='"+_uuids[u]+"_image' src='/static/images/load.gif' height=60px></img>"
											}												
											tr+="</th>"
										tr+="</tr>"
									}
									else if(listOfImageset[d]['type']=='new'){
										//_uuids = listOfImageset[d]['uuids'].join('_') //esa_imageset_[uuid1]_[uuid2]
										tr= "<tr>"+
												"<th><input class='form-check-input custom-radio' type='radio' id='esa_imageset_"+_uuids.join('_')+"' name='optImageset' value='esa_imageset_"+_uuids.join('_')+"' "+(d==0?"checked":"")+"></input></th><th>"+ymd+"<br>"+listOfImageset[d]['small_name']
											tr+="<p id='esa_imageset_"+_uuids.join('_')+"_blob' style='display:none'>"+JSON.stringify(listOfImageset[d]['esa_imagesets'])+"</p>"
											tr+="<p id='esa_imageset_"+_uuids.join('_')+"_date' style='display:none'>"+ymd+"</p>"
											tr+="</th>"
											tr+="<th>"
											for (var u=0; u<_uuids.length; u++){
												tr += "<img id='"+_uuids[u]+"_image' src='/static/images/load.gif' height=60px></img>"
											}												
											tr+="</th>"
										tr+="</tr>"
									}
									$('#div-step1ImageSelection #div-ld-listOfImageset #ld-listOfImageset').append(tr)
								}
								//load thumbnails four at a time
								// /portal/data/thumbnail/UUID/show
								imgs = $('#div-step1ImageSelection #div-ld-listOfImageset #ld-listOfImageset img')
								for (var i=0; i<imgs.length; i++){
									_id = imgs[i].id
									_id_split = _id.split('_')[0]
									$('#'+_id).attr('src','/portal/data/thumbnail/'+_id_split+'/show')
									//if (i%4==0){
									/*	setTimeout(function(_id, _id_split){
											console.log('cooldown...')
											$('#'+_id).attr('src','/portal/data/thumbnail/'+_id_split+'/show')
									
										},500,_id, _id_split)*/
									//}
									/*else{
										$('#'+_id).attr('src','/portal/data/thumbnail/'+_id_split+'/show')
									}*/
								}
							}
							else{
								dm.dialog("close")
								esaFail = jResponse['esaFail']
								if (esaFail){
									buildDynamicModalPopup('Error!', 
										'<p>Search for images at ESA failed, try again later. And no processed images found for that period.</p>', 
										[['OK', function(){ $(this).dialog( "close" )} ]], [280,220])
								}
								else{
									buildDynamicModalPopup('Error!', 
										'<p>Sorry, no processed images found for that period.</p>', 
										[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
								}
								//$('#div-step1ImageSelection #div-ld-listOfImageset #ld-listOfImageset').append('<tr><td>(Sorry, this processing has no images available)</td></tr>')
							}
						}
						else{
							dm.dialog("close")
							buildDynamicModalPopup('Error!', 
								'<p>Sorry, an error occured on loading images.</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							//$('#div-step1ImageSelection #div-ld-listOfImageset #ld-listOfImageset').append('<tr><td>(Sorry, an error occured on loading images)</td></tr>')
						}
					},
					error: function(response){
						dm.dialog("close")
						buildDynamicModalPopup('Error!', 
							'<p>Sorry, an error occured on loading images.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						console.log('onChangeStep1ImageSelectionOptions imageset error! ')
					}
				});
			},3000)
		}
	}
	function onChangeStep1ImageSelectionOptions(type){
		if (type=='roi'){
			$('#div-step1ImageSelection #select-ld-listOfSimulation').empty()
			$('#div-step1ImageSelection #div-ld-listOfImageset #ld-listOfImageset').empty()			
			onLoadStep1ImageSelectionOptions('simulation')
		}
		else if (type=='simulation'){
			//$('#div-step1ImageSelection #div-ld-listOfImageset #ld-listOfImageset').empty()			
			//onLoadStep1ImageSelectionOptions('imageset')
			onClickStep1ImageSelectionSearch()
		}
		//else if (type=='imageset'){}
	}
	function onClickStep1ImageSelectionSearch(){
		$('#div-step1ImageSelection #div-ld-listOfImageset #ld-listOfImageset').empty()
		if($('#div-step1ImageSelection #select-ld-listOfSimulation').val() == 'no_simulation'){
			buildDynamicModalPopup('Error!', 
				'<p>You cannot do a search because you do not have climatology processings for this ROI. Go to Phase 1 to create one.</p>', 
				[['OK', function(){ $(this).dialog( "close" )} ]], [280,250])
		}
		else{
			bD = $('#div-step1ImageSelection #beginDateLDFilterList').val()
			eD = $('#div-step1ImageSelection #endDateLDFilterList').val()
			isBeginTimeAboveEndTime = (new Date(bD).getTime() > new Date(eD).getTime())
			if (bD == ''){
				buildDynamicModalPopup('Error!', 
					'<p>Please provide a valid begin date</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
			else if (eD == ''){
				buildDynamicModalPopup('Error!', 
					'<p>Please provide a valid end date</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
			else if(isBeginTimeAboveEndTime){
				buildDynamicModalPopup('Error!', 
					'<p>"From" date must be before than "until" date.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}	
			else{
				onLoadStep1ImageSelectionOptions('imageset')
			}				
		}
	}


	function optionsStep3LeakDetection(){
		onChangeStep3LeakDetectionPipeNetworkOptions()
		onChangeStep3LeakDetectionMaskOptions()
		
		//force always to stay all default (no pipe network, no mask, 10 width)
		$('#div-step3LeakDetection #accordion1 input[name="optStep3LeakDetectionPipeNetwork"][value="optStep3LeakDetectionPipeNetwork3"]').click()
		$('#div-step3LeakDetection #accordion2 #optStep3LeakDetectionMask1-width').val(10)
		$('#div-step3LeakDetection #accordion2 input[name="optStep3LeakDetectionMask"][value="optStep3LeakDetectionMask2"]').click()

		$("#dialog-message #stateicon").attr('src','/static/images/uploadfile2.svg')
		$('#divuploadgeometry .progress-bar').css( 'background', '#2CC0DE')
		$('#divuploadgeometry .progress-bar').css('width', '0%')
		$('#divuploadgeometry #fileupload2').val('')
		$('#divuploadgeometry #fileupload2').fileupload({
			dataType: 'json',
			replaceFileInput:false,
			add: function (e, data) { 
				$('#divuploadgeometry #status_message').empty()
				$('#divuploadgeometry #_store_pipe_network_id').text()
				$("#dialog-message #stateicon").attr('src','/static/images/uploadfile2.svg')
				$('#divuploadgeometry .progress-bar').css( 'background', '#2CC0DE')
				$('#divuploadgeometry .progress-bar').css( 'width', '0%')      
				data.context = $('<button style="background-color: #2CC0DE"></button>').text('Upload')
					.appendTo('#divuploadgeometry #status_message')
					.click(function () {
						data.context = $('#divuploadgeometry #status_message').text('Uploading file, please wait...')//.replaceAll($(this));
						data.submit();
						$('#divuploadgeometry #_store_pipe_network_id').text()
						buildDynamicModalPopup('Uploading file!', 
							'<p>Please wait...</p>', 
							[], [250,220])
					});
				//data.submit();
				
				//$('#divuploadgeometry #status_message').append('<p>Uploading file, please wait...</p>')
				//$('.ui-dialog-buttonset button[type="button"]').prop('disabled','disabled')
				
				
			},
			done: function (e, data) {
				dm.dialog( "close" );
				$('.ui-dialog-buttonset button[type="button"]').prop('disabled','')
				if (data.result.alert == 'uploaded'){
					$("#dialog-message #stateicon").attr('src','/static/images/check.svg')
					console.log(data.result.geometry_id)
					$('#divuploadgeometry .progress-bar').css( 'background', '#2CC0DE')
					//$('#divuploadgeometry .progress-bar').css('width', '0%')
					//$('#divuploadgeometry #fileupload2').val('')
					$('#divuploadgeometry #status_message').empty()
					$('#divuploadgeometry #status_message').append("<b>File uploaded successfully. Next time you come back, it will appear listed on existing pipe networks.</b>")
					$('#divuploadgeometry #_store_pipe_network_id').text(data.result.geometry_id)
					//_clear_interval_list_user_repository_files()
					//_start_interval_list_user_repository_files()
					//updateListOfUserRepositoryFiles()
					//$('#div-step3LeakDetection #accordion1 input[name="optStep3LeakDetectionPipeNetwork"][value="optStep3LeakDetectionPipeNetwork2"]').click()
					//$('#div-step3LeakDetection #accordion1 #listOfUploadedGeometries input[name="optSelectPipeNetwork"][value="pipenetwork_'+data.result.geometry_id+'"]').click()
					//
				}
				else{
					$("#dialog-message #stateicon").attr('src','/static/images/error.svg')
					$('#divuploadgeometry .progress-bar').css( 'background', '#bb0000')
					$('#divuploadgeometry #status_message').empty()
					$('#divuploadgeometry #status_message').append('<p>An error during upload occured: '+data.result.message+'.</p>')	
					buildDynamicModalPopup('Error!', 
						'<p>An error during upload occured: '+data.result.message+'.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
			},
			fail: function (e, data) {
				dm.dialog("close")
				$("#dialog-message #stateicon").attr('src','/static/images/error.svg')
				$('#divuploadgeometry .progress-bar').css( 'background', '#bb0000')
				$('#divuploadgeometry #status_message').append('<p>An error during upload occured: '+data.result.message+'.</p>')
				buildDynamicModalPopup('Error!', 
					'<p>An error during upload occured: '+data.result.message+'.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			},
			progressall: function (e, data) {
				$("#dialog-message #stateicon").attr('src','/static/images/load.gif')
				$('.ui-dialog-buttonset button[type="button"]').prop('disabled','disabled')
				var progress = parseInt(data.loaded / data.total * 100, 10);
				$('#divuploadgeometry .progress-bar').css( 'width', progress + '%' );
			}
		});
	}
	function onChangeStep3LeakDetectionPipeNetworkOptions(){
		optStep3LeakDetectionPipeNetwork = $('#div-step3LeakDetection #accordion1 input[name="optStep3LeakDetectionPipeNetwork"]:checked').prop('id')
		if(optStep3LeakDetectionPipeNetwork == 'optStep3LeakDetectionPipeNetwork3'){//no pipe network
			$('#div-step3LeakDetection #accordion1 #divuploadgeometry').hide()
			$('#div-step3LeakDetection #accordion1 #listOfUploadedGeometries_subaccordion').hide()
			$('#div-step3LeakDetection #accordion2').hide()
		}
		else if(optStep3LeakDetectionPipeNetwork == 'optStep3LeakDetectionPipeNetwork1'){//new
			$('#div-step3LeakDetection #accordion1 #divuploadgeometry').show()
			$('#div-step3LeakDetection #accordion1 #listOfUploadedGeometries_subaccordion').hide()
			$('#div-step3LeakDetection #accordion2').show()
			$('#divuploadgeometry .progress-bar').css( 'background', '#2CC0DE')
			$('#divuploadgeometry .progress-bar').css('width', '0%')
			$('#divuploadgeometry #fileupload2').val('')
			$('#divuploadgeometry #status_message').empty()
		}
		else if(optStep3LeakDetectionPipeNetwork == 'optStep3LeakDetectionPipeNetwork2'){//existing
			$('#div-step3LeakDetection #accordion1 #divuploadgeometry').hide()
			$('#div-step3LeakDetection #accordion1 #listOfUploadedGeometries_subaccordion').show()
			$('#div-step3LeakDetection #accordion2').show()
			$('#div-step3LeakDetection #accordion1 #listOfUploadedGeometries').empty()
			buildDynamicModalPopup('Loading compatible pipe networks!', 
				'<p>Please wait...</p>', 
				[], [250,220])
			selected_roi = jsonCreateLeakDetection['step1ImageSelection']['roi_id'] //chosenROI.get('name').split('_')[1]
			$.ajax({ type: "GET", url: '/portal/waterleak/leakdetection/rois/'+selected_roi+'/compatible_pipe_networks', async: true,
				success : function(response){
					dm.dialog("close")
					listOfPipeNetworks = $.parseJSON(JSON.stringify(response));
					if (listOfPipeNetworks.length>0){
						for (var d=0;d<listOfPipeNetworks.length;d++){ 
							//list ALL uploaded geometries from user repository
							//check if geometry is compatible with roi
							//if yes, show button and list as compatible
							//if not, hide button and list as incompatible
							$('#div-step3LeakDetection #accordion1 #listOfUploadedGeometries').append(
								"<tr>"+
									"<th>"+(listOfPipeNetworks[d]['compatible']?"<input class='form-check-input custom-radio' type='radio' id='pipenetwork_"+listOfPipeNetworks[d]['id']+"' name='optSelectPipeNetwork' value='pipenetwork_"+listOfPipeNetworks[d]['id']+"' "+(d==0?"checked":"")+"></input>":"")+"</th>"+
									"<th>"+listOfPipeNetworks[d]['name']+"<br>"+(listOfPipeNetworks[d]['compatible']?"(Compatible with the ROI)":"(Incompatible with the ROI)")+"</th>"+
								"</tr>")
						}						
					}
					else{
						/*dm.dialog("close")
						buildDynamicModalPopup('Warning!', 
							'<p>No pipe networks uploaded yet. To upload, select new pipe network and select file.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])*/
						/*$('#div-step3LeakDetection #accordion1 #listOfUploadedGeometries').append(
							'<tr><td>(No pipe networks uploaded yet. To upload, select new pipe network and select file.)</td></tr>')*/
					}
				},
				error: function(response){
					dm.dialog("close")
					buildDynamicModalPopup('Error!', 
						'<p>Sorry, something went wrong on loading pipe networks.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					console.log('check compatible pipe networks: error! ')
				}
			});
		}
	}
	function onChangeStep3LeakDetectionMaskOptions(){
		optStep3LeakDetectionMask = $('#div-step3LeakDetection #accordion2 input[name="optStep3LeakDetectionMask"]:checked').prop('id')
		$('#div-step3LeakDetection #accordion2 #optStep3LeakDetectionMask1-width').prop('disabled', (optStep3LeakDetectionMask == 'optStep3LeakDetectionMask2'))
	}


	function optionsStep4LeakDetection(){
		onLoadStep4LeakDetectionLoadList()
	}

	function onLoadStep4LeakDetectionLoadList(){
		buildDynamicModalPopup('Loading list...', 
			'<p>Loading list of saved leak points for that leak detection. Please wait...</p>', 
			[], [250,220])
		//show pipe if user has chosen a pipe
		if (jsonCreateLeakDetection['step3LeakDetection']['optStep3LeakDetectionPipeNetwork']!='optStep3LeakDetectionPipeNetwork3' && jsonCreateLeakDetection['step3LeakDetection']['geometry_id']!==undefined && jsonCreateLeakDetection['step3LeakDetection']['geometry_id'].length>0){
			onChangeChkboxUserRepositoryShowOutput2(true, 'geometry', 9999, jsonCreateLeakDetection['step3LeakDetection']['geometry_id'][0], '#cc0000')
		}
		_roi_id = jsonCreateLeakDetection['step1ImageSelection']['roi_id']
		_simulation_id = jsonCreateLeakDetection['step1ImageSelection']['simulation_id']
		$('#div-step4LeakDetection #div-ld-listOfSavedLPs #ld-listOfSavedLPs').empty()
		$('#div-step4LeakDetection #div-ld-listOfSavedLPs-error').show()
		$('#div-step4LeakDetection #div-ld-listOfSavedLPs-error').text('Loading, please wait...')
		$.ajax({ type: "GET", url: '/portal/waterleak/leakdetection/rois/'+_roi_id+'/simulations/'+_simulation_id+'/leak_detections/'+EDIT_LEAK_DETECTION_ID+'/get_user_leak_points', async: true,
			success : function(response){
				dm.dialog("close")
				j = $.parseJSON(JSON.stringify(response));
				if (j['alert']!='error'){					
					$('#div-step4LeakDetection #div-ld-listOfSavedLPs-error').hide()
					$('#div-step4LeakDetection #div-ld-listOfSavedLPs-error').text('')
					listOfSavedLPs=j['user_leaks']
					if (listOfSavedLPs.length>0){						
						for (var d=0;d<listOfSavedLPs.length;d++){ 
							$('#div-step4LeakDetection #div-ld-listOfSavedLPs #ld-listOfSavedLPs').append(
								"<tr><th>"+listOfSavedLPs[d]['name']+"</th>"+
									"<th>"+listOfSavedLPs[d]['number_points']+" points</th>"+
									"<th><a onclick=onClickLeakDetectionUserSetLeakPoint('delete',"+listOfSavedLPs[d]['id']+")><img height=24px src='/static/images/delete.svg' title='Delete' style='margin:3px'/></a></th>"+
									"<th><a onclick=onClickLeakDetectionUserSetLeakPoint('view',"+listOfSavedLPs[d]['id']+")><img height=24px src='/static/images/view.svg' title='View' style='margin:3px'/></a></th>"+
								"</tr>")
						}
					}
					else{
						$('#div-step4LeakDetection #div-ld-listOfSavedLPs-error').show()
						$('#div-step4LeakDetection #div-ld-listOfSavedLPs-error').text('No saved leak points sets. Start creating them below')
					}
				}
				else{
					$('#div-step4LeakDetection #div-ld-listOfSavedLPs-error').show()
					$('#div-step4LeakDetection #div-ld-listOfSavedLPs-error').text('Error on loading leak points sets.')
				}
			},
			error: function(response){
				dm.dialog("close")
				$('#div-step4LeakDetection #div-ld-listOfSavedLPs-error').show()
				$('#div-step4LeakDetection #div-ld-listOfSavedLPs-error').text('Error on loading leak points sets.')
				buildDynamicModalPopup('Error!', 
					'<p>An error on loading sets of leak points occured.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				console.log('optionsStep4LeakDetection listOfSavedLPs error! ')
			}
		});
	}
	function onLoadStep4LeakDetectionLoadLeakPoints(_url, LAYER_NAME, colorShow="#1fbbd9"){
		buildDynamicModalPopup('Loading points...', 
			'<p>Please wait...</p>', 
			[], [250,220])
		reverseRemoveLayerEqual(LAYER_NAME)
		reverseRemoveLayerEqual(LAYER_NAME+'-2nd_deriv')
		
		$.ajax({ type: "GET", url: _url, async: true,
			success : function(response){
				dm.dialog("close")
				j = $.parseJSON(JSON.stringify(response));
				raster_id = j['raster_id']
				if (LAYER_NAME.indexOf('-edit')>-1){
					//load 2nd deriv raster
					intermediateRasterEndpoint = '/portal/proxy/intermediate/raster/tiles/'+raster_id
					console.log(intermediateRasterEndpoint)
							
					minBar = parseFloat(j['min'].toFixed(3))-0.001
					maxBar = parseFloat(j['max'].toFixed(3))+0.001
					colorFrom =  [0,0,255]
					colorOver = [200,200,200]
					colorTo = [10,10,10]
					
					rl0 = new ol.layer.Tile({
						name: LAYER_NAME+'-2nd_deriv',
						extent: chosenROI.getSource().getExtent(),
						source: new ol.source.XYZ({
						url: intermediateRasterEndpoint+'/{z}/{x}/{y}.png?colormap={"continuous":"True","from":['+colorFrom[0]+','+colorFrom[1]+','+colorFrom[2]+'],"over":['+colorOver[0]+','+colorOver[1]+','+colorOver[2]+'],"to":['+colorTo[0]+','+colorTo[1]+','+colorTo[2]+'],"range":['+minBar+','+maxBar+']}',
						opaque: false
						})
					})
					rl0.setZIndex(12)
					fname = LAYER_NAME+'-2nd_deriv'
					rl0.setProperties({'fname': fname,'raster_id':raster_id})
					//console.log(rl.getProperties())
					map.addLayer(rl0)
				}
				
				//load leak points
				detected_leaks = j['leak_points']
				//colorShow = "#1fbbd9"//$("#user"+user_id+"_leak"+object_id+"_linecolor polygon").attr('fill')
				_styleColor = _create_style_leak_points(colorShow)
				_styleBlack = _create_style_leak_points("#220022")
				rls = []
				for(var s=0; s<detected_leaks.length; s++){
					var x = detected_leaks[s]['xCoordinate']
					var y = detected_leaks[s]['yCoordinate']
					var value = detected_leaks[s]['pixelValue']
					var point_leak_id = detected_leaks[s]['id']
					var url_point = _url
					url_point = url_point.replace('show_user_leak_point','edit_user_leak_point')+'&point_leak_id='+point_leak_id
					var show_leak_point = detected_leaks[s]['showLeakPoint']
					var lonlat = ol.proj.transform([x,y], 'EPSG:3857', 'EPSG:4326');
					var lonlat2 = lonlat//[lonlat[1],lonlat[0]]
					rls[s] = new ol.layer.Vector({
						name: LAYER_NAME+'-'+point_leak_id,
						source: new ol.source.Vector({ 
							features: [new ol.Feature({ geometry: new ol.geom.Point( ol.proj.fromLonLat(lonlat2) ), })] 
						}),
						style: (show_leak_point? _styleColor : _styleBlack)
					});
					if(LEFT_PANEL_MODE!=null && LEFT_PANEL_MODE.indexOf('edit-leak')>-1){ 
						fname = $('#showStateLeakDetection #ld_name').text() }
					else{
						fname = '??????' //$('#simulation_139_ld_50_uslp_27_name').text()
					}
					fname += '|'+point_leak_id+'\n'
					console.log(fname)
					rls[s].setProperties({'fname': fname, /*'raster_id':raster_id, */'url_point': url_point})
					rls[s].setZIndex(21)
				}
				rl = new ol.layer.Group({
					name: LAYER_NAME,
					layers: rls
				})
				if(LEFT_PANEL_MODE!=null && LEFT_PANEL_MODE.indexOf('edit-leak')>-1){ 
					fname = $('#showStateLeakDetection #ld_name').text() }
				else{
					fname = '??????' //$('#simulation_139_ld_50_uslp_27_name').text()
				}
				console.log(fname)
				rl.setProperties({'fname': fname/*,'raster_id':raster_id*/})
				map.addLayer(rl);
				//listActiveLayers()
			},
			error: function(response){
				dm.dialog("close")
				buildDynamicModalPopup('Error!', 
					'<p>An error on loading sets of leak points occured.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				console.log('optionsStep4LeakDetection listOfSavedLPs error! ')
			}
		});
	}




	function onClickLeakDetectionUserSetLeakPoint(type, id){
		_roi_id = jsonCreateLeakDetection['step1ImageSelection']['roi_id']
		_simulation_id = jsonCreateLeakDetection['step1ImageSelection']['simulation_id']
		if (type=='view'){
			_url = '/portal/waterleak/leakdetection/rois/'+_roi_id+'/simulations/'+_simulation_id+'/leak_detections/'+EDIT_LEAK_DETECTION_ID+'/show_user_leak_point'
			_url += '?user_leak_id='+id
			onLoadStep4LeakDetectionLoadLeakPoints(_url, "ld"+EDIT_LEAK_DETECTION_ID)
		}
		else if (type=='delete'){			
			buildDynamicModalPopup('Warning!', 
				'<p>You are about to delete this set of leak points. Are you sure?</p>',[
					['Yes', function(){ 
						dm.dialog( "close" )
						_url = '/portal/waterleak/leakdetection/rois/'+_roi_id+'/simulations/'+_simulation_id+'/leak_detections/'+EDIT_LEAK_DETECTION_ID+'/delete_user_leak_points'
						_url += '?user_leak_id='+id
						console.log(_url)
						$.get(_url)
							.done(function(data){
								var answer = $.parseJSON(JSON.stringify(data)); 
								console.log(answer)
								console.log(data)
								if(answer['alert']=='deleted'){
									dm.dialog( "close" );
									reverseRemoveLayerIndexOf('ld')//+EDIT_LEAK_DETECTION_ID)
									onLoadStep4LeakDetectionLoadList()
								}
								else{
									dm.dialog( "close" );
									//console.log('done')
									buildDynamicModalPopup('Error!', 
										'<p>Something went wrong and we were unable to delete this set of leak points, try again!</p>', 
										[['OK', function(){ dm.dialog( "close" )} ]], [250,220])
								}
							})
							.fail(function( xhr, textStatus, errorThrown ){
								//console.log('fail')
								console.log( xhr, textStatus, errorThrown)
								dm.dialog( "close" );
								buildDynamicModalPopup('Error!', 
									'<p>Something went wrong and we were unable to delete this set of leak points, try again!</p>', 
									[['OK', function(){ dm.dialog( "close" )} ]], [250,220])
							})
					}],
					['No', function(){
						$(this).dialog( "close" )
					}]
				], [300,220])
		}
	}

	function onClickStep4LeakDetectionViewLeakPoints(){
		if ($('#div-step4LeakDetection #step4LeakDetectionView').attr('disabled') != 'disabled'){
			//load
			min_leak_points = parseInt($('#div-step4LeakDetection #numberLeakPoints').prop('min'))
			max_leak_points = parseInt($('#div-step4LeakDetection #numberLeakPoints').prop('max'))
			if($('#div-step4LeakDetection #numberLeakPoints').val()==''){
				buildDynamicModalPopup('Error!', 
					'<p>Please provide a number of maximum leak points.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
			else if(parseInt($('#div-step4LeakDetection #numberLeakPoints').val())<min_leak_points){
				buildDynamicModalPopup('Error!', 
					'<p>Number of leak points is below '+min_leak_points+'</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
			else if(parseInt($('#div-step4LeakDetection #numberLeakPoints').val())>max_leak_points){
				buildDynamicModalPopup('Error!', 
					'<p>Number of leak points is above '+max_leak_points+'</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
			else {
				_roi_id = jsonCreateLeakDetection['step1ImageSelection']['roi_id']
				_simulation_id = jsonCreateLeakDetection['step1ImageSelection']['simulation_id']
				_url = '/portal/waterleak/leakdetection/rois/'+_roi_id+'/simulations/'+_simulation_id+'/leak_detections/'+EDIT_LEAK_DETECTION_ID+'/show_leak_points'
				_url += '?number_points='+$('#div-step4LeakDetection #numberLeakPoints').val()
				onLoadStep4LeakDetectionLoadLeakPoints(_url, "ld"+EDIT_LEAK_DETECTION_ID)
			}
		}
	}
	function onClickStep4LeakDetectionSaveLeakPoints(){
		if ($('#div-step4LeakDetection #step4LeakDetectionSave').attr('disabled') != 'disabled'){
			min_leak_points = parseInt($('#div-step4LeakDetection #numberLeakPoints').prop('min'))
			max_leak_points = parseInt($('#div-step4LeakDetection #numberLeakPoints').prop('max'))
			if($('#div-step4LeakDetection #numberLeakPoints').val()==''){
				buildDynamicModalPopup('Error!', 
					'<p>Please provide a number of maximum leak points.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
			else if(parseInt($('#div-step4LeakDetection #numberLeakPoints').val())<min_leak_points){
				buildDynamicModalPopup('Error!', 
					'<p>Number of leak points is below '+min_leak_points+'</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
			else if(parseInt($('#div-step4LeakDetection #numberLeakPoints').val())>max_leak_points){
				buildDynamicModalPopup('Error!', 
					'<p>Number of leak points is above '+max_leak_points+'</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
			else if($('#div-step4LeakDetection #nameLeakPoints').val() == ''){
				buildDynamicModalPopup('Error!', 
					'<p>Please provide a name for the leak points.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}
			else{
				//store!
				jsonR = {}
				jsonR['number_points']=parseInt($('#div-step4LeakDetection #numberLeakPoints').val())
				jsonR['name']=$('#div-step4LeakDetection #nameLeakPoints').val()
				_roi_id = jsonCreateLeakDetection['step1ImageSelection']['roi_id']
				_simulation_id = jsonCreateLeakDetection['step1ImageSelection']['simulation_id']
				_url = '/portal/waterleak/leakdetection/rois/'+_roi_id+'/simulations/'+_simulation_id+'/leak_detections/'+EDIT_LEAK_DETECTION_ID+'/save_user_leak_points'
				buildDynamicModalPopup('Saving', 
					'<p>Please wait...</p>', 
					[], [250,220])
				$.post(_url, JSON.stringify(jsonR))
					.done(function( data ) {
						var answer = $.parseJSON(JSON.stringify(data)); 
						if(answer['alert']=='submitted'){
							//console.log(answer)
							dm.dialog( "close" );
							LAYER_NAME = "ld"+EDIT_LEAK_DETECTION_ID
							reverseRemoveLayerEqual(LAYER_NAME)
							//listActiveLayers()
							$('#div-step4LeakDetection #numberLeakPoints').val('35')
							$('#div-step4LeakDetection #nameLeakPoints').val('')
							onLoadStep4LeakDetectionLoadList()						
						}
						else{
							//console.log(answer)
							dm.dialog( "close" );
							buildDynamicModalPopup('Error', 
								'<p>Something went wrong while creating a set of leak points. Try again.</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						}
					})
					.fail(function( xhr, textStatus, errorThrown ){
						console.log( xhr, textStatus, errorThrown)
					})	
			}
		}
	}


	/*function optionsStep5OCConnection(){
		disableSubaccordion(!$('#div-step5OCConnection #accordion1 #step5OCConnection-enable').prop('checked'), '#div-step5OCConnection #accordion1 #step5OCConnection-options')
		$('#div-step5OCConnection #accordion1 input[name=optOCConfig]').prop('disabled', !$('#div-step5OCConnection #accordion1 #step5OCConnection-enable').prop('checked'))
		$('#div-step5OCConnection #accordion1 #oc-deployment-id').prop('disabled', !$('#div-step5OCConnection #accordion1 #step5OCConnection-enable').prop('checked'))
	}*/

	
	function onClickInfoButton(ref){
		if (ref == 'step1ROI'){
			buildDynamicModalPopup('Information', 
				'<b>Step 1 - Region of Interest (RoI)</b>'+
				'<p>To start a new processing, user must create or select a Region of Interest.</p>'+
				'<p>RoI are regions created by the user for processing imagesets and further products.</p>'+
				'<p>-Each processing will be associated to a user RoI. </p>'+
				'<p>-Each user RoI can create multiple processing as he wants in coastal and inland services. Except in water leak service, where for each user RoI must exist only one processing (by using imagesets from Sentinel2).</p>'+
				'<b>Creating a RoI:</b>'+
				'<p>1- User must set a name for the new RoI</p>'+
				'<p>2- User must select a way to create its RoI, by drawing or by uploading a CSV file.</p>'+
				'<p> --Draw rectangle: select this option and click on the button, and start drawing on the map. After drawing, the coordinates will be displayed on the coordinate fields.</p>'+
				'<p> --Upload a CSV: click on "choose file" and select the CSV file you created, WORSICA will start automatically upload. After upload, the coordinates will be displayed on the coordinate fields. Click on the information icon for detailed instructions </p><br>'+
				'<b>Select an exisiting RoI:</b>'+
				'<p>User is not forced to create a RoI for each processing. User can select an existing RoI.</p>'+
				'<p>Scroll down this menu, to the dropdown on "Select an existing RoI." '+
				'<p>By default, WORSICA sets this dropdown as "--- Region of Interest ---" to create a RoI. </p>'+
				'<p>Click on the dropdown to select an existing RoI. </p>',				
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'step1ROI-create-uploadcsv'){
			buildDynamicModalPopup('Upload CSV', 
				'<b>Instructions in order to upload a CSV file to create ROI:</b>'+
				'<p>1) Create an empty CSV file with your text editor of your preference.</p>'+
				'<p>2) Add a single line that contains the coordinates, each one separated by comma, no spaces, like this:</p>'+
				'<p>LON_MAX,LAT_MAX,LON_MIN,LAT_MIN</p><br>'+
				'<p>3) Here, click on "choose file" and select the CSV file you created, WORSICA will start automatically upload. A blue bar means the file is/has uploaded succesfully the file. A red bar means error. </p><br>'+
				'<b>Before uploading, take in account the following:</b>'+				
				'<p>- The single line you will insert on CSV must be LON_MAX,LAT_MAX,LON_MIN,LAT_MIN (e.g: 39.546147,-9.043121,39.634514,-9.129639)</p>'+
				'<p>- The coordinates decimals must be ONLY dots</p>'+
				'<p>- You can also invert their order as LON_MIN,LAT_MIN,LON_MAX,LAT_MAX. WORSICA knows how to represent correctly the max/min of coordinates on the fields below.</p>'+
				'<p>- File must be a CSV and not bigger than 512 bytes, WORSICA shows an error if this limit is exceeded or file is not CSV.</p>', 
				[['Close', function(){ $(this).dialog( "close" )} ]], [500,480])
		}
		else if (ref == 'step2Inputs'){
			buildDynamicModalPopup('Information', 
				'<b>Step 2 - Inputs</b>'+
				'<p>Here you can select a public or private provider for the inputs you want for your processing.</p>'+
				'<p>- The public ones will provide available products online that can be downloaded for free.</p>'+
				'<p>- The private ones are paid, and thus must be the user to upload them to this service.</p>'+
				'<p>At the moment, the only working provider available is Sentinel2.</p>'+
				'<b>For Sentinel2, you have the following options to select: </b>'+
				'<p>Level 1C: Select this option if you want to search and process L1C images. These images are Top of Atmosphere, they can be used, but in some cases are not good for the detection. Applying atmospheric correction will improve them by making them Bottom of Atmosphere, these images will look similiar as Level 2A ones. </p>'+
				'<p>Level 2A: Select this option if you want to search and process L2A images. These images are Bottom of Atmosphere, best for the detection. Select a filter search by cloud coverage if you want to filter your image search on inputs revision. Clouds do affect the detection. Lower cloud coverage means less clouds. </p>'+
				'<p>Monitoring period (only on Coastal and Inland): Select the date period for the image search.</p>',				
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'step3InputsRevision'){
			buildDynamicModalPopup('Information', 
				'<b>Step 3 - Image selection</b>'+
				'<p>In this list, you can select the available inputs from your chosen input provider for your processing.</p>'+
				'<p>Please select at least one imageset. To select an input for processing, click on the checkbox on the left.</p>'+
				'<p>Take note that there will be more than one image for the same day, these images are different because they are obtained from different orbits.</p>'+
				'<p>You do not need to select all of them, just the ones that cover your RoI.</p>'+
				'<p>To make sure you are choosing the right images, for each image click on its thumbnail on the right, to show the boundary box of that imageset.</p>'+
				'<p>The top buttons are for selecting/deselecting all available images from the list.</p>',				
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'step4Detection'){
			buildDynamicModalPopup('Information', 
				'<b>Step 4 - Detection settings</b>'+
				'<p>Here you can select the available water indexes for your processing.</p>'+
				'<p>Please select at least one water index. Choose wisely, each water index is calculated differently, and dependending of the case, some of them provide better detection results than others.</p>'+
				'<p>You can also apply a value for threshold filtering, this is a pixel value (between -1 and 1) to allow the algorithm to differentiate water from land, thus making easier the coastline/water body detection.</p>'+
				'<p>If you do not know the adequate water threshold, click on auto threshold, this allows WORSICA to determine autmatically.</p>'+
				'<p>Each water index has its own explanation and purpose, click on their information icon.</p>'+
				'<br>'+
				'<b>Automatic threshold for the water indexes</b>'+
				'<p>The automatic threshold algorithm implemented in WORSICA is based on the Modified Histogram Bimodal Method (MHBM), developed by Zhang et al. (2018).</p>'+
				'<i>Fangfang Zhang, Junsheng Li, Bing Zhang, Qian Shen, Huping Ye, Shenglei Wang, Zoe lu, 2018. A simple automated dynamic threshold extraction method for the classification of large water bodies from landsat-8 OLI water index images.  International Journal of Remote Sensing, 39(11):3429-3451. DOI: 10.1080/01431161.2018.1444292</i>',				
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'step4Detection-ndwi'){
			buildDynamicModalPopup('Information', 
				'<b>NDWI</b>'+
				'<p>NDWI = (Green-NIR)/(Green+NIR)</p>'+				
				'<br>'+
				'<p>Green = pixel values from the green band (Sentinel-2 / Band 3 / 0.560 m)</p>'+
				'<p>NIR = pixel values from the NIR band (Sentinel-2 / Band 8 / 0.842 m)</p>'+
				'<br>'+
				'<p>Used to monitor changes related to water content in water bodies, using green and NIR wavelengths, defined by McFeeters (1996)</p>'+
				'<i>S. K. McFEETERS (1996) The use of the Normalized Difference Water Index (NDWI) in the delineation of open water features, International Journal of Remote Sensing, 17:7, 1425-1432, DOI: 10.1080/01431169608948714</i>',
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'step4Detection-mndwi'){
			buildDynamicModalPopup('Information', 
				'<b>MNDWI</b>'+
				'<p>MNDWI = (Green - SWIR)/(Green + SWIR)</p>'+
				'<br>'+
				'<p>Green = pixel values from the green band (Sentinel-2 / Band 3 / 0.560 m)</p>'+
				'<p>SWIR = pixel values from the short-wave infrared band (Sentinel-2 / Band 11 / 1.610 m)</p>'+
				'<br>'+
				'<p>The Modified Normalized Difference Water Index (MNDWI) uses green and SWIR bands for the enhancement of open water features. It also diminishes built-up area features that are often correlated with open water in other indices.</p>'+
				'<i>Xu, H. "Modification of Normalised Difference Water Index (NDWI) to Enhance Open Water Features in Remotely Sensed Imagery." International Journal of Remote Sensing 27, No. 14 (2006): 3025-3033." (ESRI, 2018)</i>',
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'step4Detection-mndwi2'){
			buildDynamicModalPopup('Information', 
				'<b>MNDWI2</b>'+
				'<p>MNDWI2 = (Green - SWIR2) / (Green + SWIR2)</p>'+
				'<br>'+
				'<p>Green = pixel values from the green band (Sentinel-2 / Band 3 / 0.560 m)</p>'+
				'<p>SWIR2 = pixel values from the short-wave infrared band (Sentinel-2 / Band 12 / 2.190 m)</p>'+
				'<br>'+
				'<p>The Modified Normalized Difference Water Index 2 (MNDWI 2) uses green and SWIR2 bands for the enhancement of open water features.</p>'+
				'',				
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'step4Detection-awei'){
			buildDynamicModalPopup('Information', 
				'<b>AWEI</b>'+
				'<p>AWEI = 4 * (Green - SWIR2) - (0.25 * NIR + 2.75 * SWIR1)</p>'+
				'<br>'+
				'<p>Green = pixel values from the green band (Sentinel-2 / Band 3 / 0.560 m)</p>'+
				'<p>NIR = pixel values from the NIR band (Sentinel-2 / Band 8 / 0.842 m)</p>'+
				'<p>SWIR1 = pixel values from the short-wave infrared band (Sentinel-2 / Band 11 / 1.610 m)</p>'+
				'<p>SWIR2 = pixel values from the short-wave infrared band (Sentinel-2 / Band 12 / 2.190 m)</p>'+
				'<br>'+
				'<p>This index is suited for situations where shadows are not a major problem.</p>'+
				'<i>Mustafa Mustafa T., Hassoon Khalid I., Hassan Modher and Abd Modher H. "Using water indices (NDWI, MNDWI, NDMI, WRI and AWEI) to detect physical and chemical parameters by apply remote sensing and GIS techniques". International Journal of Research - Granthaalayah 5, no. 10 (2017): 117-128.</i>',				
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'step4Detection-aweish'){
			buildDynamicModalPopup('Information', 
				'<b>AWEISH</b>'+
				'<p>AWEIsh = Band1  + 2.5 * Band2 - 1.5 * (Band4 + Band5) - 0.25 * Band7</p>'+
				'<br>'+
				'<p>Band1 - Coastal aerosol (0.443 m)</p>'+
				'<p>Band2 - Blue (0.490 m) </p>'+
				'<p>Band4 - Red (0.665 m)</p>'+
				'<p>Band5 - Vegetation Red Edge (0.705 m)</p>'+
				'<p>Band7 - Vegetation Red Edge (0.783 m)</p>'+
				'<br>'+
				'<p>The subscript "sh" AWEIsh indicates that the index equation is intended to effectively eliminate shadow pixels and improve water extraction accuracy in areas with shadow and/or other dark surfaces. But this index should not be used in areas with highly reflective surfaces such as ice, snow and reflective roofs in urban areas, since it may misclassify such surfaces as water.</p>'+
				'<i>Feyisa G.L., Meilby H., Fensholt R., Proud S.R. Automated water extraction index: A new technique for surface water mapping using Landsat imagery. Remote Sens. Environ. 2014;140:2335. doi: 10.1016/j.rse.2013.08.029.</i>',				
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'step6Run'){
			buildDynamicModalPopup('Information', 
				'<b>Step 6 - Run</b>'+
				'<p>Here you can see a brief summary of your processing before submission.</p>'+
				'<p>In coastal and inland, you must provide at least a name for it. In water leak, the name is automatically generated.</p>'+
				'<p>When ready, click on Start to be submitted for execution.</p>',				
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'visualization-selectdetections'){
			buildDynamicModalPopup('Information', 
				'<b>--- I. Introduction ---</b>'+
				'<p>On the Visualization, in order to see the available processed products for each simulation to choose:</p>'+
				'<p>1) Click on the blue arrow that appear before the simulation name to show a list of processed images for that simulation.</p>'+
				'<p>2) For each processed image, click again on the blue arrow to see the list of processed products.</p>'+
				'<p>3) Click on the checkboxes to show/hide processed products raster on the map.</p>'+
				'<p>4) If you have choose one product raster, you can use the eyedropper to check its pixel value (only the top one is checked)</p><br>'+
				'<b>--- II. Processing steps ---</b>'+
				'<p>1) Download: Each imageset is downloaded by the WORSICA service. For the user owned images, the user must first upload it through User Repository. </p>'+
				'<p>2) Conversion: (only exclusive for Sentinel2 L1C products) If the option "atmospheric correction" was set on the configuration, each imageset will be converted from ToA to BoA, that conversion will remove the cirrus from the imageset for a better detection.</p>'+
				'<p>3) Resample: Each imageset is resampled/cropped to match the processing requirements.</p>'+
				'<p>4) Merge: Imagesets taken on the same day from different orbits will be merged to provide the correct output.</p>'+
				'<p>5) Process: Create RGB image (for coastal/inland only), water indexes and other processing outputs.</p>'+
				'<p>6) Store: Store processing outputs to the DB.</p><br>'+				
				'<b>--- III. Actions ---</b>'+
				'<p>- RUN: Start the processing from the point where it stopped/failed.'+
				'<p>- EDIT: Open the workflow to edit simulation details (inputs revision, detection and run) and restart all the processing to zero.'+
				'<p>- STOP: Stop the processing (will change the state of the processing as error).'+
				'<p>- DELETE: Delete the processing, only if it is not running or failed at some point.</p>'+
				'<b>--- IV. Processing states ---</b>'+
				'<p>Depending of the state of the simulation (rightmost icon):</p>'+
				'<p>- If the icon is Green, it means it has processed (one of the steps of) the simulation, so you can EDIT or DELETE it.</p>'+
				'<p>- If the icon is Yellow, it means it is processing (one of the steps of) the simulation, so you only can STOP it.</p>'+
				'<p>- If the icon is Red, it means it failed processing (one of the steps of) the simulation, so you can RUN, EDIT or DELETE it.</p>'+
				'<p>Hint: You can hover your mouse on the icon to see its status on a tooltip. Also you can click on that icon to see the current processing simulation status with more details.</p><br>'+
				'<b>--- V. Leak Detections (only on LEAK DETECTION IN IRRIGATION NETWORKS SERVICE) ---</b>'+
				'<p>Leak detection consists in applying a processing chain to detect the possible leaks, described by 3 steps.</p>'+
				'<p>1) Calculate the Anomaly by doing the difference of the index image with its climatology.</p>'+
				'<p>2) Apply 2nd derivative (LaPlacian) </p>'+
				'<p>3) Find the possible leaks by the lowest value.</p>'+	
				'<p>4) Apply leak filtering.</p>'+
				/*'<p>You can do it in two different ways:</p>'+
				'<p>- By Anomaly: For each water index, will apply these steps for each processed water index product for that imageset. </p>'+
				'<p>- By Index: Skips the anomaly (step 1) and applies 2nd derivative (LaPlacian) on each processed water index product for that imageset. And continues the normal procedure from there. </p>'+
				'<p>In order to start a leak detection, navigate through the nested list by clicking on the arrow to open the processed image and again on the arrow to see the list of products.</p>'+
				'<p>On each "Leak detection" you have:'+
				'<p>- Progress bar: helps you to know the progression.</p>'+
				'<p>- Green button: take attention this runs ONLY EACH STEP of the leak detection at a time. This leak detection is not done automatically one-shot, this allows the user to choose if wants to continue processing by clicking on that button, or giving up.</p>'+
				'<p>- State icon: tells you what is he doing while running each step. Hover your mouse on the icon to see its status on tooltip.</p>'+
				'<p>- A product list will be shown below. At the beginning, it is empty, but will start populating after running each step.</p>'+
				'<p>After running the step 3 (find the possible leaks), you are able to choose to view possible leaks on the map. Also you can edit them (with instructions), or download available shown leaks as kml.</p>'+
				'<b>--- VI. Leak Filtering ---</b>'+
				'<p>The leak filtering uses the user provided inputs to filter only the valid points that are near of pipe networks.</p>'+
				'<p>- User must first upload a Pipe Network and/or a binary mask on the User Repository. User must make sure that the uploaded inputs are loaded on the User Repository and do cover/intersect the region of interest.</p>'+
				'<p>- When the user starts a leak filtering, WORSICA starts first by generating a binary mask from the uploaded pipe networks that cover the region of interest and then applies the filtering to the leak points of all processed water indexes.</p>'+
				'<p>- Take in account that filtering consists in hiding the points on the map, not deleting them. If you go to edit, you still can see them as black circles.</p>'+
				*/'<br>',
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'visualization-activelayers'){
			buildDynamicModalPopup('Information', 
				'<b>Active Layers</b>'+
				'<p>This tool will help you to manage layers on the map.</p>'+
				'<p>Select the layers you want through Visualization, for each added layer, you can:</p>'+
				'<p>-Move to the top: allows to move a layer to the top. </p>'+
				'<p>-Deselect: allows the user to deselect quickly a layer from the map.</p>',				
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,280])
		}
		else if (ref == 'visualization-ruler'){
			buildDynamicModalPopup('Information', 
				'<b>Measure</b>'+
				'<p>This tool will allow to measure perimeters/areas on the map by clicking and marking points on the map.</p>'+
				'<p>First, click on the ruler icon to activate the mode.</p>'+
				'<p>To start, click on the map to mark a starting point. Start moving and clicking to create points.</p>'+
				'<p>To stop, do a double click on a point: one to mark, and another to end. The distance/area is shown on a tooltip. </p>'+
				'<p>Previous measurements are deleted on the map. Only the most recent measurement is shown on the map.</p>'+
				'<p>Press ESC to abort a measurement.</p>'+
				'<p>Note: You must choose eyedropper or measure for the interaction. Both cannot be used at same time.</p>',				
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'visualization-preview-pipe'){
			buildDynamicModalPopup('Information', 
				'<b>Preview pipe network</b>'+
				'<p>This tool will allows user to upload a pipe network and see it shown on map. This feature is only available on Visualization and View Leak Detection.</p>'+
				'<p>First, upload a ZIP file of the pipe network for preview on the map. ZIP must contain at least the .shp, .shx and .dbf files.</p>'+
				'<p>Then, click on upload button to start.</p>'+
				'<p>If upload is successful, the pipe network is shown on the map.</p>'+
				'<p>You are able to upload/preview one pipe network at a time. Uploading another one will remove the previous pipe network on map.</p>'+
				'<p>Note: Leaving Visualization/View Leak Detection will erase the uploaded pipe network on map.</p>',				
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'visualization-plot-sea-tide'){
			buildDynamicModalPopup('Information', 
				'<b>Tidal plot</b>'+
				'<p>This tool allows user to get the tidal levels for a point on the map, and download a file. Please check the Generate Topographic Maps information for more details.</p>'+
				'<p>User must define a z-reference, start and end date, as well selecting on a point on the map.</p>'+
				'<p>Then, click on Show Plot to load a spline chart of tidal levels.</p>'+
				'<p>After loading, user can Download the text file that can be used to generate topographic maps.  </p>'+
				'<p>Note: The end date can be >= than start date.</p>'+
				'<p>Note2: Tides are listed from 00:00:00 of starting date till 23:50:00 of ending date</p>',				
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
		else if (ref == 'visualization-generate-topo'){
			buildDynamicModalPopup('Information', 
				'<b>Generate Topography</b>'+
				'<p>This tool helps the user create topographic maps for a processed simulation by following the <b><i>Flood2Topo</i></b> methodology from Fassoni et al. 2021.</p>'+
				'<p><b><i>Flood2Topo</i></b> methodology steps:</p>'+
				'<p>1) User must always define a name for the topographic map, a z-reference, and choose Probing or Upload.</p>'+
				'<p>-If Probing, the user needs to click on a point on the map.</p>'+
				'<p>-If Upload, the user needs to upload a .txt tide file data.*</p>'+
				'<p>2) Then, click on Generate to start the generation.</p>'+
				'<p>-If Probing, WORSICA will automatically fetch the tide data according to the period of processed images on the simulation and generate topography.</p>'+
				'<p>-If Upload, the file is first uploaded, then WORSICA will use it to generate topography.**</p>'+
				'<p>3) After generation, the topographic maps will appear on the visualization.</p>'+
				'<p>* Only the tide files generated previously from the Sea Tide option can be used for the generation.</p>'+
				'<p>** user must make sure that the uploaded file contains tide data covering the period of processed images.</p>'+
				'<br>'+
				'<p>Reference:</p>'+
				'<p>Fassoni-Andrade, A. C., Durand, F., Moreira, D., Azevedo, A., dos Santos, V. F., Funi, C., and Laraque, A.: Comprehensive bathymetry and intertidal topography of the Amazon estuary, Earth Syst. Sci. Data, 13, 22752291, https://doi.org/10.5194/essd-13-2275-2021, 2021.</p>',				
				[['Close', function(){ $(this).dialog( "close" )} ]], [600,480])
		}
	}

	$(function(){
		$('#headerTitle').text(TITLE_SERVICE_NAME)
		closeLeftPanel()
		jsonCreateSimulation = createFreshBlobJsonSimulation(jsonCreateSimulation)
		jsonCreateLeakDetection = createFreshBlobJsonLeakDetection(jsonCreateLeakDetection)
		//LEFT PANEL
		loadRegionsOfInterest()
		/*$('#div-step1ROI #roiName').on('focus', function(){ step1chosenOpt = 'optCreate'; optionsStep1ROI()  })
		$('#div-step1ROI #accordion1 input[name="optCreateFrom"]').on('focus', function(){ step1chosenOpt = 'optCreate'; optionsStep1ROI() })
		$('#div-step1ROI #accordion1 #topLeftX').on('focus', function(){ step1chosenOpt = 'optCreate'; optionsStep1ROI() })
		$('#div-step1ROI #accordion1 #topLeftY').on('focus', function(){ step1chosenOpt = 'optCreate'; optionsStep1ROI() })
		$('#div-step1ROI #accordion1 #bottomRightX').on('focus', function(){ step1chosenOpt = 'optCreate'; optionsStep1ROI()})
		$('#div-step1ROI #accordion1 #bottomRightY').on('focus', function(){ step1chosenOpt = 'optCreate'; optionsStep1ROI()})*/
		$('#div-step1ROI #accordion2 #selectROI').val('roi_create')
		$('#div-step1ROI #accordion2 #selectROI').change(function(){ optionsStep1ROI() })
		//$('#div-step1ROI input[name="optAction"]').change(function(){ optionsStep1ROI() })
		$('#div-step1ROI input[name="optCreateFrom"]').change(function(){ optionsStep1ROI() })
		//$('#div-step1ROI input[name="optAction"][value="optSelect"]').click()
		optionsStep1ROI()
		disableDrawPolygonMode()
		disableMeasureMode()
		$('#div-step1ROI #accordion1 #fileupload').fileupload({
			dataType: 'json',
			replaceFileInput:false,
			add: function (e, data) { 
				$('#div-step1ROI #accordion1 #topLeftX').val('')
				$('#div-step1ROI #accordion1 #topLeftY').val('')
				$('#div-step1ROI #accordion1 #bottomRightX').val('')
				$('#div-step1ROI #accordion1 #bottomRightY').val('')
				if (drawUploadedROI != null){
					map.removeLayer(drawUploadedROI)
					drawUploadedROI = null
				}

				$('#div-step1ROI #accordion1 #divuploadfile #upload_loading').hide()
				$('#div-step1ROI #accordion1 #divuploadfile .progress-bar').css( 'background', '#2CC0DE')
				$('#div-step1ROI #accordion1 #divuploadfile .progress-bar').css( 'width', '0%')      
				//$('#textprogress').text('0%')     
				//$("#up_btn").off('click').on('click', function () {
				data.submit();
				buildDynamicModalPopup('Uploading', 
					'<p>Uploading file, please wait...</p>', 
					[], [250,220])
				//});
			},
			done: function (e, data) {
				dm.dialog( "close" );
				$('#div-step1ROI #accordion1 #divuploadfile #upload_loading').hide()
				$('.ui-dialog-buttonset button[type="button"]').prop('disabled','')
				if (data.result.alert == 'uploaded'){
					//update data here
					$('#div-step1ROI #accordion1 #topLeftX').val(parseFloat(data.result.lonMax).toFixed(5))
					$('#div-step1ROI #accordion1 #topLeftY').val(parseFloat(data.result.latMax).toFixed(5))
					$('#div-step1ROI #accordion1 #bottomRightX').val(parseFloat(data.result.lonMin).toFixed(5))
					$('#div-step1ROI #accordion1 #bottomRightY').val(parseFloat(data.result.latMin).toFixed(5))
					d = {
						'upperXcoordinate': parseFloat($('#div-step1ROI #accordion1 #topLeftX').val()),
						'upperYcoordinate': parseFloat($('#div-step1ROI #accordion1 #topLeftY').val()),
						'lowerXcoordinate': parseFloat($('#div-step1ROI #accordion1 #bottomRightX').val()),
						'lowerYcoordinate': parseFloat($('#div-step1ROI #accordion1 #bottomRightY').val()),
						'name': '',
						'roi_id': 0,
						'service': '',
						'color': '#00cc00'
					}
					drawUploadedROI = _createRoiLayer(d, 'uploaded_roi')
					drawUploadedROI.setZIndex(5)
					drawUploadedROI.setVisible(true)
					map.addLayer(drawUploadedROI)
				}
				else{
					$('#div-step1ROI #accordion1 #divuploadfile .progress-bar').css( 'background', '#bb0000')
					buildDynamicModalPopup('Error', 
						'<p>An error during upload occured: '+data.result.message+'.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					
				}
			},
			fail: function (e, data) {
				dm.dialog( "close" );
				$('#div-step1ROI #accordion1 #topLeftX').val('')
				$('#div-step1ROI #accordion1 #topLeftY').val('')
				$('#div-step1ROI #accordion1 #bottomRightX').val('')
				$('#div-step1ROI #accordion1 #bottomRightY').val('')
				if (drawUploadedROI != null){
					map.removeLayer(drawUploadedROI)
					drawUploadedROI = null
				}

				$('#div-step1ROI #accordion1 #divuploadfile .progress-bar').css( 'background', '#bb0000')
				$('#div-step1ROI #accordion1 #divuploadfile #upload_loading').hide()
				buildDynamicModalPopup('Error', 
					'<p>An error during upload occured: '+data.result.message+'.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			},
			progressall: function (e, data) {
				//$('#up_btn').prop('disabled','disabled')
				$('#div-step1ROI #accordion1 #topLeftX').val('')
				$('#div-step1ROI #accordion1 #topLeftY').val('')
				$('#div-step1ROI #accordion1 #bottomRightX').val('')
				$('#div-step1ROI #accordion1 #bottomRightY').val('')
				if (drawUploadedROI != null){
					map.removeLayer(drawUploadedROI)
					drawUploadedROI = null
				}

				$('#div-step1ROI #accordion1 #divuploadfile #upload_loading').show()
				$('.ui-dialog-buttonset button[type="button"]').prop('disabled','disabled')
				var progress = parseInt(data.loaded / data.total * 100, 10);
				$('#div-step1ROI #accordion1 #divuploadfile .progress-bar').css( 'width', progress + '%' );
				//$('#textprogress').text(progress + '%')
			}
		});

		//console.log($('#div-step2Inputs input[name="optInput"]:checked').prop('id'))
		$('#div-step2Inputs #beginDate').datetimepicker({ mask:true, timepicker: false, format: 'Y-m-d', /*minDate: '2020-02-01'*/})
		$('#div-step2Inputs #endDate').datetimepicker({ mask:true, timepicker: false, format: 'Y-m-d' })
		$('#div-step2Inputs #beginDate').val(lastYearDate.toISOString().split('T')[0])
		$('#div-step2Inputs #endDate').val(todayDate.toISOString().split('T')[0])
		$('#div-step2Inputs input[name="optInput"]').change(function(){ optionsStep2Inputs() })
		$('#div-step2Inputs input[name="optInput"][value="optInput1"]').click()
		$('#div-step2Inputs #filter-cloud-cov-l2').change(function(){ optionsStep2Inputs() })
		$('#div-step2Inputs input[name="optSentinel2"]').change(function(){ optionsStep2Inputs() })
		optionsStep2Inputs()
		
		{% if request.path == home_waterleak %}
		$('#div-step3InputsRevision #beginDateFilterList').datetimepicker({ mask:true, timepicker: false, format: 'Y-m-d', /*minDate: '2020-02-01'*/})
		$('#div-step3InputsRevision #endDateFilterList').datetimepicker({  mask:true, timepicker: false, format: 'Y-m-d' })
		$('#div-step3InputsRevision #beginDateFilterList').val(lastYearDate.toISOString().split('T')[0])
		$('#div-step3InputsRevision #endDateFilterList').val(todayDate.toISOString().split('T')[0])
		$('#div-step3InputsRevision input[name="optInputRevision"]').change(function(){ 
			optionsStep3InputsRevision()
			onChangeStep3InputRevisionType() 
		})
		{% endif %}
		optionsStep3InputsRevision()

		{% if request.path == home_waterleak %}
		$('#div-step1ImageSelection #beginDateLDFilterList').datetimepicker({ mask:true, timepicker: false, format: 'Y-m-d', /*minDate: '2020-02-01'*/})
		$('#div-step1ImageSelection #endDateLDFilterList').datetimepicker({ mask:true, timepicker: false, format: 'Y-m-d' })
		$('#div-step1ImageSelection #beginDateLDFilterList').val(lastMonthDate.toISOString().split('T')[0])
		$('#div-step1ImageSelection #endDateLDFilterList').val(todayDate.toISOString().split('T')[0])		
		{% endif %}

		if ($('#div-step4Detection #accordion1 #step4Detection-waterindex input[name="waterindex-chkbox"][type="checkbox"]:checked').length==0){
			$('#div-step4Detection #accordion1 #step4Detection-waterindex #'+DEFAULT_STEP4_WATER_INDEX).prop('checked',true)
		}
		{% if request.path == home_waterleak %}
		wi = ['ndwi',/*'ndwi1','ndwi2',*/'mndwi','mndwi2',/*'ndfi','ndmi',*/'awei','aweish'/*,'wri'*/]
		for (var w=0; w<wi.length; w++){
			//hide the default threshold value in water leak
			//console.log('#div-step4Detection #step4Detection-waterindex label[for="'+wi[w]+'"]')
			label = $('#div-step4Detection #step4Detection-waterindex label[for="'+wi[w]+'"]')[0].innerHTML
			$('#div-step4Detection #step4Detection-waterindex label[for="'+wi[w]+'"]')[0].innerHTML = label.replace(/\[(.*)\]/, "");
			$('#div-step4Detection #step4Detection-waterindex #'+wi[w]+'-subaccordion').hide()
		}
		{% endif %}
		optionsStep4SelectDetection()	

		{% if request.path == home_waterleak %}
		//WATER LEAK: Upload pipe for preview
		var sourcePreviewLayerGeometry = null
		$('#divuploadgeometry2 #status_message').css( 'color', '')
		$('#divuploadgeometry2 #status_message').empty()
		$('#new-info-preview-pipe-active #new-info-preview-pipe-table').empty()
		if ($('#new-info-preview-pipe-active #new-info-preview-pipe-table tr').length==0){
			$('#new-info-preview-pipe-active #new-info-preview-pipe-table').append(
				'<tr id="err-list-empty"><td><b>(No pipe networks uploaded for preview)</b></td></tr>')
		}
		$('#divuploadgeometry2 .progress-bar').css( 'background', '#2CC0DE')
		$('#divuploadgeometry2 .progress-bar').css('width', '0%')
		$('#divuploadgeometry2 #fileupload2').val('')
		$('#divuploadgeometry2 #fileupload2').fileupload({
			dataType: 'json',
			replaceFileInput:false,
			add: function (e, data) { 
				$('#divuploadgeometry2 #status_message').css( 'color', '')
				$('#divuploadgeometry2 #status_message').empty()
				$('#divuploadgeometry2 .progress-bar').css( 'background', '#2CC0DE')
				$('#divuploadgeometry2 .progress-bar').css( 'width', '0%')      
				data.context = $('<button style="background-color: #2CC0DE"></button>').text('Upload')
					.appendTo('#divuploadgeometry2 #status_message')
					.click(function () {
						data.context = $('#divuploadgeometry2 #status_message').text('Uploading file, please wait...')//.replaceAll($(this));
						data.submit();
						buildDynamicModalPopup('Uploading file!', 
							'<p>Please wait...</p>', 
							[], [250,220])
					});
				
			},
			done: function (e, data) {
				dm.dialog( "close" );
				$('.ui-dialog-buttonset button[type="button"]').prop('disabled','')
				if (data.result.alert == 'success'){
					//$('#divuploadgeometry2 .progress-bar').css( 'background', '#2CC0DE')
					$('#divuploadgeometry2 #status_message').css( 'color', '#00bb00')					
					$('#divuploadgeometry2 #status_message').empty()
					fn = $('#divuploadgeometry2 #fileupload2').val().split(/(\\|\/)/g).pop().split('.')[0]
					//$('#divuploadgeometry2 #status_message').append("<b>"+fn+" loaded!</b>")
					$('#divuploadgeometry2 #fileupload2').val('')
					$('#divuploadgeometry2 .progress-bar').css( 'width', '0%') 
					//
					
					var f = new ol.format.GeoJSON()
					var feats = f.readFeatures(data.result.feature_collection,{ featureProjection: 'EPSG:4326' })
					var jr2 = f.writeFeaturesObject(feats)
					var tile_extent = 4096
					var tileIndex = geojsonvt(jr2, {
						extent: tile_extent,
						tolerance: 0,
						maxZoom: 20,
						debug: 0
					});
					var tilePixels = new ol.proj.Projection({
						code: 'TILE_PIXELS',
						units: 'tile-pixels',
					});
					var replacer = function(key, value) {
						if (value && value.geometry) {
							var type;
							var rawType = value.type;
							var geometry = value.geometry;

							if (rawType === 1) {
								type = 'MultiPoint';
								if (geometry.length == 1) {
									type = 'Point'; geometry = geometry[0];
								}
							} else if (rawType === 2) {
								type = 'MultiLineString';
								if (geometry.length == 1) {
									type = 'LineString'; geometry = geometry[0];
								}
							} else if (rawType === 3) {
								type = 'Polygon';
								if (geometry.length > 1) {
									type = 'MultiPolygon'; geometry = [geometry];
								}
							}

							return {
								'type': 'Feature',
								'geometry': {
									'type': type,
									'coordinates': geometry
								},
								'properties': value.tags
							};
						} else {
							return value;
						}
					};

					var sourcePreviewGeometry = new ol.source.VectorTile({
						format: new ol.format.GeoJSON(),
						tileLoadFunction: function(tile) {
							var format = tile.getFormat();
							var tileCoord = tile.getTileCoord();
							//console.log(tile.getExtent())
							var data = tileIndex.getTile(tileCoord[0], tileCoord[1], -tileCoord[2] - 1);
							var features = format.readFeatures(
								JSON.stringify({
									type: 'FeatureCollection',
									features: data ? data.features : []
								}, replacer));
							tile.setLoader(function() {
								tile.setFeatures(features);
								tile.setProjection(tilePixels);
							});
						},
						url: 'data:' // arbitrary url, we don't use it in the tileLoadFunction
					});
					var rcolor = generateRandomHexColor();
					var sourcePreviewLayerGeometry = new ol.layer.VectorTile({
						name: 'preview_pipe_'+fn,
						source: sourcePreviewGeometry,
						style: new ol.style.Style({	        
							stroke: new ol.style.Stroke({ color: rcolor, width: 2 }),
							fill: new ol.style.Fill({ color: rcolor })
						})
					});
					//delete		
					if ($('#new-info-preview-pipe-active #new-info-preview-pipe-table #preview_pipe_'+fn).length>0){
						$('#new-info-preview-pipe-active #new-info-preview-pipe-table #preview_pipe_'+fn).remove()
						reverseRemoveLayerEqual('preview_pipe_'+fn)
					}
					$('#new-info-preview-pipe-active #new-info-preview-pipe-table #err-list-empty').remove()
					
					sourcePreviewLayerGeometry.setZIndex(20)	
					map.addLayer(sourcePreviewLayerGeometry)	
					var xtnt = new ol.source.Vector({ features: feats }).getExtent()
					//console.log(xtnt)
					var xtnt2A = ol.proj.transform([xtnt[0],xtnt[2]], 'EPSG:4326', 'EPSG:3857');
					var xtnt2B = ol.proj.transform([xtnt[1],xtnt[3]], 'EPSG:4326', 'EPSG:3857');
					//console.log(xtnt2A)
					//console.log(xtnt2B)
					map.getView().fit([xtnt2A[0],xtnt2A[1],xtnt2B[0],xtnt2B[1]], {maxZoom:11, duration:2000}); 
					$('#new-info-preview-pipe-active #new-info-preview-pipe-table').append(
						'<tr id=preview_pipe_'+fn+'>'+
							'<td style="width:9px;background-color:'+rcolor+'"></td>'+
							'<td style="width:84%; overflow: hidden; text-overflow: ellipsis">'+fn+'</td>'+
							'<td>'+
								'<a class="clickPreviewPipeRemove" onclick=onClickPreviewPipe("remove","preview_pipe_'+fn+'")><img height="24px" src="/static/images/remove.svg" title="Delete" style="margin:3px"></a>'+
								'<a class="clickPreviewPipeRemove" id="layerViewNoView" onclick=onClickPreviewPipe("viewnoview","preview_pipe_'+fn+'")><img height="24px" src="/static/images/view.svg" title="View/No View" style="margin:3px"></a>'+
							'</td>'+
						'</tr>'
					)					
				}
				else{
					$('#divuploadgeometry2 #status_message').css( 'color', '#dd0000')
					$('#divuploadgeometry2 #status_message').empty()
					$('#divuploadgeometry2 #status_message').append('<p>An error during upload occured: '+data.result.details+'.</p>')	
					$('#divuploadgeometry2 #fileupload2').val('')
					$('#divuploadgeometry2 .progress-bar').css( 'width', '0%') 
					buildDynamicModalPopup('Error!', 
						'<p>An error during upload occured: '+data.result.details+'.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,250])
				}
			},
			fail: function (e, data) {
				dm.dialog("close")
				$('#divuploadgeometry2 #status_message').css( 'color', '#dd0000')
				$('#divuploadgeometry2 #status_message').append('<p>An error during upload occured: '+data.result.message+'.</p>')
				$('#divuploadgeometry2 #fileupload2').val('')
				$('#divuploadgeometry2 .progress-bar').css( 'width', '0%') 
				buildDynamicModalPopup('Error!', 
					'<p>An error during upload occured: '+data.result.message+'.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			},
			progressall: function (e, data) {
				$('.ui-dialog-buttonset button[type="button"]').prop('disabled','disabled')
				var progress = parseInt(data.loaded / data.total * 100, 10);
				$('#divuploadgeometry2 .progress-bar').css( 'width', progress + '%' );
			}
		});

		//LEAK DETECTION		
		$('#div-step0DetectionSelection #select-ld-listOfDetection').change(function(){
			onChangeDropdownLeakConfigStep0DetectionSelection()
		})
		$('#div-step0DetectionSelection input[name="optDetectionSelection"]').change(function(){
			onChangeRadioDetectionStep0DetectionSelection()
		})
		$('#div-step1ImageSelection #select-ld-listOfROI').change(function(){
			onChangeDropdownROIStep1ImageSelection()
		})
		$('#div-step3LeakDetection #accordion1 input[name="optStep3LeakDetectionPipeNetwork"]').change(function(){
			onChangeStep3LeakDetectionPipeNetworkOptions()
		})
		$('#div-step3LeakDetection #accordion2 input[name="optStep3LeakDetectionMask"]').change(function(){
			onChangeStep3LeakDetectionMaskOptions()
		})
		{% endif %}
		
	})

	function onClickPreviewPipe(type, reference){//reference = preview_pipe_[name]
		if (type == 'remove'){
			$('#new-info-preview-pipe-active #new-info-preview-pipe-table #'+reference).remove()
			reverseRemoveLayerEqual(reference)
			if ($('#new-info-preview-pipe-active #new-info-preview-pipe-table tr').length==0){
				$('#new-info-preview-pipe-active #new-info-preview-pipe-table').append(
					'<tr id="err-list-empty"><td><b>(No pipe networks uploaded for preview)</b></td></tr>')
			}
		}
		else if(type == 'viewnoview'){
			map.getLayers().forEach(function(el) {
				if(el.get('name') !== undefined){
					if(el.get('name') === reference){
						console.log(reference)
						el.setVisible(!el.getVisible())
						if (!el.getVisible()){
							$('#new-info-preview-pipe-active #new-info-preview-pipe-table #'+reference+' #layerViewNoView img').attr('src','/static/images/noview.svg')
						}
						else{
							$('#new-info-preview-pipe-active #new-info-preview-pipe-table #'+reference+' #layerViewNoView img').attr('src','/static/images/view.svg')
						}
					}
				}
			})
		}
	}

</script>
{% block subcontent %}
{% endblock %}

{% endblock %}