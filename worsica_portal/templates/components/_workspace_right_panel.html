{% load staticfiles %}
<style>
	#rightPanel{
		padding:10px 10px 90px 10px; 
		width:480px; 
		max-width:480px;
		height: calc(100vh - 0px);
		top:80px; 
		position: absolute; 
		right:-480px; 
		background-color: #20222b; 
		z-index:100;
		overflow-y: auto;
		transition: right 0.2s linear;
	}
	#rightPanel .close{
		color: #1fbbd9;
		opacity: 1;
	}
	#rightPanel {
		color: #ffffff;
		width:100%
	}
	#rightPanel table {
		color: #ffffff;
		width:100%
	}
	/*#rightPanel #rightPanelTitle {
		font-size: 21px;
	}*/
	#rightPanel #rightPanelTitle {
		margin-top:25px;
		margin-bottom:25px;
	}
	#rightPanel #rightPanelTitle #title {
		text-align: left;
		font: Bold 32px/38px Roboto;
		letter-spacing: 0px;
		color: #FFFFFF;
	}
	#rightPanel .rightPanelSubtitle {
		text-align: left;
		font: Lighter 32px/38px Roboto;
		letter-spacing: 0px;
		color: #0CB5D4;
		opacity: 1;		
	}
	#rightPanel #rightPanelContent {
		overflow-y: hidden;
		height: 86%;
		position: static;
		/*scrollbar-color: #1fbbd9 #33363e;
		scrollbar-width: thin;*/
	}
	/*#rightPanel #rightPanelContent::-webkit-scrollbar-thumb{ background-color: #1fbbd9; }
    #rightPanel #rightPanelContent::-webkit-scrollbar-track{ background-color: #33363e; }*/
	#rightPanel #rightPanelContent #div-listOfROI{
		overflow-y:auto;
		max-height: 100px;
		height: 100px;
	}
	#rightPanel #rightPanelContent #div-listOfSimulations{
		overflow-y:auto; 
		height: calc(80vh - 400px)
	}
	#rightPanel #rightPanelNextButton {
		margin-top: 15px;
		margin-bottom: 5px;
	}
	
	
</style>

<div id="rightPanel">
	<div style='position:relative;'>
	  	<div id='rightPanelTitle'>
	  		<img class="close" width=25px src='/static/images/close@2x.png'/>
	  		<b id='title'>Title</b>  		
	  	</div>
	  	<div id='rightPanelContent'>
			<div class='mydiv' id='showVisualizationAndDetectionManager' style='display:none'>
	  			<hr>
				<label class="rightPanelSubtitle">Select RoI</label>
				<div class="myaccordion" id="accordion1" style="position: relative;margin-bottom:10px;">
					<p>Please choose the RoI to see the associated products. If someone shared simulations with you, their respective RoI appear flagged here as (shared).</p>
					<div id='div-listOfROI'>
						<table id="listOfROI" > </table>
					</div>
				</div>
				<hr>
				<label class="rightPanelSubtitle">Select products<img height=20px src='/static/images/info.svg' title='Information' style='margin-left:25px' onclick='onClickInfoButton("visualization-selectdetections")'/></label>
				<div class="myaccordion" id="accordion2" style="position: relative;margin-bottom:10px;">
					<div id='listOfSimulationsStateText'></div>
					<p id='listOfSimulationsText'>Then you can select one or more processed products from the detections for comparison</p>
					<div id='div-listOfSimulations'>
						<table id='listOfUserRepository' style='display:none'><!-- hidden-->
							<tr id='userrepository' style="padding-left:5px; padding-top:15px; width:85%">
								<td><table>
									<tr><td style='width: 22px;' id="listOfUploadedUserRepository_ocbtn">
											<img height="15px" width="15px" onclick="onClickUserRepositoryOpenCloseBtn('UserRepository','listOfUserRepository')" src="/static/images/arrow_right.svg">
										</td>
										<th style='width:365px;padding-top: 6px;'>
											[Compatible uploaded and Generated products]
										</th>
										<td></td>
										<td></td>
									</tr>
									<tr><td colspan=2 id='listOfUserRepository_td'>
										<div class='subaccordion' id='listOfUploadedUserRepository_subaccordion' style='display:none; width: 280px; padding-top: 10px;'>
											<table id='listOfUserRepository_products'>
												<tr><td>
													<table id='div-listOfUploadedGeometries' style='font-size:10pt'>
														<tr>
															<th style='width: 22px;' class="openclosebtn" id="listOfUploadedGeometries_ocbtn">
																<img height="15px" width="15px" onclick="onClickUserRepositoryOpenCloseBtn('Geometries','listOfUserRepository')" src="/static/images/arrow_right.svg">
															</th>
															<th id='listOfUploadedGeometriesText'>
																{% if request.path == home_waterleak %} Pipe networks
																{% elif request.path == home_inland %} Water bodies
																{% elif request.path == home_coastal %} Coastlines
																{% else %} Geometries (shapelines)
																{% endif %}
															</th>															
														</tr>
														<tr><td colspan='2' id="listOfUploadedGeometries_td">
															<div class='subaccordion' id='listOfUploadedGeometries_subaccordion' style='display:none; width: 280px; padding-top: 10px;'>								
																<table id="listOfUploadedGeometries" style='font-size:10pt; margin-bottom: 10px; width:369px'>
																	<colgroup>
																		<col width="0%" />
																		<col width="100%" />
																		<col width="0%" />
																	</colgroup>
																</table>
															</div>
														</td></tr>
													</table>
												</td></tr>
												{% if request.path == home_waterleak %}
												<tr><td>
													<table id='div-listOfUploadedMasks' style='font-size:10pt' >
														<tr>
															<th style='width: 22px;' class="openclosebtn" id="listOfUploadedMasks_ocbtn">
																<img height="15px" width="15px" onclick="onClickUserRepositoryOpenCloseBtn('Masks','listOfUserRepository')" src="/static/images/arrow_right.svg">
															</th>
															<th id='listOfUploadedMasksText'>Masks</th>															
														</tr>
														<tr><td colspan='2' id="listOfUploadedMasks_td">	
															<div class='subaccordion' id='listOfUploadedMasks_subaccordion' style='display:none; width: 280px; padding-top: 10px;'>								
																<table id="listOfUploadedMasks" style='font-size:10pt; margin-bottom: 10px; width:369px'> 
																	<colgroup>
																		<col width="0%" />
																		<col width="100%" />
																		<col width="0%" />
																	</colgroup>
																</table>
															</div>
														</td></tr>
													</table>
												</td></tr>
												<tr><td>
													<table id='div-listOfUploadedLeakPoints' style='font-size:10pt' >
														<tr>
															<th style='width: 22px;' class="openclosebtn" id="listOfUploadedLeakPoints_ocbtn">
																<img height="15px" width="15px" onclick="onClickUserRepositoryOpenCloseBtn('LeakPoints','listOfUserRepository')" src="/static/images/arrow_right.svg">
															</th>
															<th id='listOfUploadedLeakPointsText'>Leak Points</th>
														</tr>
														<tr><td colspan='2' id="listOfUploadedLeakPoints_td">	
															<div class='subaccordion' id='listOfUploadedLeakPoints_subaccordion' style='display:none; width: 280px; padding-top: 10px;'>								
																<table id="listOfUploadedLeakPoints" style='font-size:10pt; margin-bottom: 10px; width:369px'>
																	<colgroup>
																		<col width="0%" />
																		<col width="100%" />
																		<col width="0%" />
																	</colgroup>
																</table>
															</div>
														</td></tr>
													</table>
												</td></tr>
												{% endif %}
											</table>
										</div>
									</td></tr>
								</table></td>
							</tr>
						</table>
						<table id="listOfSimulations">
						</table>
					</div>
				</div>
			</div>

			<div class='mydiv' id='showUserRepository' style='display:none'>
				<hr>
				<label class="rightPanelSubtitle">Uploads</label>				
				<div class="myaccordion" id="accordion1" style="position: relative;">
					<p>Here you can see your own uploaded files to WORSICA. You can upload new files, or edit/delete existing ones.</p>
					<div id='div-listOfUserFile'>
						<table id="listOfUserFile">
						<tr><td>
							<table id='div-listOfUploadedGeometries'>
								<tr>
									<td style="width:22px" class="openclosebtn" id="listOfUploadedGeometries_ocbtn">
										<img height="15px" width="15px" onclick="onClickUserRepositoryOpenCloseBtn('Geometries')" src="/static/images/arrow_right.svg">
									</td>
									<th style="width:360px" id='listOfUploadedGeometriesText'>
										{% if request.path == home_waterleak %} Pipe networks
										{% elif request.path == home_inland %} Water bodies
										{% elif request.path == home_coastal %} Coastlines
										{% else %} Geometries (shapelines)
										{% endif %}
									</th>
									<td>
										<a class='clickUploadGeometry' onclick="onClickUserRepositoryUpload('geometry')"><img height="24px" src="/static/images/uploadfile2.svg"></a>
									</td>
								</tr>
								<tr><td colspan='2' id="listOfUploadedGeometries_td">
									<div class='subaccordion' id='listOfUploadedGeometries_subaccordion' style='display:none; width: 280px; padding-top: 10px;'>								
										<table id="listOfUploadedGeometries" style='font-size:10pt; margin-bottom: 10px; width:397px'>
											<colgroup>
												<col width="0%" />
												<col width="100%" />
												<col width="0%" />
												<col width="0%" />
											</colgroup>
										</table>
									</div>
								</td></tr>
							</table>
						</td></tr>
						{% if request.path == home_waterleak %}
						<tr><td>
							<table id='div-listOfUploadedMasks'>
								<tr>
									<td style="width:22px" class="openclosebtn" id="listOfUploadedMasks_ocbtn">
										<img height="15px" width="15px" onclick="onClickUserRepositoryOpenCloseBtn('Masks')" src="/static/images/arrow_right.svg">
									</td>
									<th style="width:360px" id='listOfUploadedMasksText'>Masks</th>
									<td>
										<a class='clickUploadMask' onclick="onClickUserRepositoryUpload('mask')"><img height="24px" src="/static/images/uploadfile2.svg"></a>
									</td>
								</tr>
								<tr><td colspan='2' id="listOfUploadedMasks_td">	
									<div class='subaccordion' id='listOfUploadedMasks_subaccordion' style='display:none; width: 280px; padding-top: 10px;'>								
										<table id="listOfUploadedMasks" style='font-size:10pt; margin-bottom: 10px; width:397px'> 
											<colgroup>
												<col width="0%" />
												<col width="100%" />
												<col width="0%" />
												<col width="0%" />
											</colgroup>
										</table>
									</div>
								</td></tr>
							</table>
						</td></tr>
						<tr><td>
							<table id='div-listOfUploadedLeakPoints'>
								<tr>
									<td style="width:22px" class="openclosebtn" id="listOfUploadedLeakPoints_ocbtn">
										<img height="15px" width="15px" onclick="onClickUserRepositoryOpenCloseBtn('LeakPoints')" src="/static/images/arrow_right.svg">
									</td>
									<th style="width:360px" id='listOfUploadedLeakPointsText'>Leak Points</th>
									<td>
										<a class='clickUploadLeakPoints' onclick="onClickUserRepositoryUpload('leak')"><img height="24px" src="/static/images/uploadfile2.svg"></a>
									</td>
								</tr>
								<tr><td colspan='2' id="listOfUploadedLeakPoints_td">	
									<div class='subaccordion' id='listOfUploadedLeakPoints_subaccordion' style='display:none; width: 280px; padding-top: 10px;'>								
										<table id="listOfUploadedLeakPoints" style='font-size:10pt; margin-bottom: 10px; width:397px'>
											<colgroup>
												<col width="0%" />
												<col width="100%" />
												<col width="0%" />
												<col width="0%" />
											</colgroup>
										</table>
									</div>
								</td></tr>
							</table>
						</td></tr>
						{% endif %}
						<!--<tr><td>
							<table id='div-listOfUploadedImagesets'>
								<tr>
									<td class="openclosebtn" id="listOfUploadedImagesets_ocbtn">
										<img height="15px" width="15px" onclick="onClickUserRepositoryOpenCloseBtn('Imagesets')" src="/static/images/arrow_right.svg">
									</td>
									<th style='width:83%' id='listOfUploadedImagesetsText'>Imagesets</th>
									<td>
										<a class='clickUploadMask' onclick=""><img height="24px" src="/static/images/uploadfile2.svg"></a>
									</td>
								</tr>
								<tr><td colspan='2' id="listOfUploadedImagesets_td">	
									<div class='subaccordion' id='listOfUploadedImagesets_subaccordion' style='display:none; width: 280px; padding-top: 10px;'>								
										<table id="listOfUploadedImagesets" style='font-size:10pt; margin-bottom: 10px; width:397px'> </table>
									</div>
								</td></tr>
							</table>
						</td></tr>-->
						</table>
					</div>
				</div>
			</div>
  		</div>
  	</div>
</div>

<script>
	var SHOW_MAX_LEAK_POINTS = 10000
	var intervalListOfSimulations = null
	var intervalListOfSimulationDetails = null
	var intervalListOfUserRepositoryFiles = null
	var intervalListOfSubmittedDataverses = null
	var prevcolor = ''
	var fetchLastJsonSimulations = {}
	var LIST_DELETE_LEAK_POINTS = []
	var HAS_SAVED_CHANGES = true

	function closeRightPanel(){
		$('#rightPanel').css('right', -480);
	}
	function openRightPanel(){
		$('#rightPanel').css('right', 0);
	}

	function _clear_interval_list_submitted_dataverses(){
		console.log('_clear_interval_list_submitted_dataverses')
		if (intervalListOfSubmittedDataverses!=null){
			//console.log('clearInterval updateListOfUserRepositoryFiles')
			clearInterval(intervalListOfSubmittedDataverses)
			intervalListOfSubmittedDataverses = null
		}
	}
	function _start_interval_list_submitted_dataverses(roi_id, simulation_id){
		_clear_interval_list_submitted_dataverses()
		console.log('_start_interval_list_submitted_dataverses')
		updateSubmittedDataverses(roi_id, simulation_id)
		intervalListOfSubmittedDataverses = setInterval(function(){
			//console.log('setInterval updateSubmittedDataverses')		
			updateSubmittedDataverses(roi_id, simulation_id)
		}, 10000)
	}

	function _clear_interval_list_user_repository_files(){
		if (intervalListOfUserRepositoryFiles!=null){
			//console.log('clearInterval updateListOfUserRepositoryFiles')
			clearInterval(intervalListOfUserRepositoryFiles)
			intervalListOfUserRepositoryFiles = null
		}
	}
	function _start_interval_list_user_repository_files(){
		_clear_interval_list_user_repository_files()
		updateListOfUserRepositoryFiles()
		showRightPanelOptions()
		intervalListOfUserRepositoryFiles = setInterval(function(){
			//console.log('setInterval updateListOfUserRepositoryFiles')		
			updateListOfUserRepositoryFiles()
			showRightPanelOptions()
		}, 10000)
	}

	function _clear_interval_list_simulations(){
		if (intervalListOfSimulations!=null){
			//console.log('clearInterval updateListOfSimulations')
			clearInterval(intervalListOfSimulations)
			//$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations').empty()
			intervalListOfSimulations = null
			fetchLastJsonSimulations = {}
		}
	}
	function _start_interval_list_simulations(){
		_clear_interval_list_simulations()
		showWhat=null
		if(RIGHT_PANEL_MODE == 'SHOW_LEAK_DETECTIONS'){ showWhat='showLeakDetections' }
		console.log('showWhat='+showWhat)		
		updateListOfSimulations(showWhat)
		showRightPanelOptions()
		intervalListOfSimulations = setInterval(function(){
			//console.log('setInterval updateListOfSimulations')		
			updateListOfSimulations(showWhat)
			showRightPanelOptions()
		}, 10000)
	}

	function _clear_interval_list_simulation_details(){
		if (intervalListOfSimulationDetails!=null){
			//console.log('clearInterval updateListOfSimulationDetails')
			clearInterval(intervalListOfSimulationDetails)
			intervalListOfSimulationDetails = null
		}
	}
	function _start_interval_list_simulation_details(roi_id, sim_id){
		_clear_interval_list_simulation_details()
		updateListOfSimulationDetails(roi_id, sim_id)
		intervalListOfSimulationDetails = setInterval(function(){
			//console.log('setInterval updateListOfSimulationDetails')		
			updateListOfSimulationDetails(roi_id, sim_id)
		}, 30000)
	}

	function cleanupRightPanel(){
		_clear_interval_list_simulations()
		_clear_interval_list_user_repository_files()
		_cleanup_shown_outputs_layers()
		closeRightPanel()
		$('#rightPanelContent div[class="mydiv"]').each(function(){
			$(this).hide()
		})
		_hideAllROI()
	}

	$('#rightPanelTitle .close').click(function(e){
		if (!(EDIT_LEAK_POINTS_MODE || DELETE_LEAK_POINTS_MODE)){
			cleanupRightPanel()
			//RIGHT_PANEL_MODE = null
			disableDrawPolygonMode()
			disableMeasureMode()
			if (drawUploadedROI != null){
				map.removeLayer(drawUploadedROI)
				drawUploadedROI = null
			}

			if(RIGHT_PANEL_MODE != null){
				RIGHT_PANEL_MODE = null
				//$('#listOfSimulations input[type="checkbox"]:checked').prop('checked',false)
				$('#listOfSimulations tr td table tr td table tr th table tr td input[type="checkbox"]:checked').prop('checked',false)
				$('#listOfSimulations tr td table tr td table tr th table tr th input[type="checkbox"]').prop('checked',true)
				$('#listOfSimulations tr td table tr td table tr th table tr th input[type="checkbox"]').prop('disabled', true)
				
				//EYEDROPPER_CLICK_MODE = false
				disableEyedropperClickMode()
				$('#new-info-eyedrop').hide()
				$('#new-info-show-open-layers').hide()
				$('#new-info-show-ruler').hide()
				$('#new-info-preview-pipe').hide()
				$('#new-info-plot-sea-tide').hide()
				$('#new-info-plot-sea-topography-map').hide()

				//
				reverseRemoveLayerIndexOf('preview_pipe')
				$('#new-info-preview-pipe-active #new-info-preview-pipe-table').empty()
				if ($('#new-info-preview-pipe-active #new-info-preview-pipe-table tr').length==0){
					$('#new-info-preview-pipe-active #new-info-preview-pipe-table').append(
						'<tr id="err-list-empty"><td><b>(No pipe networks uploaded for preview)</b></td></tr>')
				}
				$('#divuploadgeometry2 #status_message').css( 'color', '')
				$('#divuploadgeometry2 #status_message').empty()
				$('#divuploadgeometry2 .progress-bar').css( 'background', '#2CC0DE')
				$('#divuploadgeometry2 .progress-bar').css('width', '0%')
				$('#divuploadgeometry2 #fileupload2').val('')
			}
			$('#rightPanelTitle .close').toggleClass('closed');
		}
		else{
			buildDynamicModalPopup('Error!', 
				'<p>This option is disabled. Please leave the edit leak points mode.</p>', 
				[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
		}
	});

	function _cleanup_shown_outputs_layers(){
		outputMapLayers = []
		map.getLayers().forEach(function(el) {
			outputMapLayers.push(el)
		})
		for (var n in outputMapLayers){
			if (outputMapLayers[n].get('name') !== undefined){
				if (outputMapLayers[n].get('name').indexOf('output-')>-1) {
					map.removeLayer(outputMapLayers[n]);
				}
			}
		}
	}

	function _generate_plural(type){
		pluraltype = null
		if (type == 'geometry'){ pluraltype = 'geometries' }
		else if (type == 'mask'){ pluraltype = 'masks' }
		else if (type == 'leak'){ pluraltype = 'leaks' }
		else if (type == 'imageset'){ pluraltype = 'imagesets' }
		//else pluraltype = null
		return pluraltype
	}

	function onClickUserRepository(type, kind, object_id){
		//kind = geometry, mask, leakpoint
		pluralkind = _generate_plural(kind)
		if (type=='delete'){
			buildDynamicModalPopup('Warning!', 
				'<p>You are about to delete this '+kind+'. All its associated products will be deleted! Are you sure?</p>',[
					['Yes', function(){ 
						$(this).dialog( "close" )
						_clear_interval_list_user_repository_files()
						buildDynamicModalPopup('Deleting '+kind+'...', 
							'<p>Please wait while worsica is deleting '+kind+'...</p>', 
							[], [250,220])
						$.get('/portal/proxy/intermediate/user_repository/'+SERVICE_NAME+'/'+pluralkind+'/'+object_id+'/delete')
							.done(function(data){
								var answer = $.parseJSON(JSON.stringify(data)); 
								if(answer['alert']=='deleted'){									
									console.log('onClickUserRepository')								
									console.log(kind, answer[kind+'_id'])
									reverseRemoveLayerEqual("output-userrepository-user"+user_id+"_"+kind+answer[kind+'_id'])
									$('#showUserRepository #user'+answer['user_id']+'_'+kind+answer[kind+'_id']).remove()
									_start_interval_list_user_repository_files()
									//updateListOfUserRepositoryFiles()
									dm.dialog( "close" );
								}
								else{
									dm.dialog( "close" );
									buildDynamicModalPopup('Error!', 
										'<p>Something went wrong and we were unable to delete '+kind+', try again!</p>', 
										[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
								}
							})
							.fail(function( xhr, textStatus, errorThrown ){
								console.log( xhr, textStatus, errorThrown)
								dm.dialog( "close" );
								buildDynamicModalPopup('Error!', 
									'<p>Something went wrong and we were unable to delete '+kind+', try again!</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							})
					}],
					['No', function(){
						$(this).dialog( "close" )
					}]
				], [300,220])
		}
	}

	function onClickROIButton(type, roi_id){
		if (type=='delete'){
			if (!(EDIT_LEAK_POINTS_MODE || DELETE_LEAK_POINTS_MODE)){
				buildDynamicModalPopup('Warning!', 
					'<p>You are about to delete RoI. All associated simulation and its products will be deleted! Are you sure?</p>',[
						['Yes', function(){ 
							$(this).dialog( "close" )
							$.get('/portal/rois/'+roi_id+'/delete_roi')
								.done(function(data){
									var answer = $.parseJSON(JSON.stringify(data)); 
									if(answer['alert']=='deleted'){
										dm.dialog( "close" );
										console.log(roi_id)
										loadRegionsOfInterest()
									}
									else{
										dm.dialog( "close" );
										buildDynamicModalPopup('Error!', 
											'<p>Something went wrong and we were unable to delete RoI, try again!</p>', 
											[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
									}
								})
								.fail(function( xhr, textStatus, errorThrown ){
									console.log( xhr, textStatus, errorThrown)
									dm.dialog( "close" );
									buildDynamicModalPopup('Error!', 
										'<p>Something went wrong and we were unable to delete RoI, try again!</p>', 
										[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
								})
						}],
						['No', function(){
							$(this).dialog( "close" )
						}]
					], [300,220])
			}
			else{
				buildDynamicModalPopup('Error!', 
					'<p>This option is disabled. Please leave the edit leak points mode.</p>', 
					[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			}	
		}
	}

	function onClickActiveLayer(type, reference){
		if (type == 'movetotop'){
			//find layer by reference
			found_layer = null
			map.getLayers().forEach(function(el) {
				if(el.get('name') !== undefined){
					if(el.get('name') === reference){
						found_layer = el
					}
				}
			})
			//then remove and add again, this will bring it to the top
			reverseRemoveLayerEqual(reference)
			map.addLayer(found_layer)
			listActiveLayers()
			//if eyedropper is enabled, update the value according to the shown layer
			/*if(EYEDROPPER_CLICK_MODE){
				if(store_eyedropper_coords != null){
					get_pixel_value(store_eyedropper_coords)
				}
			}*/
		}
		else if (type == 'remove'){
			//get reference, parse it to get the .change() on the visualization side to disable layer
			//only works on visualization
			console.log(reference)
			referenceSplit = reference.split('-')
			//roiID = referenceSplit[1].split('roi_')[1]
			simID = referenceSplit[2].split('simulation')[1]
			imagesetID = referenceSplit[3].split('imageset')[1]
			type = referenceSplit[4]
			chkboxID = 'simulation_'+simID+'_imageset_'+imagesetID+'_'+type+'_chkbox'
			console.log(chkboxID)
			$('#'+chkboxID).click()
			/*if(EYEDROPPER_CLICK_MODE){//maybe check if it is the top one, dont update?
				if(store_eyedropper_coords != null){
					get_pixel_value(store_eyedropper_coords)
				}
			}*/
		}
		else if (type == 'viewnoview'){
			map.getLayers().forEach(function(el) {
				if(el.get('name') !== undefined){
					if(el.get('name') === reference){
						console.log(reference)
						el.setVisible(!el.getVisible())
						if (!el.getVisible()){
							$('#new-info-show-open-layers #new-info-show-open-layers-table #active-'+reference+' #layerViewNoView img').attr('src','/static/images/noview.svg')
						}
						else{
							$('#new-info-show-open-layers #new-info-show-open-layers-table #active-'+reference+' #layerViewNoView img').attr('src','/static/images/view.svg')
						}
					}
				}
			})
		}
	}

	function onClickLeakDetectionButton(type, roi_id, simulation_id, sim_imageset_id, detection_kind){
		if (type == 'run'){
			buildDynamicModalPopup('Starting leak detection run...', 
				'<p>Please wait...</p>', 
				[], [250,220])
			//console.log('/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/processimageset/'+sim_imageset_id+'/'+detection_kind+'/run_leak_detection')
			$.get('/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/processimageset/'+sim_imageset_id+'/'+detection_kind+'/run_leak_detection')
				.done(function(data){
					var answer = $.parseJSON(JSON.stringify(data)); 
					if(answer['state']=='created'){
						dm.dialog( "close" );
						_start_interval_list_simulations()
					}
					else{
						dm.dialog( "close" );
						buildDynamicModalPopup('Error!', 
							'<p>'+answer['error']+'</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [350,320])
					}
				})
				.fail(function( xhr, textStatus, errorThrown ){
					console.log( xhr, textStatus, errorThrown)
					dm.dialog( "close" );
					buildDynamicModalPopup('Error!', 
						'<p>Your leak detection failed to run! Something went wrong, try again!</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				})
		}
		else if(type=='restart'){
			buildDynamicModalPopup('Warning!', 
				'<p>You are about to restart this leak detection from the beginning!. Are you sure?</p>',[
					['Yes', function(){ 
						$(this).dialog( "close" )
						/*
						buildDynamicModalPopup('Starting leak detection run...', 
							'<p>Please wait...</p>', 
							[], [250,220])
						*/
						/*$.get('/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/stop_simulation')
							.done(function(data){
								var answer = $.parseJSON(JSON.stringify(data)); 
								if(answer['state']=='stopped'){
									dm.dialog( "close" );
									_start_interval_list_simulations()
								}
								else{
									dm.dialog( "close" );
									buildDynamicModalPopup('Error!', 
										'<p>Something went wrong and we were unable to stop simulation, try again!</p>', 
										[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
								}
							})
							.fail(function( xhr, textStatus, errorThrown ){
								console.log( xhr, textStatus, errorThrown)
								dm.dialog( "close" );
								buildDynamicModalPopup('Error!', 
									'<p>Something went wrong and we were unable to stop simulation, try again!</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							})*/
					}],
					['No', function(){
						$(this).dialog( "close" )
					}]
				], [250,220])
		}
	}

	function onClickDeleteTopography(roi_id, simulation_id, gt_id){
		buildDynamicModalPopup('Warning!', 
			'<p>You are about to delete this topography. Are you sure?</p>',[
				['Yes', function(){ 
					$(this).dialog( "close" )
					$.get("/portal/rois/"+roi_id+"/simulations/"+simulation_id+"/intermediate/generatetopography/"+gt_id+"/delete_products")
						.done(function(data){
							var answer = $.parseJSON(JSON.stringify(data)); 
							if(answer['alert']=='deleted'){
								dm.dialog( "close" );
								console.log(simulation_id)
								$('#showVisualizationAndDetectionManager #simulation_'+simulation_id+'_gt_'+gt_id).remove()
							}
							else{
								dm.dialog( "close" );
								buildDynamicModalPopup('Error!', 
									'<p>Something went wrong and we were unable to delete topography, try again!</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							}
						})
						.fail(function( xhr, textStatus, errorThrown ){
							console.log( xhr, textStatus, errorThrown)
							dm.dialog( "close" );
							buildDynamicModalPopup('Error!', 
								'<p>Something went wrong and we were unable to delete topography, try again!</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						})
				}],
				['No', function(){
					$(this).dialog( "close" )
				}]
			], [300,220])
	}

	function onClickSimulationButton(type, roi_id, simulation_id){
		if (type == 'run'){
			buildDynamicModalPopup('Initializing run...', 
				'<p>Please wait...</p>', 
				[], [250,220])
			$.get('/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/run_simulation')
				.done(function(data){
					var answer = $.parseJSON(JSON.stringify(data)); 
					if(answer['state']=='created'){
						dm.dialog( "close" );
						_start_interval_list_simulations()
					}
					else{
						dm.dialog( "close" );
						buildDynamicModalPopup('Error!', 
							'<p>Your simulation failed to run! Something went wrong, try again!</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
				})
				.fail(function( xhr, textStatus, errorThrown ){
					console.log( xhr, textStatus, errorThrown)
					dm.dialog( "close" );
					buildDynamicModalPopup('Error!', 
						'<p>Your simulation failed to run! Something went wrong, try again!</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				})
		}
		else if (type=='edit'){
			buildDynamicModalPopup('Loading...', 
				'<p>Please wait...</p>', 
				[], [250,220])
			$.get('/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/show_blob')
				.done(function(data){
					var answer = $.parseJSON(JSON.stringify(data)); 
					if(answer['state']=='loaded'){
						//console.log(answer['blob'])
						//start loading
						LEFT_PANEL_MODE = 'edit'
						EDIT_SIMULATION_ID = simulation_id
						steps = ['step1ROI','step2Inputs','step3InputsRevision','step4Detection',/*'step5OCConnection',*/'step6Run']
						for (var s in steps){
							loadBlobJsonSimulation(steps[s], answer['blob'])
						}
						dm.dialog( "close" );			
						closeRightPanel()
						openLeftPanel()
						$('#step-ph1').addClass('current')
						$('#step-ph1-workflow').show()
						goToStep('step3InputsRevision')			
					}
					else{
						dm.dialog( "close" );
						buildDynamicModalPopup('Error!', 
							'<p>Unable to edit! Something went wrong, try again!</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
				})
				.fail(function( xhr, textStatus, errorThrown ){
					console.log( xhr, textStatus, errorThrown)
					dm.dialog( "close" );
					buildDynamicModalPopup('Error!', 
						'<p>Unable to edit! Something went wrong, try again!</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				})
		}
		else if (type=='update'){
			buildDynamicModalPopup('Loading...', 
				'<p>Please wait...</p>', 
				[], [250,220])
			$.get('/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/show_blob')
				.done(function(data){
					var answer = $.parseJSON(JSON.stringify(data)); 
					if(answer['state']=='loaded'){
						//console.log(answer['blob'])
						//start loading
						LEFT_PANEL_MODE = 'waterleak-update'
						EDIT_SIMULATION_ID = simulation_id
						//WATERLEAK_SIMULATION_EXISTS = true
						steps = ['step1ROI','step2Inputs','step3InputsRevision','step4Detection',/*'step5OCConnection',*/'step6Run']
						for (var s in steps){
							loadBlobJsonSimulation(steps[s], answer['blob'])
						}
						dm.dialog( "close" );			
						closeRightPanel()
						openLeftPanel()
						$('#step-ph1').addClass('current')
						$('#step-ph1-workflow').show()
						goToStep('step2Inputs')			
					}
					else{
						dm.dialog( "close" );
						buildDynamicModalPopup('Error!', 
							'<p>Unable to update! Something went wrong, try again!</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
				})
				.fail(function( xhr, textStatus, errorThrown ){
					console.log( xhr, textStatus, errorThrown)
					dm.dialog( "close" );
					buildDynamicModalPopup('Error!', 
						'<p>Unable to update! Something went wrong, try again!</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				})
			
		}
		else if (type=='stop'){
			buildDynamicModalPopup('Warning!', 
				'<p>You are about to stop this simulation. Are you sure?</p>',[
					['Yes', function(){ 
						$(this).dialog( "close" )
						$.get('/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/stop_simulation')
							.done(function(data){
								var answer = $.parseJSON(JSON.stringify(data)); 
								if(answer['state']=='stopped'){
									dm.dialog( "close" );
									_start_interval_list_simulations()
								}
								else{
									dm.dialog( "close" );
									buildDynamicModalPopup('Error!', 
										'<p>Something went wrong and we were unable to stop simulation, try again!</p>', 
										[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
								}
							})
							.fail(function( xhr, textStatus, errorThrown ){
								console.log( xhr, textStatus, errorThrown)
								dm.dialog( "close" );
								buildDynamicModalPopup('Error!', 
									'<p>Something went wrong and we were unable to stop simulation, try again!</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							})
					}],
					['No', function(){
						$(this).dialog( "close" )
					}]
				], [250,220])
		}
		else if (type=='delete'){
			buildDynamicModalPopup('Warning!', 
				'<p>You are about to delete this simulation. All associated data and products will be deleted! Are you sure?</p>',[
					['Yes', function(){ 
						$(this).dialog( "close" )
						$.get('/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/delete_simulation')
							.done(function(data){
								var answer = $.parseJSON(JSON.stringify(data)); 
								if(answer['alert']=='deleted'){
									dm.dialog( "close" );
									console.log(simulation_id)
									$('#showVisualizationAndDetectionManager #simulation_'+simulation_id).remove()
									_start_interval_list_simulations()
								}
								else{
									dm.dialog( "close" );
									buildDynamicModalPopup('Error!', 
										'<p>Something went wrong and we were unable to delete simulation, try again!</p>', 
										[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
								}
							})
							.fail(function( xhr, textStatus, errorThrown ){
								console.log( xhr, textStatus, errorThrown)
								dm.dialog( "close" );
								buildDynamicModalPopup('Error!', 
									'<p>Something went wrong and we were unable to delete simulation, try again!</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							})
					}],
					['No', function(){
						$(this).dialog( "close" )
					}]
				], [300,220])
		}
    	else if(type=='submit_to_dataverse'){
			buildDynamicModalPopup('Submit simulation to dataverse', 
				'<p>This allows to submit only the metadata of your simulation and its respective products to a dataset on Dataverse (for data FAIR). You ONLY can submit one for this simulation.</p>'+
				'<p>For the file inputs: if they are public (Sentinel), only the filename and UUID will be sent; if private/uploaded, this information will be omitted.'+
				' For the file outputs (processed products), only its name and URL of the processed products (only accesible by authentication) will be sent.</p>'+
				'<i>Provide a title for your dataset and click on submit. Depending of the size of your simulation, you need to wait until it finishes. Click on the eye to see the dataset on Dataverse portal. To replace the actual submission, submit again.</i>'+
				'<table style="width:100%">'+
				'<tr style="width:80%"><td><div class="custom-form-control" style="width:100%">'+
					'<label for="dataverseTitle">Title</label>'+
					'<input class="form-control" type="text" id="dataverseTitle" style="text-align:right"></input>'+
				'</div></td><td><a id="submitBtn" class="btn btn-sm btn-primary" >Submit</a></td>'+
				'</tr></table>'+
				'<div id="dataverseSubmitMessage"></div>'+		
				'<hr>'+					
				'<div style="overflow-y:auto;max-height: 40px;height: 40px;">'+
				'<table style="color:#cccccc;width:100%;font-size:11pt" id="listOfSubmittedDataverses">'+
				'</table>'+
				'</div>', 
				[['Close', function(){ 
					_clear_interval_list_submitted_dataverses()
					$(this).dialog( "close" )
				}]
				], [580,480])
			//updateSubmittedDataverses(roi_id, simulation_id)
			_start_interval_list_submitted_dataverses(roi_id, simulation_id)
			$("#dialog-message #stateicon").attr('src','/static/images/dataverse.png')
			$("#dialog-message #submitBtn").click(function(){ 	
				$('#dataverseSubmitMessage').empty()	
				_clear_interval_list_submitted_dataverses()//stop refresh				
				if ($('#dataverseTitle').val() == ''){
					$('#dataverseSubmitMessage').html('<p style="color:#cc0000">Error: Please provide a valid title for your dataset on dataverse!</p>')
				}
				else{
					url_point = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/dataverses/submit'
					console.log(url_point)
					jsonR = {}
					jsonR['title'] = $('#dataverseTitle').val()
					console.log(jsonR)
					$('#dataverseSubmitMessage').html('<p style="color:#cccccc"><img height=24px src="/static/images/load.gif" />Submitting...</p>')
					$("#dialog-message #submitBtn").hide()
					$.post(url_point,  JSON.stringify(jsonR))
						.done(function(data){
							var response = $.parseJSON(JSON.stringify(data));
							if(response['alert']=='submitted'){	
								setTimeout(function(){	
									_start_interval_list_submitted_dataverses(roi_id, simulation_id)
								}, 700)				
							}
							else{
								$('#dataverseSubmitMessage').html('<p style="color:#cc0000">Error on submitting!</p>')
								console.log(response['exception'])
								//update table		
								//updateSubmittedDataverses(roi_id, simulation_id)
								_clear_interval_list_submitted_dataverses()
								$("#dialog-message #submitBtn").show()
							}
						})
						.fail(function( xhr, textStatus, errorThrown ){
							console.log( xhr, textStatus, errorThrown)
							$('#dataverseSubmitMessage').html('<p style="color:#cc0000">Something went wrong on submitting this simulation to Dataverse. Try again.</p>')
							//update table		
							//updateSubmittedDataverses(roi_id, simulation_id)
							_clear_interval_list_submitted_dataverses()
							$("#dialog-message #submitBtn").show()
						})
				}
			})
		}
		else if(type == 'generate_topomap'){
			enableGenerateTopomap(roi_id, simulation_id)
			
		}
		else if(type == 'share'){
			buildDynamicModalPopup('Share simulation with people', 
				'<p>To share this simulation with other users, please ask them for their User ID number. The User ID number is located on the header, below the name.</p>'+
				'<i>Hint: You can share this simulation with more than one user. Write the User IDs, separated by comma. (e.g: 12,56,34)</i>'+
				'<table style="width:100%">'+
				'<tr style="width:80%"><td><div class="custom-form-control" style="width:100%">'+
					'<label for="shareWithUserId">User ID number</label>'+
					'<input class="form-control" type="text" id="shareWithUserId" style="text-align:right"></input>'+
				'</div></td><td><a id="shareBtn" class="btn btn-sm btn-primary" >Share</a></td>'+
				'</tr></table>'+
				'<div id="shareWithUserIdMessage">'+
				'</div>'+					
				'<hr>'+					
				'<div style="font-size:10pt;overflow-y:auto;max-height: 150px;height: 150px;">'+
				'<table style="color:#cccccc;width:100%" id="listOfSharedUsers">'+
				'</table>'+
				'</div>', 
				[['Close', function(){ 
					$(this).dialog( "close" )
				}]
				], [550,480])
			updateSharedUsersSimulation(roi_id, simulation_id)
			$("#dialog-message #stateicon").attr('src','/static/images/share.svg')
			$("#dialog-message #shareBtn").click(function(){ 	
				$('#shareWithUserIdMessage').empty()					
				if ($('#shareWithUserId').val() == ''){
					$('#shareWithUserIdMessage').html('<p style="color:#cc0000">Error: Please provide a valid ID!</p>')
				}
				else{
					url_point = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/share_with/new_user'
					console.log(url_point)
					jsonR = {}
					jsonR['new_share_user_id'] = $('#shareWithUserId').val()
					console.log(jsonR)
					$('#shareWithUserIdMessage').html('<p style="color:#cccccc">Sharing, please wait...</p>')
					$.post(url_point,  JSON.stringify(jsonR))
						.done(function(data){
							var response = $.parseJSON(JSON.stringify(data));
							if(response['alert']=='shared'){
								$('#shareWithUserId').val('')
								$('#shareWithUserIdMessage').html('<p style="color:#00cc00">Shared succesfully!</p>')
								//update table		
								updateSharedUsersSimulation(roi_id, simulation_id)						
							}
							else{
								$('#shareWithUserIdMessage').html('<p style="color:#cc0000">Error on sharing!</p>')
								console.log(response['exception'])
							}
						})
						.fail(function( xhr, textStatus, errorThrown ){
							console.log( xhr, textStatus, errorThrown)
							$('#shareWithUserIdMessage').html('<p style="color:#cc0000">Something went wrong on sharing this simulation. Try again.</p>')
						})
				}
			})
		}
	}
	function updateSubmittedDataverses(roi_id, simulation_id){
		console.log('updateSubmittedDataverses')
		url_point = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/dataverses'
		$.get(url_point)
			.done(function(data){
				var answer = $.parseJSON(JSON.stringify(data)); 
				if(answer['alert']=='success'){
					console.log(answer['last_submitted_dv_state'])
					if (answer['last_submitted_dv_state'] == 'dataverse-uploading'){//continue interval
						$("#dialog-message #submitBtn").hide()
						$('#dataverseSubmitMessage').html('<p style="color:#cccccc"><img height=24px src="/static/images/load.gif" />Submitting '+answer['last_submitted_dv_name']+', please wait...</p>')
						$('#dataverseTitle').val(answer['last_submitted_dv_name'])
						//_start_interval_list_submitted_dataverses(roi_id, simulation_id)						
					}
					else{
						_clear_interval_list_submitted_dataverses()//stop interval
						$("#dialog-message #submitBtn").show()
						if (answer['last_submitted_dv_state'] == 'dataverse-uploaded'){
							$('#dataverseTitle').val('')
							$('#dataverseSubmitMessage').html('<p style="color:#00cc00">Your latest submission '+answer['last_submitted_dv_name']+' at '+answer['last_submitted_dv_time']+' was submitted successfully!</p>')
						}
						else if (answer['last_submitted_dv_state'] == 'error-dataverse-uploading'){
							$('#dataverseSubmitMessage').html('<p style="color:#cc0000">Your latest submission '+answer['last_submitted_dv_name']+' at '+answer['last_submitted_dv_time']+' failed due to an error.</p>')
						}		
						$('#dataverseTitle').val('')	
					}
					//list
					ddatasets = answer['datasets']
					if (ddatasets.length==0){
						$("#dialog-message #listOfSubmittedDataverses").html('<tr><td>This simulation has no submitted datasets.</td></tr>')
					}
					else{						
						$("#dialog-message #listOfSubmittedDataverses").empty()
						for (var i=0; i<ddatasets.length; i++){
							ddataset = ddatasets[i]
							tagClass = _set_color_state_span_tag_class(ddataset.state)
							$("#dialog-message #listOfSubmittedDataverses").html(
								'<tr id="dataverse_dataset_id_'+ddataset.id+'">'+
								'<td>'+ddataset.name+' ('+ddataset.doi+')<br>'+
									' '+ddataset.creationDate+'</td>'+
								'<td><a id=dataverse_dataset_id_'+ddataset.id+'_view_icon '+(ddataset.state=='dataverse-uploaded'?'':'style="display:none"')+' target="_blank" rel="noopener noreferrer" href='+ddataset.url+'><img height=24px src="/static/images/view.svg" title="View on Dataverse" style="margin:3px"/></a></td>'+
								'<td><img id=dataverse_dataset_id_'+ddataset.id+'_state_icon height=20px src='+tagClass[1]+' title="'+tagClass[0]+'"/></td>'
							)							
						}
					}
				}
				else{
					$("#dialog-message #listOfSubmittedDataverses").html('<tr><td>(An error occured while getting the list)</td></tr>')
				}
			})
			.fail(function( xhr, textStatus, errorThrown ){
				console.log( xhr, textStatus, errorThrown)
				$("#dialog-message #listOfSubmittedDataverses").html('<tr><td>(An error occured while getting the list)</td></tr>')
			})

	}

	function updateSharedUsersSimulation(roi_id, simulation_id){
		$("#dialog-message #listOfSharedUsers").empty()
		url_point = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/share_with'
		$.get(url_point)
			.done(function(data){
				var answer = $.parseJSON(JSON.stringify(data)); 
				if(answer['alert']=='success'){		
					shared_with_users = answer['shared_with_users']						
					if (shared_with_users.length==0){
						$("#dialog-message #listOfSharedUsers").append('<tr><td>(This simulation is not being shared by anyone yet.)</td></tr>')
					}
					else{
						for (var i=0; i<shared_with_users.length; i++){
							shared_user = shared_with_users[i]
							$("#dialog-message #listOfSharedUsers").append(
								'<tr id="shared_with_user_'+shared_user.id+'">'+
								'<td style="width:20%"><img height="50px" src="/static/images/usericon.svg"></td>'+
								'<td>'+shared_user.name+'<span class="badge" style="background-color:#1fbbd9">User ID: '+shared_user.id+'</span>'+
									'<br>'+shared_user.email+
								'</td>'+
								'<td style="width:10%"><img height="24px" src="/static/images/delete.svg" onclick=onClickRemoveSharedUserSimulation('+roi_id+','+simulation_id+','+shared_user.id+') title="Remove user from the share" style="margin:3px"></td></tr>')
						}
					}
				}
				else{
					$("#dialog-message #listOfSharedUsers").append('<tr><td>(An error occured while getting the list)</td></tr>')
				}
			})
			.fail(function( xhr, textStatus, errorThrown ){
				console.log( xhr, textStatus, errorThrown)
				$("#dialog-message #listOfSharedUsers").append('<tr><td>(An error occured while getting the list)</td></tr>')
			})
	}
	function onClickRemoveSharedUserSimulation(roi_id, simulation_id, user_id){
		url_point = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/share_with/'+user_id+'/remove'
		$.get(url_point)
			.done(function(data){
				var answer = $.parseJSON(JSON.stringify(data)); 
				if(answer['alert']=='removed'){
					$('#shareWithUserIdMessage').html('<p style="color:#00cc00">Success! User was removed from this simulation.</p>')
					updateSharedUsersSimulation(roi_id, simulation_id)
				}
				else{
					$('#shareWithUserIdMessage').html('<p style="color:#cc0000">Something went wrong on removing user from this simulation sharing. Try again.</p>')
				}
			})
			.fail(function( xhr, textStatus, errorThrown ){
				console.log( xhr, textStatus, errorThrown)
				$('#shareWithUserIdMessage').html('<p style="color:#cc0000">Something went wrong on removing user from this simulation sharing. Try again.</p>')
			})
	}
	function onChangeChkboxImagesetShowRGBOutput(kind, roi_id, simulation_id, simulation_imageset_id, shp_mpis_id){
		isRGBChecked = $("#simulation_"+simulation_id+"_imageset_"+simulation_imageset_id+"_"+kind+"_"+shp_mpis_id+"_rgb_chkbox").prop('checked')
		LAYER_NAME = 'output-roi_'+roi_id+'-simulation'+simulation_id+'-imageset'+simulation_imageset_id+'-'+kind+'-'+shp_mpis_id
		LAYER_NAME_RGB = LAYER_NAME+'-rgb'
		console.log(LAYER_NAME)
		map.getLayers().forEach(function(el) {
			if(el.get('name') !== undefined){
				if(el.get('name').indexOf(LAYER_NAME_RGB+'_grouped')>-1){
					l2Array = [...el.getLayers().getArray()]
					l2Array.forEach(function (l3) {//layer
						if (l3.get('name') !== undefined && l3.get('name') === LAYER_NAME_RGB){
							console.log(l3.get('name'))
							l3.setVisible(isRGBChecked)
							l3.changed()
						}
					})
								    
				}
			}
		})
	}
	//Visualization
	function onChangeChkboxUserRepositoryShowOutput(kind, user_id, object_id, randomColor=null, raster_id=null){ 
		//kind = geometry, mask, imageset, leakpoint
		isChecked = $("#showVisualizationAndDetectionManager #accordion2 #user"+user_id+"_"+kind+object_id+"_chkbox").prop('checked')
		//$("#user"+user_id+"_"+kind+object_id+"_chkbox").prop('disabled',!isChecked)
		//console.log(isChecked)
		onChangeChkboxUserRepositoryShowOutput2(isChecked, kind, user_id, object_id, randomColor, raster_id)
	}
	//user repo
	function onChangeChkboxUserRepositoryShowOutputB(kind, user_id, object_id, randomColor=null, raster_id=null, _chkbox_id=null){ 
		//kind = geometry, mask, imageset, leakpoint
		if (_chkbox_id==null){
			_chkbox_id = "#showUserRepository #user"+user_id+"_"+kind+object_id+"_chkbox"
		}
		isChecked = $(_chkbox_id).prop('checked')
		//$("#user"+user_id+"_"+kind+object_id+"_chkbox").prop('disabled',!isChecked)
		//console.log(isChecked)
		onChangeChkboxUserRepositoryShowOutput2(isChecked, kind, user_id, object_id, randomColor, raster_id)
	}
	function onChangeChkboxUserRepositoryShowOutput2(isChecked, kind, user_id, object_id, randomColor, raster_id){
		LAYER_NAME = "output-userrepository-user"+user_id+"_"+kind+object_id
		pluralkind = _generate_plural(kind)
		_url = '/portal/proxy/intermediate/user_repository/waterleak/'+pluralkind+'/'+object_id
		//isLeakPoints = false
		if (kind.indexOf('geometry')>-1){
			if (isChecked){
				buildDynamicModalPopup('Loading '+kind+'...', 
					'<p>Please wait...</p>',  [], [250,220])	
				$.ajax({ type: "GET", url: _url, async: true,
					success : function(response){
						dm.dialog("close")
						alreadyLoadedShapelineRoi = false
						jr = $.parseJSON(JSON.stringify(response));
						
						map.getLayers().forEach(function(el) {
							if (el.get('name') === LAYER_NAME) {
								//check if shapeline was already loaded, instead of reloading for each update
								alreadyLoadedShapelineRoi = true
							}
						})
						//console.log(alreadyLoadedShapelineRoi)
						if (!alreadyLoadedShapelineRoi){		
							loadFeatureGeojsonVT(jr['json'],randomColor)			
						}
					},
					error: function(response){
						dm.dialog("close")
						buildDynamicModalPopup('Error', 
							'<p>Could not load '+kind+'.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
				});	
			}
			else{
				reverseRemoveLayerEqual(LAYER_NAME)
			}
		}
		else{//masks
			if (isChecked){
				buildDynamicModalPopup('Loading output...', 
					'<p>Please wait...</p>', 
					[], [250,220])
				if(kind.indexOf('mask')>-1){
					console.log('is not leak point')
					_url += '/'+raster_id
					$.ajax({ type: "GET", url: _url, async: true,
						success : function(response){
							dm.dialog("close")
							//console.log(_url)
							intermediateRasterEndpoint = response['response']['url']
							console.log(intermediateRasterEndpoint)
							minBar = parseFloat(response['response']['min'])-0.1
							maxBar = parseFloat(response['response']['max'])+0.1
							colorFrom = response['response']['rgbcolorfrom']
							colorOver = response['response']['rgbcolorover']
							colorTo = response['response']['rgbcolorto']
							rl = new ol.layer.Tile({
								name: LAYER_NAME,
								extent: chosenROI.getSource().getExtent(),
								source: new ol.source.XYZ({
								url: intermediateRasterEndpoint+'/{z}/{x}/{y}.png?colormap={"continuous":"True","from":['+colorFrom[0]+','+colorFrom[1]+','+colorFrom[2]+'],"over":['+colorOver[0]+','+colorOver[1]+','+colorOver[2]+'],"to":['+colorTo[0]+','+colorTo[1]+','+colorTo[2]+'],"range":['+minBar+','+maxBar+']}',
								opaque: false
								})
							})
							rl.setZIndex(12)
							//fname = $('#user'+user_id+'_mask'+object_id+'_name').text()
							fname = 'user'+user_id+'_mask'+object_id+'_name'
							fname += '|'+kind.toUpperCase()+'\n'
							console.log(fname)
							rl.setProperties({'fname': fname,'raster_id':raster_id})
							//console.log(rl.getProperties())
							map.addLayer(rl)
						},
						error: function(response){
							dm.dialog("close")
							buildDynamicModalPopup('Error', 
								'<p>Could not load output.</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						}
					});
				}
				else{
					console.log('is leak point')
					$.ajax({ type: "GET", url: _url, async: true,
						success : function(response){
							dm.dialog("close")
							//console.log(_url)
							//
							j = $.parseJSON(JSON.stringify(response));
							detected_leaks = j['leak_points']
							colorShow = $("#user"+user_id+"_leak"+object_id+"_linecolor polygon").attr('fill')
							_styleColor = _create_style_leak_points(colorShow)
							_styleBlack = _create_style_leak_points("#220022")
							rls = []
							for(var s=0; s<detected_leaks.length; s++){
								var x = detected_leaks[s]['xCoordinate']
								var y = detected_leaks[s]['yCoordinate']
								var value = detected_leaks[s]['pixelValue']
								var point_leak_id = detected_leaks[s]['id']
								var show_leak_point = detected_leaks[s]['showLeakPoint']
								//var url_point = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/processimageset/'+simulation_imageset_id+'/'+leak_detection_kind_split[1]+'/'+leak_detection_kind_split[0]+'/'+kind+'/'+raster_id+'/leak_points/'+point_leak_id+'/change_visibility'	
								var lonlat = ol.proj.transform([x,y], 'EPSG:3857', 'EPSG:4326');
								var lonlat2 = lonlat//[lonlat[1],lonlat[0]]
								//console.log(lonlat2)
									
								rls[s] = new ol.layer.Vector({
									name: LAYER_NAME+'-'+point_leak_id,
									source: new ol.source.Vector({ 
										features: [new ol.Feature({ geometry: new ol.geom.Point( ol.proj.fromLonLat(lonlat2) ), })] 
									}),
									style: (show_leak_point? _styleColor : _styleBlack)
								});
								//console.log(rl)
								fname = $('#user'+user_id+'_leak'+object_id+'_name').text()
								fname += '|'+point_leak_id+'\n'
								console.log(fname)
								rls[s].setProperties({'fname': fname, 'raster_id':raster_id, /*'url_point': url_point*/})
								//console.log(rl.getProperties())
								rls[s].setZIndex(21)
								//draw the rectangles
								/*radius = 80 //0.0002
								geojson = {
									'type': 'FeatureCollection',
									'crs': { 'type': 'name', 'properties': { 'name': 'EPSG:3857' } },
									'features': [{
									'type': 'Feature',
									'geometry': {
										'type': 'Polygon',
										'coordinates': [[
											[x-radius, y-radius], 
											[x-radius, y+radius], 
											[x+radius, y+radius],
											[x+radius, y-radius], 
											[x-radius, y-radius]]]
									},
									"properties": {
										'name': '#'+(s+1)+': Leak ID '+point_leak_id+' ('+(show_leak_point? 'Show' : 'Hidden')+') \n ('+x+'; '+y+') \n Value: '+value,
										'id': 'point_leak_'+point_leak_id,
										'showLeakPoint': show_leak_point,
										'color': (show_leak_point? colorShow : colorHide),
									}
									}]
								}
								detectedLeaksRectanglesVectorLayer[s] = new ol.layer.Vector({
									name: 'point_leak_'+point_leak_id, 
									source: new ol.source.Vector({
										features: (new ol.format.GeoJSON()).readFeatures(geojson,{ featureProjection: 'EPSG:3857' })
									}),
									style: new ol.style.Style({	        
										stroke: new ol.style.Stroke({ color: (show_leak_point? colorShow : colorHide), width: 3 })
									})
								})
								map.addLayer(detectedLeaksRectanglesVectorLayer[s])*/
							//
							}
							rl = new ol.layer.Group({
								name: LAYER_NAME,
								layers: rls
							})
							//rl.setZIndex(21)
							fname = $('#user'+user_id+'_leak'+object_id+'_name').text()
							//fname += '|'+leak_detection_kind.toUpperCase()+'\n'
							console.log(fname)
							rl.setProperties({'fname': fname,'raster_id':raster_id})
							map.addLayer(rl);
						},
						error: function(response){
							dm.dialog("close")
							buildDynamicModalPopup('Error', 
								'<p>Could not load output.</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						}
					});
				}
			}
			else{
				reverseRemoveLayerEqual(LAYER_NAME)
			}
		}
	}

	function onChangeChkboxUserSavedLPShowOutput(roi_id, simulation_id, ld_id, us_lp_id){
		isChecked = $("#simulation_"+simulation_id+"_ld_"+ld_id+"_uslp_"+us_lp_id+"_chkbox").prop('checked')
		colorShow = $("#simulation_"+simulation_id+"_ld_"+ld_id+"_uslp_"+us_lp_id+"_linecolor polygon").attr('fill')
		USLP_LAYER_NAME = 'output-roi_'+roi_id+'-simulation'+simulation_id+'-ld'+ld_id+'-uslp'+us_lp_id
		console.log(USLP_LAYER_NAME)
		if(isChecked){
			_url = '/portal/waterleak/leakdetection/rois/'+roi_id+'/simulations/'+simulation_id+'/leak_detections/'+ld_id+'/show_user_leak_point'
			_url += '?user_leak_id='+us_lp_id
			onLoadStep4LeakDetectionLoadLeakPoints(_url, USLP_LAYER_NAME, colorShow)
		}
		else{
			reverseRemoveLayerEqual(USLP_LAYER_NAME)
		}
	}


	function onChangeChkboxImagesetShowOutput(kind, roi_id, simulation_id, simulation_imageset_id, randomColor=null, raster_id=null, is_climatology=false, leak_detection_kind='', is_user_chosen=false, portal_ld_id=null, shp_mpis_id=null){ 
		//leak_detection_kind = '2nd_deriv-by_index'
		is_topography = (kind.indexOf('_topography')>-1 || kind.indexOf('_floodfreq')>-1)
		if(is_topography){
			isChecked = $("#simulation_"+simulation_id+"_gt_"+simulation_imageset_id+"_"+kind+"_"+"chkbox").prop('checked')
			isRGBChecked = false
		}
		else{
			isChecked = $("#simulation_"+simulation_id+(portal_ld_id!=null?"_ld_"+portal_ld_id:"")+"_"+(is_climatology?"climatology_":"")+(is_user_chosen?"ucimageset":"imageset")+"_"+simulation_imageset_id+"_"+kind+(shp_mpis_id==null?"":"_"+shp_mpis_id)+"_"+(leak_detection_kind!=''? leak_detection_kind.replace('-','_')+"_": "")+"chkbox").prop('checked')
			_rgb_chkbox = $("#simulation_"+simulation_id+(portal_ld_id!=null?"_ld_"+portal_ld_id:"")+"_"+(is_climatology?"climatology_":"")+(is_user_chosen?"ucimageset":"imageset")+"_"+simulation_imageset_id+"_"+kind+(shp_mpis_id==null?"":"_"+shp_mpis_id)+"_rgb_chkbox")
			isRGBChecked = _rgb_chkbox.prop('checked')
			_rgb_chkbox.prop('disabled',!isChecked)
		}
		onChangeChkboxImagesetShowOutput2(isChecked, isRGBChecked, kind, roi_id, simulation_id, simulation_imageset_id, randomColor, raster_id, is_climatology, leak_detection_kind, is_user_chosen, portal_ld_id, shp_mpis_id, is_topography)
	}
	//
	function onChangeChkboxImagesetShowOutput2(isChecked, isRGBChecked, kind, roi_id, simulation_id, simulation_imageset_id, randomColor=null, raster_id=null, is_climatology=false, leak_detection_kind='', is_user_chosen=false, portal_ld_id=null, shp_mpis_id=null, is_topography=false){ 
		LAYER_NAME = 'output-roi_'+roi_id+'-simulation'+simulation_id+(portal_ld_id!=null?"-ld"+portal_ld_id:"")+(is_climatology?"-climatology":"")+'-'+(is_user_chosen?"ucimageset":"imageset")+simulation_imageset_id+'-'+kind+(shp_mpis_id==null?"":"-"+shp_mpis_id)+(leak_detection_kind!=''? '-'+leak_detection_kind:'')+((EDIT_LEAK_POINTS_MODE || DELETE_LEAK_POINTS_MODE)?'-edit':'')
		console.log(LAYER_NAME)
		if(kind.indexOf('coastline')>-1 || kind.indexOf('waterbody')>-1){ //mndwi_coastline or coastline
			onChangeChkboxImagesetShowShapeline(isChecked, isRGBChecked, kind, roi_id, simulation_id, simulation_imageset_id, randomColor, raster_id, LAYER_NAME, shp_mpis_id)
			
		}
		else {//if other raster
			if (isChecked){
				buildDynamicModalPopup('Loading output...', 
					'<p>Please wait...</p>', 
					[], [250,220])
				_url = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/'+(is_topography? 'generatetopography':(is_user_chosen?"ucprocessimageset" : (is_climatology? 'averageprocessimageset' : 'processimageset')))+'/'+simulation_imageset_id+'/'+kind+'/'+raster_id
				isLeakPoints = false
				if (leak_detection_kind!=''){
					leak_detection_kind_split = leak_detection_kind.split('-')
					isLeakPoints = (leak_detection_kind_split[0].indexOf('_leak_points')>-1)//2nd_deriv_leak_points
					if(portal_ld_id!=null){
						if (isLeakPoints){
							leak_detection_kind_split[0] = leak_detection_kind_split[0].replace('_leak_points','')// 2nd_deriv
							_url = '/portal/waterleak/leakdetection/rois/'+roi_id+'/simulations/'+simulation_id+'/leak_detections/'+portal_ld_id+'/intermediate/'+(is_user_chosen?"uc":"")+'processimageset/'+simulation_imageset_id+'/'+leak_detection_kind_split[1]+'/'+leak_detection_kind_split[0]+'/'+kind+'/'+raster_id+'/leak_points/show?'+((EDIT_LEAK_POINTS_MODE || DELETE_LEAK_POINTS_MODE)?'edit_mode=true&':'')+'max_leak_points='+SHOW_MAX_LEAK_POINTS
						
						}
						else{
							_url = '/portal/waterleak/leakdetection/rois/'+roi_id+'/simulations/'+simulation_id+'/leak_detections/'+portal_ld_id+'/intermediate/'+(is_user_chosen?"uc":"")+'processimageset/'+simulation_imageset_id+'/'+leak_detection_kind_split[1]+'/'+leak_detection_kind_split[0]+'/'+kind+'/'+raster_id
						}
					}
					else{
						if (isLeakPoints){
							leak_detection_kind_split[0] = leak_detection_kind_split[0].replace('_leak_points','')// 2nd_deriv
							_url = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/'+(is_user_chosen?"uc":"")+'processimageset/'+simulation_imageset_id+'/'+leak_detection_kind_split[1]+'/'+leak_detection_kind_split[0]+'/'+kind+'/'+raster_id+'/leak_points/show?'+((EDIT_LEAK_POINTS_MODE || DELETE_LEAK_POINTS_MODE)?'edit_mode=true&':'')+'max_leak_points='+SHOW_MAX_LEAK_POINTS
						}
						else{
							_url = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/'+(is_user_chosen?"uc":"")+'processimageset/'+simulation_imageset_id+'/'+leak_detection_kind_split[1]+'/'+leak_detection_kind_split[0]+'/'+kind+'/'+raster_id
						}
					}
				}
				if (isLeakPoints){
					console.log('is leak point')
					$.ajax({ type: "GET", url: _url, async: true,
						success : function(response){
							dm.dialog("close")
							//console.log(_url)
							//
							j = $.parseJSON(JSON.stringify(response));
							detected_leaks = j['leak_points']
							colorShow = $("#simulation_"+simulation_id+(portal_ld_id!=null?"_ld_"+portal_ld_id:"")+"_"+(is_user_chosen?"ucimageset":"imageset")+"_"+simulation_imageset_id+"_"+leak_detection_kind_split[1]+"_"+kind+"_"+leak_detection_kind_split[0]+"_leak_points_linecolor polygon").attr('fill')
							//colorHide = "#220022"
							_styleColor = _create_style_leak_points(colorShow)
							_styleBlack = _create_style_leak_points("#220022")
							rls = []
							for(var s=0; s<detected_leaks.length; s++){
								var x = detected_leaks[s]['xCoordinate']
								var y = detected_leaks[s]['yCoordinate']
								var value = detected_leaks[s]['pixelValue']
								var point_leak_id = detected_leaks[s]['id']
								var show_leak_point = detected_leaks[s]['showLeakPoint']
								var url_point = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/processimageset/'+simulation_imageset_id+'/'+leak_detection_kind_split[1]+'/'+leak_detection_kind_split[0]+'/'+kind+'/'+raster_id+'/leak_points/'+point_leak_id+'/change_visibility'	
								var lonlat = ol.proj.transform([x,y], 'EPSG:3857', 'EPSG:4326');
								var lonlat2 = lonlat//[lonlat[1],lonlat[0]]
								//console.log(lonlat2)
									
								rls[s] = new ol.layer.Vector({
									name: LAYER_NAME+'-'+point_leak_id,
									source: new ol.source.Vector({ 
										features: [new ol.Feature({ geometry: new ol.geom.Point( ol.proj.fromLonLat(lonlat2) ), })] 
									}),
									style: (show_leak_point? _styleColor : _styleBlack)
								});
								//console.log(rl)
								//console.log('#simulation_'+simulation_id+(portal_ld_id!=null?"_ld_"+portal_ld_id:"")+'_'+(is_user_chosen?"ucimageset":"imageset")+'_'+simulation_imageset_id+'_name')
								fname = $('#simulation_'+simulation_id+(portal_ld_id!=null?"_ld_"+portal_ld_id:"")+'_'+(is_user_chosen?"ucimageset":"imageset")+'_'+simulation_imageset_id+'_name').text()
								fname += '|'+leak_detection_kind.toUpperCase()+'-'+point_leak_id+'\n'
								console.log(fname)
								rls[s].setProperties({'fname': fname, 'raster_id':raster_id, 'url_point': url_point})
								//console.log(rl.getProperties())
								rls[s].setZIndex(21)
								
							//
							}
							rl = new ol.layer.Group({
								name: LAYER_NAME,
								layers: rls
							})
							//rl.setZIndex(21)
							fname = $('#simulation_'+simulation_id+(portal_ld_id!=null?"_ld_"+portal_ld_id:"")+'_'+(is_user_chosen?"ucimageset":"imageset")+'_'+simulation_imageset_id+'_name').text()
							fname += '|'+leak_detection_kind.toUpperCase()+'\n'
							console.log(fname)
							sname = $('#simulation_'+simulation_id+'_name').text()
							rl.setProperties({'fname': fname, 'sname':sname, 'raster_id':raster_id})
							map.addLayer(rl);
							EDIT_LEAK_POINTS_LAYER_NAME = LAYER_NAME
						},
						error: function(response){
							dm.dialog("close")
							buildDynamicModalPopup('Error', 
								'<p>Could not load output.</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						}
					});
				}
				else{
					console.log('is not leak point')
					$.ajax({ type: "GET", url: _url, async: true,
						success : function(response){
							dm.dialog("close")
							//console.log(_url)
							intermediateRasterEndpoint = response['response']['url']
							usesCustomColorspace = response['customColorspace']
							provider = response['response']['type']
							console.log(intermediateRasterEndpoint)
							is_2nd_deriv = (leak_detection_kind!='' && leak_detection_kind_split[0].indexOf('2nd_deriv')>-1)
							//
							console.log(is_2nd_deriv)
							if(is_2nd_deriv){
								minBar = parseFloat(response['response']['min'].toFixed(3))-0.001
								maxBar = parseFloat(response['response']['max'].toFixed(3))+0.001
								colorFrom =  [0,0,255]
								colorOver = [200,200,200]
								colorTo = [10,10,10]
							}
							else{
								minBar = parseFloat(response['response']['min'])-0.1
								maxBar = parseFloat(response['response']['max'])+0.1
								colorFrom = response['response']['rgbcolorfrom']
								colorOver = response['response']['rgbcolorover']
								colorTo = response['response']['rgbcolorto']
							}
							//
							if (kind=='RGB'){
								rl_layer_url = 'r:0='+raster_id+',g:1='+raster_id+',b:2='+raster_id+'&enhance_brightness=5'
								rl_url = intermediateRasterEndpoint+'/{z}/{x}/{y}.png?scale='+minBar+','+maxBar+'&layers='+rl_layer_url
							}
							else if (is_topography && usesCustomColorspace){
								cm = response['response']['colormap'].replaceAll(': ',':').replaceAll(', ',',').replaceAll('\'','\"')	
								rl_url = intermediateRasterEndpoint+'/{z}/{x}/{y}.png?layers=a='+raster_id+'&formula=a&colormap='+cm
							} 
							else{
								rl_url = intermediateRasterEndpoint+'/{z}/{x}/{y}.png?colormap={"continuous":"True","from":['+colorFrom[0]+','+colorFrom[1]+','+colorFrom[2]+'],"over":['+colorOver[0]+','+colorOver[1]+','+colorOver[2]+'],"to":['+colorTo[0]+','+colorTo[1]+','+colorTo[2]+'],"range":['+minBar+','+maxBar+']}'
							}
							//
							rl = new ol.layer.Tile({
								name: LAYER_NAME,
								extent: chosenROI.getSource().getExtent(),
								source: new ol.source.XYZ({
								url: rl_url,
								opaque: false
								})
							})
							rl.setZIndex(12)
							//console.log('#simulation_'+simulation_id+(portal_ld_id!=null?"_ld_"+portal_ld_id:"")+'_'+(is_user_chosen?"ucimageset":"imageset")+'_'+simulation_imageset_id+'_name')
							fname = $('#simulation_'+simulation_id+(portal_ld_id!=null?"_ld_"+portal_ld_id:"")+'_'+(is_user_chosen?"ucimageset":"imageset")+'_'+simulation_imageset_id+'_name').text()
							fname += '|'+kind.toUpperCase()+'\n'
							console.log(fname)
							sname = $('#simulation_'+simulation_id+'_name').text()
							rl.setProperties({'fname': fname,'sname':sname,'raster_id':raster_id})
							//console.log(rl.getProperties())
							map.addLayer(rl)
							listActiveLayers()
						},
						error: function(response){
							dm.dialog("close")
							buildDynamicModalPopup('Error', 
								'<p>Could not load output.</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						}
					});
				}
			}
			else{
				reverseRemoveLayerEqual(LAYER_NAME)
				listActiveLayers()
			}
		}
	}
	function onChangeChkboxImagesetShowShapeline(isChecked, isRGBChecked, kind, roi_id, simulation_id, simulation_imageset_id, randomColor=null, raster_id=null, LAYER_NAME, shp_mpis_id){
		LAYER_NAME_RGB = LAYER_NAME+'-rgb'
		if (isChecked){
			buildDynamicModalPopup('Loading output...', 
				'<p>Please wait...</p>', 
				[], [250,220])
			
			
			//load shapeline
			_url = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/processimageset/'+simulation_imageset_id+'/coastline/'+shp_mpis_id
			kind_split = kind.split('_') //mndwi_coastline => [mndwi,coastline]
			wi = kind_split[0]
			if (wi.indexOf('coastline')==-1 || wi.indexOf('waterbody')==-1){//if the kind does not start as coastline
				//_url += '?water_index='+wi
			}
			$.ajax({ type: "GET", url: _url, async: true,
				success : function(response){
					dm.dialog("close")
					alreadyLoadedShapelineRoi = false
					jr = $.parseJSON(JSON.stringify(response));
					
					map.getLayers().forEach(function(el) {
						if (el.get('name') === LAYER_NAME) {
							//check if shapeline was already loaded, instead of reloading for each update
							alreadyLoadedShapelineRoi = true
						}
					})

					rls = []
					//console.log(alreadyLoadedShapelineRoi)
					if (!alreadyLoadedShapelineRoi){	
						loadFeatureGeojsonVT(jr['json'],randomColor,rls)
					}

					//load RGB
					if(raster_id != null){
						_url = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/processimageset/'+simulation_imageset_id+'/RGB/'+raster_id
						$.ajax({ type: "GET", url: _url, async: true,
							success : function(response){
								dm.dialog("close")
								//console.log(_url)
								intermediateRasterEndpoint = response['response']['url']
								minBar = parseFloat(response['response']['min'])
								maxBar = parseFloat(response['response']['max']) //remove some of this scale to make it more bright
								provider = response['response']['type']
								rl_layer_url = 'r:0='+raster_id+',g:1='+raster_id+',b:2='+raster_id+'&enhance_brightness=5'
								rl2 = new ol.layer.Tile({
									name: LAYER_NAME_RGB,
									extent: chosenROI.getSource().getExtent(),
									source: new ol.source.XYZ({
										url: intermediateRasterEndpoint+'/{z}/{x}/{y}.png?scale='+minBar+','+maxBar+'&layers='+rl_layer_url,
										opaque: false
									})
								})
								rl2.setZIndex(12)
								fname = $('#simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_name').text()
								fname += '|RGB'+'\n'
								console.log(fname)
								sname = $('#simulation_'+simulation_id+'_name').text()
								//rl2.setProperties({'fname':fname,'sname':sname,'raster_id':raster_id})
								rl2.setVisible(isRGBChecked)
								//console.log(rl.getProperties())
								rls.push(rl2)
								rl = new ol.layer.Group({
									name: LAYER_NAME_RGB+'_grouped',
									layers: rls
								})
								rl.setProperties({'fname':fname,'sname':sname,'raster_id':raster_id})
								map.addLayer(rl)
								onChangeChkboxImagesetShowRGBOutput(kind, roi_id, simulation_id, simulation_imageset_id)
								listActiveLayers()
							},
							error: function(response){
								dm.dialog("close")
								buildDynamicModalPopup('Error', 
									'<p>Could not load output.</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							}
						})
					}
					
				},
				error: function(response){
					dm.dialog("close")
					buildDynamicModalPopup('Error', 
						'<p>Could not load output.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
			});
		}
		else{
			//reverseRemoveLayerEqual(LAYER_NAME)
			//reverseRemoveLayerEqual(LAYER_NAME_RGB)
			reverseRemoveLayerEqual(LAYER_NAME_RGB+'_grouped')
			listActiveLayers()
		}
	}
			

	function _set_progress_scale_by_state_leak(simulation_span_id, sim_state, start_from_step, max_steps){
		if (sim_state == 'submitted'){ step = 0 }

		else if (sim_state == 'downloading'){ step = 0.1 }
		else if (sim_state == 'error-downloading'){ step = 0.1 }
		else if (sim_state == 'error-download-corrupt'){ step = 0.1 }
		else if (sim_state == 'download-waiting-lta'){ step = 0.1 }
		else if (sim_state == 'download-timeout-retry'){ step = 0.1 }
		else if (sim_state == 'downloaded'){ step = 0.2 }			
		
		else if (sim_state == 'converting'){ step = 0.25 }
		else if (sim_state == 'error-converting'){ step = 0.25 }
		else if (sim_state == 'converted'){ step = 0.3 }
		
		else if (sim_state == 'resampling'){ step = 0.35 }
		else if (sim_state == 'error-resampling'){ step = 0.35 }	
		else if (sim_state == 'resampled'){ step = 0.4 }
		
		
		else if (sim_state == 'merging'){ step = 0.45 }
		else if (sim_state == 'error-merging'){ step = 0.45 }		
		else if (sim_state == 'merged'){step = 0.5 }
		else if (sim_state == 'storing-rgb'){ step = 0.45 }
		else if (sim_state == 'error-storing-rgb'){ step = 0.45 }		
		else if (sim_state == 'stored-rgb'){ step = 0.5 }

		else if (sim_state == 'processing'){ step = 0.5 }
		else if (sim_state == 'error-processing'){ step = 0.5 }
		else if (sim_state == 'processed'){ step = 0.55 }		
		else if (sim_state == 'storing-processing'){ step = 0.55 }
		else if (sim_state == 'error-storing-processing'){ step = 0.55 }		
		else if (sim_state == 'stored-processing'){ step = 0.6 }
		//old/legacy
		else if (sim_state == 'storing'){ step = 0.55 }
		else if (sim_state == 'error-storing'){ step = 0.55 }		
		else if (sim_state == 'stored'){ step = 0.6 }
		//
		else if (sim_state == 'calculating-diff'){ step = 0.6 }
		else if (sim_state == 'calculated-diff'){ step = 0.6 }
		else if (sim_state == 'error-calculating-diff'){ step = 0.6 }
		else if (sim_state == 'storing-calculated-diff'){ step = 0.7 }
		else if (sim_state == 'stored-calculated-diff'){ step = 1 }
		else if (sim_state == 'error-storing-calculated-diff'){ step = 0.7 }
		
		else if (sim_state == 'calculating-leak'){ step = 1.5 }
		else if (sim_state == 'calculated-leak'){ step = 1.5 }
		else if (sim_state == 'error-calculating-leak'){ step = 1.5 }
		else if (sim_state == 'storing-calculated-leak'){ step = 1.7 }
		else if (sim_state == 'error-storing-calculated-leak'){ step = 1.7 }
		else if (sim_state == 'stored-calculated-leak'){ step = 2 }
		
		else if (sim_state == 'generating-mask-leak'){ step = 2 }
		else if (sim_state == 'generated-mask-leak'){ step = 2 }
		else if (sim_state == 'error-generating-mask-leak'){ step = 2 }
		else if (sim_state == 'determinating-leak'){ step = 2.7 }
		else if (sim_state == 'determinated-leak'){ step = 2.7 }
		else if (sim_state == 'error-determinating-leak'){ step = 2.7 }
		else if (sim_state == 'storing-determinated-leak'){ step = 2.8 }
		else if (sim_state == 'stored-determinated-leak'){ step = 3 }
		else if (sim_state == 'error-storing-determinated-leak'){ step = 2.8 }

		
		/*else if (sim_state == 'cleaning-leak'){ step = 2.8 }
		else if (sim_state == 'cleaned-leak'){ step = 3 }
		else if (sim_state == 'error-cleaning-leak'){ step = 2.8 }
		else if (sim_state == 'error-cleaning-leak-nomask'){ step = 2.8 }*/
		
		else if (sim_state == 'success'){ step = 3 }

		nstep = step+start_from_step
		scale = (nstep/max_steps) * 100
		$(simulation_span_id).css('width', scale.toString()+"%")
	}


	function _set_color_state_leak(simulation_span_id, sim_state){
		//label color
		spanClass = '/static/images/unknown.svg'		
		//text
		spanTag = sim_state
		showLoadingIcon = false
		if (sim_state == 'submitted'){showLoadingIcon = true; spanTag = 'Submitted, waiting to run.'; spanClass = '/static/images/s0_submitted.svg'}

		else if (sim_state == 'downloading'){showLoadingIcon = true;  spanTag = '(Step 1/7): Downloading, this will take some time'; spanClass = '/static/images/s1_downloading.svg'}
		else if (sim_state == 'downloaded'){showLoadingIcon = true;  spanTag = '(Step 1/7): Downloaded'; spanClass = '/static/images/s1_downloaded.svg'}
		else if (sim_state == 'download-waiting-lta'){showLoadingIcon = true;  spanTag = '(Step 1/7): Download waiting for LTA, this will take some time'; spanClass = '/static/images/s1_download_waiting_lta.svg' }
		else if (sim_state == 'download-timeout-retry'){ showLoadingIcon = true;  spanTag = '(Step 1/7): Download timed out, retrying...'; spanClass = '/static/images/s1_download_timeout_retry.svg' }
		else if (sim_state == 'error-downloading'){showLoadingIcon = false;  spanTag = '(Step 1/7): Error on Downloading'; spanClass = '/static/images/s1_error_downloading.svg'}
		else if (sim_state == 'error-download-corrupt'){showLoadingIcon = false;  spanTag = '(Step 1/7): Error Downloading (File corrupt)'; spanClass = '/static/images/s1_error_downloading.svg'}
		
		else if (sim_state == 'converting'){showLoadingIcon = true;  spanTag = '(Step 1/7): Converting L1C to L2A'; spanClass = '/static/images/s2_converting.svg'}
		else if (sim_state == 'converted'){showLoadingIcon = true;  spanTag = '(Step 1/7): Converted L1C to L2A'; spanClass = '/static/images/s2_converted.svg'}
		else if (sim_state == 'error-converting'){showLoadingIcon = false;  spanTag = '(Step 1/7): Error on Converting L1C to L2A'; spanClass = '/static/images/s2_error_converting.svg'}
		
		else if (sim_state == 'resampling'){showLoadingIcon = true;  spanTag = '(Step 2/7): Resampling imagesets'; spanClass = '/static/images/s2b_resampling.svg'}
		else if (sim_state == 'resampled'){showLoadingIcon = true;  spanTag = '(Step 2/7): Resampled imagesets'; spanClass = '/static/images/s2b_resampled.svg'}
		else if (sim_state == 'error-resampling'){showLoadingIcon = false;  spanTag = '(Step 2/7): Error on resampling imagesets'; spanClass = '/static/images/s2b_error_resampling.svg'}		
		
		else if (sim_state == 'merging'){showLoadingIcon = true;  spanTag = '(Step 3/7): Merging resampled imagesets'; spanClass = '/static/images/s2c_merging.svg'}
		else if (sim_state == 'merged'){showLoadingIcon = true;  spanTag = '(Step 3/7): Merged resampled imagesets'; spanClass = '/static/images/s2c_merged.svg'}
		else if (sim_state == 'error-merging'){showLoadingIcon = false;  spanTag = '(Step 3/7): Error on merging resampled imagesets'; spanClass = '/static/images/s2c_error_merging.svg'}		
		else if (sim_state == 'storing-rgb'){showLoadingIcon = true;  spanTag = '(Step 3/7): Storing RGB product'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored-rgb'){showLoadingIcon = true;  spanTag = '(Step 3/7): Stored RGB product'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing-rgb'){showLoadingIcon = false;  spanTag = '(Step 3/7): Error on Storing RGB product'; spanClass = '/static/images/s4_error_storing.svg'}
		
		else if (sim_state == 'processing'){showLoadingIcon = true;  spanTag = '(Step 4/7): Processing'; spanClass = '/static/images/s3_processing.svg'}
		else if (sim_state == 'processed'){showLoadingIcon = true;  spanTag = '(Step 4/7): Processed'; spanClass = '/static/images/s3_processed.svg'}
		else if (sim_state == 'error-processing'){showLoadingIcon = false;  spanTag = '(Step 4/7): Error on Processing'; spanClass = '/static/images/s3_error_processing.svg'}		
		else if (sim_state == 'storing-processing'){showLoadingIcon = true;  spanTag = '(Step 4/7): Storing processed products'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored-processing'){showLoadingIcon = true;  spanTag = '(Step 4/7): Stored processed products'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing-processing'){showLoadingIcon = false;  spanTag = '(Step 4/7): Error on Storing processed products'; spanClass = '/static/images/s4_error_storing.svg'}
		//old		
		else if (sim_state == 'storing'){showLoadingIcon = true;  spanTag = '(Step 4/7): Storing products'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored'){showLoadingIcon = true;  spanTag = '(Step 4/7): Stored products'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing'){showLoadingIcon = false;  spanTag = '(Step 4/7): Error on Storing products'; spanClass = '/static/images/s4_error_storing.svg'}
		//

		else if (sim_state == 'calculating-diff'){showLoadingIcon = true;  spanTag = '(Step 5/7): Calculating anomaly'; spanClass = '/static/images/s5_calculating_anomaly.svg'}
		else if (sim_state == 'calculated-diff'){showLoadingIcon = true;  spanTag = '(Step 5/7): Calculated anomaly'; spanClass = '/static/images/s5_calculated_anomaly.svg'}
		else if (sim_state == 'error-calculating-diff'){showLoadingIcon = false;  spanTag = '(Step 5/7): Error calculating anomaly'; spanClass = '/static/images/s5_error_calculating_anomaly.svg'}
		else if (sim_state == 'storing-calculated-diff'){showLoadingIcon = true;  spanTag = '(Step 5/7): Storing Calculated anomaly'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored-calculated-diff'){ showLoadingIcon = true; spanTag = '(Step 5/7): Stored Calculated anomaly'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing-calculated-diff'){showLoadingIcon = false;  spanTag = '(Step 5/7): Error on Storing Calculated anomaly'; spanClass = '/static/images/s4_error_storing.svg'}
		
		else if (sim_state == 'calculating-leak'){showLoadingIcon = true;  spanTag = '(Step 6/7): Calculating 2nd derivative'; spanClass = '/static/images/s6_calculating_laplacian.svg'}
		else if (sim_state == 'calculated-leak'){showLoadingIcon = true;  spanTag = '(Step 6/7): Calculated 2nd derivative'; spanClass = '/static/images/s6_calculated_laplacian.svg'}
		else if (sim_state == 'error-calculating-leak'){showLoadingIcon = false;  spanTag = '(Step 6/7): Error calculating 2nd derivative'; spanClass = '/static/images/s6_error_calculating_laplacian.svg'}
		else if (sim_state == 'storing-calculated-leak'){showLoadingIcon = true;  spanTag = '(Step 6/7): Storing Calculated 2nd derivative'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored-calculated-leak'){showLoadingIcon = false;  spanTag = '(Step 6/7): Stored Calculated 2nd derivative'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing-calculated-leak'){showLoadingIcon = false;  spanTag = '(Step 6/7): Error on Storing Calculated 2nd derivative'; spanClass = '/static/images/s4_error_storing.svg'}
		
		else if (sim_state == 'generating-mask-leak'){showLoadingIcon = true;  spanTag = '(Step 7/7): Generating mask for filter possible leaks'; spanClass = '/static/images/s8_generating_mask_leak.svg' }
		else if (sim_state == 'generated-mask-leak'){showLoadingIcon = true;  spanTag = '(Step 7/7): Generated mask for filter possible leaks'; spanClass = '/static/images/s8_generated_mask_leak.svg' }
		else if (sim_state == 'error-generating-mask-leak'){showLoadingIcon = false;  spanTag = '(Step 7/7): Error generating mask for filter possible leaks'; spanClass = '/static/images/s8_error_generating_mask_leak.svg' }
		
		else if (sim_state == 'determinating-leak'){showLoadingIcon = true;  spanTag = '(Step 7/7): Identifying possible leaks'; spanClass = '/static/images/s7_identifying_leaks.svg'}
		else if (sim_state == 'determinated-leak'){ showLoadingIcon = true; spanTag = '(Step 7/7): Identified possible leaks'; spanClass = '/static/images/s7_identified_leaks.svg'}
		else if (sim_state == 'error-determinating-leak'){showLoadingIcon = false;  spanTag = '(Step 7/7): Error identifying possible leaks'; spanClass = '/static/images/s7_error_identifying_leaks.svg'}
		else if (sim_state == 'storing-determinated-leak'){showLoadingIcon = true;  spanTag = '(Step 7/7): Storing Identified possible leaks'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored-determinated-leak'){showLoadingIcon = false;  spanTag = '(Step 7/7): Stored Identified possible leaks'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing-determinated-leak'){showLoadingIcon = false;  spanTag = '(Step 7/7): Error on Storing Identified possible leaks'; spanClass = '/static/images/s4_error_storing.svg'}
		
		else if (sim_state == 'success'){showLoadingIcon = false;  spanTag = 'Finished'; spanClass = '/static/images/check.svg'}
		
		
		
		//spanTag += '\n[Click on the icon to see more details.]'
		$(simulation_span_id+' #ld_state').attr('src',spanClass)
		$(simulation_span_id+' #ld_state').attr('title',spanTag)
		$(simulation_span_id+' #ld_proc_state').text(spanTag)
		if (showLoadingIcon){ $(simulation_span_id+' #ld_loading').show() }
		else{ $(simulation_span_id+' #ld_loading').hide() }

	}

	function _set_btns_state_leak(simulation_div_btn_id, sim_state, sim_aos_id, sim_id, sim_imageset_id, detection_kind){
		//console.log(simulation_div_btn_id, sim_state, sim_aos_id, sim_id, sim_imageset_id, detection_kind)
		$('#'+simulation_div_btn_id).empty()
		buttons = ""
		if ((sim_state.indexOf('storing-calculated-diff')>-1)||(sim_state.indexOf('storing-calculated-leak')>-1)||(sim_state.indexOf('storing-determinated-leak')>-1)||(sim_state.indexOf('generated-mask-leak')>-1) ){//if finished, dont do anything
			buttons = ""
		}
		else if((sim_state.indexOf('error')>-1) || (sim_state.indexOf('ed')>-1)){//stored or generated
			//buttons += "<a class='clickLeakDetectionRestart' onclick=onClickLeakDetectionButton('restart',"+sim_aos_id+","+sim_id+","+sim_imageset_id+",'"+detection_kind+"')><img height=24px src='/static/images/restart.svg' title='Restart leak detection' style='margin-left:15px'/></a>"
			buttons += "<a class='clickLeakDetectionRun' onclick=onClickLeakDetectionButton('run',"+sim_aos_id+","+sim_id+","+sim_imageset_id+",'"+detection_kind+"')><img height=24px src='/static/images/run.svg' title='Run next step' style='margin-left:15px'/></a>"
		}
		
		$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #"+simulation_div_btn_id).append(buttons)
		if (EDIT_LEAK_POINTS_MODE || DELETE_LEAK_POINTS_MODE){
			$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #"+simulation_div_btn_id+" .clickLeakDetectionRun").hide()
			$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #"+simulation_div_btn_id+" .clickLeakDetectionRestart").hide()
		}
		else{
			$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #"+simulation_div_btn_id+" .clickLeakDetectionRun").show()
			$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #"+simulation_div_btn_id+" .clickLeakDetectionRestart").show()
		}
	}

	function _set_progress_scale_by_state(simulation_span_id, sim_state, start_from_step, max_steps){
		//console.log('_set_progress_scale_by_state('+simulation_span_id+', '+sim_state+', '+max_steps+')')
		if (sim_state == 'submitted'){ step = 0 }

		else if (sim_state == 'downloading'){ step = 0.5 }
		else if (sim_state == 'error-downloading'){ step = 0.5 }
		else if (sim_state == 'error-download-corrupt'){ step = 0.5 }		
		else if (sim_state == 'download-waiting-lta'){ step = 0.5 }
		else if (sim_state == 'download-timeout-retry'){ step = 0.5 }		
		else if (sim_state == 'downloaded'){ step = 1 }		
		else if (sim_state == 'uploading'){ step = 0.5 }
		else if (sim_state == 'error-uploading'){ step = 0.5 }
		else if (sim_state == 'uploaded'){ step = 1 }		
		
		else if (sim_state == 'converting'){ step = 1.5 }
		else if (sim_state == 'error-converting'){ step = 1.5 }
		else if (sim_state == 'converted'){ step = 2 }
		
		else if (sim_state == 'resampling'){ step = 2.5 }
		else if (sim_state == 'error-resampling'){ step = 2.5 }	
		else if (sim_state == 'resampled'){ step = 3 }	
		
		
		else if (sim_state == 'merging'){ step = 0.5 }
		else if (sim_state == 'error-merging'){ step = 0.5 }		
		else if (sim_state == 'merged'){step = 1 }
		else if (sim_state == 'storing-rgb'){ step = 1 }
		else if (sim_state == 'error-storing-rgb'){ step = 1 }		
		else if (sim_state == 'stored-rgb'){ step = 1 }

		//water leak----------------
		else if (sim_state == 'generating-virtual'){ step = 1.1 }
		else if (sim_state == 'error-generating-virtual'){ step = 1.1 }
		else if (sim_state == 'generated-virtual'){ step = 1.2 }		
		
		else if (sim_state == 'interpolating-products'){ step = 1.25}
		else if (sim_state == 'error-interpolating-products'){ step = 1.25}		
		else if (sim_state == 'interpolated-products'){ step = 1.4}
		//-------------
		
		else if (sim_state == 'processing'){ step = 1.5 }
		else if (sim_state == 'error-processing'){ step = 1.5 }
		else if (sim_state == 'processed'){ step = 2 }
		else if (sim_state == 'storing-processing'){ step = 2.1}
		else if (sim_state == 'error-storing-processing'){ step = 2.1 }		
		else if (sim_state == 'stored-processing'){ step = 2.1 }

		//water leak----------------
		else if (sim_state == 'generating-average'){ step = 2.2 }
		else if (sim_state == 'error-generating-average'){ step = 2.2 }		
		else if (sim_state == 'generated-average'){ step = 2.3 }
		else if (sim_state == 'storing-generating-average'){ step = 2.4 }
		else if (sim_state == 'error-storing-generating-average'){ step = 2.4 }		
		else if (sim_state == 'stored-generating-average'){ step = 2.4 }
		//-------------		
		//old
		else if (sim_state == 'storing'){ step = 2.5 }
		else if (sim_state == 'error-storing'){ step = 2.5 }		
		else if (sim_state == 'stored'){ step = 2.5 }
		//
		//else if (sim_state == 'dataverse-uploading'){ step = 2.5 }
		//else if (sim_state == 'error-dataverse-uploading'){ step = 2.5 }
		else if (sim_state == 'success'){ step = 3 }

		nstep = step+start_from_step
		scale = (nstep/max_steps) * 100
		$(simulation_span_id).css('width', scale.toString()+"%")
	}

	function _set_color_state3(simulation_span_id, sim_state){//user repository
		//console.log(_set_color_state3)
		//console.log(simulation_span_id, sim_state)
		//label color
		spanClass = '/static/images/unknown.svg'		
		//text
		spanTag = sim_state
		if (sim_state == 'submitted'){ spanTag = 'Submitted, waiting to be processed'; spanClass = '/static/images/s0_submitted.svg'}
		
		else if (sim_state == 'uploading'){ spanTag = 'Uploading'; spanClass = '/static/images/s1_uploading.svg'}
		else if (sim_state == 'uploaded'){ spanTag = 'Uploaded'; spanClass = '/static/images/s1_uploaded.svg'}
		else if (sim_state == 'error-uploading'){ spanTag = 'Error on Uploading'; spanClass = '/static/images/s1_error_uploading.svg'}
		
		else if (sim_state == 'generating-mask'){ spanTag = 'Generating mask for filter possible leaks'; spanClass = '/static/images/s8_generating_mask_leak.svg' }
		else if (sim_state == 'generated-mask'){ spanTag = ' Generated mask for filter possible leaks'; spanClass = '/static/images/s8_generated_mask_leak.svg' }
		else if (sim_state == 'error-generating-mask'){ spanTag = 'Error generating mask for filter possible leaks'; spanClass = '/static/images/s8_error_generating_mask_leak.svg' }
		
		else if (sim_state == 'storing'){ spanTag = 'Storing products'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored'){ spanTag = 'Stored products'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing'){ spanTag = 'Error on Storing products'; spanClass = '/static/images/s4_error_storing.svg'}
		
		$(simulation_span_id).attr('src',spanClass)
		$(simulation_span_id).attr('title',spanTag)
	} 

	function _set_color_state2(simulation_span_id, sim_state){//simulation products
		//console.log('_set_color_state2('+simulation_span_id+', '+sim_state+')')
		//label color
		spanClass = '/static/images/unknown.svg'		
		//text
		spanTag = sim_state
		if (sim_state == 'submitted'){ spanTag = 'Submitted, waiting to be processed'; spanClass = '/static/images/s0_submitted.svg'}

		else if (sim_state == 'downloading'){ spanTag = '(Step 1/3): Downloading'; spanClass = '/static/images/s1_downloading.svg'}
		else if (sim_state == 'downloaded'){ spanTag = '(Step 1/3): Downloaded'; spanClass = '/static/images/s1_downloaded.svg'}
		else if (sim_state == 'download-waiting-lta'){ spanTag = '(Step 1/3): Download waiting for LTA'; spanClass = '/static/images/s1_download_waiting_lta.svg' }
		else if (sim_state == 'download-timeout-retry'){ spanTag = '(Step 1/3): Download timed out, retrying...'; spanClass = '/static/images/s1_download_timeout_retry.svg' }
		else if (sim_state == 'error-downloading'){ spanTag = '(Step 1/3): Error on Downloading'; spanClass = '/static/images/s1_error_downloading.svg'}
		else if (sim_state == 'error-download-corrupt'){ spanTag = '(Step 1/3): Error Downloading (File corrupt)'; spanClass = '/static/images/s1_error_downloading.svg'}
		else if (sim_state == 'uploading'){ spanTag = '(Step 1/3): Uploading'; spanClass = '/static/images/s1_uploading.svg'}
		else if (sim_state == 'uploaded'){ spanTag = '(Step 1/3): Uploaded'; spanClass = '/static/images/s1_uploaded.svg'}
		else if (sim_state == 'error-uploading'){ spanTag = '(Step 1/3): Error on Uploading'; spanClass = '/static/images/s1_error_uploading.svg'}
		
		else if (sim_state == 'converting'){ spanTag = '(Step 2/3): Converting L1C to L2A'; spanClass = '/static/images/s2_converting.svg'}
		else if (sim_state == 'converted'){ spanTag = '(Step 2/3): Converted L1C to L2A'; spanClass = '/static/images/s2_converted.svg'}
		else if (sim_state == 'error-converting'){ spanTag = '(Step 2/3): Error on Converting L1C to L2A'; spanClass = '/static/images/s2_error_converting.svg'}
		
		else if (sim_state == 'resampling'){ spanTag = '(Step 3/3): Resampling imagesets'; spanClass = '/static/images/s2b_resampling.svg'}
		else if (sim_state == 'resampled'){ spanTag = '(Step 3/3): Resampled imagesets'; spanClass = '/static/images/s2b_resampled.svg'}
		else if (sim_state == 'error-resampling'){ spanTag = '(Step 3/3): Error on resampling imagesets'; spanClass = '/static/images/s2b_error_resampling.svg'}		
		
		else if (sim_state == 'merging'){ spanTag = '(Step 1/3): Merging resampled imagesets'; spanClass = '/static/images/s2c_merging.svg'}
		else if (sim_state == 'merged'){ spanTag = '(Step 1/3): Merged resampled imagesets'; spanClass = '/static/images/s2c_merged.svg'}
		else if (sim_state == 'error-merging'){ spanTag = '(Step 1/3): Error on merging resampled imagesets'; spanClass = '/static/images/s2c_error_merging.svg'}		
		else if (sim_state == 'storing-rgb'){ spanTag = '(Step 1/3): Storing RGB product'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored-rgb'){ spanTag = '(Step 1/3): Stored RGB product'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing-rgb'){ spanTag = '(Step 1/3): Error on Storing RGB product'; spanClass = '/static/images/s4_error_storing.svg'}
		
		//water leak
		else if (sim_state == 'generating-virtual'){ spanTag = '(Step 1/3): Generating virtual imagesets'; spanClass = '/static/images/s2d_generating_virtual.svg'}
		else if (sim_state == 'generated-virtual'){ spanTag = '(Step 1/3): Generated virtual imagesets'; spanClass = '/static/images/s2d_generated_virtual.svg'}
		else if (sim_state == 'error-generating-virtual'){ spanTag = '(Step 1/3): Error on generating virtual imagesets'; spanClass = '/static/images/s2d_error_generating_virtual.svg'}		
		
		else if (sim_state == 'interpolating-products'){ spanTag = '(Step 1/3): Interpolating products'; spanClass = '/static/images/s2e_interpolating_products.svg'}
		else if (sim_state == 'interpolated-products'){ spanTag = '(Step 1/3): Interpolated products'; spanClass = '/static/images/s2e_interpolated_products.svg'}
		else if (sim_state == 'error-interpolating-products'){ spanTag = '(Step 1/3): Error on interpolating products'; spanClass = '/static/images/s2e_error_interpolating_products.svg'}		
		//

		else if (sim_state == 'processing'){ spanTag = '(Step 2/3): Processing'; spanClass = '/static/images/s3_processing.svg'}
		else if (sim_state == 'processed'){ spanTag = '(Step 2/3): Processed'; spanClass = '/static/images/s3_processed.svg'}
		else if (sim_state == 'error-processing'){ spanTag = '(Step 2/3): Error on Processing'; spanClass = '/static/images/s3_error_processing.svg'}
		else if (sim_state == 'storing-processing'){ spanTag = '(Step 2/3): Storing processed products'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored-processing'){ spanTag = '(Step 2/3): Stored processed products'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing-processing'){ spanTag = '(Step 2/3): Error on Storing processed products'; spanClass = '/static/images/s4_error_storing.svg'}
				
		
		//water leak
		else if (sim_state == 'generating-average'){ spanTag = '(Step 2/3): Generating climatology'; spanClass = '/static/images/s3b_generating_average.svg'}
		else if (sim_state == 'generated-average'){ spanTag = '(Step 2/3): Generated climatology'; spanClass = '/static/images/s3b_generated_average.svg'}
		else if (sim_state == 'error-generating-average'){ spanTag = '(Step 2/3): Error on generating climatology'; spanClass = '/static/images/s3b_error_generating_average.svg'}		
		else if (sim_state == 'storing-generating-average'){ spanTag = '(Step 2/3): Storing climatology'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored-generating-average'){ spanTag = '(Step 2/3): Stored climatology'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing-generating-average'){ spanTag = '(Step 2/3): Error on Storing climatology'; spanClass = '/static/images/s4_error_storing.svg'}
		//
		//old
		else if (sim_state == 'storing'){ spanTag = '(Step 3/3): Storing products'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored'){ spanTag = '(Step 3/3): Stored products'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing'){ spanTag = '(Step 3/3): Error on Storing products'; spanClass = '/static/images/s4_error_storing.svg'}
		//
		//else if (sim_state == 'dataverse-uploading'){ spanTag = '(Step 3/3): Submitting Dataverse'; spanClass = '/static/images/error.svg'}
		//else if (sim_state == 'error-dataverse-uploading'){ spanTag = '(Step 3/3): Error on Uploading to Dataverse'; spanClass = '/static/images/error.svg'}
		else if (sim_state == 'success'){ spanTag = 'Finished'; spanClass = '/static/images/check.svg'}
		//spanTag += '\n[Click on the icon to see more details.]'
		$(simulation_span_id).attr('src',spanClass)
		$(simulation_span_id).attr('title',spanTag)
	}

	function _set_font_color_state(simulation_name_id, sim_state){
		//console.log('_set_font_color_state('+simulation_name_id+', '+sim_state+')')
		if (sim_state == 'success'){ $(simulation_name_id).css('color','') }
		else{ $(simulation_name_id).css('color','#999999') }		
	}

	function _set_color_state_span_tag_class(sim_state){
		//label color
		spanClass = '/static/images/unknown.svg'		
		//text
		spanTag = sim_state 
		if (sim_state == 'submitted'){ spanTag = 'Submitted, waiting to be processed'; spanClass = '/static/images/s0_submitted.svg'}

		else if (sim_state == 'downloading'){ spanTag = '(Step 1/6): Downloading'; spanClass = '/static/images/s1_downloading.svg'}
		else if (sim_state == 'downloaded'){ spanTag = '(Step 1/6): Downloaded'; spanClass = '/static/images/s1_downloaded.svg'}
		else if (sim_state == 'error-downloading'){ spanTag = '(Step 1/6): Error on Downloading'; spanClass = '/static/images/s1_error_downloading.svg'}
		else if (sim_state == 'error-download-corrupt'){ spanTag = '(Step 1/6): Error Downloading (File Corrupt)'; spanClass = '/static/images/s1_error_downloading.svg'}
		else if (sim_state == 'uploading'){ spanTag = '(Step 1/6): Uploading'; spanClass = '/static/images/s1_uploading.svg'}
		else if (sim_state == 'uploaded'){ spanTag = '(Step 1/6): Uploaded'; spanClass = '/static/images/s1_uploaded.svg'}
		else if (sim_state == 'error-uploading'){ spanTag = '(Step 1/6): Error on Uploading'; spanClass = '/static/images/s1_error_uploading.svg'}
		
		else if (sim_state == 'converting'){ spanTag = '(Step 2/6): Converting L1C to L2A'; spanClass = '/static/images/s2_converting.svg'}
		else if (sim_state == 'converted'){ spanTag = '(Step 2/6): Converted L1C to L2A'; spanClass = '/static/images/s2_converted.svg'}
		else if (sim_state == 'error-converting'){ spanTag = '(Step 2/6): Error on Converting L1C to L2A'; spanClass = '/static/images/s2_error_converting.svg'}
		
		else if (sim_state == 'resampling'){ spanTag = '(Step 3/6): Resampling imagesets'; spanClass = '/static/images/s2b_resampling.svg'}
		else if (sim_state == 'resampled'){ spanTag = '(Step 3/6): Resampled imagesets'; spanClass = '/static/images/s2b_resampled.svg'}
		else if (sim_state == 'error-resampling'){ spanTag = '(Step 3/6): Error on resampling imagesets'; spanClass = '/static/images/s2b_error_resampling.svg'}		
		
		else if (sim_state == 'merging'){ spanTag = '(Step 4/6): Merging resampled imagesets'; spanClass = '/static/images/s2c_merging.svg'}
		else if (sim_state == 'merged'){ spanTag = '(Step 4/6): Merged resampled imagesets'; spanClass = '/static/images/s2c_merged.svg'}
		else if (sim_state == 'error-merging'){ spanTag = '(Step 4/6): Error on merging resampled imagesets'; spanClass = '/static/images/s2c_error_merging.svg'}		
		else if (sim_state == 'storing-rgb'){ spanTag = '(Step 4/6): Storing RGB product'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored-rgb'){spanTag = '(Step 4/6): Stored RGB product'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing-rgb'){spanTag = '(Step 4/6): Error on Storing RGB product'; spanClass = '/static/images/s4_error_storing.svg'}
		
		//water leak
		else if (sim_state == 'generating-virtual'){ spanTag = '(Step 4/6): Generating virtual imagesets'; spanClass = '/static/images/s2d_generating_virtual.svg'}
		else if (sim_state == 'generated-virtual'){ spanTag = '(Step 4/6): Generated virtual imagesets'; spanClass = '/static/images/s2d_generated_virtual.svg'}
		else if (sim_state == 'error-generating-virtual'){ spanTag = '(Step 4/6): Error on generating virtual imagesets'; spanClass = '/static/images/s2d_error_generating_virtual.svg'}		
		
		else if (sim_state == 'interpolating-products'){ spanTag = '(Step 4/6): Interpolating products'; spanClass = '/static/images/s2e_interpolating_products.svg'}
		else if (sim_state == 'interpolated-products'){ spanTag = '(Step 4/6): Interpolated products'; spanClass = '/static/images/s2e_interpolated_products.svg'}
		else if (sim_state == 'error-interpolating-products'){ spanTag = '(Step 4/6): Error on interpolating products'; spanClass = '/static/images/s2e_error_interpolating_products.svg'}		
		//

		else if (sim_state == 'processing'){ spanTag = '(Step 5/6): Processing'; spanClass = '/static/images/s3_processing.svg'}
		else if (sim_state == 'processed'){ spanTag = '(Step 5/6): Processed'; spanClass = '/static/images/s3_processed.svg'}
		else if (sim_state == 'error-processing'){ spanTag = '(Step 5/6): Error on Processing'; spanClass = '/static/images/s3_error_processing.svg'}		
		else if (sim_state == 'storing-processing'){ spanTag = '(Step 5/6): Storing processed products'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored-processing'){ spanTag = '(Step 5/6): Stored processed products'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing-processing'){ spanTag = '(Step 5/6): Error on Storing processed products'; spanClass = '/static/images/s4_error_storing.svg'}
		
		//water leak
		else if (sim_state == 'generating-average'){ spanTag = '(Step 5/6): Generating climatology'; spanClass = '/static/images/s3b_generating_average.svg'}
		else if (sim_state == 'generated-average'){ spanTag = '(Step 5/6): Generated climatology'; spanClass = '/static/images/s3b_generated_average.svg'}
		else if (sim_state == 'error-generating-average'){ spanTag = '(Step 5/6): Error on generating climatology'; spanClass = '/static/images/s3b_error_generating_average.svg'}		
		else if (sim_state == 'storing-generating-average'){ spanTag = '(Step 5/6): Storing climatology'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored-generating-average'){ spanTag = '(Step 5/6): Stored climatology'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing-generating-average'){ spanTag = '(Step 5/6): Error on Storing climatology'; spanClass = '/static/images/s4_error_storing.svg'}
		//
		//old
		else if (sim_state == 'storing'){ spanTag = '(Step 6/6): Storing products'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored'){ spanTag = '(Step 6/6): Stored products'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing'){ spanTag = '(Step 6/6): Error on Storing products'; spanClass = '/static/images/s4_error_storing.svg'}
		//
		else if (sim_state == 'dataverse-uploading'){ spanTag = 'Submitting Dataverse'; spanClass = '/static/images/dataverse-uploading.svg'}
		else if (sim_state == 'dataverse-uploaded'){ spanTag = 'Submitted Dataverse'; spanClass = '/static/images/dataverse-uploaded.svg'}
		else if (sim_state == 'error-dataverse-uploading'){ spanTag = 'Error on Uploading to Dataverse'; spanClass = '/static/images/error-dataverse-uploading.svg'}
		else if (sim_state == 'success'){ spanTag = 'Finished'; spanClass = '/static/images/check.svg'}
		//
		else if (sim_state == 'generating-topo'){ spanTag = 'Topography: Generating topography'; spanClass = '/static/images/generating-topo.svg'}
		else if (sim_state == 'generated-topo'){ spanTag = 'Topography: Generated topography'; spanClass = '/static/images/generated-topo.svg'}
		else if (sim_state == 'error-generating-topo'){ spanTag = 'Topography: Error on generating topography'; spanClass = '/static/images/error-generated-topo.svg'}		
		else if (sim_state == 'storing-generated-topo'){ spanTag = 'Topography: Storing topography'; spanClass = '/static/images/s4_storing.svg'}
		else if (sim_state == 'stored-generated-topo'){ spanTag = 'Topography: Stored topography'; spanClass = '/static/images/s4_stored.svg'}
		else if (sim_state == 'error-storing-generated-topo'){ spanTag = 'Topography: Error on Storing topography'; spanClass = '/static/images/s4_error_storing.svg'}
		//
		return [spanTag, spanClass]
	}

	function _set_color_state(simulation_span_id, sim_state){//simulation
		//console.log('_set_color_state('+simulation_span_id+', '+sim_state+')')
		spanTagClass = _set_color_state_span_tag_class(sim_state)
		spanTag = spanTagClass[0]
		spanClass = spanTagClass[1]
		//spanTag += '\n[Click on the icon to see more details.]'
		$(simulation_span_id).attr('title',spanTag)
		$(simulation_span_id).attr('src',spanClass)
	}

	function _set_btns_state(simulation_div_btn_id, sim_state, sim_aos_id, sim_id){
		$('#'+simulation_div_btn_id).empty()
		buttons = ""
		if((sim_state.indexOf('error')>-1)){
			buttons += "<a class=clickSimulationRun onclick=onClickSimulationButton('run',"+sim_aos_id+","+sim_id+")><img height=24px src='/static/images/run.svg' title='Run' style='margin:3px'/></a>"
		}
		else if ((sim_state.indexOf('error')==-1) && (sim_state.indexOf('ing')>-1)){
			buttons += "<a class=clickSimulationStop onclick=onClickSimulationButton('stop',"+sim_aos_id+","+sim_id+")><img height=24px src='/static/images/stop.svg' title='Stop' style='margin:3px'/></a>"
		}
		if ((sim_state == 'success') || (sim_state.indexOf('error')>-1)){
			if (sim_state == 'success'){//if finished, show share button
				//buttons += "<br>"
				buttons += "<a class=clickSimulationSubmitToDataverse onclick=onClickSimulationButton('submit_to_dataverse',"+sim_aos_id+","+sim_id+")><img height=24px src='/static/images/dataverse.png' title='Submit to dataverse' style='margin:3px'/></a>"
				{% if request.path == home_coastal %}
				buttons += "<a class=clickSimulationGenerateTopoMap onclick=onClickCoastalLineAllSimulationButton('create_cleanup',"+sim_aos_id+","+sim_id+")><img height=24px src='/static/images/edit_leak2.svg' title='Cleanup coastline for all images' style='margin:3px'/></a>"
				buttons += "<a class=clickSimulationGenerateTopoMap onclick=onClickSimulationButton('generate_topomap',"+sim_aos_id+","+sim_id+")><img height=24px src='/static/images/topomap.svg' title='Generate topographic maps' style='margin:3px'/></a>"
				{% endif %}			
				buttons += "<a class=clickSimulationShare onclick=onClickSimulationButton('share',"+sim_aos_id+","+sim_id+")><img height=24px src='/static/images/share.svg' title='Share' style='margin:3px'/></a>"
			}
			{% if request.path != home_waterleak %}	
			buttons += "<a class=clickSimulationEdit onclick=onClickSimulationButton('edit',"+sim_aos_id+","+sim_id+")><img height=24px src='/static/images/edit.svg' title='Edit' style='margin:3px'/></a>"
			{% endif %}		
			buttons += "<a class=clickSimulationDelete onclick=onClickSimulationButton('delete',"+sim_aos_id+","+sim_id+")><img height=24px src='/static/images/delete.svg' title='Delete' style='margin:3px'/></a>"			
			
			
		}
		$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #"+simulation_div_btn_id).append(buttons)
		if(EDIT_LEAK_POINTS_MODE){//hide
			
			{% if request.path != home_waterleak %}
			$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #"+simulation_div_btn_id+' .clickSimulationEdit').hide()
			{% endif %}
			$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #"+simulation_div_btn_id+' .clickSimulationDelete').hide()
		}
		else{
		
			{% if request.path != home_waterleak %}
			$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #"+simulation_div_btn_id+' .clickSimulationEdit').show()
			{% endif %}
			$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #"+simulation_div_btn_id+' .clickSimulationDelete').show()
		}
	}

	function addOriginalThresholdValue(sim_id, sim_imageset_id, sim_imageset_job_outputs){
		for (var nj in sim_imageset_job_outputs){
			njo = sim_imageset_job_outputs[nj]
			for (var jo in njo){
				sim_imageset_job_outputs_jo = njo[jo]
				ty=sim_imageset_job_outputs_jo['group']
				if (sim_imageset_job_outputs_jo['type'].indexOf('_topography')==-1 || sim_imageset_job_outputs_jo['type'].indexOf('_floodfreq')==-1){
					if($("#simulation_"+sim_id+"_imageset_"+sim_imageset_id+"_wi_"+ty+"_thrval").text()==''){
						//console.log("#simulation_"+sim_id+"_imageset_"+sim_imageset_id+"_wi_"+ty+"_thrval")
						//console.log(sim_imageset_job_outputs_jo['threshold'])
						if (sim_imageset_job_outputs_jo['isCustomThreshold']!== undefined) {
							if (!sim_imageset_job_outputs_jo['isCustomThreshold']) {
								if (sim_imageset_job_outputs_jo['threshold']!=null){							
									t = ' ('
									if (sim_imageset_job_outputs_jo['isAutoThreshold']!== undefined){
										if (sim_imageset_job_outputs_jo['isAutoThreshold']){ t += 'Auto ' }
									}
									t += 'Threshold: '+parseFloat(sim_imageset_job_outputs_jo['threshold']).toFixed(3)+')'
									$("#simulation_"+sim_id+"_imageset_"+sim_imageset_id+"_wi_"+ty+"_thrval").text(t)
									//console.log($("#simulation_"+sim_id+"_imageset_"+sim_imageset_id+"_wi_"+ty+"_thrval").text())
								}
							}
						}
					}
				}
				
			}	
		}
	}

	function changeThresholdBtnByState(sim_id, _kind, sim_imageset_id, sim_imageset_threshold_states){
		for (var nk in sim_imageset_threshold_states){
			if (sim_imageset_threshold_states[nk] == 'submitting' || sim_imageset_threshold_states[nk] == 'calculating-threshold'){
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_apply_threshold_btn").hide()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_error").hide()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_loading").show()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_success").hide()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_dl").hide()
			}
			else if (sim_imageset_threshold_states[nk] == 'error-calculating-threshold'){
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_apply_threshold_btn").show()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_error").show()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_loading").hide()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_success").hide()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_dl").hide()
			}
			else if (sim_imageset_threshold_states[nk] == 'finished'){
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_apply_threshold_btn").show()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_error").hide()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_loading").hide()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_success").show()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_dl").show()
			}
			else{
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_apply_threshold_btn").show()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_error").hide()
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_loading").hide()	
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_success").hide()					
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nk+"_thr_dl").hide()
			}
		}
	}

	function _update_simulation(ls){
		sim_id = ls['simulation_id']
		sim_state = ls['state']
		sim_aos_id = ls['aos_id']
		sim_processed_imagesets = ls['processedImagesets']
		console.log('_update_simulation (sim_id='+sim_id+' - sim_state='+sim_state+')')
		
		if (ls['averageMergedProcessedImagesets'] !== undefined){
			sim_processed_imagesets.push(...ls['averageMergedProcessedImagesets'])
		}
		//topographies
		{% if request.path == home_coastal %}
		if (ls['coastalTopographies'] !== undefined){
			sim_processed_imagesets.push(...ls['coastalTopographies'])
		}
		{% endif %}
		
		_set_color_state("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_"+sim_id+"_state", sim_state)
		_set_font_color_state("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_"+sim_id+"_name", sim_state)
		if (ls['is_owned_by_user']==true){
			_set_btns_state("simulation_"+sim_id+"_btns", sim_state, sim_aos_id, sim_id)
		}
		if (sim_state != 'success'){
			console.log('hide list of imagesets for sim_id '+sim_id)
			$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_"+sim_id+"_imagesets").hide()
			$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_"+sim_id+"_imagesets").empty()
		}
		else{
			//does not exist, append
			if($("#simulation_"+sim_id+"_imagesets tr").length==0){
				console.log('simulation does not exist!')
				console.time('update simulation append new simulation')
				var appendProcImageSet = ""
				{% if request.path == home_waterleak %}
				if (ls['leakDetections'] !== undefined){
					sim_imageset_leak_detection_outputs = ls['leakDetections']
					for (var ld in sim_imageset_leak_detection_outputs){
						ld_id = sim_imageset_leak_detection_outputs[ld]['portal_ld_id']
						sim_ld_name = sim_imageset_leak_detection_outputs[ld]['name']
						sim_ld_type = sim_imageset_leak_detection_outputs[ld]['type']
						custom_sim_ld_type = sim_ld_type.toUpperCase()
						sim_ld_imgname = sim_imageset_leak_detection_outputs[ld]['imagename']						
						if (sim_ld_imgname == null){ custom_sim_ld_imgname = '(Imageset Downloaded from ESA)' }
						else{ custom_sim_ld_imgname = sim_ld_imgname }
						sim_ld_deriv_from = sim_imageset_leak_detection_outputs[ld]['start_processing_second_deriv_from']
						if (sim_ld_deriv_from=='by_index'){ custom_sim_ld_deriv_from = 'By Index'}
						else if (sim_ld_deriv_from=='by_anomaly'){ custom_sim_ld_deriv_from = 'By Anomaly'}
						else {custom_sim_ld_deriv_from = sim_ld_deriv_from }

						appendProcImageSet += "<tr id='simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"' style='padding-top:10px' >"+
							"<td class='openclosebtn' id='simulation_"+sim_id+"_ld_"+ld_id+"_ocbtn' style='vertical-align:top;margin-top:3px'><img height=15px width=15px onclick=onClickSimulationLDOpenCloseBtn("+sim_id+","+ld_id+") src='/static/images/arrow_right.svg'></img></td>"+
							"<th style='min-width: 284px;'>"+
							"<p id=simulation_"+sim_id+"_ld_"+ld_id+"_name style='display:inline;'>Leak detection "+sim_ld_name+"<br>["+custom_sim_ld_imgname+" - "+custom_sim_ld_type+" - "+custom_sim_ld_deriv_from+"]</p>"+
							"<div class='subaccordion' style='display:none;margin-left:-7px;margin-top:10px;margin-bottom:10px' id=simulation_"+sim_id+"_ld_"+ld_id+"_products_subaccordion >"+
							"<table id=simulation_"+sim_id+"_ld_"+ld_id+"_products style='font-size:10pt; width:252px'>"+
								_add_simulation_leak_detection_product(sim_id, ld_id, sim_imageset_leak_detection_outputs[ld]['outputs'])+
							"</table>"
					}
				}
				{% endif %}
				
				for (var is in sim_processed_imagesets){
					var sim_processed_imagesets_is = sim_processed_imagesets[is]
					sim_imageset_id = sim_processed_imagesets_is['id']
					sim_imageset_name = sim_processed_imagesets_is['small_name']
					sim_imageset_state = sim_processed_imagesets_is['processState']
					
					spanTagClass = _set_color_state_span_tag_class(sim_imageset_state)
					spanTag = spanTagClass[0]
					spanClass = spanTagClass[1]
					spanTagDetailed = "(No outputs. "+(spanTag.indexOf('error')>-1? 'Failed at '+spanTag : spanTag)+")"
					

					_sim_is_topo = sim_processed_imagesets_is['isTopography']
					_kind='imageset'
					_ocbtn="onClickSimulationImagesetOpenCloseBtn("+sim_id+","+sim_imageset_id+")"
					if (_sim_is_topo){
						_kind='gt'
						_ocbtn="onClickSimulationImagesetOpenCloseBtn("+sim_id+",null,null,"+sim_imageset_id+")"
					}

					sim_imageset_job_outputs = sim_processed_imagesets_is['job_outputs']
					if (sim_processed_imagesets_is['leak_detection_outputs']!== undefined){
						sim_imageset_leak_detection_outputs = sim_processed_imagesets_is['leak_detection_outputs']
					}
					appendProcImageSet += "<tr style='padding-top:10px' id='simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"'>"+
						"<td class='openclosebtn' id='simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_ocbtn' style='vertical-align:top;margin-top:3px'><img height=15px width=15px onclick="+_ocbtn+" src='/static/images/arrow_right.svg'></img></td>"+
						"<th style='min-width: 284px;'>"+
						"<p id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_name style='display:inline;'>"+sim_imageset_name+"</p>"+
						"<div class='subaccordion' style='display:none;margin-left:-7px;margin-top:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_products_subaccordion ><table id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_products style='font-size:10pt; width:252px'>"
							if(Object.keys(sim_imageset_job_outputs).length==0){
								appendProcImageSet += "<tr id='no_outputs_error'><td id='span_tag' class='alert alert-danger' style='padding:5px' >"+spanTagDetailed+"</td></tr>"
							}
							else{
								//$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_products #no_outputs_error").remove()
								for (var nj in sim_imageset_job_outputs){
									_ocbtn2="onClickSimulationImagesetOpenCloseBtn("+sim_id+","+sim_imageset_id+",'"+nj+"')"
									if (_sim_is_topo){
										_ocbtn2="onClickSimulationImagesetOpenCloseBtn("+sim_id+",null,'"+nj+"',"+sim_imageset_id+")"
									}
									njo = sim_imageset_job_outputs[nj]
									appendProcImageSet += "<tr style='padding-top:10px'>"+
										"<td class='openclosebtn' id='simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_ocbtn' style='vertical-align:top;margin-top:3px'><img height=15px width=15px onclick="+_ocbtn2+" src='/static/images/arrow_right.svg'></img></td>"+
										"<th style='min-width: 301px;'>"+
										"<p id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_name style='display:inline;'>"+nj.toUpperCase()+
										"<p id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thrval style='display:inline;'></p>"+
										{% if request.path != home_waterleak %}						
											(_kind=='gt'?"":"<a id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_apply_threshold_btn class='clickThresholdCreate' onclick=onClickThresholdButton('create_threshold','"+nj+"',"+sim_aos_id+","+sim_id+","+sim_imageset_id+")><img height='24px' src='/static/images/threshold.svg' title='Create Manual Threshold' style='margin:3px'></a>"+
															"<a style='display:none' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_dl href='/portal/rois/"+sim_aos_id+"/simulations/"+sim_id+"/intermediate/processimageset/"+sim_imageset_id+"/"+nj+"/download_threshold'><img src='/static/images/download.svg' height=25px title='Download products from manual threshold'></img></a>"+
															"<img style='display:none;margin-left:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_error src='/static/images/error.svg' height=20px title='Error on calculating manual threshold'></img>"+
															"<img style='display:none;margin-left:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_loading src='/static/images/load.gif' height=20px title='Calculating threshold...'></img>"+
															"<img style='display:none;margin-left:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_success src='/static/images/success.svg' height=20px title='Manual threshold calculated successfully'></img>")+
										{% endif %}
										"</p>"+
										"<div class='subaccordion' style='display:none;margin-left:-7px;margin-top:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_products_subaccordion >"+
										"<table id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_products style='font-size:10pt; width:252px'>"
									for (var jo in njo){
										appendProcImageSet += (_sim_is_topo? _add_simulation_gt_product(sim_id, sim_imageset_id, njo[jo]) : _add_simulation_product(sim_id, sim_imageset_id, njo[jo]))
									}
									appendProcImageSet += "</table>"
									appendProcImageSet += "</div>"
									appendProcImageSet += "</th></tr>"
								}
							}
					appendProcImageSet += "</table>"
					
					appendProcImageSet += "</div></th>"+
						"<th style='vertical-align:top;'>"+
							"<img id=simulation_"+sim_id+"_"+_kind+""+sim_imageset_id+"_loading style='display:none' height=24px src='/static/images/load.gif' />"+
							"<a style='margin:3px' id=simulation_"+sim_id+"_"+_kind+""+sim_imageset_id+"_download_btn href='/portal/rois/"+sim_aos_id+"/simulations/"+sim_id+"/intermediate/"+(_sim_is_topo? 'generatetopography' : (sim_imageset_name.indexOf('Climatology')>-1? 'averageprocessimageset':'processimageset'))+"/"+sim_imageset_id+"/download_products'><img height=24px src='/static/images/download.svg' title='Download Topography'/></a>"+
							(_sim_is_topo? "<a style='margin:3px' id=simulation_"+sim_id+"_"+_kind+""+sim_imageset_id+"_delete_btn onclick=onClickDeleteTopography("+sim_aos_id+","+sim_id+","+sim_imageset_id+")><img height=24px src='/static/images/delete.svg' title='Delete Topography'/></a>":"")+	
						"</th>"+
						"</tr>"
		
				}
				$("#simulation_"+sim_id+"_imagesets").append(appendProcImageSet)
				


				if (_sim_is_topo){
					$("#simulation_"+sim_id+"_"+_kind+sim_imageset_id+"_loading").show()
					if (sim_imageset_state.indexOf('error')>-1 || sim_imageset_state.indexOf('success')>-1){
						$("#simulation_"+sim_id+"_"+_kind+sim_imageset_id+"_loading").hide()
					}
					$("#simulation_"+sim_id+"_"+_kind+sim_imageset_id+"_delete_btn").hide()
					if (sim_imageset_state.indexOf('error')>-1 || sim_imageset_state.indexOf('success')>-1){
						$("#simulation_"+sim_id+"_"+_kind+sim_imageset_id+"_delete_btn").show()
					}
					$("#simulation_"+sim_id+"_"+_kind+sim_imageset_id+"_download_btn").hide()
					if (sim_imageset_state.indexOf('success')>-1){
						$("#simulation_"+sim_id+"_"+_kind+sim_imageset_id+"_download_btn").show()
					}
				}
				for (var is in sim_processed_imagesets){	

					var sim_processed_imagesets_is = sim_processed_imagesets[is]				
					sim_imageset_id = sim_processed_imagesets_is['id']
					sim_imageset_name = sim_processed_imagesets_is['small_name']
					sim_imageset_state = sim_processed_imagesets_is['processState']
					sim_imageset_job_outputs = sim_processed_imagesets_is['job_outputs']
					if (sim_processed_imagesets_is['leak_detection_outputs']!== undefined){
						sim_imageset_leak_detection_outputs = sim_processed_imagesets_is['leak_detection_outputs']
					}
					//thrval
					addOriginalThresholdValue(sim_id, sim_imageset_id, sim_imageset_job_outputs)
					//
					sim_imageset_threshold_states = sim_processed_imagesets_is['threshold_states']
					changeThresholdBtnByState(sim_id, 'imageset', sim_imageset_id, sim_imageset_threshold_states)

					$("#simulation_"+sim_id+"_imageset_"+sim_imageset_id+"_chkbox").attr('disabled', sim_imageset_state != 'success')
				}
				$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_"+sim_id+"_imagesets").show()
				
				console.timeEnd('update simulation append new simulation')
			}
			else{
				//exists, just update
				$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_"+sim_id+"_imagesets").show()
				console.log('simulation exist!')
				console.time('update simulation existing simulation')
				for (var is in sim_processed_imagesets){					
					var sim_processed_imagesets_is = sim_processed_imagesets[is]
					sim_imageset_id = sim_processed_imagesets_is['id']
					sim_imageset_name = sim_processed_imagesets_is['small_name']
					sim_imageset_state = sim_processed_imagesets_is['processState']
					
					sim_imageset_job_outputs = sim_processed_imagesets_is['job_outputs']
					if (sim_processed_imagesets_is['leak_detection_outputs']!== undefined){
						sim_imageset_leak_detection_outputs = sim_processed_imagesets_is['leak_detection_outputs']
					}
					spanTagClass = _set_color_state_span_tag_class(sim_imageset_state)
					spanTag = spanTagClass[0]
					spanClass = spanTagClass[1]
					spanTagDetailed = "(No outputs. "+(spanTag.indexOf('error')>-1? 'Failed at '+spanTag : spanTag)+")"
					
					_sim_is_topo = sim_processed_imagesets_is['isTopography']
					_kind='imageset'
					_ocbtn="onClickSimulationImagesetOpenCloseBtn("+sim_id+","+sim_imageset_id+")"
					if (_sim_is_topo){
						_kind='gt'
						_ocbtn="onClickSimulationImagesetOpenCloseBtn("+sim_id+",null,null,"+sim_imageset_id+")"
					}
					//
					if ($("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id).length==0){
						appendProcImageSet += "<tr style='padding-top:10px' id='simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"'>"+
							"<td class='openclosebtn' id='simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_ocbtn' style='vertical-align:top;margin-top:3px'><img height=15px width=15px onclick="+_ocbtn+" src='/static/images/arrow_right.svg'></img></td>"+
							"<th style='min-width: 284px;'>"+
							"<p id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_name style='display:inline;'>"+sim_imageset_name+"</p>"+
							"<div class='subaccordion' style='display:none;margin-left:-7px;margin-top:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_products_subaccordion ><table id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_products style='font-size:10pt; width:252px'>"
								if(Object.keys(sim_imageset_job_outputs).length==0){
									appendProcImageSet += "<tr id='no_outputs_error'><td id='span_tag' class='alert alert-danger' style='padding:5px'>"+spanTagDetailed+"</td></tr>"
								}
								else{
									//$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_products #no_outputs_error").remove()
									for (var nj in sim_imageset_job_outputs){
										_ocbtn2="onClickSimulationImagesetOpenCloseBtn("+sim_id+","+sim_imageset_id+",'"+nj+"')"
										if (_sim_is_topo){
											_ocbtn2="onClickSimulationImagesetOpenCloseBtn("+sim_id+",null,'"+nj+"',"+sim_imageset_id+")"
										}
										njo = sim_imageset_job_outputs[nj]
										appendProcImageSet += "<tr style='padding-top:10px'>"+
											"<td class='openclosebtn' id='simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_ocbtn' style='vertical-align:top;margin-top:3px'><img height=15px width=15px onclick="+_ocbtn2+" src='/static/images/arrow_right.svg'></img></td>"+
											"<th style='min-width: 265px;'>"+
											"<p id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_name style='display:inline;'>"+nj.toUpperCase()+
												"<p id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thrval style='display:inline;'></p>"+							
											{% if request.path != home_waterleak %}						
												(_kind=='gt'?"":"<a id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_apply_threshold_btn class='clickThresholdCreate' onclick=onClickThresholdButton('create_threshold','"+nj+"',"+sim_aos_id+","+sim_id+","+sim_imageset_id+")><img height='24px' src='/static/images/threshold.svg' title='Create Manual Threshold' style='margin:3px'></a>"+
																"<a style='display:none' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_dl href='/portal/rois/"+sim_aos_id+"/simulations/"+sim_id+"/intermediate/processimageset/"+sim_imageset_id+"/"+nj+"/download_threshold'><img src='/static/images/download.svg' height=25px title='Download products from manual threshold'></img></a>"+				
																"<img style='display:none;margin-left:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_error src='/static/images/error.svg' height=20px title='Error on calculating manual threshold'></img>"+
																"<img style='display:none;margin-left:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_loading src='/static/images/load.gif' height=20px title='Calculating threshold...'></img>"+
																"<img style='display:none;margin-left:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_success src='/static/images/success.svg' height=20px title='Manual threshold calculated successfully'></img>")+
											{% endif %}	
											"</p>"+											
											"<div class='subaccordion' style='display:none;margin-left:-7px;margin-top:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_products_subaccordion >"+
											"<table id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_products style='font-size:10pt; width:252px'>"
										for (var jo in njo){
											appendProcImageSet += (_sim_is_topo? _add_simulation_gt_product(sim_id, sim_imageset_id, njo[jo]) : _add_simulation_product(sim_id, sim_imageset_id, njo[jo]))
										}
										appendProcImageSet += "</table>"
										appendProcImageSet += "</div>"
										appendProcImageSet += "</th></tr>"
									}
								}
						appendProcImageSet += "</table>"
						
						appendProcImageSet += "</div></th>"+
							"<th style='vertical-align:top;'>"+
								"<img id=simulation_"+sim_id+"_"+_kind+""+sim_imageset_id+"_loading style='display:none' height=24px src='/static/images/load.gif' />"+
								"<a style='margin:3px' id=simulation_"+sim_id+"_"+_kind+""+sim_imageset_id+"_download_btn href='/portal/rois/"+sim_aos_id+"/simulations/"+sim_id+"/intermediate/"+(_sim_is_topo? 'generatetopography' : (sim_imageset_name.indexOf('Climatology')>-1? 'averageprocessimageset':'processimageset'))+"/"+sim_imageset_id+"/download_products'><img height=24px src='/static/images/download.svg' title='Download Topography'/></a>"+
								(_sim_is_topo? "<a style='margin:3px' id=simulation_"+sim_id+"_"+_kind+""+sim_imageset_id+"_delete_btn onclick=onClickDeleteTopography("+sim_aos_id+","+sim_id+","+sim_imageset_id+")><img height=24px src='/static/images/delete.svg' title='Delete Topography'/></a>":"")+
								
							"</th>"+
							"</tr>"
						$("#simulation_"+sim_id+"_imagesets").append(appendProcImageSet)
					}
					

					
					$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_products #no_outputs_error #span_tag").text(spanTagDetailed)
					if (_sim_is_topo){
						$("#simulation_"+sim_id+"_"+_kind+sim_imageset_id+"_loading").show()
						if (sim_imageset_state.indexOf('error')>-1 || sim_imageset_state.indexOf('success')>-1){
							$("#simulation_"+sim_id+"_"+_kind+sim_imageset_id+"_loading").hide()
						}
						$("#simulation_"+sim_id+"_"+_kind+sim_imageset_id+"_delete_btn").hide()
						if (sim_imageset_state.indexOf('error')>-1 || sim_imageset_state.indexOf('success')>-1){
							$("#simulation_"+sim_id+"_"+_kind+sim_imageset_id+"_delete_btn").show()
						}
						$("#simulation_"+sim_id+"_"+_kind+sim_imageset_id+"_download_btn").hide()
						if (sim_imageset_state.indexOf('success')>-1){
							$("#simulation_"+sim_id+"_"+_kind+sim_imageset_id+"_download_btn").show()
						}
					}
					
					for (var nj in sim_imageset_job_outputs){
						if ($("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_products_subaccordion").length==0){
							$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_products #no_outputs_error").remove()
							
							_ocbtn2="onClickSimulationImagesetOpenCloseBtn("+sim_id+","+sim_imageset_id+",'"+nj+"')"
							if (_sim_is_topo){
								_ocbtn2="onClickSimulationImagesetOpenCloseBtn("+sim_id+",null,'"+nj+"',"+sim_imageset_id+")"
							}
							y = "<tr style='padding-top:10px'>"+
								"<td class='openclosebtn' id='simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_ocbtn' style='vertical-align:top;margin-top:3px'><img height=15px width=15px onclick="+_ocbtn2+" src='/static/images/arrow_right.svg'></img></td>"+
								"<th style='min-width: 265px;'>"+
								"<p id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_name style='display:inline;'>"+nj.toUpperCase()+
								"<p id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thrval style='display:inline;'></p>"+
								{% if request.path != home_waterleak %}						
									(_kind=='gt'?"":"<a id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_apply_threshold_btn class='clickThresholdCreate' onclick=onClickThresholdButton('create_threshold','"+nj+"',"+sim_aos_id+","+sim_id+","+sim_imageset_id+")><img height='24px' src='/static/images/threshold.svg' title='Create Manual Threshold' style='margin:3px'></a>"+
													"<a style='display:none' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_dl href='/portal/rois/"+sim_aos_id+"/simulations/"+sim_id+"/intermediate/processimageset/"+sim_imageset_id+"/"+nj+"/download_threshold'><img src='/static/images/download.svg' height=25px title='Download products from manual threshold'></img></a>"+
													"<img style='display:none;margin-left:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_error src='/static/images/error.svg' height=20px title='Error on calculating manual threshold'></img>"+
													"<img style='display:none;margin-left:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_loading src='/static/images/load.gif' height=20px title='Calculating threshold...'></img>"+
													"<img style='display:none;margin-left:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_success src='/static/images/success.svg' height=20px title='Manual threshold calculated successfully'></img>")+
								{% endif %}	
								"</p>"+
								"<div class='subaccordion' style='display:none;margin-left:-7px;margin-top:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_products_subaccordion >"+
								"<table id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_products style='font-size:10pt; width:252px'>"+
								"</table>"+
								"</div>"+
								"</th></tr>"
							$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_products").append(y)
						}
						
						
						var x1=[]
						njo = sim_imageset_job_outputs[nj]
						for (var jo in njo){
							var sim_imageset_job_outputs_jo = njo[jo]
							sim_imageset_job_outputs_type = sim_imageset_job_outputs_jo['type']
							sim_imageset_job_outputs_roi_id = sim_imageset_job_outputs_jo['roi_id']
							sim_imageset_job_outputs_sim_id = sim_imageset_job_outputs_jo['simulation_id']
							if (sim_imageset_job_outputs_jo['gt_id'] !== undefined){
								sim_imageset_job_outputs_intermediate_process_imageset_id = sim_imageset_job_outputs_jo['gt_id']
							}
							else{
								sim_imageset_job_outputs_intermediate_process_imageset_id = sim_imageset_job_outputs_jo['intermediate_process_imageset_id']
							}
							if(sim_aos_id == sim_imageset_job_outputs_roi_id && sim_imageset_id==sim_imageset_job_outputs_intermediate_process_imageset_id){
								//if its a new product add it
								if($("#simulation_"+sim_imageset_job_outputs_sim_id+"_"+_kind+"_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type).length==0){
									x = (_sim_is_topo? _add_simulation_gt_product(sim_id, sim_imageset_id, sim_imageset_job_outputs_jo) : _add_simulation_product(sim_id, sim_imageset_id, sim_imageset_job_outputs_jo))
									if (x !== undefined){ x1.push(x) }
								}				
							}
						}
						//$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_products #no_outputs_error").remove()
						$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_products").append(x1.join(""))
					}
					//
					addOriginalThresholdValue(sim_id, sim_imageset_id, sim_imageset_job_outputs)
					//
					sim_imageset_threshold_states = sim_processed_imagesets_is['threshold_states']
					changeThresholdBtnByState(sim_id, _kind, sim_imageset_id, sim_imageset_threshold_states)
					
					$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_chkbox").attr('disabled', sim_imageset_state != 'success')
					_set_color_state("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_state", sim_imageset_state)
				}
				console.timeEnd('update simulation existing simulation')
			}
		}	
	}

	function onClickSimulationStateIcon(roi_id, sim_id){
		overallWidth = 480
		html = '<div id="div_sim_loading"><p>Loading, please wait...</p></div>'+			
			'<div id="div_sim_loaded" style="display:none">'+
				"<b>Simulation Details</b>"+
				"<div id='noMergedProductsWarning' style='display:none; font-size:10pt' class='alert alert-warning'>"+
					"<p>WORSICA has not found merged products on this simulation. Seems this simulation was run on a very old processing iteration. </p>"+
					"<p>The new processing will generate merged processed products to provide the correct output. We recommend you to run this simulation again (although this will erase the previous products).</p>"+
				"</div>"+
				"<div class='subaccordion'>"+
					"<table style='font-size:10pt;color:#ffffff;width:"+overallWidth+"px'>"+
						"<tr><th>Name:</th><td id='div_sim_details_name'>?</td></tr>"+
						"<tr><th>Status:</th><td id='div_sim_details_state'>?</td></tr>"+
						"<tr><th>Last submitted at:</th><td id='div_sim_details_last_submitted_at'>?</td></tr>"+
						"<tr><th>Last run at:</th><td id='div_sim_details_last_run_at'>?</td></tr>"+
						"<tr><th>Last finished at:</th><td id='div_sim_details_last_finished_at'>?</td></tr>"+
					"</table>"+
				"</div>"+
				"<br>"+
				"<b>Processed Imagesets</b>"+
				"<div class='subaccordion' style='overflow-y:auto;max-height:75px;height:75px;'>"+	
					"<table id='sim_details_pis' style='font-size:10pt;color:#ffffff;width:"+overallWidth+"px'></table>"+
				"</div>"+
				"<br>"+
				"<b>Merged processed Imagesets</b>"+
				"<div class='subaccordion' style='overflow-y:auto;max-height:75px;height:75px;'>"+								
					"<table id='sim_details_mpis' style='font-size:10pt;color:#ffffff;width:"+overallWidth+"px'></table>"+
				"</div>"+
				"<br>"
		if (SERVICE_NAME == 'waterleak'){
			html += "<b>Climatologies</b>"+
				"<div class='subaccordion' style='overflow-y:auto;max-height:75px;height:75px;'>"+								
					"<table id='sim_details_ampis' style='font-size:10pt;color:#ffffff;width:"+overallWidth+"px'></table>"+
				"</div>"
		}
		html += '</div>'+
			'<div id="div_sim_loading_error" style="display:none"><p>An error occurred, try again later.</p></div>'+
			'<div id="div_sim_loading_noinfo" style="display:none"><p>Could not load details for that simulation</div>', 
			
		buildDynamicModalPopup('Simulation status', html,
			[['Close', function(){ 
				_clear_interval_list_simulation_details()
				//jsonSimDetails = null
				$(this).dialog( "close" )
			} ]], [250,220])
		//jsonSimDetails = null
		_start_interval_list_simulation_details(roi_id, sim_id)		
	}

	function updateListOfSimulationDetails(roi_id, sim_id){		
		_url = '/portal/rois/'+roi_id+'/simulations/'+sim_id+'/details'
		$.ajax({ type: "GET", url: _url, async: true,
		     success : function(response){		
				$('#div_sim_loading').hide() 
				jsonSimDetails = $.parseJSON(JSON.stringify(response));
				if (jsonSimDetails.length==0){
					$('#div_sim_loading_noinfo').show()
					$('#div_sim_loading_error').hide()
					$('#div_sim_loaded').hide()
				}
				else{
					if (jsonSimDetails['error'] !== undefined){
						$('#div_sim_loading_noinfo').hide()
						$('#div_sim_loading_error').show()
						//$('#div_sim_loading_error #err').text(jsonSimDetails['error'])
						$('#div_sim_loaded').hide()
					}		   
					else{
						$('#div_sim_loading_noinfo').hide()
						$('#div_sim_loading_error').hide()					

						$('#div_sim_details_name').text(jsonSimDetails['simulation_name'])
						$('#div_sim_details_state').text(jsonSimDetails['state'])
						_set_color_state("#dialog-message #stateicon", jsonSimDetails['state'])
						$('#div_sim_details_last_submitted_at').text(jsonSimDetails['lastSubmittedAt'])
						$('#div_sim_details_last_run_at').text(jsonSimDetails['lastRunAt'])
						$('#div_sim_details_last_finished_at').text(jsonSimDetails['lastFinishedAt'])
						if(jsonSimDetails['mergedProcessedImagesets'].length==0){ $('#noMergedProductsWarning').show() }
						else{ $('#noMergedProductsWarning').hide() }
						_map_pis = [ 
							['pis',jsonSimDetails['processedImagesets']], 
							['mpis',jsonSimDetails['mergedProcessedImagesets']],
							['ampis',(SERVICE_NAME == 'waterleak'? jsonSimDetails['averageMergedProcessedImagesets'] : []) ] 
						]			
						for (var m=0; m<_map_pis.length;m++){
							_id = _map_pis[m][0] //"pis" or "mpis"
							_pis = _map_pis[m][1]
							for (var pi=0; pi<_pis.length; pi++){
								if ($('#sim_details_'+_id+' #'+_id+_pis[pi]['id']).length==0){//append
									$('#sim_details_'+_id).append(
										"<tr id="+_id+_pis[pi]['id']+">"+
											"<th id="+_id+_pis[pi]['id']+"_name style='width:350px'></th>"+
											"<td style='width:100px'><div class='progress' style='width:80px;height:10px;background-color:#20222b;margin-bottom:4px;margin-right:10px;margin-top:10px;'>"+
												"<div id="+_id+_pis[pi]['id']+"_progress class='progress-bar' style='width:0%;background-color:#2CC0DE'></div>"+
											"</div></td>"+
											"<td><img height=20px id="+_id+_pis[pi]['id']+"_state></td>"+
										"</tr>"
									)
								}
								$('#sim_details_'+_id+' #'+_id+_pis[pi]['id']+' #'+_id+_pis[pi]['id']+'_name').text(_pis[pi]['small_name'])
								_set_color_state2('#sim_details_'+_id+' #'+_id+_pis[pi]['id']+' #'+_id+_pis[pi]['id']+'_state', _pis[pi]['state'])
								_set_progress_scale_by_state('#sim_details_'+_id+' #'+_id+_pis[pi]['id']+' #'+_id+_pis[pi]['id']+'_progress', _pis[pi]['state'], 0, 3)
							}
						}
						dm.dialog("option",'width', 630)
			    		dm.dialog('option','height', 560)
		     			
						$('#div_sim_loaded').show()						
					}  		
				}				    	
    		},
		    error: function(response){
				$('#div_sim_loading').hide() 				
				$('#div_sim_loading_error').hide()
				$('#div_sim_loading_noinfo').show()
				$('#div_sim_loaded').hide()		
		    }
		});		
	}

	function onClickUserRepositoryOpenCloseBtn(type, list_id='listOfUserFile'){
		if ($("#"+list_id+" #listOfUploaded"+type+"_ocbtn img").attr('src').indexOf('arrow_down')>-1){
			//if opened
			$("#"+list_id+" #listOfUploaded"+type+"_subaccordion").hide()
			$("#"+list_id+" #listOfUploaded"+type+"_ocbtn img").attr('src','/static/images/arrow_right.svg')
		}
		else{
			//if closed
			$("#"+list_id+" #listOfUploaded"+type+"_subaccordion").show()
			$("#"+list_id+" #listOfUploaded"+type+"_ocbtn img").attr('src','/static/images/arrow_down.svg')
		}
	}

	function _lockfieldsUserImageset(type, isLocked){
		if (type == 'imageset'){
			$('#divupload'+type+' #fileupload_redband').prop('disabled',isLocked)
			$('#divupload'+type+' #fileupload_greenband').prop('disabled',isLocked)
			$('#divupload'+type+' #fileupload_blueband').prop('disabled',isLocked)
			$('#divupload'+type+' #fileupload_nirband').prop('disabled',isLocked)
			$('#divupload'+type+' #fileupload_issueDate').prop('disabled',isLocked)
		}
	}

	function _submitEditUserImagesetCustom(imgset_id){
		type ='imageset'
		$('#divupload'+type+' #status_message').empty()
		rB=$('#divupload'+type+' #fileupload_redband').val()
		gB=$('#divupload'+type+' #fileupload_greenband').val()
		bB=$('#divupload'+type+' #fileupload_blueband').val()
		nirB=$('#divupload'+type+' #fileupload_nirband').val()
		if($('#divupload'+type+' #fileupload_issueDate').val()==""){
			$('#divupload'+type+' #status_message').text('Error: No date provided!')
		}
		else if(rB=="" || gB=="" || bB=="" || nirB==""){
			$('#divupload'+type+' #status_message').text('Error: Missing band number!')
		}
		else if(rB==gB || rB==bB || rB==nirB ||gB==bB ||gB==nirB || bB==nirB){
			$('#divupload'+type+' #status_message').text('Error: Bands must not share same number!')
		}
		else{
			jsonR = {}
			jsonR['issueDate'] = $('#divupload'+type+' #fileupload_issueDate').val()
			jsonR['image_arguments'] = {}
			args = ['redband','greenband','blueband','nirband', 'issueDate']
			for (var b in args){ jsonR['image_arguments'][args[b]] = $('#divupload'+type+' #fileupload_'+args[b]).val() }						
			_url = "/portal/proxy/intermediate/user_repository/"+SERVICE_NAME+"/imagesets/"+imgset_id+"/edit"
			console.log(jsonR)
			_lockfieldsUserImageset(type, true)
			//$('#divupload'+type+' #status_message').empty()
			$('#divupload'+type+' #status_message').text('Updating arguments...')
			$.post(_url,  JSON.stringify(jsonR))
				.done(function(data){
					_lockfieldsUserImageset(type, false)
					//dm.dialog("close")
					var response = $.parseJSON(JSON.stringify(data));									
					if(response['alert']=='success'){					
						loadListOfUserImagesets()	
						$('#divupload'+type+' #status_message').text('Your update was successful.')
					}
					else{
						$('#divupload'+type+' #status_message').text('Could not update. Something went wrong.')
					}
				})
				.fail(function( xhr, textStatus, errorThrown ){
					console.log( xhr, textStatus, errorThrown)
					_lockfieldsUserImageset(type, false)
					$('#divupload'+type+' #status_message').text('Could not update. Something went wrong.')
				})
		}
	}

	function onClickUserRepositoryImagesetCustom(type, obj_id){//user imagesets only!!!
		kind = 'imageset'
		pluralkind = _generate_plural(kind)
		imgset_id = obj_id
		if (type=='params-edit'){
			wh = [650,580]
			html = 
				'<p>You only can edit some parameters.</p>'+
				'<p>You need to set the correct band numbers and date.</p>'+
				'<p>It is up to the user responsibility to fulfill the needed parameters</p>'+
				'<div id="divupload'+kind+'">'+
					"<div><p id='status_message'></p></div>"+
					"<div class='col-md-12 custom-form-control' style='padding-top:10px; padding-bottom:10px'>"+
						"<div class='custom-form-control'>"+
							"<label for='fileupload_issueDate'>Date</label>"+
							"<input id='fileupload_issueDate' class='form-control' type='text' value='2020-01-01' style='padding-left:80px;text-align:right'/>"+
						"</div>"+	
					"</div>"+
					"<b>Bands</b><br>"+
					"<div class='col-md-12 custom-form-control' style='padding-top:10px; padding-bottom:10px'>"+
						"<div class='custom-form-control' style='width:48%;float:left;'>"+
							"<label for='fileupload_redband'>Red</label>"+
							"<input class='form-control' type='number' id='fileupload_redband' style='text-align:right' value=1 onkeypress='return isNumericKey(event)'>"+
						"</div>"+	
						"<div class='custom-form-control' style='width:48%;float:right;'>"+
							"<label for='fileupload_greenband'>Green</label>"+
							"<input class='form-control' type='number' id='fileupload_greenband' style='text-align:right' value=2 onkeypress='return isNumericKey(event)'>"+
						"</div>"+	
					"</div>"+
					"<div class='col-md-12 custom-form-control' style='padding-top:10px; padding-bottom:10px'>"+
						"<div class='custom-form-control' style='width:48%;float:left;'>"+
							"<label for='fileupload_blueband'>Blue</label>"+
							"<input class='form-control' type='number' id='fileupload_blueband' style='text-align:right' value=3 onkeypress='return isNumericKey(event)'>"+
						"</div>"+	
						"<div class='custom-form-control'style='width:48%;float:right;'>"+
							"<label for='fileupload_nirband'>NIR</label>"+
							"<input class='form-control' type='number' id='fileupload_nirband' style='text-align:right' value=4 onkeypress='return isNumericKey(event)'>"+
						"</div>"+
					"</div>"+
					"<a class='btn btn-sm btn-primary' style='background-color: #2CC0DE' onclick=_submitEditUserImagesetCustom("+imgset_id+")>Update</a>"+
				"</div>"

			//load
			_url = "/portal/proxy/intermediate/user_repository/"+SERVICE_NAME+"/"+pluralkind+"/"+imgset_id
			$.get(_url)
				.done(function(data){
					dm.dialog("close")
					var response = $.parseJSON(JSON.stringify(data));									
					if(response['alert']=='success'){
						//open edit
						buildDynamicModalPopup('Edit '+kind, html,
							[['Close', function(){ $(this).dialog( "close" )} ]], wh)
						//existing fields
						$('#divupload'+kind+' #fileupload_issueDate').datetimepicker({ mask:true, timepicker: false, format: 'Y-m-d',})
						//$('#divupload'+kind+' #fileupload_issueDate').val(response['date'])
						args = ['redband','greenband','blueband','nirband','issueDate']
						for (var b in args){  $('#divupload'+kind+' #fileupload_'+args[b]).val(response['image_arguments'][args[b]]) }	
					}
					else{
						$('#divupload'+kind+' #status_message').text('Could not update. Something went wrong.')
					}
				})
				.fail(function( xhr, textStatus, errorThrown ){
					console.log( xhr, textStatus, errorThrown)
					$('#divupload'+kind+' #status_message').text('Could not update. Something went wrong.')
				})
		}
		else if (type=='delete'){
			buildDynamicModalPopup('Warning!', 
				'<p>You are about to delete this '+kind+'. All its associated products will be deleted! Are you sure?</p>',[
					['Yes', function(){ 
						$(this).dialog( "close" )
						_clear_interval_list_user_repository_files()
						buildDynamicModalPopup('Deleting '+kind+'...', 
							'<p>Please wait while worsica is deleting '+kind+'...</p>', 
							[], [250,220])
						$.get('/portal/proxy/intermediate/user_repository/'+SERVICE_NAME+'/'+pluralkind+'/'+imgset_id+'/delete')
							.done(function(data){
								var answer = $.parseJSON(JSON.stringify(data)); 
								if(answer['alert']=='deleted'){									
									loadListOfUserImagesets()
									dm.dialog( "close" );
								}
								else{
									dm.dialog( "close" );
									buildDynamicModalPopup('Error!', 
										'<p>Something went wrong and we were unable to delete '+kind+', try again!</p>', 
										[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
								}
							})
							.fail(function( xhr, textStatus, errorThrown ){
								console.log( xhr, textStatus, errorThrown)
								dm.dialog( "close" );
								buildDynamicModalPopup('Error!', 
									'<p>Something went wrong and we were unable to delete '+kind+', try again!</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							})
					}],
					['No', function(){
						$(this).dialog( "close" )
					}]
				], [300,220])
		}
	}

	function onClickUserRepositoryUpload(type){
		pluraltype = _generate_plural(type)
		additional_inputs = ""
		wh = [450,320]
		if (type == 'geometry'){
			text = '<p>Select a ZIP file to upload. Click upload when ready.</p>'+
			'<p>For the geometries, the zip file must contain the mandatory file extensions needed for loading: .shp, .shx and .dbf. </p>'+
			'<p>Other files are optional .prj, .xml, .sbn and .sbx. </p>'
			input_file_accept = '.zip,application/zip'
		}
		else if (type == 'mask'){
			text = '<p>Select a TIF file to upload. Click upload when ready.</p>'+
			'<p>You need to upload a valid georref TIF file (geoTIFF), and must be a binary black/white image.</p>'+
			'<p>It is up to the user responsibility to upload a valid mask to the service.</p>'
			input_file_accept = '.tiff,image/tiff'
		}
		else if (type == 'leak'){
			text = '<p>Select a KML file to upload. Click upload when ready.</p>'+
			'<p>It is up to the user responsibility to upload a valid kml to the service.</p>'
			input_file_accept = '.kml,application/vnd.google-earth.kml+xml'
		}
		else if (type == 'imageset'){
			text = '<p>Select a ZIP file to upload. Click upload when ready.</p>'+
			'<p>You need to upload a valid ZIP that MUST INCLUDE a georref TIF file (geoTIFF), and set the correct band numbers and date. ZIP and respective TIF file names MUST match.</p>'+
			'<p>It is up to the user responsibility to upload a valid image and fulfill the needed parameters</p>'
			input_file_accept = '.zip,application/zip' //'.tiff,image/tiff'
			additional_inputs = 
			"<div class='col-md-12 custom-form-control' style='padding-top:10px; padding-bottom:10px'>"+
				"<div class='custom-form-control'>"+
					"<label for='fileupload_issueDate'>Date</label>"+
					"<input id='fileupload_issueDate' class='form-control' type='text' value='2020-01-01' style='padding-left:80px;text-align:right'/>"+
				"</div>"+	
			"</div>"+
			"<b>Bands</b><br>"+
			"<div class='col-md-12 custom-form-control' style='padding-top:10px; padding-bottom:10px'>"+
				"<div class='custom-form-control' style='width:48%;float:left;'>"+
					"<label for='fileupload_redband'>Red</label>"+
					"<input class='form-control' type='number' id='fileupload_redband' style='text-align:right' value=1 onkeypress='return isNumericKey(event)'>"+
				"</div>"+	
				"<div class='custom-form-control' style='width:48%;float:right;'>"+
					"<label for='fileupload_greenband'>Green</label>"+
					"<input class='form-control' type='number' id='fileupload_greenband' style='text-align:right' value=2 onkeypress='return isNumericKey(event)'>"+
				"</div>"+	
			"</div>"+
			"<div class='col-md-12 custom-form-control' style='padding-top:10px; padding-bottom:10px'>"+
				"<div class='custom-form-control' style='width:48%;float:left;'>"+
					"<label for='fileupload_blueband'>Blue</label>"+
					"<input class='form-control' type='number' id='fileupload_blueband' style='text-align:right' value=3 onkeypress='return isNumericKey(event)'>"+
				"</div>"+	
				"<div class='custom-form-control'style='width:48%;float:right;'>"+
					"<label for='fileupload_nirband'>NIR</label>"+
					"<input class='form-control' type='number' id='fileupload_nirband' style='text-align:right' value=4 onkeypress='return isNumericKey(event)'>"+
				"</div>"+
			"</div>"
			wh = [650,580]
				
		}
		html = 
			text+
			'<div id="divupload'+type+'">'+
				"<form style='font-size:10pt;display:inline' action='/portal/proxy/intermediate/user_repository/"+SERVICE_NAME+"/"+pluraltype+"/upload' method='post' enctype='multipart/form-data'>"+
					'{% csrf_token %}'+
					"<div class='custom-form-control-file'>"+
						"<div class='progress'>"+
							"<div class='progress-bar' style='width: 0%;background-color:#2CC0DE'></div>"+
							//"<img id='upload_loading' style='display:none' height=16px src='/static/images/load.gif'/>"+
						"</div>"+
						"<input id='fileupload' name='myfile' type='file' accept='"+input_file_accept+"'>"+
					"</div>"+
				"</form>"+
				"<div><p id='status_message'></p></div>"+
				additional_inputs+
				"<div id='status_message2'></div>"+
				
			"</div>"
		buildDynamicModalPopup('Upload '+type, html,
			[['Close', function(){ $(this).dialog( "close" )} ]], wh)
		//
		$("#dialog-message #stateicon").attr('src','/static/images/uploadfile2.svg')
		if (type == 'imageset'){
			$('#divupload'+type+' #fileupload_issueDate').datetimepicker({ mask:true, timepicker: false, format: 'Y-m-d',})
			$('#divupload'+type+' #fileupload_issueDate').val('2022-01-01')
		}
		
		$('#divupload'+type+' .progress-bar').css( 'background', '#2CC0DE')
		$('#divupload'+type+' .progress-bar').css('width', '0%')
		$('#divupload'+type+' #fileupload').val('')
		$('#divupload'+type+' #fileupload').fileupload({
			dataType: 'json',
			replaceFileInput:false,
			add: function (e, data) { 
				$("#dialog-message #stateicon").attr('src','/static/images/uploadfile2.svg')
				$('#divupload'+type+' .progress-bar').css( 'background', '#2CC0DE')
				$('#divupload'+type+' .progress-bar').css( 'width', '0%')      				
				$('#divupload'+type+' #status_message2').empty()
				$('#divupload'+type+' #status_message').empty()
				data.context = $('<button style="background-color: #2CC0DE" class="btn btn-sm btn-primary"></button>').text('Upload')
					.appendTo('#divupload'+type+' #status_message2')
					.click(function () {
						//do checks
						if (type == 'imageset'){
							rB=$('#divupload'+type+' #fileupload_redband').val()
							gB=$('#divupload'+type+' #fileupload_greenband').val()
							bB=$('#divupload'+type+' #fileupload_blueband').val()
							nirB=$('#divupload'+type+' #fileupload_nirband').val()
							if($('#divupload'+type+' #fileupload_issueDate').val()==""){
								$('#divupload'+type+' #status_message').text('Error: No date provided!')
							}
							else if(rB=="" || gB=="" || bB=="" || nirB==""){
								$('#divupload'+type+' #status_message').text('Error: Missing band number!')
							}
							else if(rB==gB || rB==bB || rB==nirB ||gB==bB ||gB==nirB || bB==nirB){
								$('#divupload'+type+' #status_message').text('Error: Bands must not share same number!')
							}
							else{
								_lockfieldsUserImageset(type, true)
								$("#dialog-message #stateicon").attr('src','/static/images/load.gif')
								$('.ui-dialog-buttonset button[type="button"]').prop('disabled','disabled')
								$('#divupload'+type+' #status_message2').empty()
								data.context = $('#divupload'+type+' #status_message').text('Uploading file, please wait...')//.replaceAll($(this));
								data.submit();
							}
						}
						else{
							$("#dialog-message #stateicon").attr('src','/static/images/load.gif')
							$('.ui-dialog-buttonset button[type="button"]').prop('disabled','disabled')
							$('#divupload'+type+' #status_message2').empty()
							data.context = $('#divupload'+type+' #status_message').text('Uploading file, please wait...')//.replaceAll($(this));
							data.submit();							
						}
					});
				
			},
			done: function (e, data) {
				$('.ui-dialog-buttonset button[type="button"]').prop('disabled','')
				
				if (data.result.alert == 'uploaded'){
					//upload additional data to user imageset
					dm.dialog( "close" );
					if (type == 'imageset'){
						imgset_id = data.result['imgset_id']
						_submitEditUserImagesetCustom(imgset_id)
						
					}
					$("#dialog-message #stateicon").attr('src','/static/images/check.svg')
					if(RIGHT_PANEL_MODE == 'SHOW_USER_REPOSITORY'){	
						_clear_interval_list_user_repository_files()
						_start_interval_list_user_repository_files()
					}
					$('#divupload'+type+' #status_message').empty()
					
				}
				else{
					$("#dialog-message #stateicon").attr('src','/static/images/error.svg')
					$('#divupload'+type+' .progress-bar').css( 'background', '#bb0000')
					$('#divupload'+type+' #status_message').empty()
					$('#divupload'+type+' #status_message').append('<p>An error during upload occured: '+data.result.message+'.</p>')	
				}
			},
			fail: function (e, data) {
				_lockfieldsUserImageset(type, false)
				$("#dialog-message #stateicon").attr('src','/static/images/error.svg')
				$('#divupload'+type+' .progress-bar').css( 'background', '#bb0000')
				$('#divupload'+type+' #status_message').append('<p>An error during upload occured: '+data.result.message+'.</p>')
			},
			progressall: function (e, data) {				
				$('.ui-dialog-buttonset button[type="button"]').prop('disabled','disabled')
				var progress = parseInt(data.loaded / data.total * 100, 10);
				$('#divupload'+type+' .progress-bar').css( 'width', progress + '%' );
			}
		});

		
	}

	function onClickSimulationOpenCloseBtn(sim_id){
		if ($("#simulation_"+sim_id+"_imagesets_ocbtn img").attr('src').indexOf('arrow_down')>-1){
			//if opened
			$("#simulation_"+sim_id+"_imagesets_subaccordion").hide()
			$("#simulation_"+sim_id+"_imagesets_ocbtn img").attr('src','/static/images/arrow_right.svg')
		}
		else{
			//if closed
			$("#simulation_"+sim_id+"_imagesets_subaccordion").show()
			$("#simulation_"+sim_id+"_imagesets_ocbtn img").attr('src','/static/images/arrow_down.svg')
		}
	}

	function onClickSimulationImagesetOpenCloseBtn(sim_id, sim_imageset_id, sim_wi_id=null, sim_gt_id=null){
		_id = "simulation_"+sim_id+(sim_imageset_id!=null? "_imageset_"+sim_imageset_id : (sim_gt_id? "_gt_"+sim_gt_id : ""))+(sim_wi_id? "_wi_"+sim_wi_id : "")
		if ($("#"+_id+"_ocbtn img").attr('src').indexOf('arrow_down')>-1){
			//if opened
			$("#"+_id+"_products_subaccordion").hide()
			$("#"+_id+"_ocbtn img").attr('src','/static/images/arrow_right.svg')
		}
		else{
			//if closed
			$("#"+_id+"_products_subaccordion").show()
			$("#"+_id+"_ocbtn img").attr('src','/static/images/arrow_down.svg')
		}
	}

	function onClickSimulationLDOpenCloseBtn(sim_id, ld_id){
		if ($("#simulation_"+sim_id+"_ld_"+ld_id+"_ocbtn img").attr('src').indexOf('arrow_down')>-1){
			//if opened
			$("#simulation_"+sim_id+"_ld_"+ld_id+"_products_subaccordion").hide()
			$("#simulation_"+sim_id+"_ld_"+ld_id+"_ocbtn img").attr('src','/static/images/arrow_right.svg')
		}
		else{
			//if closed
			$("#simulation_"+sim_id+"_ld_"+ld_id+"_products_subaccordion").show()
			$("#simulation_"+sim_id+"_ld_"+ld_id+"_ocbtn img").attr('src','/static/images/arrow_down.svg')
		}
	}

	function _append_user_repository(type, ur){
		if (type == 'geometry'){ pluraltype = 'Geometries' }
		else if (type == 'mask'){ pluraltype = 'Masks' }
		else if (type == 'leak'){ pluraltype = 'Leaks' /*'leakpoints'*/ }
	}

	function _append_simulation(ls){		
		sim_id = ls['simulation_id']
 		sim_name = ls['simulation_name']+(ls['is_owned_by_user']? "":" (shared)")
 		sim_state = ls['state']
 		sim_aos_id = ls['aos_id']
		console.log('_append_simulation (sim_id='+sim_id+')')
 		appendSim = 
	 		"<tr id=simulation_"+sim_id+" class='trsimulation' style='padding-left:5px; padding-top:15px; width:85%'>"+
	 			"<td style='padding-top: 5px;'>"+
	 			"<table>"+
		 			"<tr>"+
						"<td class='openclosebtn' id=simulation_"+sim_id+"_imagesets_ocbtn>"+
							"<img height=15px width=15px onclick=onClickSimulationOpenCloseBtn("+sim_id+") src='/static/images/arrow_right.svg'></img>"+
						"</td>"+
						"<th style='width:45%;padding-top: 6px;'>"+
							"<p id=simulation_"+sim_id+"_name style='width:80%; overflow: hidden; text-overflow: ellipsis;' title="+sim_name+">"+sim_name+"</p>"+
						"</th>"+
						"<td id=simulation_"+sim_id+"_btns style='width:185px;vertical-align:top;text-align:right'></td>"+
						"<td style='vertical-align:top;padding-top:5px;padding-left: 5px;'><img height=20px onclick=onClickSimulationStateIcon("+sim_aos_id+","+sim_id+") id=simulation_"+sim_id+"_state src='' title=''/></td>"+
					"</tr>"+
					"<tr>"+
						"<td colspan=3 id=simulation_"+sim_id+"_imagesets_td>"+
						"<div class='subaccordion' id=simulation_"+sim_id+"_imagesets_subaccordion style='display:none;width:280px;padding-top:10px;padding-bottom:10px;'>"+
							"<table style='font-size:10pt' id=simulation_"+sim_id+"_imagesets></table>"+
						"</div>"+
						"</td>"+
					"</tr>"+
				"</table>"+
				"</td>"+
			"</tr>"

 		$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations').append(appendSim)
		
		//start loading imagesets
		sim_processed_imagesets = ls['processedImagesets']
		if (ls['averageMergedProcessedImagesets'] !== undefined){
			//sim_processed_imagesets = sim_processed_imagesets.concat(ls['averageMergedProcessedImagesets'])
			sim_processed_imagesets.push(...ls['averageMergedProcessedImagesets'])
		}
		//topographies
		{% if request.path == home_coastal %}
		if (ls['coastalTopographies'] !== undefined){
			sim_processed_imagesets.push(...ls['coastalTopographies'])
		}
		{% endif %}

 		_set_color_state("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_"+sim_id+"_state", sim_state)
		_set_font_color_state("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_"+sim_id+"_name", sim_state)
 		if (ls['is_owned_by_user']==true){
			_set_btns_state("simulation_"+sim_id+"_btns", sim_state, sim_aos_id, sim_id)
		}
		//
		if (sim_state != 'success'){
			console.log('hide list of imagesets for sim_id '+sim_id)
			$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_"+sim_id+"_imagesets").hide()
			$("#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_"+sim_id+"_imagesets").empty()
		}
		else{
			console.time('append simulation append new simulation')
			var appendProcImageSet = ""
			{% if request.path == home_waterleak %}
			if (ls['leakDetections'] !== undefined){
				sim_imageset_leak_detection_outputs = ls['leakDetections']
				for (var ld in sim_imageset_leak_detection_outputs){
					ld_id = sim_imageset_leak_detection_outputs[ld]['portal_ld_id']
					sim_ld_name = sim_imageset_leak_detection_outputs[ld]['name']
					sim_ld_type = sim_imageset_leak_detection_outputs[ld]['type']
					custom_sim_ld_type = sim_ld_type.toUpperCase()
					sim_ld_imgname = sim_imageset_leak_detection_outputs[ld]['imagename']
					if (sim_ld_imgname == null){ custom_sim_ld_imgname = '(Imageset Downloaded from ESA)' }
					else{ custom_sim_ld_imgname = sim_ld_imgname }						
					sim_ld_deriv_from = sim_imageset_leak_detection_outputs[ld]['start_processing_second_deriv_from']
					if (sim_ld_deriv_from=='by_index'){ custom_sim_ld_deriv_from = 'By Index'}
					else if (sim_ld_deriv_from=='by_anomaly'){ custom_sim_ld_deriv_from = 'By Anomaly'}
					else {custom_sim_ld_deriv_from = sim_ld_deriv_from }
					appendProcImageSet += "<tr style='padding-top:10px'>"+
						"<td class='openclosebtn' id='simulation_"+sim_id+"_ld_"+ld_id+"_ocbtn' style='vertical-align:top;margin-top:3px'><img height=15px width=15px onclick=onClickSimulationLDOpenCloseBtn("+sim_id+","+ld_id+") src='/static/images/arrow_right.svg'></img></td>"+
						"<th style='min-width: 284px;'>"+
						"<p id=simulation_"+sim_id+"_ld_"+ld_id+"_name style='display:inline;'>Leak detection "+sim_ld_name+"<br>["+custom_sim_ld_imgname+" - "+custom_sim_ld_type+" - "+custom_sim_ld_deriv_from+"]</p>"+
						"<div class='subaccordion' style='display:none;margin-left:-7px;margin-top:10px;' id=simulation_"+sim_id+"_ld_"+ld_id+"_products_subaccordion >"+
						"<table id=simulation_"+sim_id+"_ld_"+ld_id+"_products style='font-size:10pt; width:252px'>"+
							_add_simulation_leak_detection_product(sim_id, ld_id, sim_imageset_leak_detection_outputs[ld]['outputs'])+
						"</table>"
				}
			}
			{% endif %}
			//
			for (var is in sim_processed_imagesets){
				var sim_processed_imagesets_is = sim_processed_imagesets[is]			
				sim_imageset_id = sim_processed_imagesets_is['id']
				sim_imageset_name = sim_processed_imagesets_is['small_name']
				sim_imageset_state = sim_processed_imagesets_is['processState']
				spanTagClass = _set_color_state_span_tag_class(sim_imageset_state)
				spanTag = spanTagClass[0]
				spanClass = spanTagClass[1]
				
				_sim_is_topo = sim_processed_imagesets_is['isTopography']
				_kind='imageset'
				_ocbtn="onClickSimulationImagesetOpenCloseBtn("+sim_id+","+sim_imageset_id+")"
				if (_sim_is_topo){
					_kind='gt'
					_ocbtn="onClickSimulationImagesetOpenCloseBtn("+sim_id+",null,null,"+sim_imageset_id+")"
				}

				sim_imageset_job_outputs = sim_processed_imagesets_is['job_outputs']
				appendProcImageSet += "<tr id='simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"' style='padding-top:10px'>"+
					"<td class='openclosebtn' id='simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_ocbtn' style='vertical-align:top;margin-top:3px'><img height=15px width=15px onclick="+_ocbtn+" src='/static/images/arrow_right.svg'></img></td>"+
					"<th style='min-width: 284px;'>"+
					"<p id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_name style='display:inline;'>"+sim_imageset_name+"</p>"+
					"<div class='subaccordion' style='display:none;margin-left:-7px;margin-top:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_products_subaccordion >"+
					"<table id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_products style='font-size:10pt; width:252px'>"
					if(Object.keys(sim_imageset_job_outputs).length==0){
						appendProcImageSet += "<tr id='no_outputs_error'><td class='alert alert-danger' style='padding:5px'>(No outputs. Failed at "+spanTag+")</td></tr>"
					}
					else{
						$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_products #no_outputs_error").remove()
						for (var nj in sim_imageset_job_outputs){
							//console.log(nj)
							_ocbtn2="onClickSimulationImagesetOpenCloseBtn("+sim_id+","+sim_imageset_id+",'"+nj+"')"
							if (_sim_is_topo){
								_ocbtn2="onClickSimulationImagesetOpenCloseBtn("+sim_id+",null,'"+nj+"',"+sim_imageset_id+")"
							}
							njo = sim_imageset_job_outputs[nj]
							appendProcImageSet += "<tr style='padding-top:10px'>"+
								"<td class='openclosebtn' id='simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_ocbtn' style='vertical-align:top;margin-top:3px'><img height=15px width=15px onclick="+_ocbtn2+" src='/static/images/arrow_right.svg'></img></td>"+
								"<th style='min-width: 265px;'>"+
								"<p id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_name style='display:inline;'>"+nj.toUpperCase()+
								"<p id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thrval style='display:inline;'></p>"+
								{% if request.path != home_waterleak %}						
									(_kind=='gt'?"":"<a id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_apply_threshold_btn class='clickThresholdCreate' onclick=onClickThresholdButton('create_threshold','"+nj+"',"+sim_aos_id+","+sim_id+","+sim_imageset_id+")><img height='24px' src='/static/images/threshold.svg' title='Create Manual Threshold' style='margin:3px'></a>"+
													"<a style='display:none' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_dl href='/portal/rois/"+sim_aos_id+"/simulations/"+sim_id+"/intermediate/processimageset/"+sim_imageset_id+"/"+nj+"/download_threshold'><img src='/static/images/download.svg' height=25px title='Download products from manual threshold'></img></a>"+
													"<img style='display:none;margin-left:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_error src='/static/images/error.svg' height=20px title='Error on calculating manual threshold'></img>"+
													"<img style='display:none;margin-left:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_loading src='/static/images/load.gif' height=20px title='Calculating threshold...'></img>"+
													"<img style='display:none;margin-left:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_thr_success src='/static/images/success.svg' height=20px title='Manual threshold calculated successfully'></img>")+
								{% endif %}
								"</p>"+		
								"<div class='subaccordion' style='display:none;margin-left:-7px;margin-top:10px;' id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_products_subaccordion >"+
								"<table id=simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_wi_"+nj+"_products style='font-size:10pt; width:252px'>"
							for (var jo in njo){
								appendProcImageSet += (_sim_is_topo? _add_simulation_gt_product(sim_id, sim_imageset_id, njo[jo]) : _add_simulation_product(sim_id, sim_imageset_id, njo[jo]))
							}
							appendProcImageSet += "</table>"
							appendProcImageSet += "</div>"
							appendProcImageSet += "</th></tr>"
						}
					}
				appendProcImageSet += "</table>"
				
				appendProcImageSet += "</div>"+
					"</th>"+
					"<th style='vertical-align:top;'>"+
						"<img id=simulation_"+sim_id+"_"+_kind+""+sim_imageset_id+"_loading style='display:none' height=24px src='/static/images/load.gif' />"+
						"<a style='margin:3px' id=simulation_"+sim_id+"_"+_kind+""+sim_imageset_id+"_download_btn href='/portal/rois/"+sim_aos_id+"/simulations/"+sim_id+"/intermediate/"+(_sim_is_topo? 'generatetopography':(sim_imageset_name.indexOf('Climatology')>-1? 'averageprocessimageset':'processimageset'))+"/"+sim_imageset_id+"/download_products'><img height=24px src='/static/images/download.svg' title='Download Processed Product'/></a>"+
						(_sim_is_topo? "<a style='margin:3px' id=simulation_"+sim_id+"_"+_kind+""+sim_imageset_id+"_delete_btn onclick=onClickDeleteTopography("+sim_aos_id+","+sim_id+","+sim_imageset_id+")><img height=24px src='/static/images/delete.svg' title='Delete Topography'/></a>":"")+
					"</th>"+
					"</tr>"
			}	 
			$("#simulation_"+sim_id+"_imagesets").append(appendProcImageSet)
			

			
			for (var is in sim_processed_imagesets){
				var sim_processed_imagesets_is = sim_processed_imagesets[is]
				sim_imageset_id = sim_processed_imagesets_is['id']
				sim_imageset_state = sim_processed_imagesets_is['processState']
				_sim_is_topo = sim_processed_imagesets_is['isTopography']
				//thrval
				sim_imageset_job_outputs = sim_processed_imagesets_is['job_outputs']
				addOriginalThresholdValue(sim_id, sim_imageset_id, sim_imageset_job_outputs)
				//
				_kind='imageset'
				if (_sim_is_topo){
					_kind='gt'
				}
				$("#simulation_"+sim_id+"_"+_kind+"_"+sim_imageset_id+"_chkbox").attr('disabled', sim_imageset_state != 'success')
				sim_imageset_threshold_states = sim_processed_imagesets_is['threshold_states']
				changeThresholdBtnByState(sim_id, _kind, sim_imageset_id, sim_imageset_threshold_states)
			}
		}

		console.timeEnd('append simulation append new simulation')
		if(RIGHT_PANEL_MODE == 'SHOW_DETECTION_MANAGER'){
			$('#rightPanelContent #showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_'+sim_id+'_imagesets_ocbtn').hide()
		}
		else if (RIGHT_PANEL_MODE == 'SHOW_VISUALIZATION' || RIGHT_PANEL_MODE == 'SHOW_LEAK_DETECTIONS'){
			$('#rightPanelContent #showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_'+sim_id+'_imagesets_ocbtn').show()
		}
	 	
	}

	function _add_simulation_leak_detection_product(sim_id, portal_ld_id, sim_imageset_leak_detection_outputs_ld){//, determine_by){
		var appendProcImageSet2 = ""
		//if (sim_imageset_leak_detection_outputs_ld['start_processing_second_deriv_from'] == determine_by){
		for (var l=0; l<sim_imageset_leak_detection_outputs_ld.length; l++){
			//console.log(sim_imageset_leak_detection_outputs_ld[l])
			sim_imageset_job_outputs_ldtype = sim_imageset_leak_detection_outputs_ld[l]['ldType']
			determine_by = sim_imageset_leak_detection_outputs_ld[l]['start_processing_second_deriv_from']
			sim_imageset_job_outputs_type = sim_imageset_leak_detection_outputs_ld[l]['type']
			sim_imageset_job_outputs_name = sim_imageset_leak_detection_outputs_ld[l]['name']
			sim_imageset_job_outputs_roi_id = sim_imageset_leak_detection_outputs_ld[l]['roi_id']
			sim_imageset_job_outputs_sim_id = sim_imageset_leak_detection_outputs_ld[l]['simulation_id']
			sim_imageset_job_outputs_raster_id = sim_imageset_leak_detection_outputs_ld[l]['raster_id']
			sim_imageset_job_outputs_intermediate_process_imageset_id = sim_imageset_leak_detection_outputs_ld[l]['intermediate_process_imageset_id']
			sim_imageset_job_outputs_intermediate_ucprocess_imageset_id = sim_imageset_leak_detection_outputs_ld[l]['intermediate_ucprocess_imageset_id']
			isLeakPoints = (sim_imageset_job_outputs_ldtype.indexOf('_leak_points')>-1)
			isLPUserSaved = false
			isGeometry = false
			if(sim_imageset_leak_detection_outputs_ld[l]['lp_user_saved']!==undefined){
				isLPUserSaved = sim_imageset_leak_detection_outputs_ld[l]['lp_user_saved']				
			}
			if(sim_imageset_leak_detection_outputs_ld[l]['is_geometry']!==undefined){
				isGeometry = sim_imageset_leak_detection_outputs_ld[l]['is_geometry']				
			}
			if(sim_imageset_leak_detection_outputs_ld[l]['is_owned_by_user']!==undefined){
				isOwnedByUser = sim_imageset_leak_detection_outputs_ld[l]['is_owned_by_user']			
			}
			if(isLPUserSaved){//user saved
				us_lp_id = sim_imageset_leak_detection_outputs_ld[l]['lp_user_saved_id']
				if ($("#simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_uslp_"+us_lp_id).length == 0){
					appendProcImageSet2 += "<tr id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_uslp_"+us_lp_id+">"+
						"<td style='width:30px; height:30px'>"+
							"<input class='"+(isLeakPoints?"clickLeakDetectionLeakPoint":"")+" form-check-input custom-checkbox' type='checkbox' id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_uslp_"+us_lp_id+"_chkbox onchange=onChangeChkboxUserSavedLPShowOutput("+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+portal_ld_id+","+us_lp_id+")></input>"+
						"</td>"+
						"<th><p id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_uslp_"+us_lp_id+"_name>"+sim_imageset_job_outputs_name+
							(isLeakPoints? "<svg id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_uslp_"+us_lp_id+"_linecolor style='margin-left:10px;margin-top:6px' width=25 height=16 viewBox='0 0 25 8' xmlns='http://www.w3.org/2000/svg'>"+
								"<polygon points='0,0 0,8 25,8 25,0' fill='"+generateRandomHexColor()+"'></svg>":"")+'<br>'+
							(isLeakPoints? (isOwnedByUser? "<a class=clickLeakDetectionLeakPointsEdit onclick=onClickLeakDetectionLeakPointsButton('edit_leak_points',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+portal_ld_id+","+us_lp_id+")><img height=24px src='/static/images/edit_leak.svg' title='Show/hide leak points' style='margin:3px'/></a>"+
								"<a class=clickLeakDetectionLeakPointsDelete onclick=onClickLeakDetectionLeakPointsButton('delete_leak_points',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+portal_ld_id+","+us_lp_id+")><img height=24px src='/static/images/delete_leak.svg' title='Delete leak points' style='margin:3px'/></a>":"")+
								"<a href='/portal/waterleak/leakdetection/rois/"+sim_imageset_job_outputs_roi_id+"/simulations/"+sim_imageset_job_outputs_sim_id+"/leak_detections/"+portal_ld_id+"/download_user_leak_point?user_leak_id="+us_lp_id+"'><img height=24px src='/static/images/download.svg' title='Download leak points as KML' style='margin:3px'/></a>" : "")+
						"</p></th>"+
					"</tr>"
				}
			}
			else if(isGeometry){
				//onChangeChkboxUserRepositoryShowOutputB('geometry',9999,16,'#c5bbc9',null,'#'+_chkbox_id)
				geometry_id = sim_imageset_leak_detection_outputs_ld[l]['geometry_id']
				_chkbox_id = "simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_geom_"+geometry_id+"_chkbox"
				_color = generateRandomHexColor()
				if ($("#simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_geom_"+geometry_id).length == 0){
					appendProcImageSet2 += "<tr id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_geom_"+geometry_id+">"+
						"<td style='width:30px; height:30px'>"+
							"<input class='"+(isLeakPoints?"clickLeakDetectionLeakPoint":"")+" form-check-input custom-checkbox' type='checkbox' id="+_chkbox_id+" onchange=onChangeChkboxUserRepositoryShowOutputB('geometry','9999_ld"+portal_ld_id+"',"+geometry_id+",'"+_color+"',null,'#"+_chkbox_id+"')></input>"+
						"</td>"+
						"<th><p>"+sim_imageset_job_outputs_name+
							"<svg id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_geom_"+geometry_id+"_linecolor style='margin-left:10px;margin-top:6px' width=25 height=16 viewBox='0 0 25 8' xmlns='http://www.w3.org/2000/svg'>"+
								"<polygon points='0,0 0,8 25,8 25,0' fill='"+_color+"'></svg>"+
						"</p></th>"+
					"</tr>"
				}
			}
			else{
				if (sim_imageset_job_outputs_intermediate_process_imageset_id!=null){//normal image
					if ($("#simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+determine_by+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_ldtype).length == 0){
						appendProcImageSet2 += "<tr id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+determine_by+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_ldtype+">"+
							"<td style='width:30px; height:30px'>"+
								"<input class='"+(isLeakPoints?"clickLeakDetectionLeakPoint":"")+" form-check-input custom-checkbox' type='checkbox' id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_ldtype+"_"+determine_by+"_chkbox onchange=onChangeChkboxImagesetShowOutput('"+sim_imageset_job_outputs_type+"',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+sim_imageset_job_outputs_intermediate_process_imageset_id+",null,"+sim_imageset_job_outputs_raster_id+",false,'"+sim_imageset_job_outputs_ldtype+"-"+determine_by+"',false,"+portal_ld_id+")></input>"+
								"<span id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_ldtype+"_"+determine_by+"_raster_id style='display:none'>"+sim_imageset_job_outputs_raster_id+"</span>"+
							"</td>"+
							"<th><p>"+sim_imageset_job_outputs_name+
								(isLeakPoints? "<svg id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+determine_by+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_ldtype+"_linecolor style='margin-left:10px;margin-top:6px' width=25 height=16 viewBox='0 0 25 8' xmlns='http://www.w3.org/2000/svg'>"+
									"<polygon points='0,0 0,8 25,8 25,0' fill='"+generateRandomHexColor()+"'></svg>":"")+
							"</p></th>"+
						"</tr>"
					}
				}
				else if (sim_imageset_job_outputs_intermediate_ucprocess_imageset_id!=null){//user custom
					if ($("#simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_ucimageset_"+sim_imageset_job_outputs_intermediate_ucprocess_imageset_id+"_"+determine_by+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_ldtype).length == 0){
						appendProcImageSet2 += "<tr id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_ucimageset_"+sim_imageset_job_outputs_intermediate_ucprocess_imageset_id+"_"+determine_by+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_ldtype+">"+
							"<td style='width:30px; height:30px'>"+
								"<input class='"+(isLeakPoints?"clickLeakDetectionLeakPoint":"")+" form-check-input custom-checkbox' type='checkbox' id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_ucimageset_"+sim_imageset_job_outputs_intermediate_ucprocess_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_ldtype+"_"+determine_by+"_chkbox onchange=onChangeChkboxImagesetShowOutput('"+sim_imageset_job_outputs_type+"',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+sim_imageset_job_outputs_intermediate_ucprocess_imageset_id+",null,"+sim_imageset_job_outputs_raster_id+",false,'"+sim_imageset_job_outputs_ldtype+"-"+determine_by+"',true,"+portal_ld_id+")></input>"+
								"<span id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_ucimageset_"+sim_imageset_job_outputs_intermediate_ucprocess_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_ldtype+"_"+determine_by+"_raster_id style='display:none'>"+sim_imageset_job_outputs_raster_id+"</span>"+
							"</td>"+
							"<th><p>"+sim_imageset_job_outputs_name+
								(isLeakPoints? "<svg id=simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_ucimageset_"+sim_imageset_job_outputs_intermediate_ucprocess_imageset_id+"_"+determine_by+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_ldtype+"_linecolor style='margin-left:10px;margin-top:6px' width=25 height=16 viewBox='0 0 25 8' xmlns='http://www.w3.org/2000/svg'>"+
									"<polygon points='0,0 0,8 25,8 25,0' fill='"+generateRandomHexColor()+"'></svg>":"")+
							"</p></th>"+
						"</tr>"
					}
				}
			}
		}
		//}
		//console.log(appendProcImageSet2)
		return appendProcImageSet2
	}

	{% if request.path == home_coastal %}
	//generate topomap
	function enableGenerateTopomap(roi_id, simulation_id){		
		disableDrawPolygonMode()
		disableEyedropperClickMode()
		disableMeasureMode()
		disablePlotSTMode()
		GENERATE_TOPOGRAPHY_MAP_MODE = true
		GENERATE_TOPOGRAPHY_ROI_ID = roi_id
		GENERATE_TOPOGRAPHY_SIM_ID = simulation_id
		$('#map #new-info-show-open-layers').hide()
		$('#map #new-info-show-ruler').hide()
		$('#map #new-info-plot-sea-tide').hide()
		$('#map #new-info-eyedrop').hide()
		$('#map #new-info-plot-sea-topography-map').show()
		$('#new-info-plot-sea-topography-map #new-info-plot-sea-topography-map-active input[name="optSeaTopoMap"]').change(function(){ optionsSeaTopoMap() })
		$('#new-info-plot-sea-topography-map #new-info-plot-sea-topography-map-active #sim_name').text($('#simulation_'+simulation_id+'_name').text())
		closeRightPanel()
	}
	function disableGenerateTopomap(){
		GENERATE_TOPOGRAPHY_MAP_MODE = false
		GENERATE_TOPOGRAPHY_ROI_ID = null
		GENERATE_TOPOGRAPHY_SIM_ID = null		
		$('#map #new-info-show-open-layers').show()
		$('#map #new-info-show-ruler').show()
		$('#map #new-info-plot-sea-tide').show()
		$('#map #new-info-eyedrop').show()
		$('#map #new-info-plot-sea-topography-map').hide()
		//default
		map.removeLayer(markerVectorLayer);
		$('#new-info-plot-sea-topography-map #new-info-plot-sea-topography-map-active #optSeaTopoMap1-div-zref').val(0)
		$('#new-info-plot-sea-topography-map #new-info-plot-sea-topography-map-active #optSeaTopoMap1-div-coords').text("(click on a point on the map)")
		$('#divuploadseatide #fileupload3').val('')
		$('#new-info-plot-sea-topography-map #new-info-plot-sea-topography-map-active #optSeaTopoMap1-div-name').val('')
		$('#new-info-plot-sea-topography-map #new-info-plot-sea-topography-map-active #sim_name').text('')
		openRightPanel()
	}
	{% endif %}

	//create threshold
	//clone coastline
	function enableCreateThreshold(){
		CREATE_THRESHOLD_MODE = true
		//disable the following actions
		//roi radio buttons
		$('#listOfROI tr th input[type="radio"]').attr('disabled',true)
		//roi delete button 
		$('#listOfROI tr td .clickROIDelete').hide()
		// other (leak point or all?) checkboxes
		//$('#listOfSimulations tr td input[type="checkbox"]').attr('disabled',true)
		//$('#listOfUserRepository tr td input[type="checkbox"]').attr('disabled',true)		
		//all other edit/delete simulation btns
		{% if request.path == home_waterleak %}
		$('#listOfSimulations tr td .clickSimulationUpdate').hide()
		{% else %}
		$('#listOfSimulations tr td .clickSimulationEdit').hide()
		{% endif %}
		$('#listOfSimulations tr td .clickSimulationDelete').hide()
		//
		$('#map #new-info-edit-leak-points').hide()
		$('#map #new-info-edit-threshold').show()
		$('#map #new-info-show-open-layers').hide()
		$('#map #new-info-show-ruler').hide()
		$('#map #new-info-plot-sea-tide').hide()
		$('#map #new-info-plot-sea-topography-map').hide()
		closeRightPanel()
		//hide other layers
		map.getLayers().forEach(function(el){ 
			if (el.get('name') !== undefined){ 
				if(el.get('name').indexOf('output-')>-1 && el.get('name').indexOf('-edit')==-1){
					el.setVisible(false)
				}
			} 
		})
	}
	function disableCreateThreshold(){
		CREATE_THRESHOLD_MODE = false
		//disable the following actions
		//roi radio buttons
		$('#listOfROI tr th input[type="radio"]').attr('disabled',false)
		//roi delete button 
		$('#listOfROI tr td .clickROIDelete').show()
		// other (leak point or all?) checkboxes
		//$('#listOfSimulations tr td input[type="checkbox"]').attr('disabled',false)
		//$('#listOfUserRepository tr td input[type="checkbox"]').attr('disabled',false)
		//all other edit/delete simulation btns
		{% if request.path == home_waterleak %}
		$('#listOfSimulations tr td .clickSimulationUpdate').show()
		{% else %}
		$('#listOfSimulations tr td .clickSimulationEdit').show()
		{% endif %}
		$('#listOfSimulations tr td .clickSimulationDelete').show()
		//
		$('#map #new-info-show-open-layers').show()
		$('#map #new-info-show-ruler').show()
		$('#map #new-info-edit-leak-points').hide()
		$('#map #new-info-edit-threshold').hide()
		$('#map #new-info-plot-sea-tide').hide()
		$('#map #new-info-plot-sea-topography-map').hide()
		openRightPanel()
		//hide other layers		
		reverseRemoveLayerEqual('threshold-test')
		map.getLayers().forEach(function(el){ 
			if (el.get('name') !== undefined){ 
				if(el.get('name').indexOf('output-')>-1 && el.get('name').indexOf('-edit')==-1){
					el.setVisible(true)
				}
			} 
		})
	}

	//clone coastline
	function enableCreateCleanupCoastline(){
		CREATE_CLEANUP_COASTLINE_MODE = true
		//disable the following actions
		//roi radio buttons
		$('#listOfROI tr th input[type="radio"]').attr('disabled',true)
		//roi delete button 
		$('#listOfROI tr td .clickROIDelete').hide()
		// other (leak point or all?) checkboxes
		//$('#listOfSimulations tr td input[type="checkbox"]').attr('disabled',true)
		//$('#listOfUserRepository tr td input[type="checkbox"]').attr('disabled',true)		
		//all other edit/delete simulation btns
		{% if request.path == home_waterleak %}
		$('#listOfSimulations tr td .clickSimulationUpdate').hide()
		{% else %}
		$('#listOfSimulations tr td .clickSimulationEdit').hide()
		{% endif %}
		$('#listOfSimulations tr td .clickSimulationDelete').hide()
		//
		$('#map #new-info-edit-leak-points').show()
		$('#map #new-info-edit-threshold').hide()
		$('#map #new-info-show-open-layers').hide()
		$('#map #new-info-show-ruler').hide()
		$('#map #new-info-plot-sea-tide').hide()
		$('#map #new-info-plot-sea-topography-map').hide()
		closeRightPanel()
		//hide other layers
		map.getLayers().forEach(function(el){ 
			if (el.get('name') !== undefined){ 
				if(el.get('name').indexOf('output-')>-1 && el.get('name').indexOf('-edit')==-1){
					el.setVisible(false)
				}
			} 
		})
	}
	function disableCreateCleanupCoastline(){
		CREATE_CLEANUP_COASTLINE_MODE = false
		//disable the following actions
		//disable draw polygon if activated
		disableDrawPolygonCreateCleanupCoastline()
		//roi radio buttons
		$('#listOfROI tr th input[type="radio"]').attr('disabled',false)
		//roi delete button 
		$('#listOfROI tr td .clickROIDelete').show()
		// other (leak point or all?) checkboxes
		//$('#listOfSimulations tr td input[type="checkbox"]').attr('disabled',false)
		//$('#listOfUserRepository tr td input[type="checkbox"]').attr('disabled',false)
		//all other edit/delete simulation btns
		{% if request.path == home_waterleak %}
		$('#listOfSimulations tr td .clickSimulationUpdate').show()
		{% else %}
		$('#listOfSimulations tr td .clickSimulationEdit').show()
		{% endif %}
		$('#listOfSimulations tr td .clickSimulationDelete').show()
		//
		$('#map #new-info-show-open-layers').show()
		$('#map #new-info-show-ruler').show()
		$('#map #new-info-edit-leak-points').hide()
		$('#map #new-info-edit-threshold').hide()
		$('#map #new-info-plot-sea-tide').hide()
		$('#map #new-info-plot-sea-topography-map').hide()
		openRightPanel()
		//hide other layers		
		map.getLayers().forEach(function(el){ 
			if (el.get('name') !== undefined){ 
				if(el.get('name').indexOf('output-')>-1 && el.get('name').indexOf('-edit')==-1){
					el.setVisible(true)
				}
			} 
		})
	}
	//draw polygon for cleanup coastline
	function enableDrawPolygonCreateCleanupCoastline(){
		disableEditPolygonCreateCleanupCoastline()
		disableDeletePolygonCreateCleanupCoastline()
		coastlinePolygonsAddInteractionDraw()
		SET_POLYGON_CLEANUP_COASTLINE_MODE = 'draw'
		$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn #cleanup_addpolygon_icon').attr('src','/static/images/cleanup_addpolygon2.svg')
	}
	function disableDrawPolygonCreateCleanupCoastline(){
		coastlinePolygonsRemoveInteractionDraw()
		SET_POLYGON_CLEANUP_COASTLINE_MODE = null
		$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn #cleanup_addpolygon_icon').attr('src','/static/images/cleanup_addpolygon.svg')
	}
	//edit polygon for cleanup coastline
	function enableEditPolygonCreateCleanupCoastline(){
		disableDrawPolygonCreateCleanupCoastline()
		disableDeletePolygonCreateCleanupCoastline()
		coastlinePolygonsAddInteractionModify()
		SET_POLYGON_CLEANUP_COASTLINE_MODE = 'edit'
		$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn #cleanup_editpolygon_icon').attr('src','/static/images/edit.svg')
	}
	function disableEditPolygonCreateCleanupCoastline(){
		coastlinePolygonsRemoveInteractionModify()
		SET_POLYGON_CLEANUP_COASTLINE_MODE = null
		$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn #cleanup_editpolygon_icon').attr('src','/static/images/edit0.svg')
	}
	//edit polygon for cleanup coastline
	function enableDeletePolygonCreateCleanupCoastline(){
		disableDrawPolygonCreateCleanupCoastline()
		disableEditPolygonCreateCleanupCoastline()
		//coastlinePolygonsAddInteractionDelete()
		SET_POLYGON_CLEANUP_COASTLINE_MODE = 'delete'
		$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn #cleanup_deletepolygon_icon').attr('src','/static/images/delete.svg')
	}
	function disableDeletePolygonCreateCleanupCoastline(){		
		//coastlinePolygonsRemoveInteractionDelete()
		SET_POLYGON_CLEANUP_COASTLINE_MODE = null
		$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn #cleanup_deletepolygon_icon').attr('src','/static/images/delete0.svg')
	}



	//leak points
	function enableEditLeakPoints(){
		EDIT_LEAK_POINTS_MODE = true
		enableEditDeleteLeakPoints()
	}
	function enableDeleteLeakPoints(){
		DELETE_LEAK_POINTS_MODE = true
		enableEditDeleteLeakPoints()
	}
	function enableEditDeleteLeakPoints(){
		//disable the following actions
		//roi radio buttons
		$('#listOfROI tr th input[type="radio"]').attr('disabled',true)
		//roi delete button 
		$('#listOfROI tr td .clickROIDelete').hide()
		// other (leak point or all?) checkboxes
		$('#listOfSimulations tr td input[type="checkbox"]').attr('disabled',true)
		$('#listOfUserRepository tr td input[type="checkbox"]').attr('disabled',true)		
		//all other edit/delete simulation btns
		{% if request.path == home_waterleak %}
		$('#listOfSimulations tr td .clickSimulationUpdate').hide()
		{% else %}
		$('#listOfSimulations tr td .clickSimulationEdit').hide()
		{% endif %}
		$('#listOfSimulations tr td .clickSimulationDelete').hide()
		//
		$('#listOfSimulations tr td .clickLeakDetectionRun').hide()
		$('#listOfSimulations tr td .clickLeakDetectionLeakPointsEdit').hide()
		$('#listOfSimulations tr td .clickLeakDetectionLeakPointsDelete').hide()
		//
		$('#map #new-info-show-open-layers').hide()
		$('#map #new-info-edit-leak-points').show()
		$('#map #new-info-edit-threshold').hide()
		closeRightPanel()
		//hide other layers
		map.getLayers().forEach(function(el){ 
			if (el.get('name') !== undefined){ 
				if(el.get('name').indexOf('output-')>-1 && el.get('name').indexOf('-edit')==-1){
					el.setVisible(false)
				}
			} 
		})
	}

	function disableEditLeakPoints(){
		EDIT_LEAK_POINTS_MODE = false
		disableEditDeleteLeakPoints()
	}
	function disableDeleteLeakPoints(){
		DELETE_LEAK_POINTS_MODE = false
		disableEditDeleteLeakPoints()
	}
	function disableEditDeleteLeakPoints(){
		//disable the following actions
		//roi radio buttons
		$('#listOfROI tr th input[type="radio"]').attr('disabled',false)
		//roi delete button 
		$('#listOfROI tr td .clickROIDelete').show()
		// other (leak point or all?) checkboxes
		$('#listOfSimulations tr td input[type="checkbox"]').attr('disabled',false)
		$('#listOfUserRepository tr td input[type="checkbox"]').attr('disabled',false)
		//all other edit/delete simulation btns
		{% if request.path == home_waterleak %}
		$('#listOfSimulations tr td .clickSimulationUpdate').show()
		{% else %}
		$('#listOfSimulations tr td .clickSimulationEdit').show()
		{% endif %}
		$('#listOfSimulations tr td .clickSimulationDelete').show()
		//
		$('#listOfSimulations tr td .clickLeakDetectionRun').show()
		$('#listOfSimulations tr td .clickLeakDetectionLeakPointsEdit').show()
		$('#listOfSimulations tr td .clickLeakDetectionLeakPointsDelete').show()
		//
		$('#map #new-info-show-open-layers').show()
		$('#map #new-info-edit-leak-points').hide()
		$('#map #new-info-edit-threshold').hide()
		openRightPanel()
		//hide other layers		
		map.getLayers().forEach(function(el){ 
			if (el.get('name') !== undefined){ 
				if(el.get('name').indexOf('output-')>-1 && el.get('name').indexOf('-edit')==-1){
					el.setVisible(true)
				}
			} 
		})
	}

	/*why the fuck openlayers does not do the removal of layers by descending?*/
	function reverseRemoveLayerIndexOf(name){
		var layers = map.getLayers().getArray();
		for (var i = layers.length - 1; i >= 0; --i) {
			var layer = layers[i];
			if (layer.get('name') !== undefined){ 
				if (layer.get('name').indexOf(name)>-1) {
					map.removeLayer(layer);
				}
			}
		}
	}
	function reverseRemoveLayerEqual(name){
		var layers = map.getLayers().getArray();
		for (var i = layers.length - 1; i >= 0; --i) {
			var layer = layers[i];
			if (layer.get('name') !== undefined){ 
				if (layer.get('name')===name) {
					map.removeLayer(layer);
				}
			}
		}
	}

	function onClickLeakDetectionLeakPointsButton(type, sim_imageset_job_outputs_roi_id, sim_imageset_job_outputs_sim_id, ld_id, uslp_id){
		USLP_LAYER_NAME = 'output-roi_'+roi_id+'-simulation'+sim_imageset_job_outputs_sim_id+'-ld'+ld_id+'-uslp'+uslp_id	
		EDIT_LEAK_POINTS_REFERENCE = '#simulation_'+sim_imageset_job_outputs_sim_id+'_ld_'+ld_id+'_uslp_'+uslp_id

		if (type == 'edit_leak_points'){			
			if(EDIT_LEAK_POINTS_MODE){
				disableEditLeakPoints()				
				$(EDIT_LEAK_POINTS_REFERENCE).css('background-color','')
				$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsEdit').show()
				$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsEdit img').attr('src','/static/images/edit_leak.svg')
				$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsDelete').show()
				$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsDelete img').attr('src','/static/images/delete_leak.svg')
				$('#new-info-edit-leak-points #new-info-edit-leak-points-active-text').empty()
				$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn').empty()
				
				//remove actual -edit layers
				reverseRemoveLayerIndexOf(USLP_LAYER_NAME+'-edit')
				reverseRemoveLayerIndexOf(USLP_LAYER_NAME+'-2nd_deriv')
				listActiveLayers()
				//load again the removed actual layers
				//if layer was checked on visualization or is on edit mode
				isLeakLayerChecked=$(EDIT_LEAK_POINTS_REFERENCE+'_chkbox').prop('checked')
				setTimeout(function(){	
					if(isLeakLayerChecked){
						onChangeChkboxUserSavedLPShowOutput(sim_imageset_job_outputs_roi_id,sim_imageset_job_outputs_sim_id,ld_id,uslp_id)
					}
				}, 300)
				EDIT_LEAK_POINTS_REFERENCE = null
				EDIT_LEAK_POINTS_LAYER_NAME = null
			}
			else{				
				enableEditLeakPoints()
				//simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+portal_ld_id+"_uslp_"+us_lp_id+"_name
				$(EDIT_LEAK_POINTS_REFERENCE).css('background-color','#2CC0DE')
				$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsEdit').show()
				$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsEdit img').attr('src','/static/images/edit_leak_finish.svg')
				$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsDelete').show()
				$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsDelete img').attr('src','/static/images/delete_leak.svg')
				$('#new-info-edit-leak-points #new-info-edit-leak-points-active-text').append(
					"<b>Show/hide leak points - "+$(EDIT_LEAK_POINTS_REFERENCE+'_name').text()+" </b><br>"+
					"Instructions: Clicking on a point update/change immediately their state, without the need to save. Colored dots mean they are on visible state, black ones mean they are on hidden state. </br>"+
					"To finish the changes, click on 'Go to View LDs'."
				)
				$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn').append(
					"<a onclick=onClickLeakDetectionLeakPointsButton('"+type+"',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+ld_id+","+uslp_id+") class='btn btn-sm btn-primary'>Go to View LDs</a>")
				
				colorShow = $(EDIT_LEAK_POINTS_REFERENCE+"_linecolor polygon").attr('fill')
				_url = '/portal/waterleak/leakdetection/rois/'+sim_imageset_job_outputs_roi_id+'/simulations/'+sim_imageset_job_outputs_sim_id+'/leak_detections/'+ld_id+'/show_user_leak_point'
				_url += '?user_leak_id='+uslp_id+'&edit=true'
				onLoadStep4LeakDetectionLoadLeakPoints(_url, USLP_LAYER_NAME+'-edit', colorShow)

				//remove actual layers
				reverseRemoveLayerIndexOf(USLP_LAYER_NAME)
				listActiveLayers()
			}
		}
		else if (type == 'delete_leak_points'){			
			if(DELETE_LEAK_POINTS_MODE){
				if(!HAS_SAVED_CHANGES){
					buildDynamicModalPopup('Warning!', 
					'<p>You have not saved your changes on your actual leak point set. Leaving this menu will lose the changes. Proceed anyway?</p>',[
						['Yes', function(){ 
							$(this).dialog( "close" )
							disableDeleteLeakPoints()				
							$(EDIT_LEAK_POINTS_REFERENCE).css('background-color','')
							$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsEdit').show()
							$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsEdit img').attr('src','/static/images/edit_leak.svg')
							$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsDelete').show()
							$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsDelete img').attr('src','/static/images/delete_leak.svg')
							$('#new-info-edit-leak-points #new-info-edit-leak-points-active-text').empty()
							$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn').empty()
							
							//remove actual -edit layers
							reverseRemoveLayerIndexOf(USLP_LAYER_NAME+'-edit')
							reverseRemoveLayerIndexOf(USLP_LAYER_NAME+'-2nd_deriv')
							listActiveLayers()
							//load again the removed actual layers
							//if layer was checked on visualization or is on edit mode
							isLeakLayerChecked=$(EDIT_LEAK_POINTS_REFERENCE+'_chkbox').prop('checked')
							setTimeout(function(){	
								if(isLeakLayerChecked){
									onChangeChkboxUserSavedLPShowOutput(sim_imageset_job_outputs_roi_id,sim_imageset_job_outputs_sim_id,ld_id,uslp_id)
								}
							}, 300)
							EDIT_LEAK_POINTS_REFERENCE = null
							EDIT_LEAK_POINTS_LAYER_NAME = null
							HAS_SAVED_CHANGES = true
							$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn #save_leak_points_btn').css('background-color','')
						}],
						['No', function(){
							$(this).dialog( "close" )
						}]
					], [330,220])
				}
				else{	
					disableDeleteLeakPoints()				
					$(EDIT_LEAK_POINTS_REFERENCE).css('background-color','')
					$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsEdit').show()
					$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsEdit img').attr('src','/static/images/edit_leak.svg')
					$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsDelete').show()
					$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsDelete img').attr('src','/static/images/delete_leak.svg')
					$('#new-info-edit-leak-points #new-info-edit-leak-points-active-text').empty()
					$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn').empty()
					
					//remove actual -edit layers
					reverseRemoveLayerIndexOf(USLP_LAYER_NAME+'-edit')
					reverseRemoveLayerIndexOf(USLP_LAYER_NAME+'-2nd_deriv')
					listActiveLayers()
					//load again the removed actual layers
					//if layer was checked on visualization or is on edit mode
					isLeakLayerChecked=$(EDIT_LEAK_POINTS_REFERENCE+'_chkbox').prop('checked')
					setTimeout(function(){	
						if(isLeakLayerChecked){
							onChangeChkboxUserSavedLPShowOutput(sim_imageset_job_outputs_roi_id,sim_imageset_job_outputs_sim_id,ld_id,uslp_id)
						}
					}, 300)
					EDIT_LEAK_POINTS_REFERENCE = null
					EDIT_LEAK_POINTS_LAYER_NAME = null
					HAS_SAVED_CHANGES = true
					$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn #save_leak_points_btn').css('background-color','')
				}
			}
			else{				
				enableDeleteLeakPoints()
				LIST_DELETE_LEAK_POINTS = []
				$(EDIT_LEAK_POINTS_REFERENCE).css('background-color','#2CC0DE')
				$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsEdit').show()
				$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsEdit img').attr('src','/static/images/edit_leak_finish.svg')
				$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsDelete').show()
				$(EDIT_LEAK_POINTS_REFERENCE+' .clickLeakDetectionLeakPointsDelete img').attr('src','/static/images/delete_leak.svg')
				$('#new-info-edit-leak-points #new-info-edit-leak-points-active-text').append(
					"<b>Delete leak points - "+$(EDIT_LEAK_POINTS_REFERENCE+'_name').text()+" </b><br>"+
					"Instructions: All points will be shown for deletion. Colored dots mean they are visible, black ones mean they are hidden. If some appear black, it's because you edited them previously through 'show/hide leak points' option. </br>"+
					"Clicking on a point will ask you if you want to delete it or not. After deleting, the 'Save' button becomes red to apply the changes. </br>"+
					"To save the changes, click below on 'Save' first. To clone this set with another name, click on 'Clone'. To leave without saving, click on 'Go to View LDs', but make sure if you want to save the changes."
				)
				$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn').append(
					"<a onclick=onClickLeakDetectionLeakPointsButton('"+type+"',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+ld_id+","+uslp_id+") class='btn btn-sm btn-primary'>Go to View LDs</a>"+
					"<a onclick=onClickLeakDetectionLeakPointsButton('save_leak_points',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+ld_id+","+uslp_id+") class='btn btn-sm btn-primary' id='save_leak_points_btn'>Save</a>"+
					"<a onclick=onClickLeakDetectionLeakPointsButton('clone_leak_points',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+ld_id+","+uslp_id+") class='btn btn-sm btn-primary pull-right'>Clone</a>"
				)
				
				colorShow = $(EDIT_LEAK_POINTS_REFERENCE+"_linecolor polygon").attr('fill')
				_url = '/portal/waterleak/leakdetection/rois/'+sim_imageset_job_outputs_roi_id+'/simulations/'+sim_imageset_job_outputs_sim_id+'/leak_detections/'+ld_id+'/show_user_leak_point'
				_url += '?user_leak_id='+uslp_id+'&edit=true'
				onLoadStep4LeakDetectionLoadLeakPoints(_url, USLP_LAYER_NAME+'-edit', colorShow)

				//remove actual layers
				reverseRemoveLayerIndexOf(USLP_LAYER_NAME)
				listActiveLayers()
			}		
		}
		else if (type == 'save_leak_points'){	
			if(DELETE_LEAK_POINTS_MODE){
				url_point = '/portal/waterleak/leakdetection/rois/'+sim_imageset_job_outputs_roi_id+'/simulations/'+sim_imageset_job_outputs_sim_id+'/leak_detections/'+ld_id+'/delete_a_user_leak_point'
				url_point += '?user_leak_id='+uslp_id+'&delete_leak_points='+LIST_DELETE_LEAK_POINTS.toString()
				console.log(url_point)
				buildDynamicModalPopup('Saving...', 
					'<p>Please wait...</p>', 
					[], [250,220])
				$.ajax({ type: "GET", url: url_point, async: true,
					success : function(response){
						if(response['alert']=='deleted'){
							dm.dialog("close")
							buildDynamicModalPopup('Success', 
								'<p>Saved. Your deleted points were removed.</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							HAS_SAVED_CHANGES = true
							$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn #save_leak_points_btn').css('background-color','')
						}
						else{
							dm.dialog("close")
							buildDynamicModalPopup('Error', 
								'<p>Something went wrong on deleting leak points. Try again.</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						}
					},
					error: function(response){
						dm.dialog("close")
						buildDynamicModalPopup('Error', 
							'<p>Something went wrong on deleting leak point. Try again.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
				});
			}
		}
		else if (type == 'clone_leak_points'){	
			if(DELETE_LEAK_POINTS_MODE){
				buildDynamicModalPopup('Clone leak points', 
					'<p>What will be the name for your new cloned leak point set?</p>'+
					'<div class="custom-form-control" style="width:100%">'+
						'<label for="newLeakPointSetName">Name</label>'+
						'<input class="form-control" type="text" id="newLeakPointSetName" style="text-align:right"></input>'+
					'</div>'+
					'<br>'+
					'<div id="newLeakPointSetNameMessage">'+
					'</div>'+
					'<div style="font-size:10pt" class="alert alert-warning">'+
					'<p>Attention: the cloned leak point set will "mirror" the changes you made on the actual leak you are now working on, even if you havent saved them. Dont forget: You still need to save the changes on actual leak point set through "Save".</p>'+
					'</div>', 
					[['OK', function(){ 	
						$('#newLeakPointSetNameMessage').empty()					
						if ($('#newLeakPointSetName').val() == ''){
							$('#newLeakPointSetNameMessage').html('<p style="color:#cc0000">Error: Please provide a valid name!</p>')
						}
						else if($('#newLeakPointSetName').val().length < 4){
							$('#newLeakPointSetNameMessage').html('<p style="color:#cc0000">Error: Provided name is too small (must be at least 4 characters)!</p>')
						}
						else{
							url_point = '/portal/waterleak/leakdetection/rois/'+sim_imageset_job_outputs_roi_id+'/simulations/'+sim_imageset_job_outputs_sim_id+'/leak_detections/'+ld_id+'/clone_user_leak_points'
							//url_point += '?user_leak_id='+uslp_id+'&exclude_leak_points='+LIST_DELETE_LEAK_POINTS.toString()
							console.log(url_point)
							jsonR = {}
							jsonR['name'] = $('#newLeakPointSetName').val()
							jsonR['user_leak_id'] = uslp_id
							jsonR['exclude_leak_points'] = LIST_DELETE_LEAK_POINTS.toString()
							console.log(jsonR)
							dm.dialog("close")
							buildDynamicModalPopup('Cloning...', 
								'<p>Please wait...</p>', 
								[], [250,220])
							$.post(url_point,  JSON.stringify(jsonR))
								.done(function(data){
									var response = $.parseJSON(JSON.stringify(data));
									if(response['alert']=='cloned'){
										dm.dialog("close")
										cloned_ld = response['outputs']
										cloned_ld_app = _add_simulation_leak_detection_product(sim_imageset_job_outputs_sim_id, ld_id, cloned_ld)
										$("#simulation_"+sim_imageset_job_outputs_sim_id+"_ld_"+ld_id+"_products").append(cloned_ld_app)										
										buildDynamicModalPopup('Success', 
											'<p>Your leak points were cloned successfully as '+jsonR['name']+'</p>', 
											[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
										
									}
									else{
										dm.dialog("close")
										buildDynamicModalPopup('Error', 
											'<p>Something went wrong on cloning leak point set. Try again.</p>', 
											[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
									}
								})
								.fail(function( xhr, textStatus, errorThrown ){
									console.log( xhr, textStatus, errorThrown)
									dm.dialog("close")
									buildDynamicModalPopup('Error', 
										'<p>Something went wrong on cloning leak point set. Try again.</p>', 
										[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
								})
							
							//$(this).dialog( "close" )
						}
					}],
					['Cancel', function(){ 
						$(this).dialog( "close" )
					}]
					], [550,380])
			}	
		}
	}

	function _add_simulation_gt_product(sim_id, gt_id, sim_imageset_job_outputs_jo){
		sim_imageset_job_outputs_type = sim_imageset_job_outputs_jo['type']
		sim_imageset_job_outputs_name = sim_imageset_job_outputs_jo['name']
		sim_imageset_job_outputs_roi_id = sim_imageset_job_outputs_jo['roi_id']
		sim_imageset_job_outputs_sim_id = sim_imageset_job_outputs_jo['simulation_id']
		//shplineSourceType = sim_imageset_job_outputs_jo['shplineSourceType']
		sim_imageset_job_outputs_intermediate_gt_id = sim_imageset_job_outputs_jo['gt_id']
		if (sim_imageset_job_outputs_sim_id==sim_id && sim_imageset_job_outputs_intermediate_gt_id==gt_id){
			if($("#simulation_"+sim_imageset_job_outputs_sim_id+"_gt_"+sim_imageset_job_outputs_intermediate_gt_id+"_"+sim_imageset_job_outputs_type).length==0){
				var appendProcImageSet = ""
				appendProcImageSet = 
					"<tr id=simulation_"+sim_imageset_job_outputs_sim_id+"_gt_"+sim_imageset_job_outputs_intermediate_gt_id+"_"+sim_imageset_job_outputs_type+">"+
						"<td style='width:30px; height:30px'>"
				
				
				sim_imageset_job_outputs_raster_id = sim_imageset_job_outputs_jo['raster_id']
				appendProcImageSet += 
						"<input class='form-check-input custom-checkbox' type='checkbox' id=simulation_"+sim_imageset_job_outputs_sim_id+"_gt_"+sim_imageset_job_outputs_intermediate_gt_id+"_"+sim_imageset_job_outputs_type+"_chkbox onchange=onChangeChkboxImagesetShowOutput('"+sim_imageset_job_outputs_type+"',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+sim_imageset_job_outputs_intermediate_gt_id+",null,"+sim_imageset_job_outputs_raster_id+",false)></input>"+
						"<span id=simulation_"+sim_imageset_job_outputs_sim_id+"_gt_"+sim_imageset_job_outputs_intermediate_gt_id+"_"+sim_imageset_job_outputs_type+"_raster_id style='display:none'>"+sim_imageset_job_outputs_raster_id+"</span>"
				
				appendProcImageSet += "</td>"
				appendProcImageSet += "<th><p>"+sim_imageset_job_outputs_name+"</p></th>"
				appendProcImageSet += "</tr>"	
				return appendProcImageSet
			}
		}
	}

	function _add_simulation_product(sim_id, imageset_id, sim_imageset_job_outputs_jo){
		sim_imageset_job_outputs_type = sim_imageset_job_outputs_jo['type']
		sim_imageset_job_outputs_name = sim_imageset_job_outputs_jo['name']
		sim_imageset_job_outputs_roi_id = sim_imageset_job_outputs_jo['roi_id']
		sim_imageset_job_outputs_sim_id = sim_imageset_job_outputs_jo['simulation_id']
		sim_imageset_job_outputs_shp_mpis_id = sim_imageset_job_outputs_jo['shp_mpis_id']
		
		shplineSourceType = sim_imageset_job_outputs_jo['shplineSourceType']
		sim_imageset_job_outputs_intermediate_process_imageset_id = sim_imageset_job_outputs_jo['intermediate_process_imageset_id']
		//console.log('_add_simulation_product('+sim_id+', '+imageset_id+', '+sim_imageset_job_outputs_jo['name']+')')
		
		if (sim_imageset_job_outputs_sim_id==sim_id && sim_imageset_job_outputs_intermediate_process_imageset_id==imageset_id){
			sim_imageset_job_outputs_is_climatology = false
			if (sim_imageset_job_outputs_jo['is_climatology'] !== undefined){
				sim_imageset_job_outputs_is_climatology = sim_imageset_job_outputs_jo['is_climatology']
			}

			sim_imageset_job_outputs_thr_id = null
			if (sim_imageset_job_outputs_jo['thr_id'] !== undefined){
				sim_imageset_job_outputs_thr_id = sim_imageset_job_outputs_jo['thr_id']
			}

			/*sim_imageset_job_outputs_jo_threshold_state = null
			if (sim_imageset_job_outputs_jo['threshold_state'] !== undefined){
				sim_imageset_job_outputs_jo_threshold_state = sim_imageset_job_outputs_jo['threshold_state']
			}*/

			sim_imageset_job_outputs_shp_state = null		
			if (sim_imageset_job_outputs_jo['clone_state'] !== undefined){
				sim_imageset_job_outputs_shp_state = sim_imageset_job_outputs_jo['clone_state']
			}

			//clone cleanup coastlines
			if (sim_imageset_job_outputs_shp_mpis_id!==undefined && shplineSourceType=='cloning_and_cleaning'){
				//console.log(sim_imageset_job_outputs_name)
				//console.log("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_chkbox")
				$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_name").text(sim_imageset_job_outputs_name)
				if (sim_imageset_job_outputs_shp_state == 'cloning'){
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_clone_error").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_clone_loading").css('display','inline')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_chkbox").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_svg").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_clone_btn").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_delete_btn").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_download_btn").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_delete_btn").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_rgb_div").css('display','none')
				}	
				else if (sim_imageset_job_outputs_shp_state == 'finished'){
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_clone_error").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_clone_loading").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_chkbox").css('display','')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_svg").css('display','')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_clone_btn").css('display','')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_delete_btn").css('display','')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_download_btn").css('display','')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_rgb_div").css('display','')
				}
				else if(sim_imageset_job_outputs_shp_state == 'error-cloning'){
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_clone_error").css('display','inline')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_clone_loading").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_chkbox").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_svg").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_clone_btn").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_delete_btn").css('display','')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_download_btn").css('display','none')
					$("#simulation_"+sim_imageset_job_outputs_sim_id+"_imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type+"_"+sim_imageset_job_outputs_shp_mpis_id+"_rgb_div").css('display','none')
				}
			}
			//it is getting too big to handle!
			big_sim_identifier0 = "simulation_"+sim_imageset_job_outputs_sim_id+"_"
			big_sim_identifier0 += (sim_imageset_job_outputs_is_climatology? "climatology_":"")
			big_sim_identifier0 += "imageset_"+sim_imageset_job_outputs_intermediate_process_imageset_id+"_"+sim_imageset_job_outputs_type
			big_sim_identifier = big_sim_identifier0
			big_sim_identifier += (sim_imageset_job_outputs_type.indexOf('coastline')>-1 || sim_imageset_job_outputs_type.indexOf('waterbody')>-1?(sim_imageset_job_outputs_shp_mpis_id==null?"_":"_"+sim_imageset_job_outputs_shp_mpis_id):"")				
			//big_sim_identifier += (sim_imageset_job_outputs_thr_id!=null?"_threshold"+sim_imageset_job_outputs_thr_id:"")

			if($("#"+big_sim_identifier).length==0){
				var appendProcImageSet = ""
				appendProcImageSet = 
					"<tr id="+big_sim_identifier+">"+
						"<td style='width:30px; height:30px'>"
				randomColor = generateRandomHexColor()
				if (sim_imageset_job_outputs_type.indexOf('coastline')>-1 || sim_imageset_job_outputs_type.indexOf('waterbody')>-1){
					sim_imageset_job_outputs_raster_id_rgb = sim_imageset_job_outputs_jo['rgb']['raster_id']
					clone_has_finished = (sim_imageset_job_outputs_shp_state == 'not-applicable' || sim_imageset_job_outputs_shp_state == 'finished')
					clone_has_failed = (sim_imageset_job_outputs_shp_state == 'error-cloning')
					appendProcImageSet += 
						"<img style=display:"+(!clone_has_failed?'none':'inline')+" id="+big_sim_identifier+"_clone_error src='/static/images/error.svg' height=25px></img>"+
						"<img style=display:"+(clone_has_failed||clone_has_finished?'none':'inline')+" id="+big_sim_identifier+"_clone_loading src='/static/images/load.gif' height=25px></img>"+
						"<input "+(!(clone_has_failed||clone_has_finished)?'style=display:none':'')+" class='form-check-input custom-checkbox' type='checkbox' id="+big_sim_identifier+"_chkbox onchange=onChangeChkboxImagesetShowOutput('"+sim_imageset_job_outputs_type+"',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+sim_imageset_job_outputs_intermediate_process_imageset_id+",'"+randomColor+"',"+sim_imageset_job_outputs_raster_id_rgb+",false,'',false,null,"+sim_imageset_job_outputs_shp_mpis_id+")></input>"+
						"<span id="+big_sim_identifier+"_raster_id style='display:none'>"+sim_imageset_job_outputs_raster_id_rgb+"</span>"+
						(sim_imageset_job_outputs_thr_id!=null?" <span id="+big_sim_identifier+"_threshold"+sim_imageset_job_outputs_thr_id+" style='display:none'></span>":"")
				}
				else {
					sim_imageset_job_outputs_raster_id = sim_imageset_job_outputs_jo['raster_id']
					/*if (sim_imageset_job_outputs_type.indexOf('threshold')>-1 && sim_imageset_job_outputs_jo_threshold_state != null){
						thr_has_finished = (sim_imageset_job_outputs_jo_threshold_state == 'not-applicable' || sim_imageset_job_outputs_jo_threshold_state == 'finished')
						thr_has_failed = (sim_imageset_job_outputs_jo_threshold_state == 'error-calculating-threshold')
						appendProcImageSet += 
							"<input "+(!(thr_has_failed||thr_has_finished)?'style=display:none':'')+" class='form-check-input custom-checkbox' type='checkbox' id="+big_sim_identifier+"_chkbox onchange=onChangeChkboxImagesetShowOutput('"+sim_imageset_job_outputs_type+"',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+sim_imageset_job_outputs_intermediate_process_imageset_id+",null,"+sim_imageset_job_outputs_raster_id+","+sim_imageset_job_outputs_is_climatology+")></input>"+
							"<span id="+big_sim_identifier+"_raster_id style='display:none'>"+sim_imageset_job_outputs_raster_id+"</span>"+
							(sim_imageset_job_outputs_thr_id!=null?" <span id="+big_sim_identifier+"_threshold"+sim_imageset_job_outputs_thr_id+" style='display:none'></span>":"")
					}
					else{*/
						appendProcImageSet += 
							"<input class='form-check-input custom-checkbox' type='checkbox' id="+big_sim_identifier+"_chkbox onchange=onChangeChkboxImagesetShowOutput('"+sim_imageset_job_outputs_type+"',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+sim_imageset_job_outputs_intermediate_process_imageset_id+",null,"+sim_imageset_job_outputs_raster_id+","+sim_imageset_job_outputs_is_climatology+")></input>"+
							"<span id="+big_sim_identifier+"_raster_id style='display:none'>"+sim_imageset_job_outputs_raster_id+"</span>"+
							(sim_imageset_job_outputs_thr_id!=null?" <span id="+big_sim_identifier+"_threshold"+sim_imageset_job_outputs_thr_id+" style='display:none'></span>":"")
					//}
				
				}
				
				if (sim_imageset_job_outputs_name.indexOf('Coastline')>-1 || sim_imageset_job_outputs_name.indexOf('Waterbody')>-1){
					//...
				}
				else{
					{% if request.path == home_waterleak %}
					//do not show thresholds
					{% else %}
					if(sim_imageset_job_outputs_jo['threshold']!=null){
						if (sim_imageset_job_outputs_jo['isCustomThreshold']!== undefined) {
							if (sim_imageset_job_outputs_jo['isCustomThreshold']){
								sim_imageset_job_outputs_name += ' ('+sim_imageset_job_outputs_jo['threshold_name']+': '+parseFloat(sim_imageset_job_outputs_jo['threshold']).toFixed(3)+')'								
							}
						}
					}
					{% endif %}
				}
				appendProcImageSet += "</td>"

				if (sim_imageset_job_outputs_type.indexOf('coastline')>-1 || sim_imageset_job_outputs_type.indexOf('waterbody')>-1){
					clone_has_finished = (sim_imageset_job_outputs_shp_state == 'not-applicable' || sim_imageset_job_outputs_shp_state == 'finished')
					clone_has_failed = (sim_imageset_job_outputs_shp_state == 'error-cloning')										
					appendProcImageSet += "<th>"
					appendProcImageSet +=
						"<p style='display:inline' id="+big_sim_identifier+"_name>"+sim_imageset_job_outputs_name+"</p>"+
						"<svg style='"+(!clone_has_finished?'display:none;':'')+"margin-left:10px' id="+big_sim_identifier+"_svg width=25 height=16 viewBox='0 0 25 8' xmlns='http://www.w3.org/2000/svg'>"+
							"<polygon points='0,0 0,8 25,8 25,0' fill='"+randomColor+"'>"+
						"</svg>"
					if (sim_imageset_job_outputs_name.indexOf('Coastline')>-1 || sim_imageset_job_outputs_name.indexOf('Waterbody')>-1){
						appendProcImageSet += "<a "+(!clone_has_finished?'style=display:none':'')+" id="+big_sim_identifier+"_clone_btn class='clickCoastalLineCreate' onclick=onClickCoastalLineButton('create_cleanup','"+sim_imageset_job_outputs_type+"',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+sim_imageset_job_outputs_intermediate_process_imageset_id+",'"+randomColor+"',"+sim_imageset_job_outputs_raster_id_rgb+","+sim_imageset_job_outputs_shp_mpis_id+")><img height='24px' src='/static/images/edit_leak.svg' title='Create shapeline cleanup' style='margin:3px'></a>"
						appendProcImageSet += (shplineSourceType=='cloning_and_cleaning' ? "<a "+(clone_has_finished||clone_has_failed?'':'style=display:none')+" id="+big_sim_identifier+"_delete_btn class='clickCoastalLineDelete' onclick=onClickCoastalLineButton('delete_cleanup','"+sim_imageset_job_outputs_type+"',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+sim_imageset_job_outputs_intermediate_process_imageset_id+",'"+randomColor+"',"+sim_imageset_job_outputs_raster_id_rgb+","+sim_imageset_job_outputs_shp_mpis_id+")><img height='24px' src='/static/images/delete.svg' title='Delete cleaned up shapeline' style='margin:3px'></a>" : "")
						appendProcImageSet += (shplineSourceType=='cloning_and_cleaning' ? "<a "+(clone_has_finished?'':'style=display:none')+" id="+big_sim_identifier+"_download_btn href='/portal/rois/"+sim_aos_id+"/simulations/"+sim_id+"/intermediate/"+(sim_imageset_name.indexOf('Climatology')>-1? 'averageprocessimageset':'processimageset')+"/"+sim_imageset_job_outputs_intermediate_process_imageset_id+"/coastline/"+sim_imageset_job_outputs_shp_mpis_id+"/download_cleanup'><img height=24px src='/static/images/download.svg' title='Download cleaned up shapeline'/></a>" : "")
						appendProcImageSet += "<br><div style='"+(clone_has_finished?'':'display:none;')+"' id="+big_sim_identifier+"_rgb_div><input style='margin-left:15px' class='form-check-input custom-checkbox' type='checkbox' id="+big_sim_identifier+"_rgb_chkbox onchange=onChangeChkboxImagesetShowRGBOutput('"+sim_imageset_job_outputs_type+"',"+sim_imageset_job_outputs_roi_id+","+sim_imageset_job_outputs_sim_id+","+sim_imageset_job_outputs_intermediate_process_imageset_id+","+sim_imageset_job_outputs_shp_mpis_id+") checked disabled></input>Show RGB</div>"
					}		
					appendProcImageSet += "</th>"
				}
				else{
					appendProcImageSet += "<th><p style='display:inline' id="+big_sim_identifier0+"_name>"+sim_imageset_job_outputs_name+"</p>"
					
					appendProcImageSet += "</th>"
				}
				appendProcImageSet += "</tr>"	
				return appendProcImageSet
			}
		}
		
	}

	//
	function onClickCoastalLineAllSimulationButton(type, roi_id, simulation_id){
		COASTLINE_REFERENCES = $("tr[id*='simulation_"+simulation_id+"'][id*='_coastline_']").sort(function(a, b) {
			var compA = a.getAttribute('id').toUpperCase();
			var compB = b.getAttribute('id').toUpperCase();
			return (compA < compB) ? -1 : (compA > compB) ? 1 : 0;
		});
		CLONE_COASTLINE_REFERENCE = (COASTLINE_REFERENCES.length==0? null : COASTLINE_REFERENCES[0].id)
		ccr_split = CLONE_COASTLINE_REFERENCE.split('_')
		simulation_imageset_id = ccr_split[3]
		kind = ccr_split[4]+'_'+ccr_split[5]
		shp_mpis_id = ccr_split[6]
		raster_id = $('#'+CLONE_COASTLINE_REFERENCE+'_raster_id').text()//null
		//CLONE_COASTLINE_REFERENCE = '#simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_'+kind+'_'+shp_mpis_id
		LAYER_NAME = 'output-roi_'+roi_id+'-simulation'+simulation_id+'-imageset'+simulation_imageset_id+'-'+kind+'-'+shp_mpis_id
		console.log(CLONE_COASTLINE_REFERENCE)
		
		if (type == 'create_cleanup'){			
			if(CREATE_CLEANUP_COASTLINE_MODE){
				disableCreateCleanupCoastline()				
				$('#new-info-edit-leak-points #new-info-edit-leak-points-active-text').empty()
				$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn').empty()
				coastlinePolygonsDisable()
				if(CLONE_COASTLINE_REFERENCE!= null){
					isCoastlineLayerChecked=$('#'+CLONE_COASTLINE_REFERENCE+'_chkbox').prop('checked')
					setTimeout(function(){	
						if(isCoastlineLayerChecked){
							onChangeChkboxImagesetShowOutput(kind, roi_id, simulation_id, simulation_imageset_id, randomColor, raster_id, shp_mpis_id)
						}
					}, 300)
					CLONE_COASTLINE_REFERENCE = null
				}
			}
			else{				
				disableEyedropperClickMode()
				disableMeasureMode()
				enableCreateCleanupCoastline()
				shapeline_sim_name = $('#simulation_'+simulation_id+'_name').text()
				$('#new-info-edit-leak-points #new-info-edit-leak-points-active-text').append(
					"<b>Shapeline cleanup</b><br>"+
					"<b style='font-size:10pt'>"+shapeline_sim_name+"</b><br>"+
					"Instructions: Draw areas on the map that you want to cleanup the <b>ORIGINAL</b> shapelines from <b>ALL</b> processed images, by using polygons. "+
					"<b>The polygon defines the area you want to PRESERVE, outside of it will be REMOVED. </b>"+
					"You can draw, edit or delete them by using the polygon tools below. "+
					"To finish, click on 'Generate', and give a name to your new shapeline. </br>"+
					"To leave, click on 'Go to Visualization'.<br>"+
					"<b>ATTENTION: Doing that will REPLACE the existing cleaned up shapelines from all images. </b>"+
					"<b>NOTE: Since it's not feasible to show all shapelines, only one is shown here, as a guide.</b>"
				)
				$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn').append(
					"<a onclick=onClickCoastalLineAllSimulationButton('"+type+"',"+roi_id+","+simulation_id+") class='btn btn-sm btn-primary'>Go to Visualization</a>"+
					"<div class='well well-sm' style='display:inline;border-color:#337ab7 !important;margin-left:20px;'>"+
						"<p style='display:inline;margin-right:10px'>Polygon tools:</p>"+
						"<img title='Draw' height='32px' id=cleanup_addpolygon_icon src='/static/images/cleanup_addpolygon.svg' onclick=onClickCoastalLineAllSimulationButton('add_polygon',"+roi_id+","+simulation_id+")></img>"+
						"<img title='Edit' height='32px' id=cleanup_editpolygon_icon src='/static/images/edit0.svg' onclick=onClickCoastalLineAllSimulationButton('edit_polygon',"+roi_id+","+simulation_id+")></img>"+
						"<img title='Delete' height='32px' id=cleanup_deletepolygon_icon src='/static/images/delete0.svg' onclick=onClickCoastalLineAllSimulationButton('delete_polygon',"+roi_id+","+simulation_id+")></img>"+
					"</div>"+
					"<a onclick=onClickCoastalLineAllSimulationButton('submit',"+roi_id+","+simulation_id+") class='btn btn-sm btn-primary pull-right'>Generate</a>"
				)
				
				coastlinePolygonsEnable()
			}
			
			LAYER_NAME += '-edit'
			console.log(LAYER_NAME)
			onChangeChkboxImagesetShowShapeline(CREATE_CLEANUP_COASTLINE_MODE, true, kind, roi_id, simulation_id, simulation_imageset_id, randomColor, raster_id, LAYER_NAME, shp_mpis_id)			
			
		}
		else if (type == 'add_polygon'){
			if(CREATE_CLEANUP_COASTLINE_MODE){
				if(SET_POLYGON_CLEANUP_COASTLINE_MODE == 'draw'){
					disableDrawPolygonCreateCleanupCoastline()					
				}
				else{
					enableDrawPolygonCreateCleanupCoastline()					
				}
			}
		}
		else if (type == 'edit_polygon'){
			if(CREATE_CLEANUP_COASTLINE_MODE){
				if(SET_POLYGON_CLEANUP_COASTLINE_MODE == 'edit'){
					disableEditPolygonCreateCleanupCoastline()					
				}
				else{
					enableEditPolygonCreateCleanupCoastline()					
				}
			}
		}
		else if (type == 'delete_polygon'){
			if(CREATE_CLEANUP_COASTLINE_MODE){
				if(SET_POLYGON_CLEANUP_COASTLINE_MODE == 'delete'){
					disableDeletePolygonCreateCleanupCoastline()					
				}
				else{
					enableDeletePolygonCreateCleanupCoastline()					
				}
			}
		}
		else if (type == 'submit'){
			if(CREATE_CLEANUP_COASTLINE_MODE){
				var geom = [];
				coastlinePolygonsSourceVector.forEachFeature( function(feature) { 
					geom.push(new ol.Feature(feature.getGeometry().clone().transform('EPSG:3857', 'EPSG:4326'))); 
				} );
				if (geom.length==0){
					buildDynamicModalPopup('Error', 
						'<p>Please draw at least one polygon.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
				}
				else{
					buildDynamicModalPopup('Submit cleanup', 
						'<p>Before submitting your polygons, provide a name for this cleanup.</p>'+
						'<div class="custom-form-control" style="width:100%">'+
							'<label for="newClonedShapelineSetName">Name</label>'+
							'<input class="form-control" type="text" id="newClonedShapelineSetName" style="text-align:right"></input>'+
						'</div>'+
						'<br>'+
						'<div id="newClonedShapelineSetNameMessage">'+
						'</div>', 
						[['OK', function(){ 
							$('#newClonedShapelineSetNameMessage').empty()					
							if ($('#newClonedShapelineSetName').val() == ''){
								$('#newClonedShapelineSetNameMessage').html('<p style="color:#cc0000">Error: Please provide a valid name!</p>')
							}
							else if($('#newClonedShapelineSetName').val().length < 4){
								$('#newClonedShapelineSetNameMessage').html('<p style="color:#cc0000">Error: Provided name is too small (must be at least 4 characters)!</p>')
							}
							else{
								$(this).dialog( "close" )											
								var writer = new ol.format.GeoJSON();
								var geoJsonStr = writer.writeFeatures(geom);
								var shapeline_name = $('#newClonedShapelineSetName').val()
								jsonR = {}
								jsonR['polygons'] = $.parseJSON(geoJsonStr)
								jsonR['custom_name'] = shapeline_name
								console.log(jsonR);
								//start submitting
								buildDynamicModalPopup('Loading...', 
									'<p>Generating shapeline '+shapeline_name+', please wait...</p>', 
									[], [250,220])
								_url = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/clone_cleanup_all'
								$.post(_url,  JSON.stringify(jsonR))
									.done(function(data){
										dm.dialog("close")
										var response = $.parseJSON(JSON.stringify(data));									
										if(response['alert']=='success'){
											//remove older
											rsp_shps = response['shapeline']
											for (var f=0; f<rsp_shps.length; f++){
												rsp_shp = rsp_shps[f]
												idx_type = rsp_shp['group']
												simulation_imageset_id = rsp_shp['intermediate_process_imageset_id']
												
												if (rsp_shp['rm_shapeline_group_id']!=null){
													kind = rsp_shp['type']
													rm_old_shp_mpis_id = rsp_shp['rm_shapeline_group_id']
													$('#listOfSimulations #simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_'+kind+'_'+rm_old_shp_mpis_id).remove()
												}
												$('#listOfSimulations #simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_'+idx_type+'_cleanup_binary').remove()
												$('#listOfSimulations #simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_'+idx_type+'_cleanup_binary_closing_edge_detection').remove()
												$("#listOfSimulations #simulation_"+simulation_id+"_imageset_"+simulation_imageset_id+"_wi_"+rsp_shp['group']+"_products").append(_add_simulation_product(simulation_id, simulation_imageset_id, rsp_shp))
												
											}
											
											buildDynamicModalPopup('Success', 
												'<p>Your cleanup submission '+shapeline_name+' was accepted and will be applied to all your shapelines. Now "Go to Visualization" and check the output on the product list.</p>', 
												[['OK', function(){ $(this).dialog( "close" )} ]], [350,220])

											//go back to visualization
											onClickCoastalLineAllSimulationButton('create_cleanup', roi_id, simulation_id, simulation_imageset_id) 
										}
										else{
											buildDynamicModalPopup('Error', 
												'<p>Could not generate shapeline '+shapeline_name+'. Something went wrong.</p>', 
												[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
										}
									})
									.fail(function( xhr, textStatus, errorThrown ){
										console.log( xhr, textStatus, errorThrown)
										dm.dialog("close")
										buildDynamicModalPopup('Error', 
											'<p>Could not generate shapeline '+shapeline_name+'. Something went wrong..</p>', 
											[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
									})
							}
							
							
						}],
						['Cancel', function(){
							$(this).dialog( "close" )
						}]], [350,250])
					
				}
			}
		}
	}
	//
	function onChangeThresholdValue(raster_id){
		reverseRemoveLayerEqual('threshold-test')//layer_name
		thr = $('#optThreshold-div-thr').val()
		rl_url = '/portal/proxy/intermediate/raster/algebra/{z}/{x}/{y}.png?layers=a='+raster_id+'&formula=a&colormap={"x>='+thr+'":"FFFFFF","x<'+thr+'":"000000"}'
		rl = new ol.layer.Tile({
			name: 'threshold-test',
			extent: chosenROI.getSource().getExtent(),
			source: new ol.source.XYZ({
				url: rl_url,
				opaque: false
			})
		})
		rl.setZIndex(12)
		map.addLayer(rl)
	}

	function onClickThresholdButton(type, kind, roi_id, simulation_id, simulation_imageset_id){
		CT_REFERENCE = '#simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_'+kind
		CT_WI_REFERENCE = '#simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_wi_'+kind
		//LAYER_NAME = 'output-roi_'+roi_id+'-simulation'+simulation_id+'-imageset'+simulation_imageset_id+'-'+kind
		if((['mndwi','ndwi','awei','aweish'].indexOf(kind)>-1)){
			if (type == 'create_threshold'){	
				if(CREATE_THRESHOLD_MODE){
					disableCreateThreshold()				
					$('#new-info-edit-threshold #new-info-edit-threshold-active-text').empty()
					$('#new-info-edit-threshold #new-info-edit-threshold-active-exitbtn').empty()
				}
				else{
					disableEyedropperClickMode()
					disableMeasureMode()
					enableCreateThreshold()
					buildDynamicModalPopup('Loading histogram', 
						'<p>Please wait...</p>', 
					[], [250,220])
					shapeline_sim_name = $('#simulation_'+simulation_id+'_name').text()
					shapeline_imageset_name = $('#simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_name').text()
					shapeline_prod_name = $(CT_REFERENCE+'_name').text()//.split(' (Orig. Threshold')[0]
					raster_id = $(CT_REFERENCE+'_raster_id').text()					
					$('#new-info-edit-threshold #new-info-edit-threshold-active-text').append(
						"<b>Create manual threshold</b><br>"+
						"<b style='font-size:10pt'>"+shapeline_sim_name+" > "+shapeline_imageset_name+" > "+shapeline_prod_name+"</b><br>"+
						'<table id="tablehistogram" style="width:100%;">'+
							'<tr>'+
								'<td></td>'+
							'</tr>'+
						'</table>'+
						"Instructions: Look at the histogram above and see the threshold value you want to apply. You can also click on the chart to automatically set the value. "+
						"<b>When changing the threshold value, the layer will preview the final result.</b>"+
						"To finish, click on 'Generate', and give a name to your new shapeline. </br>"+
						"To leave, click on 'Go to Visualization'. "+
						'<div class="custom-form-control" style="padding-left:10px">'+
							'<label for="optThreshold-div-thr">Threshold</label>'+
							'<input class="form-control" type="number" id="optThreshold-div-thr" style="text-align:right" oninput=onChangeThresholdValue('+raster_id+') onchange=onChangeThresholdValue('+raster_id+') value=0 min=-1 max=1 step=0.001 onkeypress="return isNumericKey(event)">'+
						'</div>'
					)
					$('#new-info-edit-threshold #new-info-edit-threshold-active-exitbtn').append(
						"<a onclick=onClickThresholdButton('"+type+"','"+kind+"',"+roi_id+","+simulation_id+","+simulation_imageset_id+") class='btn btn-sm btn-primary'>Go to Visualization</a>"+
						"<a onclick=onClickThresholdButton('submit','"+kind+"',"+roi_id+","+simulation_id+","+simulation_imageset_id+") class='btn btn-sm btn-primary pull-right'>Generate</a>"
					)

					_url = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/processimageset/'+simulation_imageset_id+'/'+kind+'/'+raster_id+'/show_histogram'
					$.get(_url)
						.done(function( data ) {
							var answer = $.parseJSON(JSON.stringify(data)); 
							if(answer['alert']=='success'){
								thr_val = $(CT_WI_REFERENCE+'_thrval').text().replace(' (','').replace('Auto ','').replace('Threshold: ','').replace(')','')
								//console.log(answer)
								dm.dialog( "close" );
								tdata = answer['response']
								console.log('----deploy chart-----')
								hchart = addHistogramChart('histogram', tdata, 'Value', 'Quantity')
								//hchart.showLoading('Loading, please wait...');		
								//unpack data
								console.log('----add data to chart-----')
								$('#optThreshold-div-thr').val(thr_val)
								onChangeThresholdValue(raster_id)			
							}
							else{
								//console.log(answer)
								dm.dialog( "close" );
								buildDynamicModalPopup('Error', 
									'<p>Something went wrong while loading histogram. Try again.</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							}
						})
						.fail(function( xhr, textStatus, errorThrown ){
							console.log( xhr, textStatus, errorThrown)
						})
				}
			}
			else if (type == 'submit'){
				if(CREATE_THRESHOLD_MODE){
					//$('#optThreshold #submitBtn').click(function(){
					thr = $('#optThreshold-div-thr').val()
					if (thr<-1 && thr > 1){
						buildDynamicModalPopup('Error', 
							'<p>Value is not under -1 and 1 range.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else if ((thr<0 && thr.length > 6) || (thr>=0 && thr.length > 5)){
						buildDynamicModalPopup('Error', 
							'<p>Value must have two decimals</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else{
						buildDynamicModalPopup('Submit threshold', 
							'<p>Before submitting your threshold, provide a name for it.</p>'+
							'<div class="custom-form-control" style="width:100%">'+
								'<label for="newCreatedThresholdSetName">Name</label>'+
								'<input class="form-control" type="text" id="newCreatedThresholdSetName" style="text-align:right"></input>'+
							'</div>'+
							'<br>'+
							'<div id="newCreatedThresholdSetNameMessage">'+
							'</div>', 
							[['OK', function(){ 
								$('#newCreatedThresholdSetNameMessage').empty()					
								if ($('#newCreatedThresholdSetName').val() == ''){
									$('#newCreatedThresholdSetNameMessage').html('<p style="color:#cc0000">Error: Please provide a valid name!</p>')
								}
								else if($('#newCreatedThresholdSetName').val().length < 4){
									$('#newCreatedThresholdSetNameMessage').html('<p style="color:#cc0000">Error: Provided name is too small (must be at least 4 characters)!</p>')
								}
								else{
									$(this).dialog( "close" )											
									var thr_name = $('#newCreatedThresholdSetName').val()
									jsonR = {}
									jsonR['threshold_value'] = $('#optThreshold-div-thr').val()
									jsonR['custom_name'] = thr_name
									console.log(jsonR);
									//start submitting
									buildDynamicModalPopup('Loading...', 
										'<p>Generating threshold '+thr_name+', please wait...</p>', 
										[], [250,220])
									_url = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/processimageset/'+simulation_imageset_id+'/'+kind+'/create_threshold'
									$.post(_url,  JSON.stringify(jsonR))
										.done(function(data){
											dm.dialog("close")
											var response = $.parseJSON(JSON.stringify(data));									
											if(response['alert']=='success'){
												//remove older
												rsp_shps = response['image']
												rm_old_created_threshold_id = response['rm_created_threshold_id']
												threshold_states = response['threshold_states']
												for (var f=0; f<rsp_shps.length; f++){
													rsp_shp = rsp_shps[f]
													//idx_type = rsp_shp['group']
													if (rm_old_created_threshold_id!=null){
														//list spans associated to that threshold_id
														list_span_threshold_products = $("span[id*='simulation_"+simulation_id+"'][id*='_threshold"+rm_old_created_threshold_id+"']")
														for (var v=0; v<list_span_threshold_products.length; v++){
															id_product_remove = list_span_threshold_products[v].id.replace('_threshold'+rm_old_created_threshold_id, '')
															console.log('remove '+id_product_remove)
															$('#listOfSimulations #'+id_product_remove).remove()
														}
													}													
													$("#listOfSimulations #simulation_"+simulation_id+"_imageset_"+simulation_imageset_id+"_wi_"+rsp_shp['group']+"_products").append(_add_simulation_product(simulation_id, simulation_imageset_id, rsp_shp))
												}

												changeThresholdBtnByState(simulation_id, 'imageset', simulation_imageset_id, threshold_states)
												
												buildDynamicModalPopup('Success', 
													'<p>Your threshold submission was accepted and will be applied to this image. Now "Go to Visualization" and check the output on the product list.</p>', 
													[['OK', function(){ $(this).dialog( "close" )} ]], [350,220])

												//go back to visualization
												onClickThresholdButton('create_threshold', kind, roi_id, simulation_id, simulation_imageset_id) 
											}
											else{
												buildDynamicModalPopup('Error', 
													'<p>Could not create threshold '+thr_name+'. Something went wrong.</p>', 
													[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
											}
										})
										.fail(function( xhr, textStatus, errorThrown ){
											console.log( xhr, textStatus, errorThrown)
											dm.dialog("close")
											buildDynamicModalPopup('Error', 
												'<p>Could not create threshold '+thr_name+'. Something went wrong..</p>', 
												[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
										})
								}
								
								
							}],
							['Cancel', function(){
								$(this).dialog( "close" )
							}]], [350,250])



						//go back to visualization
						
					}
					//})
				}	
			}
		}
	}

	function onClickCoastalLineButton(type, kind, roi_id, simulation_id, simulation_imageset_id, randomColor=null, raster_id=null, shp_mpis_id){
		CLONE_COASTLINE_REFERENCE = '#simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_'+kind+'_'+shp_mpis_id
		LAYER_NAME = 'output-roi_'+roi_id+'-simulation'+simulation_id+'-imageset'+simulation_imageset_id+'-'+kind+'-'+shp_mpis_id
		console.log(CLONE_COASTLINE_REFERENCE)
		if((kind.indexOf('coastline')>-1 || kind.indexOf('waterbody')>-1)){
			if (type == 'create_cleanup'){			
				if(CREATE_CLEANUP_COASTLINE_MODE){
					disableCreateCleanupCoastline()				
					$('#new-info-edit-leak-points #new-info-edit-leak-points-active-text').empty()
					$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn').empty()
					coastlinePolygonsDisable()
					isCoastlineLayerChecked=$(CLONE_COASTLINE_REFERENCE+'_chkbox').prop('checked')
					setTimeout(function(){	
						if(isCoastlineLayerChecked){
							onChangeChkboxImagesetShowOutput(kind, roi_id, simulation_id, simulation_imageset_id, randomColor, raster_id, shp_mpis_id)
						}
					}, 300)
					CLONE_COASTLINE_REFERENCE = null
				}
				else{				
					disableEyedropperClickMode()
					disableMeasureMode()
					enableCreateCleanupCoastline()
					shapeline_sim_name = $('#simulation_'+simulation_id+'_name').text()
					shapeline_imageset_name = $('#simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_name').text()
					shapeline_prod_name = $(CLONE_COASTLINE_REFERENCE+'_name').text()
					$('#new-info-edit-leak-points #new-info-edit-leak-points-active-text').append(
						"<b>Shapeline cleanup</b><br>"+
						"<b style='font-size:10pt'>"+shapeline_sim_name+" > "+shapeline_imageset_name+" > "+shapeline_prod_name+"</b><br>"+
						"Instructions: Draw areas on the map that you want to cleanup the shapeline, by using polygons."+
						"<b>ATTENTION: The polygon defines the area you want to REMOVE, outside of it will be PRESERVED.</b>"+
						"You can draw, edit or delete them by using the polygon tools below. "+
						"To finish, click on 'Generate', and give a name to your new shapeline. </br>"+
						"To leave, click on 'Go to Visualization'. "+
						"<b>ATTENTION: Doing that will REPLACE the existing cleaned up shapeline.</b>"
					)
					$('#new-info-edit-leak-points #new-info-edit-leak-points-active-exitbtn').append(
						"<a onclick=onClickCoastalLineButton('"+type+"','"+kind+"',"+roi_id+","+simulation_id+","+simulation_imageset_id+",'"+randomColor+"',"+raster_id+","+shp_mpis_id+") class='btn btn-sm btn-primary'>Go to Visualization</a>"+
						"<div class='well well-sm' style='display:inline;border-color:#337ab7 !important;margin-left:20px;'>"+
							"<p style='display:inline;margin-right:10px'>Polygon tools:</p>"+
							"<img title='Draw' height='32px' id=cleanup_addpolygon_icon src='/static/images/cleanup_addpolygon.svg' onclick=onClickCoastalLineButton('add_polygon','"+kind+"',"+roi_id+","+simulation_id+","+simulation_imageset_id+",'"+randomColor+"',"+raster_id+","+shp_mpis_id+")></img>"+
							"<img title='Edit' height='32px' id=cleanup_editpolygon_icon src='/static/images/edit0.svg' onclick=onClickCoastalLineButton('edit_polygon','"+kind+"',"+roi_id+","+simulation_id+","+simulation_imageset_id+",'"+randomColor+"',"+raster_id+","+shp_mpis_id+")></img>"+
							"<img title='Delete' height='32px' id=cleanup_deletepolygon_icon src='/static/images/delete0.svg' onclick=onClickCoastalLineButton('delete_polygon','"+kind+"',"+roi_id+","+simulation_id+","+simulation_imageset_id+",'"+randomColor+"',"+raster_id+","+shp_mpis_id+")></img>"+
						"</div>"+
						"<a onclick=onClickCoastalLineButton('submit','"+kind+"',"+roi_id+","+simulation_id+","+simulation_imageset_id+",'"+randomColor+"',"+raster_id+","+shp_mpis_id+") class='btn btn-sm btn-primary pull-right'>Generate</a>"
					)
					
					coastlinePolygonsEnable()
				}
				LAYER_NAME += '-edit'
				console.log(LAYER_NAME)				
				onChangeChkboxImagesetShowShapeline(CREATE_CLEANUP_COASTLINE_MODE, true, kind, roi_id, simulation_id, simulation_imageset_id, randomColor, raster_id, LAYER_NAME, shp_mpis_id)
			}
			else if (type == 'delete_cleanup'){
				shapeline_prod_name = $(CLONE_COASTLINE_REFERENCE+'_name').text()
				buildDynamicModalPopup('Delete cleanup', 
				'<p>You are about to delete '+shapeline_prod_name+'. This operation is not reversible! Continue anyway?</p>', 
				[['Yes', function(){ 
					$(this).dialog( "close" )						
					//start deleting
					buildDynamicModalPopup('Loading...', 
						'<p>Deleting '+shapeline_prod_name+', please wait...</p>', 
						[], [250,220])
					_url = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/processimageset/'+simulation_imageset_id+'/coastline/'+shp_mpis_id+'/delete_cleanup'
					$.ajax({ type: "GET", url: _url, async: true,
						success : function(data){
							dm.dialog("close")
							var response = $.parseJSON(JSON.stringify(data));									
							if(response['alert']=='success'){
								idx_type = response['indexType']
								$('#listOfSimulations #simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_'+kind+'_'+shp_mpis_id).remove()
								$('#listOfSimulations #simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_'+idx_type+'_cleanup_binary').remove()
								$('#listOfSimulations #simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_'+idx_type+'_cleanup_binary_closing_edge_detection').remove()
								buildDynamicModalPopup('Success', 
									'<p>Your coastline '+shapeline_prod_name+' was deleted!</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							}
							else{
								buildDynamicModalPopup('Error', 
									'<p>Could not delete '+shapeline_prod_name+'. Something went wrong!</p>', 
									[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
							}
						},
						error: function( xhr, textStatus, errorThrown ){
							console.log( xhr, textStatus, errorThrown)
							dm.dialog("close")
							buildDynamicModalPopup('Error', 
								'<p>Could not delete '+shapeline_prod_name+'. Something went wrong!</p>', 
								[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
						}
					});
				}],
				['No', function(){
					$(this).dialog( "close" )
				}]], [350,250])
			}
			else if (type == 'add_polygon'){
				if(CREATE_CLEANUP_COASTLINE_MODE){
					if(SET_POLYGON_CLEANUP_COASTLINE_MODE == 'draw'){
						disableDrawPolygonCreateCleanupCoastline()					
					}
					else{
						enableDrawPolygonCreateCleanupCoastline()					
					}
				}
			}
			else if (type == 'edit_polygon'){
				if(CREATE_CLEANUP_COASTLINE_MODE){
					if(SET_POLYGON_CLEANUP_COASTLINE_MODE == 'edit'){
						disableEditPolygonCreateCleanupCoastline()					
					}
					else{
						enableEditPolygonCreateCleanupCoastline()					
					}
				}
			}
			else if (type == 'delete_polygon'){
				if(CREATE_CLEANUP_COASTLINE_MODE){
					if(SET_POLYGON_CLEANUP_COASTLINE_MODE == 'delete'){
						disableDeletePolygonCreateCleanupCoastline()					
					}
					else{
						enableDeletePolygonCreateCleanupCoastline()					
					}
				}
			}
			else if (type == 'submit'){
				if(CREATE_CLEANUP_COASTLINE_MODE){
					var geom = [];
					coastlinePolygonsSourceVector.forEachFeature( function(feature) { 
						geom.push(new ol.Feature(feature.getGeometry().clone().transform('EPSG:3857', 'EPSG:4326'))); 
					} );
					if (geom.length==0){
						buildDynamicModalPopup('Error', 
							'<p>Please draw at least one polygon.</p>', 
							[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
					}
					else{
						buildDynamicModalPopup('Submit cleanup', 
							'<p>Before submitting your polygons, provide a name for this cleanup.</p>'+
							'<div class="custom-form-control" style="width:100%">'+
								'<label for="newClonedShapelineSetName">Name</label>'+
								'<input class="form-control" type="text" id="newClonedShapelineSetName" style="text-align:right"></input>'+
							'</div>'+
							'<br>'+
							'<div id="newClonedShapelineSetNameMessage">'+
							'</div>', 
							[['OK', function(){ 
								$('#newClonedShapelineSetNameMessage').empty()					
								if ($('#newClonedShapelineSetName').val() == ''){
									$('#newClonedShapelineSetNameMessage').html('<p style="color:#cc0000">Error: Please provide a valid name!</p>')
								}
								else if($('#newClonedShapelineSetName').val().length < 4){
									$('#newClonedShapelineSetNameMessage').html('<p style="color:#cc0000">Error: Provided name is too small (must be at least 4 characters)!</p>')
								}
								else{
									$(this).dialog( "close" )											
									var writer = new ol.format.GeoJSON();
									var geoJsonStr = writer.writeFeatures(geom);
									var shapeline_name = $('#newClonedShapelineSetName').val()
									jsonR = {}
									jsonR['polygons'] = $.parseJSON(geoJsonStr)
									jsonR['custom_name'] = shapeline_name
									console.log(jsonR);
									//start submitting
									buildDynamicModalPopup('Loading...', 
										'<p>Generating shapeline '+shapeline_name+', please wait...</p>', 
										[], [250,220])
									_url = '/portal/rois/'+roi_id+'/simulations/'+simulation_id+'/intermediate/processimageset/'+simulation_imageset_id+'/coastline/'+shp_mpis_id+'/clone_cleanup'
									$.post(_url,  JSON.stringify(jsonR))
										.done(function(data){
											dm.dialog("close")
											var response = $.parseJSON(JSON.stringify(data));									
											if(response['alert']=='success'){
												//remove older
												rsp_shps = response['shapeline']
												for (var f=0; f<rsp_shps.length; f++){
													rsp_shp = rsp_shps[f]
													idx_type = rsp_shp['group']
													if (rsp_shp['rm_shapeline_group_id']!=null){
														rm_old_shp_mpis_id = rsp_shp['rm_shapeline_group_id']
														$('#listOfSimulations #simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_'+idx_type+'_coastline_'+rm_old_shp_mpis_id).remove()
													}
													$('#listOfSimulations #simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_'+idx_type+'_cleanup_binary').remove()
													$('#listOfSimulations #simulation_'+simulation_id+'_imageset_'+simulation_imageset_id+'_'+idx_type+'_cleanup_binary_closing_edge_detection').remove()
													
													$("#listOfSimulations #simulation_"+simulation_id+"_imageset_"+simulation_imageset_id+"_wi_"+idx_type+"_products").append(_add_simulation_product(simulation_id, simulation_imageset_id, rsp_shp))
												}
												
												buildDynamicModalPopup('Success', 
													'<p>Your shapeline '+shapeline_name+' was generated successfully. Now "Go to Visualization" and check the output on the product list.</p>', 
													[['OK', function(){ $(this).dialog( "close" )} ]], [350,220])

												//go back to visualization
												onClickCoastalLineButton('create_cleanup', kind, roi_id, simulation_id, simulation_imageset_id, randomColor, raster_id, shp_mpis_id) 
											}
											else{
												buildDynamicModalPopup('Error', 
													'<p>Could not generate shapeline '+shapeline_name+'. Something went wrong.</p>', 
													[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
											}
										})
										.fail(function( xhr, textStatus, errorThrown ){
											console.log( xhr, textStatus, errorThrown)
											dm.dialog("close")
											buildDynamicModalPopup('Error', 
												'<p>Could not generate shapeline '+shapeline_name+'. Something went wrong..</p>', 
												[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
										})
								}
								
								
							}],
							['Cancel', function(){
								$(this).dialog( "close" )
							}]], [350,250])
						
					}
				}
			}
		}
	}

	function showRightPanelOptions(){
		//console.log('showRightPanelOptions('+RIGHT_PANEL_MODE+')')
		if(RIGHT_PANEL_MODE == 'SHOW_USER_REPOSITORY'){	
			$('#rightPanelTitle #title').text('User Repository')
		}
		/*else if(RIGHT_PANEL_MODE == 'SHOW_DETECTION_MANAGER'){	
			$('#rightPanelTitle #title').text('Detection Manager')
			$('#rightPanelContent #showVisualizationAndDetectionManager #listOfSimulationsText').text('Select only the detection you want to manage.')	
		}*/
		else if (RIGHT_PANEL_MODE == 'SHOW_VISUALIZATION'){
			$('#rightPanelTitle #title').text('Visualization')
			$('#rightPanelContent #showVisualizationAndDetectionManager #listOfSimulationsText').text('Click on the arrow on the left of each simulation to see a list of processed products to choose for visualization. On shared simulations, you are only able to view/download the products.')
		}
		else if (RIGHT_PANEL_MODE == 'SHOW_LEAK_DETECTIONS'){
			$('#rightPanelTitle #title').text('Leak Detections')
			$('#rightPanelContent #showVisualizationAndDetectionManager #listOfSimulationsText').text('Click on the arrow on the left of each simulation to see a list of leak detections for visualization. On shared simulations, you are only able to view/download the products.')
		}
		$('#rightPanelContent #showVisualizationAndDetectionManager #accordion2 #listOfSimulations .trsimulation').each(function(){
			if(RIGHT_PANEL_MODE == 'SHOW_USER_REPOSITORY'){	
				$('#'+this.id+'_imagesets_ocbtn').hide()
				$('#'+this.id+'_imagesets_td').hide()
				$('#'+this.id+'_btns').show()
			}
			/*else if(RIGHT_PANEL_MODE == 'SHOW_DETECTION_MANAGER'){	
				$('#'+this.id+'_imagesets_ocbtn').hide()
				$('#'+this.id+'_imagesets_td').hide()
				$('#'+this.id+'_btns').show()
			}*/
			else if (RIGHT_PANEL_MODE == 'SHOW_VISUALIZATION' || RIGHT_PANEL_MODE == 'SHOW_LEAK_DETECTIONS'){
				$('#'+this.id+'_imagesets_ocbtn').show()
				$(' #'+this.id+'_imagesets_td').show()
				$('#'+this.id+'_btns').show()
			}

		})
	}

	function getListOfSimulations(){		
		console.log('getListOfSimulations(showVisualizationAndDetectionManager)')
		_clear_interval_list_simulations()
		_clear_interval_list_user_repository_files()
		_cleanup_shown_outputs_layers()
		listActiveLayers()
		resetSelectedROI()

		$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations').empty()
		$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedGeometries tbody').empty()
		$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedMasks tbody').empty()
		$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedLeakPoints tbody').empty()
		
		showWhat=null
		if(RIGHT_PANEL_MODE == 'SHOW_LEAK_DETECTIONS'){
			showWhat='showLeakDetections'
		}
		console.log('showWhat='+showWhat)

		opt_roi_checked = $('#showVisualizationAndDetectionManager #accordion1 #listOfROI input[name="optROIshowVisualizationAndDetectionManager"]:checked').prop('id')
		if (opt_roi_checked !== undefined){
			if(RIGHT_PANEL_MODE == 'SHOW_VISUALIZATION' || RIGHT_PANEL_MODE == 'SHOW_LEAK_DETECTIONS'){ highlightSelectedROI4(opt_roi_checked) }
			else{ highlightSelectedROI3(opt_roi_checked) }		
			buildDynamicModalPopup('Loading list...', 
				'<p>Searching available simulations for that RoI. Please wait...</p>', 
				[], [250,220])

			//
			map.getLayers().forEach(function(el) {
				if (el.get('name') !== undefined){ 
					if(el.get('name').indexOf('preview_pipe')>-1){
						el.setVisible(true)
						el.getStyle().setStroke(new ol.style.Stroke({ 
							color: el.getStyle().getStroke().getColor(), width: 2 }) )
						el.changed()		    
					}
				}
			})
			//
			roi_id = opt_roi_checked.split('_')[1]
			_url = '/portal/rois/'+roi_id+'/simulations'+(showWhat=='showLeakDetections'?"?showWhat=showLeakDetections":"")
			$.ajax({ type: "GET", url: _url, async: true,
				success : function(response){
					dm.dialog("close")		     	
					jsonResponse = response //$.parseJSON(JSON.stringify(response));
					if (jsonResponse.length==0){
						$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations').empty()
						/*if ($('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #err').length==0){
							$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations').append("<tr id='err'><th>No simulations available for that RoI</th></tr>")
						}*/
						$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedGeometries tbody').empty()
						$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedMasks tbody').empty()
						$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedLeakPoints tbody').empty()
					}
					else{
						//user repo
						
						_start_interval_list_simulations()		     		
					}
				},
				error: function(response){
					dm.dialog("close")
					$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations').empty()
					$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations').append("<tr id='err'><th>An error ocurred while loading list of detections.</th></tr>")
					$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedGeometries tbody').empty()
					$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedMasks tbody').empty()
					$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedLeakPoints tbody').empty()
					buildDynamicModalPopup('Error', 
						'<p>Could not load available simulations.</p>', 
						[['OK', function(){ $(this).dialog( "close" )} ]], [250,220])
			
				}
			});
		}
	}

	function updateListOfUserRepositoryFiles(){
		_url = '/portal/proxy/intermediate/user_repository/'+SERVICE_NAME+'/show'
		$.ajax({ type: "GET", url: _url, async: true,
		     success : function(response){
				listOfURF = $.parseJSON(JSON.stringify(response));
				user_id = listOfURF['user_id']
				if (listOfURF['geometries'] !== undefined){
					listOfURFGeom = listOfURF['geometries']
					for (var s in listOfURFGeom){
						gid = listOfURFGeom[s]['id']
						gname = listOfURFGeom[s]['name']
						gstate = listOfURFGeom[s]['state']
						gcolor = generateRandomHexColor()
						if ($('#showUserRepository #listOfUploadedGeometries #user'+user_id+'_geometry'+gid).length==0){
							tr='<tr id=user'+user_id+'_geometry'+gid+'>'+//onChangeChkboxImagesetShowOutput('ndwi',135,130,445,null,1612,false)
									'<td style="white-space: nowrap;width:30px; height:30px">'+
										"<input class='form-check-input custom-checkbox' type='checkbox' id='user"+user_id+"_geometry"+gid+"_chkbox' onchange=onChangeChkboxUserRepositoryShowOutputB('geometry',"+user_id+","+gid+",'"+gcolor+"',null)>"+
									'</td>'+
									'<th style="white-space: nowrap; text-overflow:ellipsis; overflow: hidden; max-width:1px;" id=user'+user_id+'_geometry'+gid+'_name>'+gname+'</th>'+
									'<td><svg id=user'+user_id+"_geometry"+gid+'_linecolor style="margin-left:10px;margin-top:6px" width="25" height="16" viewBox="0 0 25 8" xmlns="http://www.w3.org/2000/svg"><polygon points="0,0 0,8 25,8 25,0" fill="'+gcolor+'"></polygon></svg></td>'+
									
									"<td style='white-space: nowrap;'><a class='clickUserGeometryDelete' onclick=onClickUserRepository('delete','geometry',"+gid+") id=user"+user_id+"_geometry"+gid+"_delete_btn style='display:none'><img height='24px' src='/static/images/delete.svg' title='Delete' style='margin:3px'></a></td>"+
									'<td style="white-space: nowrap;"><img height="20px" id=user'+user_id+'_geometry'+gid+'_state src="/static/images/unknown.svg"></td>'+
								'</tr>'
							$('#showUserRepository #listOfUploadedGeometries').append(tr)
						}
						_set_color_state3('#showUserRepository #listOfUploadedGeometries #user'+user_id+'_geometry'+gid+' #user'+user_id+'_geometry'+gid+'_state', gstate)
						//show delete button if error or stored
						if (gstate.indexOf('error')>-1 || gstate.indexOf('stored')>-1){ $("#showUserRepository #listOfUploadedGeometries #user"+user_id+"_geometry"+gid+"_delete_btn").show()}
						else{$("#showUserRepository #listOfUploadedGeometries #user"+user_id+"_geometry"+gid+"_delete_btn").hide()}
					}
				}
				//masks
				if (listOfURF['masks'] !== undefined){
					listOfURFMask = listOfURF['masks']
					for (var s in listOfURFMask){
						mid = listOfURFMask[s]['id']
						mname = listOfURFMask[s]['name']
						mtypemask = listOfURFMask[s]['type_mask']
						mstate = listOfURFMask[s]['state']
						mrasterid = listOfURFMask[s]['raster_id']						
						if ($('#showUserRepository #listOfUploadedMasks #user'+user_id+'_mask'+mid).length==0){
							tr='<tr id=user'+user_id+'_mask'+mid+'>'+//onChangeChkboxImagesetShowOutput('ndwi',135,130,445,null,1612,false)
									'<td style="white-space: nowrap;width:30px; height:30px">'+
										"<input class='form-check-input custom-checkbox' type='checkbox' id='user"+user_id+"_mask"+mid+"_chkbox' onchange=onChangeChkboxUserRepositoryShowOutputB('mask',"+user_id+","+mid+",null,"+mrasterid+")>"+
									'</td>'+
									'<th style="white-space: nowrap; text-overflow:ellipsis; overflow: hidden; max-width:1px;" id=user'+user_id+'_mask'+mid+'_name>'+mname+'</th>'+
									'<td></td>'+
									"<td style='white-space: nowrap;'><a class='clickUserMaskDelete' onclick=onClickUserRepository('delete','mask',"+mid+") id=user"+user_id+"_mask"+mid+"_delete_btn style='display:none'><img height='24px' src='/static/images/delete.svg' title='Delete' style='margin:3px'></a></td>"+									
									'<td style="white-space: nowrap;"><img height="20px" id=user'+user_id+'_mask'+mid+'_state src="/static/images/unknown.svg"></td>'+
								'</tr>'
							$('#showUserRepository #listOfUploadedMasks').append(tr)
						}
						else{
							//$'user'+user_id+'_mask'+mid+'_chkbox').setAttribute('onchange',onChangeChkboxUserRepositoryShowOutput('mask',user_id,mid,null,mrasterid))
							$('#showUserRepository #listOfUploadedMasks #user'+user_id+'_mask'+mid+' #user'+user_id+'_mask'+mid+'_chkbox').attr('onchange','onChangeChkboxUserRepositoryShowOutputB("mask",'+user_id+','+mid+',null,'+mrasterid+')')
						}
						_set_color_state3('#showUserRepository #listOfUploadedMasks #user'+user_id+'_mask'+mid+' #user'+user_id+'_mask'+mid+'_state', mstate)
						//show delete button if error or stored
						if (mstate.indexOf('error')>-1 || mstate.indexOf('stored')>-1){ $("#showUserRepository #listOfUploadedMasks #user"+user_id+"_mask"+mid+"_delete_btn").show()}
						else{$("#showUserRepository #listOfUploadedMasks #user"+user_id+"_mask"+mid+"_delete_btn").hide()}
					}
				}
				//leaks
				if (listOfURF['leaks'] !== undefined){
					listOfURFLeak = listOfURF['leaks']
					for (var s in listOfURFLeak){
						lid = listOfURFLeak[s]['id']
						lname = listOfURFLeak[s]['name']
						lstate = listOfURFLeak[s]['state']
						lcolor = generateRandomHexColor()
						if ($('#showUserRepository #listOfUploadedLeakPoints #user'+user_id+'_leak'+lid).length==0){
							tr='<tr id=user'+user_id+'_leak'+lid+'>'+//onChangeChkboxImagesetShowOutput('ndwi',135,130,445,null,1612,false)
									'<td style="white-space: nowrap;width:30px; height:30px">'+
										"<input class='form-check-input custom-checkbox' type='checkbox' id='user"+user_id+"_leak"+lid+"_chkbox' onchange=onChangeChkboxUserRepositoryShowOutputB('leak',"+user_id+","+lid+",'"+lcolor+"',null)>"+
									'</td>'+
									'<th style="white-space: nowrap; text-overflow:ellipsis; overflow: hidden; max-width:1px;" id=user'+user_id+'_leak'+lid+'_name>'+lname+'</th>'+
									'<td><svg id=user'+user_id+"_leak"+lid+'_linecolor style="margin-left:10px;margin-top:6px" width="25" height="16" viewBox="0 0 25 8" xmlns="http://www.w3.org/2000/svg"><polygon points="0,0 0,8 25,8 25,0" fill="'+lcolor+'"></polygon></svg></td>'+
									"<td style='white-space: nowrap;'><a class='clickUserLeakDelete' onclick=onClickUserRepository('delete','leak',"+lid+") id=user"+user_id+"_leak"+lid+"_delete_btn style='display:none'><img height='24px' src='/static/images/delete.svg' title='Delete' style='margin:3px'></a></td>"+									
									'<td style="white-space: nowrap;"><img height="20px" id=user'+user_id+'_leak'+lid+'_state src="/static/images/unknown.svg"></td>'+
								'</tr>'
							$('#showUserRepository #listOfUploadedLeakPoints').append(tr)
						}
						_set_color_state3('#showUserRepository #listOfUploadedLeakPoints #user'+user_id+'_leak'+lid+' #user'+user_id+'_leak'+lid+'_state', lstate)
						//show delete button if error or stored
						if (lstate.indexOf('error')>-1 || lstate.indexOf('stored')>-1){ $("#showUserRepository #listOfUploadedLeakPoints #user"+user_id+"_leak"+lid+"_delete_btn").show()}
						else{$("#showUserRepository #listOfUploadedLeakPoints #user"+user_id+"_leak"+lid+"_delete_btn").hide()}
					}
				}
			 },
			 error: function(response){}
		})

	}

	function updateListOfSimulations(showWhat=null){
		console.log('updateListOfSimulations(showVisualizationAndDetectionManager)')
		console.time('updateListOfSimulations')
		opt_roi_checked = $('#showVisualizationAndDetectionManager #accordion1 #listOfROI input[name="optROIshowVisualizationAndDetectionManager"]:checked').prop('id')
		$('#listOfSimulationsStateText').empty()
		if (opt_roi_checked !== undefined){
			roi_id = opt_roi_checked.split('_')[1]
			_url = '/portal/rois/'+roi_id+'/simulations'+(showWhat=='showLeakDetections'?"?showWhat=showLeakDetections":"")
			$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #err').remove()
			$('#listOfSimulationsStateText').html('<img height=20px src="/static/images/load.gif"><i>Updating list of simulations, please wait...</i>')
			$.ajax({ type: "GET", url: _url, async: true,
				success : function(response){
					jsonResponse = response//$.parseJSON(JSON.stringify(response));
					if (jsonResponse.length==0){
						_cleanup_shown_outputs_layers()
						$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations').empty()
						$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations').append("<tr id='err'><th>No simulations available for that RoI</th></tr>")
						
						$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedGeometries tbody').empty()
						$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedMasks tbody').empty()
						$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedLeakPoints tbody').empty()
					}
					else{
						
						//simulations
						listOfSims = jsonResponse['simulations']
						
						//create a method to store a list of ids and states and compare it.
						//what changes the listing is when a simulation goes from a processing state to success state
						//if success, should not update constantly
						fetchActualJsonSimulations = {}
						for (var s in listOfSims){
							fetchActualJsonSimulations[listOfSims[s]['simulation_id']] = { 
								's': s, 'state': listOfSims[s]['state'], 
								'numTopographiesSubmitted': listOfSims[s]['numTopographies']['submitted'],
								'numTopographiesRunning': listOfSims[s]['numTopographies']['running'],
								'numTopographiesFinished': listOfSims[s]['numTopographies']['finished'],
								'numTopographiesError': listOfSims[s]['numTopographies']['error'],
								'numClonedCoastlinesSubmitted': listOfSims[s]['numClonedCoastlines']['submitted'],
								'numClonedCoastlinesRunning': listOfSims[s]['numClonedCoastlines']['running'],
								'numClonedCoastlinesFinished': listOfSims[s]['numClonedCoastlines']['finished'],
								'numClonedCoastlinesError': listOfSims[s]['numClonedCoastlines']['error'],
								'numCreatedThresholdsSubmitted': listOfSims[s]['numCreatedThresholds']['submitted'],
								'numCreatedThresholdsRunning': listOfSims[s]['numCreatedThresholds']['running'],
								'numCreatedThresholdsFinished': listOfSims[s]['numCreatedThresholds']['finished'],
								'numCreatedThresholdsError': listOfSims[s]['numCreatedThresholds']['error'],
							}
						}
						//check if a simulation on actual list was removed
						fetchLastKeys = Object.keys(fetchLastJsonSimulations)
						for (var k in fetchLastKeys){
							fA = fetchLastKeys[k]
							s = fetchLastJsonSimulations[fA]['s']	
							if (fetchActualJsonSimulations[fA] === undefined){//if does not exist now, remove it
								$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations #simulation_'+fA).remove()
								if ($('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations .trsimulation').length==0){
									$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations').append("<tr id='err'><th>No simulations available for that RoI</th></tr>")
									
									reverseRemoveLayerIndexOf('simulation'+fA)//remove any active layers
									listActiveLayers()
								}
							}
						}
						//compare states
						if (Object.keys(fetchLastJsonSimulations).length>0){
							fetchActualKeys = Object.keys(fetchActualJsonSimulations)
							for (var k in fetchActualKeys){
								fA = fetchActualKeys[k]
								s = fetchActualJsonSimulations[fA]['s']	
								sim_id = listOfSims[s]['simulation_id']
								sim_roi_id = listOfSims[s]['aos_id']
								
								if (fetchLastJsonSimulations[fA] !== undefined){//if didnt exist before, add it
									has_simulation_changed_state = (fetchActualJsonSimulations[fA]['state'] != fetchLastJsonSimulations[fA]['state'])
									has_topographies_changed_state = (fetchActualJsonSimulations[fA]['numTopographiesSubmitted'] != fetchLastJsonSimulations[fA]['numTopographiesSubmitted'] ||
										fetchActualJsonSimulations[fA]['numTopographiesRunning'] != fetchLastJsonSimulations[fA]['numTopographiesRunning'] ||
										fetchActualJsonSimulations[fA]['numTopographiesFinished'] != fetchLastJsonSimulations[fA]['numTopographiesFinished'] ||
										fetchActualJsonSimulations[fA]['numTopographiesError'] != fetchLastJsonSimulations[fA]['numTopographiesError'])
									//console.log(has_topographies_changed_state)
									has_cloned_coastlines_changed_state = (fetchActualJsonSimulations[fA]['numClonedCoastlinesSubmitted'] != fetchLastJsonSimulations[fA]['numClonedCoastlinesSubmitted'] ||
										fetchActualJsonSimulations[fA]['numClonedCoastlinesRunning'] != fetchLastJsonSimulations[fA]['numClonedCoastlinesRunning'] ||
										fetchActualJsonSimulations[fA]['numClonedCoastlinesFinished'] != fetchLastJsonSimulations[fA]['numClonedCoastlinesFinished'] ||
										fetchActualJsonSimulations[fA]['numClonedCoastlinesError'] != fetchLastJsonSimulations[fA]['numClonedCoastlinesError'])
									//console.log(has_topographies_changed_state)
									has_created_thresholds_changed_state = (fetchActualJsonSimulations[fA]['numCreatedThresholdsSubmitted'] != fetchLastJsonSimulations[fA]['numCreatedThresholdsSubmitted'] ||
										fetchActualJsonSimulations[fA]['numCreatedThresholdsRunning'] != fetchLastJsonSimulations[fA]['numCreatedThresholdsRunning'] ||
										fetchActualJsonSimulations[fA]['numCreatedThresholdsFinished'] != fetchLastJsonSimulations[fA]['numCreatedThresholdsFinished'] ||
										fetchActualJsonSimulations[fA]['numCreatedThresholdsError'] != fetchLastJsonSimulations[fA]['numCreatedThresholdsError'])
									//console.log(has_created_thresholds_changed_state)
									if (has_simulation_changed_state || has_topographies_changed_state || has_cloned_coastlines_changed_state || has_created_thresholds_changed_state){
										//state changed, update or append!
										console.log('state changed, update or append!')
										if (roi_id == sim_roi_id && sim_id !== undefined){
											if (has_topographies_changed_state){
												console.log('has_topographies_changed_state update!')
												_update_simulation(listOfSims[s])
											}
											else if (has_cloned_coastlines_changed_state){
												console.log('has_cloned_coastlines_changed_state update!')
												_update_simulation(listOfSims[s])
											}
											else if (has_created_thresholds_changed_state){
												console.log('has_created_thresholds_changed_state update!')
												_update_simulation(listOfSims[s])
											}
											else if ($("#simulation_"+sim_id).length==0){
												console.log('append!')
												_append_simulation(listOfSims[s])
											}
											else{
												console.log('update!')
												_update_simulation(listOfSims[s])								
											}
										}
									}
								}
								else{
									//if didnt exist previously, append
									console.log('didnt exist previously, append')
									if (roi_id == sim_roi_id && sim_id !== undefined){
										if ($("#simulation_"+sim_id).length==0){
											_append_simulation(listOfSims[s])
										}
									}
									
								}

							}
						}
						else{
							fetchActualKeys = Object.keys(fetchActualJsonSimulations)
							for (var k in fetchActualKeys){
								fA = fetchActualKeys[k]
								s = fetchActualJsonSimulations[fA]['s']	
								sim_id = listOfSims[s]['simulation_id']
								sim_roi_id = listOfSims[s]['aos_id']
								if (roi_id == sim_roi_id && sim_id !== undefined){
									if ($("#simulation_"+sim_id).length==0){
										_append_simulation(listOfSims[s])
									}
									else{
										_update_simulation(listOfSims[s])								
									}
								}
							}
						}
						fetchLastJsonSimulations = fetchActualJsonSimulations
						//console.log(fetchLastJsonSimulations)						
						$('#listOfSimulationsStateText').html('<img height=20px src="/static/images/success.svg"><i>OK! Updated list!</i>')
					
					}
					console.timeEnd('updateListOfSimulations')
				},
				error: function(response){
					$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations').empty()
					$('#showVisualizationAndDetectionManager #accordion2 #listOfSimulations').append("<tr id='err'><th>An error ocurred while updating list of detections.</th></tr>")
					$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedGeometries tbody').empty()
					$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedMasks tbody').empty()
					$('#showVisualizationAndDetectionManager #accordion2 #listOfUserRepository #listOfUploadedLeakPoints tbody').empty()
					console.timeEnd('updateListOfSimulations')
					fetchLastJsonSimulations = {}
					reverseRemoveLayerIndexOf('output-')
					listActiveLayers()
					$('#listOfSimulationsStateText').html('<img height=20px src="/static/images/error2.svg"><i>Error on updating list!</i>')
					
				}
			});
		}
		
	}
</script>